MWF.xApplication.Execution=MWF.xApplication.Execution||{},MWF.xDesktop.requireApp("Template","MPopupForm",null,!1),MWF.xDesktop.requireApp("Template","MForm",null,!1),MWF.xDesktop.requireApp("Execution","WorkForm",null,!1),MWF.xApplication.Execution.StatForm=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"default",width:"90%",height:"90%",hasTop:!0,hasIcon:!1,hasBottom:!0,title:"",draggable:!1,closeAction:!0,isNew:!1,isEdited:!0},initialize:function(t,e,i,s){this.setOptions(s),this.explorer=t,this.app=t.app,this.lp=this.app.lp.statForm,this.actions=this.app.restActions,this.path="../x_component_Execution/$StatForm/",this.cssPath=this.path+this.options.style+"/css.wcss",this._loadCss(),this.options.title=this.lp.title,this.data=i||{},this.actions=e},load:function(){this.centerWorkId=this.options.centerWorkId,this.centerWorkData={},this.getCenterWork(this.centerWorkId),this.options.isNew?this.create():this.options.isEdited?this.edit():this.open(),this.resizeWindow(),this.app.addEvent("resize",function(){this.resizeWindow()}.bind(this))},resizeWindow:function(){var t=this.formNode.getSize(),e=this.formTopContentNode.getWidth();this.formTopTextNode.setStyles({width:t.x-e-200+"px"})},getCenterWork:function(t){this.actions.getMainTask(t,function(t){this.centerWorkData=t.data}.bind(this),function(t,e,i){this.showErrorMsg(t,e,i)}.bind(this),!1)},createTopNode:function(){this.formTopNode||(this.formTopNode=new Element("div.formTopNode",{styles:this.css.formTopNode}).inject(this.formNode),this.formTopIconNode=new Element("div",{styles:this.css.formTopIconNode}).inject(this.formTopNode),this.formTopTextNode=new Element("div.formTopTextNode",{styles:this.css.formTopTextNode,text:this.centerWorkData.title?this.centerWorkData.title:this.options.title}).inject(this.formTopNode),this.options.closeAction&&(this.formTopCloseActionNode=new Element("div.formTopCloseActionNode",{styles:this.css.formTopCloseActionNode}).inject(this.formTopNode),this.formTopCloseActionNode.addEvent("click",function(){this.close()}.bind(this))),this.formTopContentNode=new Element("div.formTopContentNode",{styles:this.css.formTopContentNode}).inject(this.formTopNode),this._createTopContent())},_createTopContent:function(){if(this.centerWorkData.title){var t="<span style='font-size:14px;'>"+this.lp.topTitle.drafter+":</span>    <span style='font-size:14px;'>"+this.centerWorkData.creatorName.split("@")[0]+"</span>   <span style='font-size:14px;margin-left:10px;'>"+this.lp.topTitle.department+":</span>   <span style='font-size:14px;'>"+this.centerWorkData.creatorUnitName.split("@")[0]+"</span>   <span style='font-size:14px;margin-left:10px;'>"+this.lp.topTitle.createTime+":</span>   <span style='font-size:14px;'>"+this.centerWorkData.createTime.split(" ")[0]+"</span>";this.formTopContentNode.set("html",t)}},_createTableContent:function(t){this.createWeeklyList()},createWeeklyList:function(){this.weeklyContentDiv=new Element("div.weeklyContentDiv",{styles:this.css.weeklyContentDiv}).inject(this.formTableArea);new Element("div.weeklyTitleDiv",{styles:this.css.weeklyTitleDiv,text:this.lp.weeklyTitle}).inject(this.weeklyContentDiv);this.weeklyListDiv=new Element("div.weeklyListDiv",{styles:this.css.weeklyListDiv}).inject(this.weeklyContentDiv),this.loadWeeklyList()},loadWeeklyList:function(){var t={centerId:this.centerWorkData.id,order:"DESC"};if(this.actions.getStatDateList(t,function(t){"success"==t.type&&(this.weeklyData=t.data)}.bind(this),function(t,e,i){this.showErrorMsg(t,e,i)}.bind(this),!1),!this.weeklyData||0==this.weeklyData.length){new Element("li.weeklyListLi",{styles:this.css.weeklyListLi,text:"未生成汇报统计"}).inject(this.weeklyListDiv);return!1}this.weeklyData.each(function(t,e){var i=new Element("li.weeklyListLi",{styles:this.css.weeklyListLi,text:t.datetime,title:t.reportCycle}).inject(this.weeklyListDiv);i.addEvents({click:function(){this.weeklyListDiv.getElements("li").setStyles({"background-color":"",color:""}),i.setStyles({"background-color":"#3c76c1",color:"#ffffff"}),this.displayDateStat(t),this.currentWeeklyLi=i,this.currentWeeklyData=t}.bind(this),mouseover:function(){i.setStyles({border:"1px solid #3c76c1"})}.bind(this),mouseout:function(){i.setStyles({border:""})}.bind(this)}),0==e&&(this.currentWeeklyLi=i)}.bind(this)),this.currentWeeklyLi&&this.currentWeeklyLi.click()},createStatView:function(t){this.statViewDiv&&this.statViewDiv.destroy(),this.statViewDiv=new Element("div.statViewDiv",{styles:this.css.statViewDiv}).inject(this.formTableArea);new Element("div.statViewTitleDiv",{styles:this.css.statViewTitleDiv,text:this.lp.statViewTitle}).inject(this.statViewDiv);this.statViewListDiv=new Element("div.statViewListDiv",{styles:this.css.statViewListDiv}).inject(this.statViewDiv),this.loadStatView(t)},displayDateStat:function(t,e){if(this.statViewListDiv&&this.statViewListDiv.empty(),t){var i={statisticTimeFlag:t.datetime,centerId:this.centerWorkData.id};this.statViewListDiv&&this.statViewListDiv.set("text","loading..."),this.actions.getStatDate(i,function(t){"success"==t.type&&(this.dateStatData=t.data,this.displayDateStatTable())}.bind(this),function(t,e,i){this.showErrorMsg(t,e,i)}.bind(this),!0)}},displayDateStatTable:function(){if(this.dateStatData){for(var t in this.statViewListDiv&&this.statViewListDiv.destroy(),this.statViewListDiv=new Element("div.statViewListDiv",{styles:this.css.statViewListDiv}).inject(this.formTableArea),this.statTable=new Element("table.statTable",{styles:this.css.statTable}).inject(this.statViewListDiv),this.statHeadTr=new Element("tr.statHeadTr",{styles:this.css.statHeadTr}).inject(this.statTable),this.lp.statTable)new Element("td.statHeadTd",{styles:this.css.statHeadTd,text:this.lp.statTable[t]}).inject(this.statHeadTr);this.dateStatData.each(function(t,e){t.contents&&t.contents.length>0&&t.contents.each(function(t,e){var i=new Element("tr.baseTr").inject(this.statTable);for(var s in this.lp.statTable){var n="";"opinions"==s?t[s]&&t[s].each((function(t){n=n+t.processorName.split("@")[0]+"：\n"+t.opinion+"\n"})):"responsibilityUnitName"==s?n=(n=t[s]).split("@")[0]:t[s]&&(n=t[s]);var o=new Element("td.dateStatBaseTd",{styles:this.css.dateStatBaseTd,html:n.length>50?n.substring(0,50)+"...":n,title:n}).inject(i);"serialNumber"==s&&o.setStyles({width:"35px","text-align":"center"}),"responsibilityUnitName"==s&&(o.setStyles({width:"87px"}),n=n.split("@")[0])}}.bind(this))}.bind(this))}},loadStatView:function(t){for(var e in this.statTable=new Element("table.statTable",{styles:this.css.statTable}).inject(this.statViewListDiv),this.statHeadTr=new Element("tr.statHeadTr",{styles:this.css.statHeadTr}).inject(this.statTable),this.lp.statTable)new Element("td.statHeadTd",{styles:this.css.statHeadTd,text:this.lp.statTable[e]}).inject(this.statHeadTr);parentWorkId||(parentWorkId="(0)"),this.actions.getStatByWorkId(id,parentWorkId,function(t){t.data.each(function(t,e){var i=new Element("tr.statBodyTr",{styles:this.css.statBodyTr}).inject(this.statTable),s=new Element("td.statBodyTd",{styles:this.css.statBodyTd,text:e+1,id:t.workId}).inject(i);for(var n in s.setStyles({width:"35px","text-align":"center"}),this.lp.statTable)if("order"!=n){var o="";"opinions"==n?t[n]&&t[n].each((function(t){o=o+t.processorName.split("@")[0]+"：<br>"+t.opinion+"<br>"})):o=t[n],s=new Element("td.statBodyTd",{styles:this.css.statBodyTd,html:o.length>50?o.substring(0,50)+"...":o,title:o}).inject(i),"organizationName"==n&&s.setStyles({width:"87px"}),"workDetail"==n&&s.addEvents({click:function(){this.loadSubStat(id,t.workId,i)}.bind(this)})}}.bind(this))}.bind(this),function(t,e,i){this.showErrorMsg(t,e,i)}.bind(this),!1)},loadSubStat:function(t,e,i){var s=i.getElementById(e).get("text");this.actions.getStatByWorkId(t,e,function(e){this.subStatData=e.data,e.data.each(function(e,n){if(document.getElementById(e.workId))return!1;var o=new Element("tr.statBodyTr",{styles:this.css.statBodyTr}).inject(i,"after"),a=new Element("td.statBodyTd",{styles:this.css.statBodyTd,text:s+"."+(this.subStatData.length-n),id:e.workId}).inject(o);for(var r in this.lp.statTable)if("order"!=r){var l="";"opinions"==r?e[r]&&e[r].each((function(t){l=l+t.processorName.split("@")[0]+"：<br>"+t.opinion+"<br>"})):l=e[r],a=new Element("td.statBodyTd",{styles:this.css.statBodyTd,html:l.length>50?l.substring(1,50)+"...":l,title:l}).inject(o),"workDetail"==r&&a.addEvents({click:function(){this.loadSubStat(t,e.workId)}.bind(this)})}}.bind(this))}.bind(this),function(t,e,i){this.showErrorMsg(t,e,i)}.bind(this),!1)},_createBottomContent:function(){this.formBottomNode&&this.formBottomNode.empty(),this.closeActionNode=new Element("div.closeActionNode",{styles:this.css.formActionNode,text:this.lp.actions.close}).inject(this.formBottomNode),this.closeActionNode.addEvents({click:function(){this.close()}.bind(this)}),this.exportActionNode=new Element("div.exportActionNode",{styles:this.css.formActionNode,text:this.lp.actions.export}).inject(this.formBottomNode),this.exportActionNode.addEvents({click:function(){var t={};t.centerId=this.centerWorkId,t.statisticTimeFlag=this.currentWeeklyData.datetime,t.reportCycle=this.currentWeeklyData.reportCycle,this.actions.exportByCenterWork(t,function(t){if(t.data&&t.data.id){var e=this.actions.action.address+"/jaxrs/export/statisticreportcontent/"+t.data.id+"/stream";window.open(o2.filterUrl(e))}}.bind(this),function(t,e,i){this.showErrorMsg(t,e,i)}.bind(this),!1)}.bind(this)})},showErrorMsg:function(t,e,i){var s=i;t&&(errorMessage=t.responseText);var n=JSON.parse(errorMessage);n.message?this.app.notice(n.message,"error"):this.app.notice(s,"error")}});