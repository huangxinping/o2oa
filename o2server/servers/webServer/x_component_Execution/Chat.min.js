MWF.xApplication.Execution.Chat=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",documentId:""},initialize:function(t,i,e,s,n,o){this.setOptions(o),this.dialogContainer=$(t),this.editorContainer=$(i),this.app=e,this.actions=s,this.lp=n,this.userName=layout.desktop.session.user.name,this.userName=layout.desktop.session.user.distinguishedName,this.path="../x_component_Execution/$Chat/"+this.options.style+"/",this.actionSettingPath=MWF.defaultPath+"/widget/$SimpleEditor/"+this.options.style+"/ActionSetting.js",this.cssPath=this.path+"css.wcss",this._loadCss(),this.orgActionsAlpha=MWF.Actions.get("x_organization_assemble_control")},load:function(){if(this._loadEmotionSetting(),this.dialogContainer){this.dialogNode=new Element("div.dialogNode",{styles:this.css.dialogNode}).inject(this.dialogContainer);var t=this;MWF.require("MWF.widget.ScrollBar",function(){this.scrollObj=new MWF.widget.ScrollBar(this.dialogContainer,{indent:!1,style:"default",where:"before",distance:60,friction:4,axis:{x:!1,y:!0},onScroll:function(i){0==i&&(t.isItemsLoaded||t.loadDialog())}})}.bind(this),!1),this.items=[],this.isItemsLoaded=!1,this.isItemLoadding=!1,this.loadDialog(function(){this.scrollToLater()}.bind(this))}this.editorContainer&&this.loadEditor(this.editorContainer,"")},scrollToLater:function(){setTimeout(function(){var t=this.scrollObj.node.getSize();if(this.scrollObj.scrollVNode||this.scrollObj.checkScroll(),this.scrollObj.scrollVNode){var i=this.scrollObj.scrollVNode.getSize(),e=t.y.toFloat()-i.y.toFloat();this.scrollObj.scroll(e,null)}}.bind(this),500)},_loadEmotionSetting:function(){this.emotionSetting||new Request({url:this.actionSettingPath,async:!1,method:"get",onSuccess:function(t,i){this.emotionSetting=MWF.widget.SimpleEditor.Actions.setting.emotion}.bind(this),onFailure:function(t){alert(t.responseText)}}).send()},loadDialog:function(t){this.isItemsLoaded||this.isItemLoadding||(this.isItemLoadding=!0,this.getCurrentPageData(function(i){i.count<=this.items.length&&(this.isItemsLoaded=!0),i.data.each(function(t){this.loadDialogItem(t)}.bind(this)),this.isItemLoadding=!1,t&&t()}.bind(this),10))},loadDialogItem:function(t,i){this.items.push(t.id);var e=t.senderName==this.userName,s=new Element("div.msg_li",{styles:this.css.msg_li}).inject(this.dialogNode,i||"top"),n=new Element("div",{styles:this.css.msg_item}).inject(s),o=new Element("div",{styles:this.css[e?"msg_person_right":"msg_person_left"]}).inject(n),a=new Element("img",{styles:this.css.msg_face}).inject(o);if(this.setUserFace(t.senderName,a),!e)new Element("div",{styles:this.css.msg_person_name,text:t.senderName.split("@")[0]}).inject(o);new Element("div",{styles:this.css[e?"msg_arrow_right":"msg_arrow_left"]}).inject(n);var r=new Element("div",{styles:this.css[e?"msg_content_body_right":"msg_content_body_left"]}).inject(n),l=new Element("div",{styles:this.css.msg_content_area}).inject(r);new Element("p",{styles:this.css.msg_content_text,html:this.parseEmotion(t.content)}).inject(l),new Element("p",{styles:this.css.msg_content_time,text:t.createTime}).inject(l)},parseEmotion:function(t){return t.replace(/\[emotion=(.*?)\]/g,function(t,i){return"<img imagename='"+i+"' style='cursor:pointer;border:0;padding:2px;'  class='MWF_editor_emotion' src='"+this.emotionSetting.imagesPath+i+this.emotionSetting.fileExt+"'>"}.bind(this))},getCurrentPageData:function(t,i){i||(i=5);var e=this.items&&this.items.length?this.items[this.items.length-1]:"(0)",s={workId:this.options.workId}||{};this.actions.getChatListNext(e,i,s,function(i){t&&t(i)}.bind(this),null,!1)},setUserFace:function(t,i){i.set("src",this.orgActionsAlpha.getPersonIcon(t))},sendMessage:function(t,i){var e={workId:this.options.workId,createTime:(new Date).format("db"),content:t,targetIdentity:this.app.identity,senderName:this.userName};this.actions.submitChat(e,function(t){}.bind(this),function(t,i,e){var s=e;t&&(errorMessage=t.responseText);var n=JSON.parse(errorMessage);n.message?this.app.notice(n.message,"error"):this.app.notice(s,"error")}.bind(this),!1),this.loadDialogItem(e,"bottom"),i&&i()},loadEditor:function(t,i){MWF.require("MWF.widget.SimpleEditor",function(){this.editor=new MWF.widget.SimpleEditor({style:"chatReceive",hasHeadNode:!1,hasTitleNode:!1,editorDisabled:!1,hasToolbar:!0,toolbarDisable:!1,hasSubmit:!0,submitDisable:!1,hasCustomArea:!0,paragraphise:!1,minHeight:100,maxHeight:100,overFlow:"visible",width:"100%",action:"Emotion",limit:255,onQueryLoad:function(){return!0},onPostLoad:function(t){t.setCustomInfo("")},onSubmitForm:function(t){var i=t.getContent(!0);"<br>"!=i.trim()&&""!=i.trim()?this.sendMessage(i,function(){t.setContent(""),this.scrollToLater()}.bind(this)):this.app.notice("不能发送空消息","error")}.bind(this)},t,i||"",null,null),this.editor.load()}.bind(this))}});