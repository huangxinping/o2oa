MWF.xApplication.Execution=MWF.xApplication.Execution||{},MWF.xDesktop.requireApp("Template","MPopupForm",null,!1),MWF.xDesktop.requireApp("Template","MForm",null,!1),MWF.xDesktop.requireApp("Execution","Attachment",null,!1),MWF.xApplication.Execution.WorkForm=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"default",width:"800",height:"100%",hasTop:!0,hasIcon:!1,hasBottom:!0,title:"",draggable:!1,closeAction:!0},initialize:function(t,e,s,i){this.setOptions(i),this.explorer=t,this.app=t.app,this.lp=this.app.lp.workForm,this.actions=this.app.restActions,this.path="../x_component_Execution/$WorkForm/",this.cssPath=this.path+this.options.style+"/css.wcss",this._loadCss(),this.options.title=this.lp.title,this.data=s||{},this.actions=e},load:function(){this.options.isNew?this.options.parentWorkId?this.actions.getBaseWorkInfo(this.options.parentWorkId,function(t){t.data&&(this.parentWorkData=t.data)}.bind(this),function(t,e,s){this.showErrorMessage(t,e,s)}.bind(this),!1):this.options.centerWorkId?this.data.centerId=this.options.centerWorkId:this.data.centerWorkId&&(this.data.centerId=this.data.centerWorkId):(this.data.id?this.id=this.data.id:this.options.id&&(this.id=this.options.id),this.actions.getBaseWorkInfo(this.id,function(t){t.data&&(this.data=t.data)}.bind(this),function(t,e,s){this.showErrorMessage(t,e,s)}.bind(this),!1)),this.options.isNew?this.create():this.options.isEdited?this.edit():this.open()},createTopNode:function(){this.formTopNode||(this.formTopNode=new Element("div.formTopNode",{styles:this.css.formTopNode}).inject(this.formNode),this.formTopIconNode=new Element("div",{styles:this.css.formTopIconNode}).inject(this.formTopNode),this.formTopTextNode=new Element("div",{styles:this.css.formTopTextNode,text:this.options.title+(this.data.title?"-"+this.data.title:"")}).inject(this.formTopNode),this.options.closeAction&&(this.formTopCloseActionNode=new Element("div",{styles:this.css.formTopCloseActionNode}).inject(this.formTopNode),this.formTopCloseActionNode.addEvent("click",function(){this.close()}.bind(this))),this.formTopContentNode=new Element("div",{styles:this.css.formTopContentNode}).inject(this.formTopNode),this._createTopContent())},_createTopContent:function(){},_createTableContent:function(){this.formTableArea.set("html","<table width='100%' bordr='0' cellpadding='5' cellspacing='0' styles='formTable'><tr>   <td styles='formTableTitle' lable='centerWorkTitle'></td>   <td styles='formTableValue' item='centerWorkTitle' colspan='3'></td></tr><tr>   <td styles='formTableTitle' lable='timeLimit'></td>   <td styles='formTableValue' item='timeLimit'></td>   <td styles='formTableTitle' lable='reportCycle'></td>   <td styles='formTableValue'><span item='reportCycle'></span><span item='reportDay'></span></td></tr><tr>   <td styles='formTableTitle' lable='dutyDepartment'></td>   <td styles='formTableValue' item='dutyDepartment'></td>   <td styles='formTableTitle' lable='dutyPerson'></td>   <td styles='formTableValue' item='dutyPerson'></td></tr><tr>   <td styles='formTableTitle' lable='secondDepartment'></td>   <td styles='formTableValue' item='secondDepartment'></td>   <td styles='formTableTitle' lable='secondPerson'></td>   <td styles='formTableValue' item='secondPerson'></td></tr><tr>   <td styles='formTableTitle' lable='readReader'></td>   <td styles='formTableValue' item='readReader' colspan='3'></td></tr><tr>   <td styles='formTableValue' colspan='4'>       <div styles='formTableTitleDiv' lable='workSplitAndDescription'></div>       <div styles='formTableValueDiv' item='workSplitAndDescription'></div>   </td></tr><tr>   <td styles='formTableValue' colspan='4'>       <div styles='formTableTitleDiv' lable='specificActionInitiatives'></div>       <div styles='formTableValueDiv' item='specificActionInitiatives'></div>   </td></tr><tr></tr><tr>   <td styles='formTableValue' colspan='4'>       <div styles='formTableTitleDiv' lable='milestoneMark'></div>       <div styles='formTableValueDiv' item='milestoneMark'></div>   </td></tr><tr>   <td styles='formTableValue' colspan='4'>       <div styles='formTableValueDiv' item='attachments'></div>   </td></tr></table>"),this.loadForm()},loadForm:function(){this.parentWorkData&&(this.data.parentWorkId=this.parentWorkData.id,this.data.workDetail=this.parentWorkData.workDetail,this.data.centerId=this.parentWorkData.centerId),this.form=new MForm(this.formTableArea,this.data,{style:"execution",isEdited:this.isEdited||this.isNew,itemTemplate:this.getItemTemplate(this.lp)},this.app),this.form.load(),this.formTableArea.getElements("textarea").setStyles({height:"70px"}),this.attachmentArea=this.formTableArea.getElement("[item='attachments']"),this.loadAttachment(this.attachmentArea),this.tmpLp=this.lp.processInfo,this.processInfo=new Element("div.processInfo",{styles:this.css.processInfoDiv}).inject(this.formTableArea),this.processInfoTitle=new Element("div.processInfoTitle",{styles:this.css.processInfoTitleDiv,text:this.tmpLp.title}).inject(this.processInfo),this.processInfoContent=new Element("div.processInfoContent",{styles:this.css.processInfoContent}).inject(this.processInfo);var t="<tr>";t+="<td styles='processTH'>"+this.tmpLp.operate+"</td>",t+="<td styles='processTH'>"+this.tmpLp.time+"</td>",t+="<td styles='processTH'>"+this.tmpLp.source.split("@")[0]+"</td>",t+="<td styles='processTH'>"+this.tmpLp.target.split("@")[0]+"</td>",t+="<td styles='processTH'>"+this.tmpLp.opinion+"</td>",t+="</tr>",this.data.workDeployAuthorizeRecords&&this.data.workDeployAuthorizeRecords.each(function(e){t+="<tr>",t+="<td styles='processTD'>"+e.operationTypeCN+"</td>",t+="<td styles='processTD'>"+e.operationTime+"</td>",t+="<td styles='processTD'>"+e.source.split("@")[0]+"</td>",t+="<td styles='processTD'>"+e.target.split("@")[0]+"</td>",t+="<td styles='processTD'>"+e.opinion+"</td>",t+="</tr>"}.bind(this));this.processInfoContent.set("html","<table styles='processTable'>"+t+"</table>"),this.formatStyles(this.processInfoContent)},formatStyles:function(t){t.getElements("[styles]").each(function(t){var e=t.get("styles");e&&this.css[e]&&t.setStyles(this.css[e])}.bind(this))},getItemTemplate:function(t){return _self=this,{centerWorkTitle:{text:t.centerWorkTitle+":",type:"innerText",value:this.data.centerWorkInfo?this.data.centerWorkInfo.title:this.data.centerWorkTitle?this.data.centerWorkTitle.title:""},workType:{text:t.workType+":",type:"select",notEmpty:!0,selectValue:t.workTypeValue.split(",")},workLevel:{text:t.workLevel+":",type:"select",notEmpty:!0,selectValue:t.workLevelValue.split(",")},timeLimit:{text:t.timeLimit+":",tType:"date",name:"completeDateLimitStr",notEmpty:!0,attr:{readonly:!0}},reportCycle:{text:t.reportCycle+":",type:"select",notEmpty:!0,selectText:t.reportCycleText.split(","),className:_self.isEdited||_self.isNew?"inputSelectUnformatWidth":"",event:{change:function(e,s){e.get("value")==t.reportCycleText.split(",")[0]?this.form.getItem("reportDay").resetItemOptions(t.weekDayValue.split(","),t.weekDayText.split(",")):e.get("value")==t.reportCycleText.split(",")[1]&&this.form.getItem("reportDay").resetItemOptions(t.monthDayValue.split(","),t.monthDayText.split(","))}.bind(this)}},reportDay:{type:"select",name:"reportDayInCycle",notEmpty:!0,selectValue:this.data.reportCycle&&this.data.reportCycle!=t.reportCycleText.split(",")[0]?t.monthDayValue.split(","):t.weekDayValue.split(","),selectText:this.data.reportCycle&&this.data.reportCycle!=t.reportCycleText.split(",")[0]?t.monthDayText.split(","):t.weekDayText.split(","),className:_self.isEdited||_self.isNew?"inputSelectUnformatWidth":""},dutyDepartment:{type:"org",orgType:"unit",text:t.dutyDepartment+":",name:"responsibilityUnitName",notEmpty:!0,attr:{readonly:!0},event:{change:function(t){var e=t.getValue(",");e&&_self.getDepartmentLeader(e,(function(t){_self.form.getItem("dutyPerson").setValue(t)}))}}},dutyPerson:{type:"org",orgType:"identity",text:t.dutyPerson+":",count:1,name:"responsibilityIdentity",notEmpty:!0,attr:{readonly:!0},onQuerySelect:function(t){var e=this.form.getItem("dutyDepartment").getValue();e="string"==typeOf(e)?[e]:e;var s=[];(e||[]).each((function(t){return s.push(t.split("@")[0])})),t.options.units=s||[]}.bind(this)},secondDepartment:{text:t.secondDepartment+":",type:"org",orgType:"unit",name:"cooperateUnitNameList",value:this.cooperateUnitNameList?this.cooperateUnitNameList.join(","):"",count:0,attr:{readonly:!0},event:{change:function(t){var e=t.getValue(",");if(e){for(var s=e.split(","),i="",o=0;o<s.length;o++)""!=s[o]&&_self.getDepartmentLeader(s[o],(function(t){i=""==i?t:i+","+t}));_self.form.getItem("secondPerson").setValue(i)}}}},secondPerson:{text:t.secondPerson+":",type:"org",orgType:"identity",name:"cooperateIdentityList",value:this.cooperateIdentity?this.cooperateIdentity.join(","):"",count:0,attr:{readonly:!0}},readReader:{text:t.readReader+":",type:"org",orgType:"identity",name:"readLeaderIdentityList",value:this.readLeaderIdentity?this.readLeaderIdentity.join(","):"",attr:{readonly:!0},count:0},subject:{text:t.subject+":",name:"title",notEmpty:!0},workSplitAndDescription:{text:t.workSplitAndDescription+":",type:"textarea",name:"workDetail",notEmpty:!0},specificActionInitiatives:{text:t.specificActionInitiatives+":",type:"textarea",name:"progressAction"},cityCompanyDuty:{text:t.cityCompanyDuty+":",type:"textarea",name:"dutyDescription"},milestoneMark:{text:t.milestoneMark+":",type:"textarea",name:"landmarkDescription"},importantMatters:{text:t.importantMatters+":",type:"textarea",name:"majorIssuesDescription"}}},loadAttachment:function(t){this.attachment=new MWF.xApplication.Execution.Attachment(t,this.app,this.actions,this.app.lp,{size:this.options.isNew?"max":"min",documentId:this.data.id,isNew:this.options.isNew,isEdited:this.options.isEdited,onQueryUploadAttachment:function(){if(this.attachment.isQueryUploadSuccess=!0,!this.data.id||""==this.data.id){var t=this.form.getResult(!0,",",!0,!1,!0);if(!t)return void(this.attachment.isQueryUploadSuccess=!1);this.options.isNew&&(t.centerId=this.options.centerWorkId||this.data.centerWorkId||this.data.centerId),""==t.cooperateUnitNameList?t.cooperateUnitNameList=[]:t.cooperateUnitNameList=t.cooperateUnitNameList.split(","),""==t.cooperateIdentityList?t.cooperateIdentityList=[]:t.cooperateIdentityList=t.cooperateIdentityList.split(","),""==t.readLeaderIdentityList?t.readLeaderIdentityList=[]:t.readLeaderIdentityList=t.readLeaderIdentityList.split(","),this.app.restActions.saveTask(t,function(t){t.type&&"success"==t.type&&t.data.id&&(this.attachment.options.documentId=t.data.id,this.data.id=t.data.id)}.bind(this),function(t,e,s){this.showErrorMessage(t,e,s)}.bind(this),!1)}}.bind(this)}),this.attachment.load()},_createBottomContent:function(){this.cancelActionNode=new Element("div.formCancelActionNode",{styles:this.css.formCancelActionNode,text:this.app.lp.cancel}).inject(this.formBottomNode),this.cancelActionNode.addEvent("click",function(t){this.cancel(t)}.bind(this)),(this.isNew||this.isEdited)&&"save"==this.options.actionStatus&&(this.okActionNode=new Element("div.formOkActionNode",{styles:this.css.formOkActionNode,text:this.app.lp.ok}).inject(this.formBottomNode),this.okActionNode.addEvent("click",function(t){this.ok(t)}.bind(this))),"deploy"==this.options.actionStatus&&(this.deployActionNode=new Element("div.formDeployActionNode",{styles:this.css.formOkActionNode,text:this.app.lp.deploy}).inject(this.formBottomNode).addEvent("click",function(){this.deploy()}.bind(this)))},deploy:function(){var t=this.form.getResult(!0,",",!0,!1,!0);t&&(""==t.cooperateUnitNameList?t.cooperateUnitNameList=[]:t.cooperateUnitNameList=t.cooperateUnitNameList.split(","),""==t.cooperateIdentityList?t.cooperateIdentityList=[]:t.cooperateIdentityList=t.cooperateIdentityList.split(","),""==t.readLeaderIdentityList?t.readLeaderIdentityList=[]:t.readLeaderIdentityList=t.readLeaderIdentityList.split(","),t.title=t.workDetail,t.deployerName=this.app.user,t.creatorName=this.app.user,t.centerId=this.data.centerId,this.app.createShade(),this.app.restActions.saveTask(t,function(t){if(t.type&&"success"==t.type&&t.data.id){var e=[];e.push(t.data.id);var s={workIds:e};this.actions.deployBaseWork(s,function(t){t.type&&"success"==t.type&&(this.app.notice(this.app.lp.WorkDeploy.deployeSuccess,"ok"),this.close()),this.fireEvent("postDeploy",t),this.app.destroyShade()}.bind(this),function(t,e,s){this.app.destroyShade(),this.app.showErrorMessage(t,e,s)}.bind(this))}}.bind(this),function(t,e,s){this.app.showErrorMessage(t,e,s)}.bind(this)))},_ok:function(t,e){""==t.cooperateUnitNameList?t.cooperateUnitNameList=[]:t.cooperateUnitNameList=t.cooperateUnitNameList.split(","),""==t.cooperateIdentityList?t.cooperateIdentityList=[]:t.cooperateIdentityList=t.cooperateIdentityList.split(","),""==t.readLeaderIdentityList?t.readLeaderIdentityList=[]:t.readLeaderIdentityList=t.readLeaderIdentityList.split(","),this.app.createShade(),this.app.restActions.saveTask(t,function(t){t.type&&"success"==t.type&&(this.app.notice(this.lp.submitSuccess,"ok"),this.options.tabLocation?(this.app.workTask&&this.app.workTask.loadBaseWorkList(this.options.tabLocation),this.app.workList&&this.app.workList.loadBaseWorkList(this.options.tabLocation)):this.explorer&&this.explorer.explorer&&this.explorer.explorer.reloadList&&this.explorer.explorer.reloadList(),this.close()),this.app.destroyShade(),this.fireEvent("postSave",t)}.bind(this),function(t,e,s){this.app.destroyShade();var i=s;t&&(errorMessage=t.responseText);var o=JSON.parse(errorMessage);o.message?this.app.notice(o.message,"error"):this.app.notice(i,"error")}.bind(this))},getDepartmentLeader:function(t,e){var s={};s.name=this.app.lp.departmentLeader,s.unit=t,this.app.orgActions.getDutyValue(s,function(t){t.data.identityList&&t.data.identityList.length>0&&e&&e(t.data.identityList[0])}.bind(this),null,!1)},showErrorMessage:function(t,e,s){var i=s;if(t&&(errorMessage=t.responseText),""!=errorMessage){var o=JSON.parse(errorMessage);o.message?this.app.notice(o.message,"error"):this.app.notice(i,"error")}else this.app.notice(i,"error")}});