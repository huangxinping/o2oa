MWF.xApplication.Execution=MWF.xApplication.Execution||{},MWF.xDesktop.requireApp("Template","MPopupForm",null,!1),MWF.xDesktop.requireApp("Template","MForm",null,!1),MWF.xDesktop.requireApp("Execution","Minder",null,!1),MWF.xDesktop.requireApp("Execution","WorkDeploy",null,!1),MWF.xApplication.Execution.WorkMinder=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"default",template:"default",theme:"fresh-blue-compat",width:"100%",height:"100%",hasTop:!0,hasTopIcon:!0,hasTopContent:!0,hasIcon:!1,hasBottom:!1,hasScroll:!1,title:"脑图展现",draggable:!1,closeAction:!0},initialize:function(t,e,o){this.setOptions(o),this.app=t.app,this.lp=this.app.lp,this.actions=this.app.restActions,this.explorer=t,this.path="../x_component_Execution/$WorkMinder/",this.cssPath=this.path+this.options.style+"/css.wcss",this._loadCss(),this.options.title=this.lp.minderTitle+"-"+(e.title||""),this.data=e},load:function(t){this.open()},_open:function(){if(this.formMaskNode=new Element("div.formMaskNode",{styles:this.css.formMaskNode,events:{mouseover:function(t){t.stopPropagation()},mouseout:function(t){t.stopPropagation()}}}).inject(this.app.content),this.formAreaNode=new Element("div.formAreaNode",{styles:this.css.formAreaNode}),this.formAreaNode.inject(this.formMaskNode,"after"),this.formAreaNode.fade("in"),this.createFormNode(),this.refreshFun=this.refresh.bind(this),this.app.addEvent("resize",this.refreshFun),this.options.draggable&&this.formTopNode){var t=this.app.content.getSize(),e=this.formAreaNode.getSize();this.formAreaNode.makeDraggable({handle:this.formTopNode,limit:{x:[0,t.x-e.x],y:[0,t.y-e.y]}})}},destroy:function(){this.minder&&this.minder.destroy(),this.formMaskNode.destroy(),this.formAreaNode.destroy()},refresh:function(){this.setFormNodeSize(),this.minder&&this.minder.refresh()},reload:function(){this.minder&&this.minder.destroy(),this.formTableArea.empty(),this._createTableContent()},_createTableContent:function(){this.setFormNodeSize(),this.formTableArea.setStyles({width:"100%",height:"100%","background-color":"#fbfbfb"}),this.listNestWork(function(t){this.createMinder(t)}.bind(this))},createMinder:function(t){this.minder=new MWF.xApplication.Execution.Minder(this.formTableArea,this.app,t,{hasNavi:!1,onPostLoad:function(){this.minder.km.execCommand("ExpandToLevel",1),this.minder.loadNavi(this.formTableContainer)}.bind(this),onPostLoadNode:function(t){this.setMinderNode(t)}.bind(this)}),this.minder.load()},listNestWork:function(t){this.actions.getUserMind(this.data.id,function(e){var o=this.transportData(e);t&&t(o)}.bind(this))},transportData:function(t){var e=[];this.getNestData(t.data.works,e);var o={root:{data:this.data,children:e}};return o.root.data.text=o.root.data.title.length>30?o.root.data.title.substr(0,30)+"...":o.root.data.title,o.root.data.note=" ",o.root.data.isCenterWork=!0,o},getNestData:function(t,e){t.each(function(t){var o={};t.subWorks&&(o.children=[],this.getNestData(t.subWorks,o.children)),o.data=t,t.subWorks&&delete o.data.subWorks,o.data.text=t.title.length>20?t.title.substr(0,20)+"...":t.title,o.data.note=t.watch?" ":null,o.data.resource=this.getActions(o.data,o.children),e.push(o)}.bind(this))},setMinderNode:function(t){var e=this;if(t.getData().watch){var o=t.getRenderer("NoteIconRenderer").getRenderShape();o&&(o.addEventListener("mouseover",function(t){e.workInforTimer=setTimeout(function(){var t=this.getRenderBox("screen");e.showWorkInfor(this.getData(),t)}.bind(this),300)}.bind(t)),o.addEventListener("mouseout",function(t){clearTimeout(e.workInforTimer),e.destroyWorkInfor()}.bind(t)),o.addEventListener("click",function(t){e.openWork(this,this.getData()),t.stopPropagation()}.bind(t)));var i=t.getRenderer("ResourceRenderer");i&&i.overlays&&i.overlays.length>0&&i.overlays.forEach((function(o){o.addEventListener("click",function(t){var i={event:{x:t.originEvent.x,y:t.originEvent.y}};e.activeAction(o.lastResourceName,this.getData(),i),t.stopPropagation()}.bind(t))})),t.getRenderContainer().node.addEventListener("dblclick",function(t){e.openWork(this,this.getData())}.bind(t))}else;},getActions:function(t,e){var o=[];return t.workProcessStatus==this.lp.WorkDeploy.statusDraft?this.app.identity==t.deployerIdentity&&o.push("删除"):(e&&0!=e.length||this.app.identity!=t.deployerIdentity||o.push("删除"),t.responsibilityIdentity==this.app.identity&&(o.push("汇报"),o.push("拆分"))),[]},activeAction:function(t,e,o){"删除"==t?this.removeWork(e,o):"汇报"==t?this.reportWork(e):"拆分"==t&&this.splitWork(e)},openWork:function(t,e){e.isCenterWork?this.openCenterWork(t,e):this.openBaseWork(t,e)},openCenterWork:function(t,e){var o=e.processStatus==this.lp.WorkDeploy.statusDraft&&this.app.identity==e.deployerIdentity;this.workDeploy=new MWF.xApplication.Execution.WorkMinder.WorkDeploy(this,this.actions,{id:e.id},{isEdited:o,centerWorkId:e.id,onQueryClose:function(){this.workDeploy.contentChanged&&this.reload()}.bind(this)}),this.workDeploy.load()},openBaseWork:function(t,e){e.workProcessStatus==this.lp.WorkDeploy.statusDraft?(MWF.xDesktop.requireApp("Execution","WorkForm",null,!1),new MWF.xApplication.Execution.WorkForm(this.explorer,this.app.restActions,e,{isNew:!1,isEdited:this.app.identity==e.deployerIdentity,onPostSave:function(){this.reload()}.bind(this)}).load()):MWF.xDesktop.requireApp("Execution","WorkDetail",function(){new MWF.xApplication.Execution.WorkDetail(this,this.app.restActions,e,{isNew:!1,isEdited:!1}).load()}.bind(this))},removeWork:function(t,e){var o=this.app.lp,i=o.deleteDocument2.replace(/{title}/g,t.title),s=this;this.readyRemove=!0,this.app.confirm("warn",e,o.deleteDocumentTitle,i,350,120,(function(){s._removeDocument(t),this.close()}),(function(){s.readyRemove=!1,this.close()}))},_removeDocument:function(t){t.isCenterWork?this.actions.deleteCenterWork(t.id,function(t){this.app.notice(this.app.lp.deleteDocumentOK,"success"),this.reload()}.bind(this)):this.actions.deleteBaseWork(t.id,function(t){t.type&&"success"==t.type?(this.app.notice(this.app.lp.deleteDocumentOK,"success"),this.reload()):this.app.notice(t.data.message,"error")}.bind(this))},reportWork:function(t){MWF.xDesktop.requireApp("Execution","WorkReport",function(){var e={title:t.title,workId:t.id,centerId:t.centerId,parentWorkId:t.parentWorkId,workType:t.workType,workLevel:t.workLevel,completeDateLimitStr:t.completeDateLimitStr,completeDateLimit:t.completeDateLimit,reportCycle:t.reportCycle,responsibilityOrganizationName:t.responsibilityOrganizationName,responsibilityEmployeeName:t.responsibilityEmployeeName,responsibilityIdentity:t.responsibilityIdentity,cooperateOrganizationName:t.cooperateOrganizationName,cooperateEmployeeName:t.cooperateEmployeeName,cooperateIdentity:t.cooperateIdentity,readLeaderName:t.readLeaderName,readLeaderIdentity:t.readLeaderIdentity,reportDayInCycle:t.reportDayInCycle};new MWF.xApplication.Execution.WorkReport(this,this.app.restActions,e,{isNew:!1,isEdited:!1,from:"drafter"}).load()}.bind(this))},splitWork:function(t){MWF.xDesktop.requireApp("Execution","WorkForm",function(){var e={title:t.title,centerId:t.centerId,parentWorkId:t.id,workType:t.workType,workLevel:t.workLevel,completeDateLimitStr:t.completeDateLimitStr,completeDateLimit:t.completeDateLimit,reportCycle:t.reportCycle,reportDayInCycle:t.reportDayInCycle};new MWF.xApplication.Execution.WorkForm(this,this.app.restActions,e,{isNew:!1,isEdited:!0,tabLocation:"myDo",onPostSave:function(){this.reload()}.bind(this),onPostDeploy:function(){this.reload()}.bind(this)}).load()}.bind(this))},destroyWorkInfor:function(){this.inforNode&&(this.inforNode.destroy(),this.inforNode=null),this.tooltip&&(this.tooltip.destroy(),this.tooltip=null)},showWorkInfor:function(t,e){this.destroyWorkInfor(),this.createInforNode(t,e)},setInforNodeCoondinates:function(t,e){var o,i,s,r,n=this.formTableContainer.getScroll(),a=this.formTableContainer.getSize(),d=t.getSize();e.left+10+d.x-n.x>a.x?(o=e.left+50-d.x,i="right"):(o=e.left+10,i="left"),e.top+57+d.y-n.y>a.y?(r=e.top-d.y-10,s="bottom"):(r=e.top+e.height+10,s="top"),t.setStyles({left:o,top:r}),this.inforBoxArrow=new Element("div",{styles:this.css.inforBoxArrow}).inject(this.inforNode),"top"==s?this.inforBoxArrow.setStyles({top:"-8px","background-position":"0px -18px"}):this.inforBoxArrow.setStyles({bottom:"-8px","background-position":"0px -28px"}),"left"==i?this.inforBoxArrow.setStyle("left","52px"):this.inforBoxArrow.setStyle("right","10px")},createInforNode:function(t,e,o){this.inforNode=new Element("div",{styles:{"font-size":"12px",position:"absolute","z-index":"11","background-color":"#fff",border:"1px solid #aaa",padding:"10px","border-radius":"3px","box-shadow":"0px 0px 5px #aaa"}}).inject(this.formTableArea),this.inforNode.set("html",t.isCenterWork?this.getCenterWorkInforHtml(t):this.getSubWorkInforHtml(t)),this.setInforNodeCoondinates(this.inforNode,e),o&&o()},getSubWorkInforHtml:function(t){var e="font-weight:bold;",o=this.lp.workForm;return"<table width='300' bordr='0' cellpadding='3' cellspacing='0' styles='formTable'><tr>   <td style='"+e+"' colspan='2'>"+t.title+"</td></tr><tr>   <td style='"+e+"' width='60px'>状态:</td>   <td style='' width='140px'>"+t.workProcessStatus+"</td></tr><tr>   <td style='"+e+"' width='60px'>"+o.workType+":</td>   <td style='' width='140px'>"+t.workType+"</td></tr><tr>   <td style='"+e+"'>"+o.timeLimit+":</td>   <td style=''>"+t.completeDateLimitStr+"</td></tr><tr>   <td style='"+e+"'>"+o.dutyDepartment+":</td>   <td style=''>"+t.responsibilityOrganizationName+"</td></tr><tr>   <td style='"+e+"'>"+o.dutyPerson+":</td>   <td style=''>"+t.responsibilityEmployeeName+"</td></tr><tr>   <td style='"+e+"'>"+o.secondDepartment+":</td>   <td style=''>"+t.cooperateOrganizationName+"</td></tr><tr>   <td style='"+e+"'>"+o.secondPerson+":</td>   <td style=''>"+t.cooperateEmployeeName+"</td></tr></table>"},getCenterWorkInforHtml:function(t){var e="font-weight:bold;",o=this.lp,i=t.description.length>50?t.description.substring(0,50)+"...":t.description;return"<table width='300' bordr='0' cellpadding='3' cellspacing='0' styles='formTable'><tr>   <td style='"+e+"' colspan='2'>"+t.title+"</td></tr><tr>   <td style='"+e+"' width='60px'>状态:</td>   <td style='' width='140px'>"+t.processStatus+"</td></tr><tr>   <td style='"+e+"'>"+o.workForm.workType+":</td>   <td style=''>"+t.defaultWorkType+"</td></tr><tr>   <td style='"+e+"'>"+o.workForm.timeLimit+":</td>   <td style=''>"+t.defaultCompleteDateLimitStr+"</td></tr><tr>   <td style='"+e+"'>"+o.baseWorkView.deployerName+":</td>   <td style=''>"+t.deployerIdentity+"</td></tr><tr>   <td style='"+e+"'>"+o.WorkDeploy.draftDate+":</td>   <td style=''>"+t.createTime+"</td></tr><tr>   <td style='"+e+"'>"+o.description+":</td>   <td style=''>"+i+"</td></tr></table>"},setFormNodeSize:function(t,e,o,i){t||(t=this.options.width?this.options.width:"50%"),e||(e=this.options.height?this.options.height:"50%"),o||(o=this.options.top?this.options.top:0),i||(i=this.options.left?this.options.left:0);var s=this.app.content.getSize(),r=s.x,n=s.y;"string"==typeof t&&1<t.length&&"%"==t.substr(t.length-1,1)&&(t=parseInt(r*parseInt(t,10)/100,10)),"string"==typeof e&&1<e.length&&"%"==e.substr(e.length-1,1)&&(e=parseInt(n*parseInt(e,10)/100,10)),300>t&&(t=300),220>e&&(e=220),o=o||parseInt((n-e)/2,10),i=i||parseInt((r-t)/2,10),this.formAreaNode.setStyles({width:t+"px",height:e+"px",top:o+"px",left:i+"px"}),this.formNode.setStyles({width:t+"px",height:e+"px"});var a=this.formIconNode?this.formIconNode.getSize():{x:0,y:0},d=this.formTopNode?this.formTopNode.getSize():{x:0,y:0},p=this.formBottomNode?this.formBottomNode.getSize():{x:0,y:0},l=e-a.y-d.y-p.y;this.formContentNode.setStyles({height:l+"px"}),this.formTableContainer.setStyles({width:t+"px",height:l+"px"})}}),MWF.xApplication.Execution.WorkMinder.WorkDeploy=new Class({Extends:MWF.xApplication.Execution.WorkDeploy,deploy:function(){var t=[];this.actions.getUserDeployBaseWork(this.centerWorkId,function(e){if(this.centerWorkInforData&&(this.centerWorkInforData.processStatus==this.lp.statusDraft?e.data.each(function(e){e.workProcessStatus==this.lp.statusDraft&&t.push(e.id)}.bind(this)):e.data.each(function(e){e.subWorks&&e.subWorks.each(function(e){e.workProcessStatus==this.lp.statusDraft&&t.push(e.id)}.bind(this)),e.workProcessStatus==this.lp.statusDraft&&t.push(e.id)}.bind(this))),t.length>0){var o={workIds:t};this.actions.deployBaseWork(o,function(t){t.type&&"success"==t.type?(this.app.notice(this.lp.deployeSuccess,"ok"),this.close(),this.explorer.reload()):this.app.notice(t.data.message,"error")}.bind(this))}else this.app.notice(this.lp.noWordNeedDeployed,"ok")}.bind(this))}});