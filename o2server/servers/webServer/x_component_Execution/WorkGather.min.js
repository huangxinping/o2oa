MWF.xApplication.Execution=MWF.xApplication.Execution||{},MWF.xDesktop.requireApp("Template","Explorer",null,!1),MWF.xDesktop.requireApp("Template","MPopupForm",null,!1),MWF.xDesktop.requireApp("Template","MForm",null,!1),MWF.xDesktop.requireApp("Execution","WorkForm",null,!1),MWF.xApplication.Execution.WorkGather=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"default",width:"100%",height:"100%",hasTop:!0,hasIcon:!1,hasBottom:!0,title:"",draggable:!1,closeAction:!0,isNew:!1,isEdited:!0},initialize:function(e,t,i,n){this.setOptions(n),this.explorer=e,this.app=e.app||e,this.lp=this.app.lp.workGather,this.actions=this.app.restActions,this.path="../x_component_Execution/$WorkGather/",this.cssPath=this.path+this.options.style+"/css.wcss",this._loadCss(),this.data=i||{},this.actions=t},load:function(){this.options.isNew?this.create():this.options.isEdited?this.edit():this.open()},createTopNode:function(){this.formTopNode||(this.formTopNode=new Element("div.formTopNode",{styles:this.css.formTopNode}).inject(this.formNode),this.formTopIconNode=new Element("div",{styles:this.css.formTopIconNode}).inject(this.formTopNode),this.formTopTextNode=new Element("div",{styles:this.css.formTopTextNode,text:this.data.title}).inject(this.formTopNode),this.options.closeAction&&(this.formTopCloseActionNode=new Element("div.formTopCloseActionNode",{styles:this.css.formTopCloseActionNode}).inject(this.formTopNode),this.formTopCloseActionNode.addEvent("click",function(){this.close()}.bind(this))),this.formTopContentNode=new Element("div",{styles:this.css.formTopContentNode}).inject(this.formTopNode),this._createTopContent())},_createTopContent:function(){},_createTableContent:function(e){this.titleDiv=new Element("div.titleDiv",{styles:this.css.titleDiv,text:this.data.title}).inject(this.formTableArea),this.inforDiv=new Element("div.inforDiv",{styles:this.css.inforDiv}).inject(this.formTableArea),this.gatherJson=null,this.gatherJsonLen=0,this.loadGather()},loadGather:function(){this.gatherDiv&&this.gatherDiv.destroy(),this.gatherDiv=new Element("div.gatherDiv",{styles:this.css.gatherDiv}).inject(this.formTableArea),this.tabContentDiv=new Element("div.tabContentDiv",{styles:this.css.tabContentDiv}).inject(this.gatherDiv),this.actions.getDepartmentGather(this.data.gatherId,function(e){e.data&&(this.gatherJson=e.data,this.gatherJsonLen=e.data.length)}.bind(this),null,!1),this.gatherJsonLen>0&&this.loadTabContent()},loadTabContent:function(){for(i=0;i<this.gatherJson.length;i++)this.tabContentLi=new Element("li.tabContentLi",{styles:this.css.tabContentLi,tabIndex:i,text:this.gatherJson[i].activityName+"("+this.gatherJson[i].count+")",tabName:this.gatherJson[i].activityName}).inject(this.tabContentDiv);var e=this;this.tabContentDiv.getElements("li").addEvents({click:function(){e.loadGatherContent(this)}}),this.curTabIndex||(this.curTabName="",this.curTabIndex=0),this.tabContentDiv.getElements("li")[this.curTabIndex].click()},loadGatherContent:function(e){this.curTabName=e.get("tabName"),this.curTabIndex=e.get("tabIndex"),this.tabContentDiv.getElements("li").setStyles({"background-color":"",color:""}),e.setStyles({"background-color":"#3d77c1",color:"#ffffff"}),this.gatherContentDiv&&this.gatherContentDiv.destroy(),this.gatherContentDiv=new Element("div.gatherContentDiv",{styles:this.css.gatherContentDiv}).inject(this.gatherDiv);var t=e.get("tabIndex"),i=e.get("tabName");e.get("tabName")==this.lp.gatherName.drafter?templateUrl=this.path+"listItem_drafter.json":e.get("tabName")==this.lp.gatherName.manager?templateUrl=this.path+"listItem_manager.json":e.get("tabName")==this.lp.gatherName.leader&&(templateUrl=this.path+"listItem_leader.json"),this.reportDataArr=[],this.WorkReportView=new MWF.xApplication.Execution.WorkGather.WorkReportView(this.gatherContentDiv,this.app,this,{templateUrl:templateUrl,tab:t,tabName:i}),this.WorkReportView.load()},openWorkReport:function(e,t){MWF.xDesktop.requireApp("Execution","WorkReport",function(){var i={workReportId:e,workId:t};this.workReport=new MWF.xApplication.Execution.WorkReport(this,this.actions,i,{isEdited:!1,width:"90%",height:"90%",onReloadView:function(e){this.actions.getDepartmentGather(this.data.gatherId,function(e){e.data&&0==e.data.length&&(this.fireEvent("reloadView"),this.close())}.bind(this),null,!1),this.loadGather()}.bind(this)}),this.workReport.load()}.bind(this))},_createBottomContent:function(){this.submitActionNode=new Element("div.submitActionNode",{styles:this.css.formActionNode,text:this.lp.bottomAction.submit}).inject(this.formBottomNode);var e=this.curTabName==this.lp.activityName.drafter||this.curTabName==this.lp.activityName.manager?this.lp.submitWarn.warnGatherSubmit:this.lp.submitWarn.warnGatherSubmitAll,t=this;this.submitActionNode.addEvent("click",function(i){this.app.confirm("warn",i,this.lp.submitWarn.warnTitle,e,300,150,(function(){t.submitGather(),this.close()}),(function(){this.close()}))}.bind(this)),this.closeActionNode=new Element("div.formActionNode",{styles:this.css.formActionNode,text:this.lp.bottomAction.close}).inject(this.formBottomNode),this.closeActionNode.addEvent("click",function(e){this.close(e)}.bind(this))},submit:function(e,t){var i=this.gatherDiv.getElementById("progress"+e.id),n="";i&&(n=i.get("value"));var o=this.gatherDiv.getElementById("plan"+e.id),s="";o&&(s=o.get("value"));var r=this.gatherDiv.getElementById("admin"+e.id),a="";r&&(a=r.get("value"));var l="",c=this.gatherDiv.getElementById("opinion"+e.id);c&&(l=c.get("value"));var h=this.gatherDiv.getElementById("completeSelect"+e.id),p="";h&&(p=h.get("value"));var d=this.gatherDiv.getElementById("completePercentSelect"+e.id),m="";if(d&&(m=parseInt(d.get("value"))),i&&""==n)return this.app.notice(this.lp.viewProgressDescription+this.lp.notEmpty,"error"),!1;if(o&&""==s)return this.app.notice(this.lp.viewWorkPlan+this.lp.notEmpty,"error"),!1;var v={workId:e.workId,id:e.id,progressDescription:n,workPlan:s,adminSuperviseInfo:a,opinion:l};if(h&&(v.isWorkCompleted="yes"==p),d&&(v.progressPercent=m),h&&"yes"==h.get("value")){var u=this;this.app.confirm("warn",t,u.lp.submitWarn.warnTitle,u.lp.submitWarn.warnWorkCompleted,300,150,(function(){u.app.createShade(),u.actions.submitWorkReport(v,function(e){u.app.destroyShade(),"success"==e.type&&(u.app.notice(u.lp.prompt.submitWorkReport,"success"),u.actions.getDepartmentGather(u.data.gatherId,function(e){e.data&&0==e.data.length?(u.fireEvent("reloadView"),u.close()):(1==u.gatherJson[this.curTabIndex].count&&(u.curTabIndex=0,u.curTabName=""),u.loadGather())}.bind(u),null,!1))}.bind(u),function(e,t,i){u.app.destroyShade();var n=i;e&&(errorMessage=e.responseText);var o=JSON.parse(errorMessage);o.message?u.app.notice(o.message,"error"):u.app.notice(n,"error")}.bind(u)),this.close()}),(function(){this.close()}))}else this.app.createShade(),this.actions.submitWorkReport(v,function(e){this.app.destroyShade(),"success"==e.type&&(this.app.notice(this.lp.prompt.submitWorkReport,"success"),this.actions.getDepartmentGather(this.data.gatherId,function(e){e.data&&0==e.data.length?(this.fireEvent("reloadView"),this.close()):(1==this.gatherJson[this.curTabIndex].count&&(this.curTabIndex=0,this.curTabName=""),this.loadGather())}.bind(this),null,!1))}.bind(this),function(e,t,i){var n=i;e&&(errorMessage=e.responseText);var o=JSON.parse(errorMessage);o.message?this.app.notice(o.message,"error"):this.app.notice(n,"error"),this.app.destroyShade()}.bind(this))},submitGather:function(){if(this.submitStatus=!0,this.submitError="",this.reportDataArr){this.app.createShade();for(var e=0;e<this.reportDataArr.length;e++)if(this.currentReportData=this.reportDataArr[e],this.submitStatus){var t=this.gatherDiv.getElementById("progress"+this.currentReportData.id),i="";t&&(i=t.get("value"));var n=this.gatherDiv.getElementById("plan"+this.currentReportData.id),o="";n&&(o=n.get("value"));var s=this.gatherDiv.getElementById("admin"+this.currentReportData.id),r="";s&&(r=s.get("value"));var a="",l=this.gatherDiv.getElementById("opinion"+this.currentReportData.id);l&&(a=l.get("value"));var c=this.gatherDiv.getElementById("completeSelect"+this.currentReportData.id),h="";c&&(h=c.get("value"));var p=this.gatherDiv.getElementById("completePercentSelect"+this.currentReportData.id),d="";p&&(d=parseInt(p.get("value")));var m={workId:this.currentReportData.workId,id:this.currentReportData.id,progressDescription:i,workPlan:o,adminSuperviseInfo:r,opinion:a};c&&(m.isWorkCompleted="yes"==h),p&&(m.progressPercent=d),this.actions.submitWorkReport(m,function(e){}.bind(this),function(e){var t=JSON.parse(e.responseText);this.submitError="《"+this.currentReportData.title+"》"+t.message,this.submitStatus=!1}.bind(this),!1)}}this.submitStatus?(this.app.notice(this.lp.submitWarn.submitSuccess,"success"),1==this.gatherJsonLen||0==this.gatherJsonLen?(this.fireEvent("reloadView"),this.close()):(this.curTabIndex=0,this.curTabName="",this.loadGather())):(this.app.notice(this.submitError,"error"),this.loadGather()),this.app.destroyShade()}}),MWF.xApplication.Execution.WorkGather.WorkReportView=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexView,_createDocument:function(e){return e.tabName=this.options.tabName,new MWF.xApplication.Execution.WorkGather.WorkReportDocument(this.viewNode,e,this.explorer,this)},_getCurrentPageData:function(e,t){this.actions.getDepartmentGather(this.explorer.data.gatherId,function(t){if(t.data){if(this.options.tab){var i=parseInt(this.options.tab);t=t.data[i].reportCollect}else t=t.data[0].reportCollect;e&&e(t)}}.bind(this),null,!1)},loadElementList:function(e){this.isItemsLoaded||(this.isItemLoadding?this.loadItemQueue++:(this.isItemLoadding=!0,this._getCurrentPageData(function(e){e.count<=this.items.length&&(this.isItemsLoaded=!0),e.reportInfos.each(function(e){if(!this.documents[e.id]){var t=this._createDocument(e);this.items.push(t),this.documents[e.id]=t}}.bind(this)),this.isItemLoadding=!1,this.loadItemQueue>0&&(this.loadItemQueue--,this.loadElementList())}.bind(this),e)))},_removeDocument:function(e,t){},_create:function(e){},_openDocument:function(e){},_queryCreateViewNode:function(){},_postCreateViewNode:function(e){},_queryCreateViewHead:function(){},_postCreateViewHead:function(e){}}),MWF.xApplication.Execution.WorkGather.WorkReportDocument=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexDocument,_queryCreateDocumentNode:function(e){},_postCreateDocumentNode:function(e,t){t.tabName==this.view.lp.gatherName.drafter?cols=5:t.tabName==this.view.lp.gatherName.manager?cols=6:t.tabName==this.view.lp.gatherName.leader&&(cols=7),t.reports&&t.reports.each(function(e,i){this.view.explorer.reportDataArr.push(e);var n=new Element("tr.trNodeTitle",{styles:this.view.css.trNodeTitle}).inject(this.view.viewNode),o=new Element("td.tdNodeTitle",{styles:this.view.css.tdNodeTitle,html:e.title+"&nbsp;&nbsp;&nbsp;&nbsp;("+e.createTime+")",colspan:cols}).inject(n).addEvents({click:function(){this.view.explorer.openWorkReport(e.id,e.workId)}.bind(this)});if(n=new Element("tr.trNode",{styles:this.view.css.trNode}).inject(this.view.viewNode),o=new Element("td.tdNodeContent",{styles:this.view.css.tdNodeContent}).inject(n),divNode=new Element("div.divNode",{styles:this.view.css.divNode,text:e.workInfo.shortProgressAction?e.workInfo.shortProgressAction:"",title:e.workInfo.shortProgressAction?e.workInfo.shortProgressAction:""}).inject(o),t.tabName==this.view.lp.gatherName.drafter){o=new Element("td.tdNodeContent",{styles:this.view.css.tdNodeContent}).inject(n);new Element("textarea.tetareaNode",{styles:this.view.css.textareaNode,id:"progress"+e.id,value:e.progressDescription}).inject(o);o=new Element("td.tdNodeContent",{styles:this.view.css.tdNodeContent}).inject(n);new Element("textarea.tetareaNode",{styles:this.view.css.textareaNode,id:"plan"+e.id,value:e.workPlan}).inject(o);o=new Element("td.tdNodeContent",{styles:this.view.css.tdNodeContent}).inject(n);var s=new Element("div.completeSelectDiv",{styles:this.css.completeSelectDiv}).inject(o),r=new Element("select.completeSelect",{styles:this.css.completeSelect,id:"completeSelect"+e.id,position:i}).inject(s);new Element("option.completeSelectOption",{text:this.lp.isCompletedNoOption,value:"no"}).inject(r);new Element("option.completeSelectOption",{text:this.lp.isCompletedYesOption,value:"yes"}).inject(r);var a=this;r.addEvents({change:function(){if("yes"==this.get("value")){var e=this.get("position");a.view.explorer.gatherContentDiv.getElements(".completePercentSelect[position="+e+"]").set("value","100")}}}),r.set("value",e.isWorkCompleted?"yes":"no"),s=new Element("div.completeSelectDiv",{styles:this.css.completeSelectDiv}).inject(o);var l=new Element("select.completePercentSelect",{styles:this.css.completeSelect,id:"completePercentSelect"+e.id,position:i}).inject(s);new Element("option.completePercentSelectOption",{text:"0%",value:"0"}).inject(l);new Element("option.completePercentSelectOption",{text:"10%",value:"10"}).inject(l),new Element("option.completePercentSelectOption",{text:"20%",value:"20"}).inject(l),new Element("option.completePercentSelectOption",{text:"30%",value:"30"}).inject(l),new Element("option.completePercentSelectOption",{text:"40%",value:"40"}).inject(l),new Element("option.completePercentSelectOption",{text:"50%",value:"50"}).inject(l),new Element("option.completePercentSelectOption",{text:"60%",value:"60"}).inject(l),new Element("option.completePercentSelectOption",{text:"70%",value:"70"}).inject(l),new Element("option.completePercentSelectOption",{text:"80%",value:"80"}).inject(l),new Element("option.completePercentSelectOption",{text:"90%",value:"90"}).inject(l),new Element("option.completePercentSelectOption",{text:"100%",value:"100"}).inject(l),l.set("value",parseInt(e.progressPercent))}else if(t.tabName==this.view.lp.gatherName.manager){o=new Element("td.tdNodeContent",{styles:this.view.css.tdNodeContent}).inject(n),divNode=new Element("div.divNode",{styles:this.view.css.divNode,text:e.progressDescription,title:e.progressDescription}).inject(o),o=new Element("td.tdNodeContent",{styles:this.view.css.tdNodeContent}).inject(n),divNode=new Element("div.divNode",{styles:this.view.css.divNode,text:e.workPlan,title:e.workPlan}).inject(o),o=new Element("td.tdNodeContent",{styles:this.view.css.tdNodeContent}).inject(n);s=new Element("div.completeSelectDiv",{styles:this.css.completeSelectDiv}).inject(o),r=new Element("select.completeSelect",{styles:this.css.completeSelect,id:"completeSelect"+e.id,position:i}).inject(s),new Element("option.completeSelectOption",{text:this.lp.isCompletedNoOption,value:"no"}).inject(r);new Element("option.completeSelectOption",{text:this.lp.isCompletedYesOption,value:"yes"}).inject(r);a=this;r.addEvents({change:function(){if("yes"==this.get("value")){var e=this.get("position");a.view.explorer.gatherContentDiv.getElements(".completePercentSelect[position="+e+"]").set("value","100")}}}),r.set("value",e.isWorkCompleted?"yes":"no"),s=new Element("div.completeSelectDiv",{styles:this.css.completeSelectDiv}).inject(o);l=new Element("select.completePercentSelect",{styles:this.css.completeSelect,id:"completePercentSelect"+e.id,position:i}).inject(s),new Element("option.completePercentSelectOption",{text:"0%",value:"0"}).inject(l);new Element("option.completePercentSelectOption",{text:"10%",value:"10"}).inject(l),new Element("option.completePercentSelectOption",{text:"20%",value:"20"}).inject(l),new Element("option.completePercentSelectOption",{text:"30%",value:"30"}).inject(l),new Element("option.completePercentSelectOption",{text:"40%",value:"40"}).inject(l),new Element("option.completePercentSelectOption",{text:"50%",value:"50"}).inject(l),new Element("option.completePercentSelectOption",{text:"60%",value:"60"}).inject(l),new Element("option.completePercentSelectOption",{text:"70%",value:"70"}).inject(l),new Element("option.completePercentSelectOption",{text:"80%",value:"80"}).inject(l),new Element("option.completePercentSelectOption",{text:"90%",value:"90"}).inject(l),new Element("option.completePercentSelectOption",{text:"100%",value:"100"}).inject(l),l.set("value",parseInt(e.progressPercent)),o=new Element("td.tdNodeContent",{styles:this.view.css.tdNodeContent}).inject(n);new Element("textarea.tetareaNode",{styles:this.view.css.textareaNode,id:"admin"+e.id,value:e.adminSuperviseInfo}).inject(o)}else if(t.tabName==this.view.lp.gatherName.leader){o=new Element("td.tdNodeContent",{styles:this.view.css.tdNodeContent}).inject(n),divNode=new Element("div.divNode",{styles:this.view.css.divNode,text:e.progressDescription,title:e.progressDescription}).inject(o),o=new Element("td.tdNodeContent",{styles:this.view.css.tdNodeContent}).inject(n),divNode=new Element("div.divNode",{styles:this.view.css.divNode,text:e.workPlan,title:e.workPlan}).inject(o),o=new Element("td.tdNodeContent",{styles:this.view.css.tdNodeContent}).inject(n),divNode=new Element("div.divNode",{styles:this.view.css.divNode,text:e.isWorkCompleted?"是":"否"}).inject(o);new Element("div.percentComplete",{text:"完成率:"+e.progressPercent+"%"}).inject(divNode);o=new Element("td.tdNodeContent",{styles:this.view.css.tdNodeContent}).inject(n),divNode=new Element("div.divNode",{styles:this.view.css.divNode,text:e.adminSuperviseInfo,title:e.adminSuperviseInfo}).inject(o),o=new Element("td.tdNodeContent",{styles:this.view.css.tdNodeContent}).inject(n);new Element("textarea.tetareaNode",{styles:this.view.css.textareaNode,id:"opinion"+e.id,value:this.lp.leaderDefaultOpinion}).inject(o)}var c=new Element("td.tdNodeAction",{styles:this.view.css.tdNodeAction}).inject(n);new Element("a.actionTxt",{styles:this.view.css.actionTxt,text:this.view.lp.viewSubmit}).inject(c).addEvents({click:function(t){this.view.explorer.submit(e,t)}.bind(this)})}.bind(this))}});