MWF.xDesktop.requireApp("Attendance","Explorer",null,!1),MWF.xDesktop.requireApp("Template","MPopupForm",null,!1),MWF.xDesktop.requireApp("Template","MDomItem",null,!1),MWF.xDesktop.requireApp("Selector","package",null,!1),MWF.xApplication.Attendance.ImportExplorer=new Class({Extends:MWF.xApplication.Attendance.Explorer,Implements:[Options,Events],initialize:function(e,t,s,i){this.setOptions(i),this.app=t,this.path="../x_component_Attendance/$ImportExplorer/",this.cssPath="../x_component_Attendance/$ImportExplorer/"+this.options.style+"/css.wcss",this._loadCss(),this.actions=s,this.node=$(e),this.initData(),this.personActions||(this.personActions=new MWF.xAction.org.express.RestActions)},loadView:function(){this.view=new MWF.xApplication.Attendance.ImportExplorer.View(this.elementContentNode,this.app,this,this.viewData,this.options.searchKey),this.view.load(),this.setContentSize()},createDocument:function(){this.view&&this.view._createDocument()},importExcel:function(){this.upload()},upload:function(){if(!this.uploadFileAreaNode){this.uploadFileAreaNode=new Element("div");this.uploadFileAreaNode.set("html",'<input name="file" type="file"/>'),this.fileUploadNode=this.uploadFileAreaNode.getFirst(),this.fileUploadNode.addEvent("change",function(){var t=e.files;if(t.length)for(var s=0;s<t.length;s++){var i=t.item(s),n=i.name.split(".");if(this.uploadFileName=i.name,"xls"!=n[n.length-1].toLowerCase()&&"xlsx"!=n[n.length-1].toLowerCase())return void this.app.notice("请导入excel文件！","error");var o=new FormData;o.append("file",i),this.actions.uploadAttachment(function(e){var t=e.id;this.actions.getAttachmentInfo(t,function(e){new MWF.xApplication.Attendance.ImportExplorer.Progress(t,this.actions).load(function(){new MWF.xApplication.Attendance.ImportExplorer.Result(this,e.data,{id:t},{app:this.app,actions:this.app.restActions,css:{}}).open(),this.view.reload()}.bind(this))}.bind(this))}.bind(this),function(e,t,s){var i=s;e&&(i=e.responseText),this.app.notice(i,"error")}.bind(this),o,i)}}.bind(this))}var e=this.uploadFileAreaNode.getFirst();e.click()},checkData:function(){new MWF.xApplication.Attendance.ImportExplorer.YearMonthSelctor(this).edit()},analyseData:function(){this.actions.analyseDetail("0","0",function(){this.app.notice("分析考勤数据成功","success")}.bind(this))},staticData:function(){this.actions.staticAllDetail(function(){this.app.notice("统计考勤数据成功","success")}.bind(this))},downloadTemplate:function(){window.open(o2.filterUrl(this.path+encodeURIComponent("dataTemplate.xls"),"_blank"))},showDescription:function(e){if(this.descriptionNode)this.descriptionNode.setStyle("display","block"),this.descriptionNode.position({relativeTo:e,position:"bottomLeft",edge:"upperCenter",offset:{x:-60,y:0}});else{this.descriptionNode=new Element("div",{styles:this.css.descriptionNode}).inject(this.node),this.descriptionNode.position({relativeTo:e,position:"bottomLeft",edge:"upperCenter",offset:{x:-60,y:0}}),this.descriptionNode.addEvent("mousedown",(function(e){e.stopPropagation()})),document.body.addEvent("mousedown",function(){this.descriptionNode.setStyle("display","none")}.bind(this));var t=new Element("table",{width:"100%",border:"0",cellpadding:"5",cellspacing:"0",styles:this.css.filterTable,class:"filterTable"}).inject(this.descriptionNode),s=new Element("tr").inject(t);new Element("td",{text:"数据导入步骤",styles:this.css.descriptionTdHead}).inject(s);s=new Element("tr").inject(t);new Element("td",{text:"1、下载Excel模板，根据模板格式填写考勤数据；",styles:this.css.descriptionTdValue}).inject(s);s=new Element("tr").inject(t);new Element("td",{text:"2、点击导入考勤数据按钮，选择考勤数据并确定，系统将校验考勤数据是否正确并导入数据；",styles:this.css.descriptionTdValue}).inject(s);s=new Element("tr").inject(t);new Element("td",{text:"3、点击核对考勤数据按钮，选择需要核对的年度和月份，系统将核对需要考勤的人员的数据；",styles:this.css.descriptionTdValue}).inject(s);s=new Element("tr").inject(t);new Element("td",{text:"4、点击分析考勤数据按钮，系统将生成出勤明细数据；",styles:this.css.descriptionTdValue}).inject(s);s=new Element("tr").inject(t);new Element("td",{text:"5、点击统计考勤数据按钮，系统将生成个人、部门、公司的出勤率统计。",styles:this.css.descriptionTdValue}).inject(s)}}}),MWF.xApplication.Attendance.ImportExplorer.View=new Class({Extends:MWF.xApplication.Attendance.Explorer.View,_createItem:function(e){return new MWF.xApplication.Attendance.ImportExplorer.Document(this.table,e,this.explorer,this)},_getCurrentPageData:function(e,t){this.actions.listAttachmentInfo((function(t){e&&e(t)}))},_removeDocument:function(e,t){this.actions.deleteAttachment(e.id,function(e){this.explorer.view.reload(),this.app.notice(this.app.lp.deleteDocumentOK,"success")}.bind(this))},_createDocument:function(){},_openDocument:function(e){this.actions.getAttachmentStream(e.id)}}),MWF.xApplication.Attendance.ImportExplorer.Document=new Class({Extends:MWF.xApplication.Attendance.Explorer.Document,openVaild:function(e){},openResult:function(){new MWF.xApplication.Attendance.ImportExplorer.Result(this,this.data,{id:this.data.id},{app:this.app,actions:this.app.restActions,css:{}}).open()}}),MWF.xApplication.Attendance.ImportExplorer.YearMonthSelctor=new Class({Extends:MPopupForm,options:{style:"attendance",width:500,height:300,hasTop:!0,hasBottom:!0,title:"选择核对月份",draggable:!0,closeAction:!0,false:!0},_createTableContent:function(){this.formTableContainer.setStyles({width:"300px"});this.formTableArea.set("html","<table width='100%' bordr='0' cellpadding='5' cellspacing='0' styles='formTable'><tr><td styles='formTabelTitle' lable='cycleYear'></td>    <td styles='formTableValue' item='cycleYear'></td></tr><tr><td styles='formTabelTitle' lable='cycleMonth'></td>    <td styles='formTableValue' item='cycleMonth'></td></tr></table>"),MWF.xDesktop.requireApp("Template","MForm",function(){this.form=new MForm(this.formTableArea,{},{isEdited:this.isEdited||this.isNew,itemTemplate:{cycleYear:{text:"年度",type:"select",selectValue:function(){var e=[];d=new Date;for(var t=0;t<5;t++)e.push(d.getFullYear()),d.setFullYear(d.getFullYear()-1);return e}},cycleMonth:{text:"月份",type:"select",defaultValue:function(){return(new Date).getMonth()},selectValue:["1","2","3","4","5","6","7","8","9","10","11","12"]}}},this.app),this.form.load()}.bind(this),!0)},_ok:function(e,t){this.app.restActions.checkDetail(e.cycleYear,e.cycleMonth,function(e){this.app.notice("考勤数据核对成功"),this.close()}.bind(this))}}),MWF.xApplication.Attendance.ImportExplorer.Result=new Class({Extends:MPopupForm,options:{style:"attendance",width:800,height:600,hasTop:!0,hasBottom:!1,title:"考勤数据导入结果",draggable:!0,closeAction:!0,hasScroll:!0,closeByClickMask:!0,id:""},_createTableContent:function(){this.actions.getImportStatusDetail(this.options.id,function(e){this.checkData=e.data,this.createImportContent()}.bind(this))},createImportContent:function(){if(0==this.checkData.errorCount)var e="您上传的文件:“"+this.data.fileName+"”已经成功导入。下面显示其中的"+this.checkData.detailList.length+"条：";else e="您上传的文件:“"+this.data.fileName+"”未通过校验，有"+this.checkData.errorCount+"条错误数据。请修改后重新导入。下面显示其中的"+this.checkData.detailList.length+"条：";this.formDescriptionNode=new Element("div",{styles:this.css.formDescriptionNode,text:e}).inject(this.formTableArea);var t=new Element("table",{width:"100%",border:"",cellpadding:"5",cellspacing:"0",styles:this.css.editTable,class:"editTable"}).inject(this.formTableArea),s=new Element("tr").inject(t);new Element("td",{styles:this.css.editTableTitle,text:"行号"}).inject(s),new Element("td",{styles:this.css.editTableTitle,text:"员工号"}).inject(s),new Element("td",{styles:this.css.editTableTitle,text:"员工名字"}).inject(s),new Element("td",{styles:this.css.editTableTitle,text:"日期"}).inject(s),new Element("td",{styles:this.css.editTableTitle,text:"上午上班打卡时间"}).inject(s),new Element("td",{styles:this.css.editTableTitle,text:"上午下班打卡时间"}).inject(s),new Element("td",{styles:this.css.editTableTitle,text:"下午上班打卡时间"}).inject(s),new Element("td",{styles:this.css.editTableTitle,text:"下午下班打卡时间"}).inject(s),new Element("td",{styles:this.css.editTableTitle,text:"检查结果"}).inject(s);new Element("td",{styles:this.css.editTableTitle,text:"描述"}).inject(s).setStyle("width","300px"),this.checkData.detailList.each(function(e){var s=new Element("tr").inject(t);new Element("td",{styles:this.css.editTableValue,text:e.curRow}).inject(s),new Element("td",{styles:this.css.editTableValue,text:e.employeeNo}).inject(s),new Element("td",{styles:this.css.editTableValue,text:e.employeeName.split("@")[0]}).inject(s),new Element("td",{styles:this.css.editTableValue,text:e.recordDateString}).inject(s),new Element("td",{styles:this.css.editTableValue,text:e.onDutyTime}).inject(s),new Element("td",{styles:this.css.editTableValue,text:e.morningOffDutyTime}).inject(s),new Element("td",{styles:this.css.editTableValue,text:e.afternoonOnDutyTime}).inject(s),new Element("td",{styles:this.css.editTableValue,text:e.offDutyTime}).inject(s),new Element("td",{styles:this.css.editTableValue,text:"error"==e.checkStatus?"错误":"正确"}).inject(s),new Element("td",{styles:this.css.editTableValue,text:e.description}).inject(s)}.bind(this))}}),MWF.xApplication.Attendance.ImportExplorer.Progress=new Class({initialize:function(e,t){this.id=e,this.actions=t},load:function(e){this.currentDate=new Date,this.addFormDataMessage(),this.status="ready",this.intervalId=setInterval(function(){this.actions.getImportStatus(this.id,function(t){var s=t.data;s.processing&&"COMPLETE"!=s.currentProcessName?"VALIDATE"==s.currentProcessName?(this.status!=s.currentProcessName&&(this.setMessageTitle("正在检查数据"),this.setMessageText("开始检查数据，共"+s.process_validate_total+"条"),this.status=s.currentProcessName),this.updateProgress(s.currentProcessName,s.process_validate_count,s.process_validate_total,s.errorCount)):"SAVEDATA"==s.currentProcessName&&(this.status!=s.currentProcessName&&(this.setMessageTitle("正在导入数据"),this.setMessageText("开始导入数据，共"+s.process_save_total+"条"),this.status=s.currentProcessName),this.updateProgress(s.currentProcessName,s.process_save_count,s.process_save_total,s.errorCount)):(this.status=s.currentProcessName,clearInterval(this.intervalId),this.transferComplete(s),e&&e())}.bind(this),null)}.bind(this),500)},addFormDataMessage:function(e){var t={subject:"准备导入数据",content:e?'<div style="height: 20px; line-height: 20px">正在准备导入数据...</div></div>':'<div style="overflow: hidden"><div style="height: 3px; border:1px solid #999; margin: 3px 0px"><div style="height: 3px; background-color: #acdab9; width: 0px;"></div></div><div style="height: 20px; line-height: 20px">正在准备导入数据...</div></div>'};this.messageItem=layout.desktop.message.addMessage(t),this.messageItem.status="ready",window.setTimeout(function(){layout.desktop.message.isShow||layout.desktop.message.show()}.bind(this),100)},updateProgress:function(e,t,s,i){var n=this.messageItem,o=i?t+i:t,a=o/s*100,l=new Date,r=this.lastTime||this.currentDate,c=l.getTime()-r.getTime(),d=1e3*(o-(this.lastProcessed||0))/c;if(d=d.round(2),n.contentNode){var h=n.contentNode.getFirst("div").getFirst("div").getFirst("div"),p=n.contentNode.getFirst("div").getLast("div");if(h.setStyle("width",a+"%"),"VALIDATE"==e){var m="正检查数据: "+d+"条/秒,共"+s+"条,剩余"+(s-t)+"条";m+=i?",出错"+i+"条":""}else{m="正导入数据: "+d+"条/秒,共"+s+"条,剩余"+(s-t)+"条";m+=i?",出错"+i+"条":""}p.set("text",m)}this.lastProcessed=o,this.lastTime=new Date},transferComplete:function(e){var t=e.errorCount,s=(this.messageItem,(new Date).getTime()-this.currentDate.getTime()),i="";if(s>36e5){var n=s%36e5,o=n/6e4,a=n%6e4/1e3;i=(s/36e5).toInt()+"小时"+o.toInt()+"分"+a.toInt()+"秒"}else if(s>6e4){a=s%6e4/1e3;i=(o=s/6e4).toInt()+"分"+a.toInt()+"秒"}else{i=(a=s/1e3).toInt()+"秒"}if(0==t){var l=1e3*(r=e.process_save_total)/s;l=l.round(2),this.setMessageTitle("导入成功"),this.setMessageText("共导入数据"+r+"条  速度: "+l+"条/秒  耗时: "+i)}else{var r=e.process_validate_total;this.setMessageTitle("导入失败"),this.setMessageText("共有数据"+r+"条  出错"+t+"条  耗时: "+i+"  请修改后重新导入")}this.clearMessageProgress()},setMessageText:function(e){this.getProgessNode().getFirst("div");this.getProgressInforNode().set("text",e),this.messageItem.dateNode.set("text",(new Date).format("db"))},setMessageTitle:function(e){this.messageItem.subjectNode.set("text",e)},clearMessageProgress:function(){this.getProgessNode().destroy()},getProgessNode:function(){return this.progressNode||(this.progressNode=this.messageItem.contentNode.getFirst("div").getFirst("div")),this.progressNode},getProgressInforNode:function(){return this.progressInforNode||(this.progressInforNode=this.messageItem.contentNode.getFirst("div").getLast("div")),this.progressInforNode}});