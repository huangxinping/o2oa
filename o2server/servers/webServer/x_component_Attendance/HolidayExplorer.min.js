MWF.xDesktop.requireApp("Attendance","Explorer",null,!1),MWF.xDesktop.requireApp("Template","MDomItem",null,!1),MWF.xApplication.Attendance.HolidayExplorer=new Class({Extends:MWF.xApplication.Attendance.Explorer,Implements:[Options,Events],initialize:function(t,e,i,a){this.setOptions(a),this.app=e,this.path="../x_component_Attendance/$HolidayExplorer/",this.cssPath="../x_component_Attendance/$HolidayExplorer/"+this.options.style+"/css.wcss",this._loadCss(),this.actions=i,this.node=$(t),this.initData(),this.personActions||(this.personActions=new MWF.xAction.org.express.RestActions)},loadView:function(){this.view=new MWF.xApplication.Attendance.HolidayExplorer.View(this.elementContentNode,this.app,this,this.viewData,this.options.searchKey),this.view.load(),this.setContentSize()},createDocument:function(){this.view&&this.view._createDocument()}}),MWF.xApplication.Attendance.HolidayExplorer.View=new Class({Extends:MWF.xApplication.Attendance.Explorer.View,_createItem:function(t){return new MWF.xApplication.Attendance.HolidayExplorer.Document(this.table,t,this.explorer,this)},_getCurrentPageData:function(t,e){this.actions.listHolidayAll((function(e){t&&t(e)}))},_removeDocument:function(t,e,i){this.actions.listHolidayByYearAndName(t.configYear,t.configName,function(t){t.data.each(function(t){this.actions.deleteHoliday(t.id,function(t){}.bind(this),null,!1)}.bind(this)),e||this.app.notice(this.app.lp.deleteDocumentOK,"success"),i&&i(),this.explorer.reload()}.bind(this))},_createDocument:function(){new MWF.xApplication.Attendance.HolidayExplorer.Holiday(this.explorer).create()},_openDocument:function(t){this.actions.getHoliday(t.id,function(t){var e=t.data,i={configYear:e.configYear,configName:e.configName,makeUpClassDay:[]};this.actions.listHolidayByYearAndName(e.configYear,e.configName,function(t){var e,a;t.data.each(function(t){"Workday"==t.configType?i.makeUpClassDay.push(t.configDate):(e?new Date(e)>new Date(t.configDate)&&(e=t.configDate):e=t.configDate,a?new Date(a)<new Date(t.configDate)&&(a=t.configDate):a=t.configDate)}.bind(this)),i.startDate=e,i.endDate=a,new MWF.xApplication.Attendance.HolidayExplorer.Holiday(this.explorer,i).edit()}.bind(this))}.bind(this))}}),MWF.xApplication.Attendance.HolidayExplorer.Document=new Class({Extends:MWF.xApplication.Attendance.Explorer.Document}),MWF.xApplication.Attendance.HolidayExplorer.Holiday=new Class({Extends:MWF.widget.Common,options:{width:"500",height:"600"},initialize:function(t,e){this.explorer=t,this.app=t.app,this.data=e||{},this.css=this.explorer.css,this.load()},load:function(){},open:function(t){this.isNew=!1,this.isEdited=!1,this._open()},create:function(){this.isNew=!0,this._open()},edit:function(){this.isEdited=!0,this._open()},_open:function(){this.createMarkNode=new Element("div",{styles:this.css.createMarkNode,events:{mouseover:function(t){t.stopPropagation()},mouseout:function(t){t.stopPropagation()}}}).inject(this.app.content,"after"),this.createAreaNode=new Element("div",{styles:this.css.createAreaNode}),this.createNode(),this.createAreaNode.inject(this.createMarkNode,"after"),this.createAreaNode.fade("in"),this.setCreateNodeSize(),this.setCreateNodeSizeFun=this.setCreateNodeSize.bind(this),this.addEvent("resize",this.setCreateNodeSizeFun)},createNode:function(){var t=this;this.createNode=new Element("div",{styles:this.css.createNode}).inject(this.createAreaNode),this.createNode.setStyle("overflow-y","auto"),this.createIconNode=new Element("div",{styles:this.isNew?this.css.createNewNode:this.css.createIconNode}).inject(this.createNode),this.createFormNode=new Element("div",{styles:this.css.createFormNode}).inject(this.createNode);var e=this.app.lp.holiday,i="width: 99%; border:1px solid #999; background-color:#FFF; border-radius: 3px; box-shadow: 0px 0px 6px #CCC;height: 26px;background : url(../x_component_Attendance/$HolidayExplorer/default/icon/calendar.png) 98% center no-repeat",a="";this.data&&this.data.makeUpClassDay?this.data.makeUpClassDay.each(function(t,e){a+="<input type='text' class='makeUpClassDay' style='"+i+"' value='"+(t||"")+"'/>",e>0&&(a+="<div class='removeMakeUpClassDay' style='color: #354f67;padding-bottom: 5px;cursor: pointer;'>删除</div>")}.bind(this)):a+="<input type='text' class='makeUpClassDay' style='"+i+"' value=''/>";var s="<table width='100%' height='200' border='0' cellPadding='3' cellSpacing='0'><tr><td colspan='2' style='height: 50px; line-height: 50px; text-align: center; min-width: 80px; font-size:18px;font-weight: bold;'>"+e.setHoliday+"</td></tr><tr><td style='height: 30px; line-height: 30px; text-align: left; min-width: 80px; width:25%'>"+e.year+":</td><td style='; text-align: left;' id='yearArea'></td></tr><tr><td style='height: 30px; line-height: 30px; text-align: left'>"+e.name+":</td><td style='; text-align: right;'>"+(this.isNew||this.isEdited?"<input type='text' id='configName' style='width: 99%; border:1px solid #999; background-color:#FFF; border-radius: 3px; box-shadow: 0px 0px 6px #CCC;height: 26px;' value='"+(this.data&&this.data.configName?this.data.configName:"")+"'/>":"")+"</td></tr><tr><td style='height: 30px; line-height: 30px;  text-align: left'>"+e.startDate+":</td><td style='; text-align: right;'>"+(this.isNew||this.isEdited?"<input type='text' id='startDate' style='"+i+"' value='"+(this.data&&this.data.startDate?this.data.startDate:"")+"'/>":"")+"</td></tr><tr><td style='height: 30px; line-height: 30px;  text-align: left'>"+e.endDate+":</td><td style='; text-align: right;'>"+(this.isNew||this.isEdited?"<input type='text' id='endDate' style='"+i+"' value='"+(this.data&&this.data.endDate?this.data.endDate:"")+"'/>":"")+"</td></tr><tr><td valign='top' style='height: 30px; line-height: 30px;  text-align: left'>"+e.makeUpClassDay+":</td><td style='; text-align: right;' id='makeUpClassDayTd'>"+(this.isNew||this.isEdited?a:"")+(this.isNew||this.isEdited?"<div id='addMakeupClass' style='color: #354f67;cursor: pointer;'>增加补班日期</div>":"")+"</td></tr></table>";this.createFormNode.set("html",s),this.yearArea=this.createFormNode.getElement("#yearArea"),this.configYear=new MDomItem(this.yearArea,{name:"configYear",type:"select",value:this.data.configYear||(new Date).getFullYear(),selectValue:function(){for(var t=[],e=(new Date).getFullYear()+5,i=0;i<11;i++)t.push(e--);return t}},!0,this.app),this.configYear.load(),this.configName=this.createFormNode.getElement("#configName"),this.startDate=this.createFormNode.getElement("#startDate"),this.endDate=this.createFormNode.getElement("#endDate"),this.makeUpClassDay=this.createFormNode.getElements(".makeUpClassDay"),this.removeMakeUpClassDay=this.createFormNode.getElements(".removeMakeUpClassDay"),this.addMakeupClass=this.createFormNode.getElement("#addMakeupClass"),this.makeUpClassDayTd=this.createFormNode.getElement("#makeUpClassDayTd"),this.startDate.addEvent("click",(function(){t.selectCalendar(this)})),this.endDate.addEvent("click",(function(){t.selectCalendar(this)})),this.makeUpClassDay.addEvent("click",(function(){t.selectCalendar(this)})),this.removeMakeUpClassDay.addEvent("click",(function(){var t=this.getPrevious();t&&"input"===t.get("tag")&&t.destroy(),this.destroy()})),this.addMakeupClass.addEvent("click",(function(){new Element("input",{class:"makeUpClassDay",style:i,value:"",events:{click:function(){t.selectCalendar(this)}}}).inject(this,"before"),new Element("div",{class:"removeMakeUpClassDay",style:"color: #354f67;padding-bottom: 5px;cursor: pointer;",text:"删除",events:{click:function(){var t=this.getPrevious();t&&"input"===t.get("tag")&&t.destroy(),this.destroy()}}}).inject(this,"before")})),this.cancelActionNode=new Element("div",{styles:this.css.createCancelActionNode,text:this.app.lp.cancel}).inject(this.createFormNode),this.createOkActionNode=new Element("div",{styles:this.css.createOkActionNode,text:this.app.lp.ok}).inject(this.createFormNode),this.cancelActionNode.addEvent("click",function(t){this.cancelCreate(t)}.bind(this)),this.createOkActionNode.addEvent("click",function(t){this.okCreate(t)}.bind(this))},setCreateNodeSize:function(t,e,i,a){t||(t=this.options&&this.options.width?this.options.width:"50%"),e||(e=this.options&&this.options.height?this.options.height:"50%"),i||(i=this.options&&this.options.top?this.options.top:0),a||(a=this.options&&this.options.left?this.options.left:0);var s=this.app.content.getSize(),n=s.x,o=s.y;"string"==typeof t&&1<t.length&&"%"==t.substr(t.length-1,1)&&(t=parseInt(n*parseInt(t,10)/100,10)),"string"==typeof e&&1<e.length&&"%"==e.substr(e.length-1,1)&&(e=parseInt(o*parseInt(e,10)/100,10)),300>t&&(t=300),220>e&&(e=220),i=i||parseInt((o-e)/2,10),a=a||parseInt((n-t)/2,10),this.createAreaNode.setStyles({width:t+"px",height:e+"px",top:i+"px",left:a+"px"}),this.createNode.setStyles({width:t+"px",height:e+"px"});var r=this.createIconNode?this.createIconNode.getSize():{x:0,y:0},c=this.formTopNode?this.formTopNode.getSize():{x:0,y:0},d=this.formBottomNode?this.formBottomNode.getSize():{x:0,y:0},h=e-r.y-c.y-d.y;this.createFormNode.setStyles({height:h+"px"})},cancelCreate:function(t){var e=this;this.isNew&&this.configName.get("value")?this.app.confirm("warn",t,this.app.lp.create_cancel_title,this.app.lp.create_cancel,"320px","100px",(function(){e.createMarkNode.destroy(),e.createAreaNode.destroy(),this.close()}),(function(){this.close()})):(this.createMarkNode.destroy(),this.createAreaNode.destroy(),delete e)},okCreate:function(t){var e={id:this.data&&this.data.id?this.data.id:this.app.restActions.getUUID(),configYear:this.configYear.get("value"),configName:this.configName.get("value"),startDate:this.startDate.get("value"),endDate:this.endDate.get("value")};if(e.configYear&&e.configName&&e.startDate&&e.endDate){var i=new Date(e.endDate),a=new Date(e.startDate);if(a>i)return void this.app.notice("开始日期不能大于结束日期","error");var s=function(){var t="";this.getDateByRange(a,i).each(function(i){this.app.restActions.saveHoliday({configName:e.configName,configYear:e.configYear,configDate:i,configType:"Holiday"},function(e){"ERROR"==e.type&&(t=e.message)}.bind(this),function(t){!1}.bind(this),!1)}.bind(this)),this.createFormNode.getElements(".makeUpClassDay").each(function(i){i.get("value")&&this.app.restActions.saveHoliday({configName:e.configName,configYear:e.configYear,configDate:this.dateFormat(new Date(i.get("value")),"yyyy-MM-dd"),configType:"Workday"},(function(e){"ERROR"==e.type&&(t=e.message)}),function(t){!1}.bind(this),!1)}.bind(this)),""==t?(this.createMarkNode.destroy(),this.createAreaNode.destroy(),this.explorer.view&&this.explorer.view.reload(),this.app.notice(this.isNew?this.app.lp.createSuccess:this.app.lp.updateSuccess,"success")):this.app.notice(t,"error")}.bind(this);this.isNew?s():this.explorer.view._removeDocument(e,!1,s)}else this.configName.setStyle("border-color","red"),this.configName.focus(),this.app.notice(this.app.lp.holiday.inputValid,"error")},selectCalendar:function(t){MWF.require("MWF.widget.Calendar",function(){new MWF.widget.Calendar(t,{style:"xform",isTime:!1,target:this.app.content}).show()}.bind(this))},getDateByRange:function(t,e){for(var i=[];t<=e;)i.push(this.dateFormat(t,"yyyy-MM-dd")),t.setDate(t.getDate()+1);return i},dateFormat:function(t,e){var i={"M+":t.getMonth()+1,"d+":t.getDate(),"h+":t.getHours(),"m+":t.getMinutes(),"s+":t.getSeconds(),"q+":Math.floor((t.getMonth()+3)/3),S:t.getMilliseconds()};for(var a in/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(t.getFullYear()+"").substr(4-RegExp.$1.length))),i)new RegExp("("+a+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?i[a]:("00"+i[a]).substr((""+i[a]).length)));return e}});