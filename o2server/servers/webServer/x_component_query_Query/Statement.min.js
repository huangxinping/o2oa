MWF.xApplication.query=MWF.xApplication.query||{},MWF.xApplication.query.Query=MWF.xApplication.query.Query||{},MWF.xDesktop.requireApp("query.Query","Viewer",null,!1),MWF.xApplication.query.Query.Statement=MWF.QStatement=new Class({Extends:MWF.QViewer,options:{},initialize:function(t,e,i,s,a){this.setOptions(i),this.path="../x_component_query_Query/$Viewer/",this.cssPath="../x_component_query_Query/$Viewer/"+this.options.style+"/css.wcss",this._loadCss(),this.lp=MWF.xApplication.query.Query.LP,this.app=s,this.container=$(t),this.json=e||{},this.parentMacro=a,this.originalJson=Object.clone(e),this.viewJson=null,this.filterItems=[],this.searchStatus="none",this.items=[],this.selectedItems=[],this.hideColumns=[],this.openColumns=[],this.parameter={},this.gridJson=null,this.options.isload&&this.init(function(){this.load()}.bind(this))},init:function(t){this.json.view?(this.viewJson=JSON.decode(this.json.view),this.statementJson=this.json,this.statementJson.viewJson=this.viewJson,t&&t()):this.getView(t)},loadMacro:function(t){MWF.require("MWF.xScript.Macro",function(){this.Macro=new MWF.Macro.ViewContext(this),t&&t()}.bind(this))},createActionbarNode:function(){if(this.actionbarAreaNode.empty(),("boolean"!==typeOf(this.json.showActionbar)||!0===this.json.showActionbar)&&"boolean"===typeOf(this.viewJson.actionbarHidden)){if(!0===this.viewJson.actionbarHidden||!this.viewJson.actionbarList||!this.viewJson.actionbarList.length)return;this.actionbar=new MWF.xApplication.query.Query.Statement.Actionbar(this.actionbarAreaNode,this.viewJson.actionbarList[0],this,{}),this.actionbar.load()}},_loadPageNode:function(){var t;(this.viewPageAreaNode.empty(),this.paging)?this.paging.reload():(t=this.viewJson.pagingList&&this.viewJson.pagingList.length?this.viewJson.pagingList[0]:{firstPageText:this.lp.firstPage,lastPageText:this.lp.lastPage},this.paging=new MWF.xApplication.query.Query.Statement.Paging(this.viewPageAreaNode,t,this,{}),this.paging.load())},lookup:function(t,e){if(!this.lookuping){this.lookuping=!0;var i=t||{};this.loadParameter(i),this.loadFilter(i),this.currentPage=this.options.defaultPage||1,this.options.defaultPage=null,this.noDataTextNode&&this.noDataTextNode.destroy(),this.loadCurrentPageData(function(t){if(this.count)this.fireEvent("postLoad"),this.lookuping=!1,e&&e(this);else{if(this.viewPageAreaNode.empty(),this.viewJson.noDataText){var i=this.css.noDataTextNode;this.viewJson.viewStyles&&this.viewJson.viewStyles.noDataTextNode&&(i=this.viewJson.viewStyles.noDataTextNode),this.noDataTextNode=new Element("div",{styles:i,text:this.viewJson.noDataText}).inject(this.contentAreaNode)}this.fireEvent("postLoad"),this.lookuping=!1,e&&e(this)}}.bind(this),!0,"all")}},loadFilter:function(t){this.filterList=[],(t.filterList||[]).each(function(t){var e=t.path.replace(/\./g,"_"),i=t.value;"like"===t.comparison||"notLike"===t.comparison?("%"!==i.substr(0,1)&&(i="%"+i),"%"!==i.substr(i.length-1,1)&&(i+="%"),this.parameter[e]=i):("dateTimeValue"===t.formatType||"datetimeValue"===t.formatType?i="{ts '"+i+"'}":"dateValue"===t.formatType?i="{d '"+i+"'}":"timeValue"===t.formatType&&(i="{t '"+i+"'}"),this.parameter[e]=i),t.value=e,this.filterList.push(t)}.bind(this))},loadParameter:function(){this.parameter={};var t=this.json.parameter?Object.clone(this.json.parameter):{};for(var e in(this.viewJson.parameterList||[]).each(function(e){var i=e.value;if(t&&t[e.parameter]&&(i=t[e.parameter],delete t[e.parameter]),"date"===typeOf(i)&&(i=i.format("db")),"script"===e.valueType)i=this.Macro.exec(e.valueScript?e.valueScript.code:"",this);else{var s=layout.user;switch(e.value){case"@person":i=s.distinguishedName;break;case"@identityList":i=s.identityList.map((function(t){return t.distinguishedName}));break;case"@unitList":o2.Actions.load("x_organization_assemble_express").UnitAction.listWithPerson({personList:[s.distinguishedName]},(function(t){i=t.unitList}),null,!1);break;case"@unitAllList":o2.Actions.load("x_organization_assemble_express").UnitAction.listWithIdentitySupNested({personList:[s.distinguishedName]},(function(t){i=t.unitList}),null,!1);break;case"@year":i=(new Date).getFullYear().toString();break;case"@season":var a=(new Date).format("%m");i=["01","02","03"].contains(a)?"1":["04","05","06"].contains(a)?"2":["07","08","09"].contains(a)?"3":"4";break;case"@month":i=(new Date).format("%Y-%m");break;case"@time":i=(new Date).format("db");break;case"@date":i=(new Date).format("%Y-%m-%d")}}"dateTimeValue"===e.formatType||"datetimeValue"===e.formatType?i="{ts '"+i+"'}":"dateValue"===e.formatType?i="{d '"+i+"'}":"timeValue"===e.formatType&&(i="{t '"+i+"'}"),this.parameter[e.parameter]=i}.bind(this)),t){var i=t[e];"date"===typeOf(i)&&(i="{ts '"+i.format("db")+"'}"),this.parameter[e]=i}},loadCurrentPageData:function(t,e,i){if(!this.pageloading){this.pageloading=!0,this.items=[];for(var s=this.currentPage,a={filterList:this.filterList,parameter:this.parameter};this.viewTable.rows.length>1;)this.viewTable.deleteRow(-1);this.loadViewRes=o2.Actions.load("x_query_assemble_surface").StatementAction.executeV2(this.options.statementId||this.options.statementName||this.json.statementId||this.json.statementName,i||"data",s,this.json.pageSize,a,function(e){if(("all"===i||"count"===i)&&"number"===typeOf(e.count)){this.count=e.count;var s=this.count/this.json.pageSize;this.pages=s.toInt()<s?s.toInt()+1:s}this.gridJson=e.data,this.setSelectedableFlag(),this.fireEvent("postLoadPageData"),this.loadData(),this.gridJson.length&&this._loadPageNode(),this.loadingAreaNode&&(this.loadingAreaNode.destroy(),this.loadingAreaNode=null),this.pageloading=!1,this.fireEvent("loadView"),this.fireEvent("postLoadPage"),t&&t(e)}.bind(this),null,!1!==e)}},getView:function(t){this.getViewRes=o2.Actions.load("x_query_assemble_surface").StatementAction.get(this.json.statementId||this.json.statementName,function(e){var i=JSON.decode(e.data.view);this.json.pageSize||(this.json.pageSize=i.pageSize||"20"),this.viewJson=i.data,this.json.application=e.data.query,this.statementJson=e.data,this.statementJson.viewJson=this.viewJson,t&&t()}.bind(this))},loadData:function(){"multi"===this.getSelectFlag()&&this.viewJson.allowSelectAll?this.selectTitleCell&&this.selectTitleCell.retrieve("selectAllLoaded")?this.setUnSelectAllStyle():this.createSelectAllNode():this.selectAllNode&&this.clearSelectAllStyle(),this.gridJson.length?this.gridJson.each(function(t,e){this.items.push(new MWF.xApplication.query.Query.Statement.Item(this,t,null,e))}.bind(this)):this.viewPageAreaNode&&this.viewPageAreaNode.empty()},loadDataByPaging:function(){if(!this.isItemsLoading&&!this.isItemsLoaded){var t=Math.min(this.pageNumber*this.options.perPageCount,this.gridJson.length),e=Math.min((this.pageNumber+1)*this.options.perPageCount+1,this.gridJson.length);this.isItemsLoading=!0;for(var i=t;i<e;i++)this.items.push(new MWF.xApplication.query.Query.Statement.Item(this,this.gridJson[i],null,i));this.isItemsLoading=!1,this.pageNumber++,e==this.gridJson.length&&(this.isItemsLoaded=!0)}},getFilter:function(){var t=[];if("custom"===this.searchStatus&&this.filterItems.length&&this.filterItems.each(function(e){t.push(e.data)}.bind(this)),"default"===this.searchStatus){var e=this.viewSearchInputNode.get("value");e&&e!==this.lp.searchKeywork&&this.viewJson.customFilterList.each(function(i){if("textValue"===i.formatType){var s={path:i.path,value:e,formatType:i.formatType,logic:"or",comparison:"like"};t.push(s)}if("numberValue"===i.formatType){var a=e.toFloat();if(!isNaN(a)){s={path:i.path,value:a,formatType:i.formatType,logic:"or",comparison:"like"};t.push(s)}}}.bind(this))}return t.length?t:null},viewSearchCustomAddToFilter:function(){var t=this.viewSearchCustomPathListNode.selectedIndex,e=this.viewSearchCustomComparisonListNode.selectedIndex;if(-1===t)return MWF.xDesktop.notice("error",{x:"left",y:"top"},this.lp.filterErrorTitle,this.viewSearchCustomPathListNode,{x:0,y:85}),!1;if(-1===e)return MWF.xDesktop.notice("error",{x:"left",y:"top"},this.lp.filterErrorComparison,this.viewSearchCustomComparisonListNode,{x:0,y:85}),!1;var i=this.viewSearchCustomPathListNode.options[t].retrieve("entry");if(i){var s=i.title,a=i.path,n=this.viewSearchCustomComparisonListNode.options[e].get("value"),o=this.viewSearchCustomComparisonListNode.options[e].get("text"),r="";if("script"===i.valueType&&i.valueScript&&i.valueScript.code){if(-1!==(l=this.viewSearchCustomValueNode.selectedIndex)){var h=this.viewSearchCustomValueNode.options[l].get("value");r="booleanValue"===i.formatType?"true"===h:h}}else switch(i.formatType){case"numberValue":case"dateTimeValue":r=this.viewSearchCustomValueNode.get("value");break;case"booleanValue":var l;if(-1!==(l=this.viewSearchCustomValueNode.selectedIndex))r="true"===(h=this.viewSearchCustomValueNode.options[l].get("value"));break;default:r=this.viewSearchCustomValueNode.get("value")}if(""===r)return MWF.xDesktop.notice("error",{x:"left",y:"top"},this.lp.filterErrorValue,this.viewSearchCustomValueContentNode,{x:0,y:85}),!1;this.filterItems.push(new MWF.xApplication.query.Query.Statement.Filter(this,{logic:"and",path:a,title:s,comparison:n,comparisonTitle:o,value:r,formatType:"datetimeValue"==i.formatType?"dateTimeValue":i.formatType},this.viewSearchCustomFilterContentNode)),this.searchCustomView()}},getStatementInfor:function(){return this.statementJson},getPageInfor:function(){return{pages:this.pages,perPageCount:this.json.pageSize,currentPageNumber:this.currentPage}},switchStatement:function(t){this.switchView(t)},setFilter:function(t,e,i){this.lookuping||this.pageloading||(t||(t=[]),e||(e={}),this.json.filter=t,this.json.parameter=e,this.viewAreaNode&&this.createViewNode({filterList:this.json.filter.clone()},i))}}),MWF.xApplication.query.Query.Statement.Item=new Class({Extends:MWF.xApplication.query.Query.Viewer.Item,initialize:function(t,e,i,s,a){this.view=t,this.data=e,this.css=this.view.css,this.isSelected=!1,this.category=a,this.prev=i,this.idx=s,this.clazzType="item",this.load()},load:function(){this.view.fireEvent("queryLoadItemRow",[null,this]);var t=(e=this.view.viewJson.viewStyles)&&e.contentTd?e.contentTd:this.css.viewContentTdNode;this.node=new Element("tr",{styles:e&&e.contentTr?e.contentTr:this.css.viewContentTrNode}),this.prev?this.node.inject(this.prev.node,"after"):this.node.inject(this.view.viewTable),this.selectTd=new Element("td",{styles:t}).inject(this.node),this.selectTd.setStyles({cursor:"pointer"}),this.view.json.itemStyles&&this.selectTd.setStyles(this.view.json.itemStyles);var e,i=this.view.getSelectFlag();if(this.data.$selectedEnable&&["multi","single"].contains(i)&&"always"===this.view.viewJson.selectBoxShow)if(e=this.view.viewJson.viewStyles)"single"===i?this.selectTd.setStyles(e.radioNode):this.selectTd.setStyles(e.checkboxNode);else{var s="checkbox";"single"===i&&(s="radiobox"),this.selectTd.setStyles({background:"url(../x_component_query_Query/$Viewer/default/icon/"+s+".png) center center no-repeat"})}if(this.view.isSelectTdHidden()&&this.selectTd.hide(),"yes"===this.view.viewJson.isSequence){this.sequenceTd=new Element("td",{styles:t}).inject(this.node),this.sequenceTd.setStyle("width","10px");var a=1+this.view.json.pageSize*(this.view.currentPage-1)+this.idx;this.sequenceTd.set("text",a)}Object.each(this.view.entries,function(e,i){if(-1===this.view.hideColumns.indexOf(i)){var s=new Element("td",{styles:t}).inject(this.node),a=this.getText(e,i,s);null==a&&(a="");var n=a;e.isHtml?s.set("html",n):s.set("text",n),"object"===typeOf(e.contentProperties)&&s.setProperties(e.contentProperties),this.view.json.itemStyles&&s.setStyles(this.view.json.itemStyles),"object"===typeOf(e.contentStyles)&&s.setStyles(e.contentStyles),-1!==this.view.openColumns.indexOf(i)&&this.setOpenWork(s,e),Object.each(e.events||{},function(t,i){t.code&&("loadContent"===i?this.view.Macro.fire(t.code,{node:s,json:e,data:n,view:this.view,row:this}):"loadTitle"!==i&&s.addEvent(i,function(i){return this.view.Macro.fire(t.code,{node:s,json:e,data:n,view:this.view,row:this},i)}.bind(this)))}.bind(this))}}.bind(this));var n=this.view.json.defaultSelectedScript||this.view.viewJson.defaultSelectedScript;if(!this.isSelected&&n){var o=this.view.Macro.exec(n,{node:this.node,data:this.data,view:this.view,row:this});if(o)if("multi"===o||"single"===o)this.select(o);else if("true"===o.toString()){var r=this.view.json.select||this.view.viewJson.select||"none";"single"!==r&&"multi"!==r||this.select()}}this.setEvent(),this.view.fireEvent("postLoadItemRow",[null,this])},getDataByPath:function(t,e){for(var i=e.split("."),s=0;s<i.length;s++){var a=i[s];if(/(^[1-9]\d*$)/.test(a)&&(a=a.toInt()),!t[a]){t="";break}t=t[a]}return t},getText:function(t,e,i){var s=t.path,a=t.code,n=this.data;if(!s)return"";"$all"===s||(n=this.getDataByPath(n,s)),a&&a.trim()&&(n=this.view.Macro.exec(a,{value:n,data:this.data,entry:t,node:i,json:t,row:this}));var o,r=function(t){return"array"===typeOf(t)?Array.each(t,(function(e,i){t[i]=r(e)})):"object"===typeOf(t)?Object.each(t,(function(e,i){t[i]=r(e)})):"string"===typeOf(t)&&(t=o2.name.cn(t)),t};return null!=n&&null!=n&&(o="array"===typeOf(n)?t.isName?JSON.stringify(r(Array.clone(n))):JSON.stringify(n):"object"===typeOf(n)?t.isName?JSON.stringify(r(Object.clone(n))):JSON.stringify(n):t.isName?o2.name.cn(n.toString()):n),o},setOpenWork:function(t,e){if(t.setStyle("cursor","pointer"),e.clickCode)this.view.Macro||MWF.require("MWF.xScript.Macro",function(){this.view.businessData={},this.view.Macro=new MWF.Macro.PageContext(this.view)}.bind(this),!1),t.addEvent("click",function(t){var i=this.view.Macro.fire(e.clickCode,this,t);return t.stopPropagation(),i}.bind(this));else if("official"===this.view.statementJson.entityCategory&&e.idPath){var i=this.getDataByPath(this.data,e.idPath);i&&("com.x.cms.core.entity.Document"===this.view.statementJson.entityClassName?t.addEvent("click",function(t){this.openCms(t,i),t.stopPropagation()}.bind(this)):t.addEvent("click",function(t){this.openWork(t,i),t.stopPropagation()}.bind(this)))}},openCms:function(t,e){var i={documentId:e};this.view.fireEvent("openDocument",[i,this]),layout.desktop.openApplication(t,"cms.Document",i)},openWork:function(t,e){var i={workId:e};this.view.fireEvent("openDocument",[i,this]),layout.desktop.openApplication(t,"process.Work",i)}}),MWF.xApplication.query.Query.Statement.Filter=new Class({Extends:MWF.xApplication.query.Query.Viewer.Filter}),MWF.xApplication.query.Query.Statement.Actionbar=new Class({Extends:MWF.xApplication.query.Query.Viewer.Actionbar}),MWF.xApplication.query.Query.Statement.Paging=new Class({Extends:MWF.xApplication.query.Query.Viewer.Paging});