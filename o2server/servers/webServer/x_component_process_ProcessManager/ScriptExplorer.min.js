MWF.xDesktop.requireApp("process.ProcessManager","DictionaryExplorer",null,!1),MWF.xApplication.process.ProcessManager.ScriptExplorer=new Class({Extends:MWF.xApplication.process.ProcessManager.DictionaryExplorer,Implements:[Options,Events],options:{create:MWF.APPPM.LP.script.create,search:MWF.APPPM.LP.script.search,searchText:MWF.APPPM.LP.script.searchText,noElement:MWF.APPPM.LP.script.noScriptNoticeText},keyCopy:function(t){if(this.selectMarkItems.length){var i=[],e=0,a=function(t){if(e>=this.selectMarkItems.length&&i.length){var a=JSON.encode(i);t?t.clipboardData.setData("text/plain",a):window.clipboardData.setData("Text",a),this.app.notice(this.app.lp.copyed,"success")}}.bind(this);this.selectMarkItems.each(function(n){this.app.restActions.getScript(n.data.id,function(n){n.data.elementType="script",i.push(n.data),e++,a(t)}.bind(this),null,!1)}.bind(this)),t&&t.preventDefault()}},keyPaste:function(t){var i="";i=t?t.clipboardData.getData("text/plain"):window.clipboardData.getData("Text");var e=JSON.decode(i);this.pasteItem(e,0)},pasteItem:function(t,i){if(i<t.length){var e=t[i];"script"===e.elementType?this.saveItemAs(e,function(){i++,this.pasteItem(t,i)}.bind(this),function(){i++,this.pasteItem(t,i)}.bind(this),function(){this.reload()}.bind(this)):(i++,this.pasteItem(t,i))}else this.reload()},saveItemAs:function(t,i,e,a){this.app.restActions.listScript(this.app.options.application.id,function(n){var s=n.data.filter((function(i){return i.id===t.id}));if(s.length){var o=s[0],p=this.app.lp,r=this,c=(new Date).parse(t.lastUpdateTime),l=(new Date).parse(o.lastUpdateTime),d="<div>"+p.copyConfirmInfor+"</div>";d+="<div style='overflow: hidden; margin: 10px 0px; padding: 5px 10px; background-color: #ffffff; border-radius: 6px;'><div style='font-weight: bold; font-size:14px;'>"+p.copySource+" "+o.name+"</div>",d+="<div style='font-size:12px; color: #666666; float: left'>"+o.lastUpdateTime+"</div><div style='font-size:12px; color: #666666; float: left; margin-left: 20px;'>"+MWF.name.cn(o.lastUpdatePerson)+"</div><div style='color: red; float: right;'>"+(c>=l?"":p.copynew)+"</div></div>",d+="<div style='overflow: hidden; margin: 10px 0px; padding: 5px 10px; background-color: #ffffff; border-radius: 6px;'><div style='clear: both;font-weight: bold; font-size:14px;'>"+p.copyTarget+" "+t.name+"</div>",d+="<div style='font-size:12px; color: #666666; float: left;'>"+t.lastUpdateTime+"</div><div style='font-size:12px; color: #666666; float: left; margin-left: 20px;'>"+MWF.name.cn(t.lastUpdatePerson)+"</div><div style='color: red; float: right;'>"+(c<=l?"":p.copynew)+"</div></div>",this.app.dlg("inofr",null,this.app.lp.copyConfirmTitle,{html:d},500,290,[{text:p.copyConfirm_overwrite,action:function(){r.saveItemAsUpdate(o,t,i,e),this.close()}},{text:p.copyConfirm_new,action:function(){r.saveItemAsNew(n,t,i,e),this.close()}},{text:p.copyConfirm_skip,action:function(){this.close(),i&&i()}},{text:p.copyConfirm_cancel,action:function(){this.close(),a&&a()}}])}else this.saveItemAsNew(n,t,i,e)}.bind(this),function(){e&&e()}.bind(this))},saveItemAsUpdate:function(t,i,e,a){i.id=t.id,i.name=t.name,i.alias=t.alias,i.isNewScript=!1,i.application=t.application,i.applicationName=t.applicationName,this.app.restActions.saveScript(i,function(){e&&e()}.bind(this),function(){a&&a()}.bind(this))},saveItemAsNew:function(t,i,e,a){for(var n=this.app.options.application,s=n.id,o=n.name,p=i.name,r=1;t.data.some((function(t){return t.name==i.name||t.alias==i.name}));)i.name=p+"_copy"+r,i.alias=p+"_copy"+r,r++;i.id="",i.isNewScript=!0,i.application=s,i.applicationName=o,this.app.restActions.saveScript(i,function(){e&&e()}.bind(this),function(){a&&a()}.bind(this))},_createElement:function(t){var i=this,e={onQueryLoad:function(){this.actions=i.app.restActions,this.application=i.app.options.application||i.app.application,this.explorer=i}};this.app.desktop.openApplication(t,"process.ScriptDesigner",e)},_loadItemDataList:function(t){var i="";this.app.application&&(i=this.app.application.id),this.app.options.application&&(i=this.app.options.application.id),this.actions.listScript(i,t)},_getItemObject:function(t){return new MWF.xApplication.process.ProcessManager.ScriptExplorer.Script(this,t)},setTooltip:function(){this.options.tooltip={create:MWF.APPPM.LP.script.create,search:MWF.APPPM.LP.script.search,searchText:MWF.APPPM.LP.script.searchText,noElement:MWF.APPPM.LP.script.noScriptNoticeText}},deleteItems:function(){for(this.hideDeleteAction();this.deleteMarkItems.length;){var t=this.deleteMarkItems.shift();this.deleteMarkItems.length?t.deleteScript():t.deleteScript(function(){}.bind(this))}}}),MWF.xApplication.process.ProcessManager.ScriptExplorer.Script=new Class({Extends:MWF.xApplication.process.ProcessManager.DictionaryExplorer.Dictionary,_customNodes:function(){this.data.validated||(new Element("div",{styles:this.explorer.css.itemErrorNode}).inject(this.node),this.node.setStyle("background-color","#f9e8e8"))},_open:function(t){var i=this,e={appId:"process.ScriptDesigner"+i.data.id,onQueryLoad:function(){this.actions=i.explorer.actions,this.category=i,this.options.id=i.data.id,this.application=i.explorer.app.options.application,this.explorer=i.explorer}};this.explorer.app.desktop.openApplication(t,"process.ScriptDesigner",e)},_getIcon:function(){return"script.png"},_getLnkPar:function(){return{icon:this.explorer.path+this.explorer.options.style+"/scriptIcon/lnk.png",title:this.data.name,par:'process.ScriptDesigner#{"id": "'+this.data.id+'", "applicationId": "'+this.explorer.app.options.application.id+'"}'}},deleteScript:function(t){this.explorer.app.restActions.deleteScript(this.data.id,function(){this.node.destroy(),t&&t()}.bind(this))},saveItemAs:function(t){var i=t.id,e=t.name;this.explorer.app.restActions.getScript(this.data.id,function(t){var a=t.data,n=a.name;this.explorer.app.restActions.listScript(i,function(t){for(var s=1;t.data.some((function(t){return t.name==a.name||t.alias==a.name}));)a.name=n+"_copy"+s,a.alias=n+"_copy"+s,s++;a.id="",a.isNewScript=!0,a.application=i,a.applicationName=e,this.explorer.app.restActions.saveScript(a,function(){i==this.explorer.app.options.application.id&&this.explorer.reload()}.bind(this))}.bind(this))}.bind(this))}});