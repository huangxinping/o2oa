MWF.xApplication=MWF.xApplication||{},MWF.xApplication.service=MWF.xApplication.service||{},MWF.xApplication.service.InvokeDesigner=MWF.xApplication.service.InvokeDesigner||{},MWF.SRVID=MWF.xApplication.service.InvokeDesigner,MWF.require("MWF.widget.Common",null,!1),MWF.xDesktop.requireApp("service.InvokeDesigner","lp."+MWF.language,null,!1),MWF.require("MWF.widget.JavascriptEditor",null,!1),MWF.xApplication.service.InvokeDesigner.Invoke=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",showTab:!0},initialize:function(e,t,i){this.setOptions(i),this.path="../x_component_service_InvokeDesigner/$Invoke/",this.cssPath="../x_component_service_InvokeDesigner/$Invoke/"+this.options.style+"/css.wcss",this._loadCss(),this.isChanged=!1,this.designer=e,this.data=t,this.data.text||(this.data.text=""),this.node=this.designer.designNode,this.tab=this.designer.invokeTab,this.areaNode=new Element("div",{styles:{overflow:"hidden",height:"700px"}}),this.propertyNode=this.designer.propertyContentArea,this.isNewInvoke=!this.data.id,this.autoSave(),this.designer.addEvent("queryClose",function(){this.autoSaveTimerID&&window.clearInterval(this.autoSaveTimerID)}.bind(this))},autoSave:function(){this.autoSaveTimerID=window.setInterval(function(){this.autoSaveCheckNode||(this.autoSaveCheckNode=this.designer.contentToolbarNode.getElement("#MWFInvokeAutoSaveCheck")),this.autoSaveCheckNode&&this.autoSaveCheckNode.get("checked")&&this.isChanged&&this.saveSilence()}.bind(this),6e4)},load:function(){this.setAreaNodeSize(),this.designer.addEvent("resize",this.setAreaNodeSize.bind(this)),this.page=this.tab.addTab(this.areaNode,this.data.name||this.designer.lp.newInvoke,!this.data.isNewInvoke&&this.data.id!=this.designer.options.id),this.page.invoke=this,this.page.addEvent("show",function(){this.designer.invokeListAreaNode.getChildren().each(function(e){e.retrieve("invoke").id==this.data.id&&(this.designer.currentListInvokeItem&&this.designer.currentListInvokeItem.setStyles(this.designer.css.listInvokeItem),e.setStyles(this.designer.css.listInvokeItem_current),this.designer.currentListInvokeItem=e,this.lisNode=e)}.bind(this)),this.designer.currentScript=this,this.setPropertyContent(),this.editor.editor&&this.editor.editor.focus()}.bind(this)),this.page.addEvent("queryClose",function(){this.autoSaveTimerID&&window.clearInterval(this.autoSaveTimerID),this.lisNode&&this.lisNode.setStyles(this.designer.css.listInvokeItem)}.bind(this)),this.page.tabNode.addEvent("dblclick",this.designer.maxOrReturnEditor.bind(this.designer)),this.editor=new MWF.widget.JavascriptEditor(this.areaNode,{runtime:"service"}),this.editor.load(function(){if(this.data.text)this.editor.editor.setValue(this.data.text);else{"this.entityManager; //实体管理器\n","this.applications; //访问系统内服务\n","this.requestText//请求正文\n","this.request//请求\n","this.currentPerson//当前用户\n","this.response//响应对象。通过this.response.setBody(data)设置响应内容\n","this.organization; //组织访问\n","this.org; //组织快速访问方法\n","this.service; ///webSerivces客户端\n","********************/\n",this.editor.editor.setValue("/********************\nthis.entityManager; //实体管理器\nthis.applications; //访问系统内服务\nthis.requestText//请求正文\nthis.request//请求\nthis.currentPerson//当前用户\nthis.response//响应对象。通过this.response.setBody(data)设置响应内容\nthis.organization; //组织访问\nthis.org; //组织快速访问方法\nthis.service; ///webSerivces客户端\n********************/\n")}this.editor.addEditorEvent("change",function(){this.isChanged||(this.isChanged=!0,this.page.textNode.set("text"," * "+this.page.textNode.get("text")))}.bind(this)),this.editor.addEvent("save",function(){this.save()}.bind(this));for(var e=this.designer.styleSelectNode.options,t=0;t<e.length;t++){if((i=e[t]).value==this.editor.theme){i.set("selected",!0);break}}for(e=this.designer.fontsizeSelectNode.options,t=0;t<e.length;t++){if((i=e[t]).value==this.editor.fontSize){i.set("selected",!0);break}}e=this.designer.editorSelectNode.options;for(t=0;t<e.length;t++){if((i=e[t]).value==this.editor.options.type){i.set("selected",!0);break}}e=this.designer.monacoStyleSelectNode.options;for(t=0;t<e.length;t++){var i;if((i=e[t]).value==this.editor.theme){i.set("selected",!0);break}}"ace"==this.editor.options.type?(this.designer.monacoStyleSelectNode.hide(),this.designer.styleSelectNode.show()):(this.designer.monacoStyleSelectNode.show(),this.designer.styleSelectNode.hide())}.bind(this)),this.options.showTab&&this.page.showTabIm()},showReferenceMenu:function(){var e=this.editor.getCursorPixelPosition(),t={page:{}};t.page.x=e.left,t.page.y=e.top,this.invokeReferenceMenu.menu.showIm(t)},setIncludeNode:function(){this.designer.propertyIncludeListArea.empty(),this.data.dependInvokeList.each(function(e){this.designer.addIncludeToList(e)}.bind(this))},setPropertyContent:function(){this.designer.propertyIdNode.set("text",this.data.id||""),this.designer.propertyNameNode.set("value",this.data.name||""),this.designer.propertyAliasNode.set("value",this.data.alias||""),this.designer.propertyEnableTokenNode.getElement("option[value='"+this.data.enableToken+"']").set("selected",!0),this.designer.propertyEnableNode.getElement("option[value='"+this.data.enable+"']").set("selected",!0),this.designer.propertyRemoteAddrRegexNode.set("value",this.data.remoteAddrRegex||""),this.designer.propertyLastStartTimeNode.set("text",this.data.lastStartTime||""),this.designer.propertyLastEndTimeNode.set("text",this.data.lastEndTime||""),this.designer.propertyDescriptionNode.set("value",this.data.description||""),this.setInvokeUrlText(),this.designer.propertyEnableTokenNode.addEvent("change",this.setInvokeUrlText.bind(this))},setInvokeUrlText:function(){var e=this.designer.actions.action,t=!0;if(this.designer.propertyEnableTokenNode.getElements("option").each((function(e){e.selected&&(t="true"==e.value)})),!0===t)i=(i=e.address+e.actions.executeToken.uri).replace("{flag}",this.data.alias||this.data.name||this.data.id);else{var i=e.address+e.actions.executeInvoke.uri;i=i.replace("{flag}",this.data.alias||this.data.name||this.data.id)}this.designer.propertyInvokeUriNode.set("text",i)},setAreaNodeSize:function(){var e=this.node.getSize(),t=this.tab.tabNodeContainer.getSize(),i=e.y-t.y;this.areaNode.setStyle("height",i+"px"),this.editor&&this.editor.resize(i)},addInclude:function(){},saveInvoke:function(e,t,i){e.isNewInvoke?this.designer.actions.createInvoke(e,t,i):this.designer.actions.updateInvoke(e.id,e,t,i)},save:function(e){if(this.isSave)MWF.xDesktop.notice("info",{x:"right",y:"top"},this.designer.lp.isSave);else{var t=this.editor.validated(),i=this.designer.propertyNameNode.get("value"),s=this.designer.propertyAliasNode.get("value"),n=this.designer.propertyDescriptionNode.get("value"),a=this.designer.propertyRemoteAddrRegexNode.get("value"),o=!0;this.designer.propertyEnableNode.getElements("option").each((function(e){e.selected&&(o="true"==e.value)}));var d=!0;if(this.designer.propertyEnableTokenNode.getElements("option").each((function(e){e.selected&&(d="true"==e.value)})),!i)return this.designer.notice(this.designer.lp.notice.inputName,"error"),!1;this.data.name=i,this.data.alias=s,this.data.description=n,this.data.remoteAddrRegex=a,this.data.validated=t,this.data.text=this.editor.editor.getValue(),this.data.enable=o,this.data.enableToken=d,this.isSave=!0,this.saveInvoke(this.data,function(t){this.isSave=!1,this.data.isNewInvoke&&(this.data.isNewInvoke=!1),this.isChanged=!1,this.page.textNode.set("text",this.data.name),this.lisNode&&this.lisNode.getLast().set("text",this.data.name),this.designer.notice(this.designer.lp.notice.save_success,"success",this.node,{x:"left",y:"bottom"}),this.data.id=t.data.id,this.designer.propertyIdNode.set("text",this.data.id),this.setInvokeUrlText(),e&&e()}.bind(this),function(e,t,i){this.isSave=!1;var s=i+":"+t;e&&(s=e.responseText),MWF.xDesktop.notice("error",{x:"right",y:"top"},"request json error: "+s)}.bind(this))}},saveSilence:function(e){if(this.isSave)MWF.xDesktop.notice("info",{x:"right",y:"top"},this.designer.lp.isSave);else{for(var t=this.editor.editor.getSession().getAnnotations(),i=!0,s=0;s<t.length;s++)if("error"==t[s].type){i=!1;break}if(this.designer.currentScript==this){var n=this.designer.propertyNameNode.get("value"),a=this.designer.propertyAliasNode.get("value"),o=this.designer.propertyDescriptionNode.get("value"),d=this.designer.propertyRemoteAddrRegexNode.get("value"),r=!0;if(this.designer.propertyEnableNode.getElements("option").each((function(e){e.selected&&(r="true"==e.value)})),!n)return this.designer.notice(this.designer.lp.notice.inputName,"error"),!1;this.data.name=n,this.data.alias=a,this.data.description=o,this.data.remoteAddrRegex=d,this.data.validated=i,this.data.enable=r}this.data.text=this.editor.editor.getValue(),this.isSave=!0,this.saveInvoke(this.data,function(t){this.isSave=!1,this.data.isNewInvoke&&(this.data.isNewInvoke=!1),this.data.isNewInvoke=!1,this.isChanged=!1,this.page.textNode.set("text",this.data.name),this.lisNode&&this.lisNode.getLast().set("text",this.data.name),this.data.id=t.data.id,this.designer.currentScript==this&&(this.designer.propertyIdNode.set("text",this.data.id),this.setInvokeUrlText()),e&&e()}.bind(this),function(e,t,i){this.isSave=!1}.bind(this))}},saveAs:function(){},explode:function(){},implode:function(){}});