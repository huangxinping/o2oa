MWF.xApplication.AppMarketV2.ApplicationsContent=new Class({Implements:[Options,Events],options:{view:"applicationsContent.html"},initialize:function(t,a,n){this.setOptions(n),this.app=t,this.container=a,this.viewPath=this.app.path+this.app.options.style+"/"+this.options.view,this.querydata={},this.currentcategory={name:"全部",count:0},this.load()},load:function(){this.container.loadHtml(this.viewPath,{bind:{lp:this.app.lp},module:this},function(){this.loadApplication(function(){this.fireEvent("load")}.bind(this))}.bind(this))},loadApplication:function(t){this.isLoading||(this.applicationsContentV?this.applicationsContentV.load():this.applicationsContentV=new MWF.xApplication.AppMarketV2.ApplicationsContent.Applications(this,{onLoad:function(){t&&t()}}))},focusAppSearch:function(){this.searchAppNode.addClass("layout_content_taskbar_area_search_box_focus"),this.searchAppNode.addClass("mainColor_border"),this.searchAppIconNode.addClass("icon_search_focus")},blurAppSearch:function(){this.searchAppNode.removeClass("layout_content_taskbar_area_search_box_focus"),this.searchAppNode.removeClass("mainColor_border"),this.searchAppIconNode.removeClass("icon_search_focus")},searchAppInputKeyDown:function(t){this.searchAppInputNode.get("value")?this.searchAppClearNode.addClass("icon_clear"):this.searchAppClearNode.removeClass("icon_clear"),13===t.keyCode&&this.doAppSearch()},clearAppSearch:function(){this.searchAppInputNode.set("value",""),this.searchAppClearNode.removeClass("icon_clear"),this.clearSearchResult()},doAppSearch:function(){var t=this.searchAppInputNode.get("value");t?(this.querydata.name=t,this.applicationsContentV?this.applicationsContentV.load():this.applicationsContentV=new MWF.xApplication.AppMarketV2.ApplicationsContent.Applications(this,{onLoad:function(){callback&&callback()}})):this.clearSearchResult()},clearSearchResult:function(){this.querydata.name="",this.applicationsContentV?this.applicationsContentV.load():this.applicationsContentV=new MWF.xApplication.AppMarketV2.ApplicationsContent.Applications(this,{onLoad:function(){callback&&callback()}})}}),MWF.xApplication.AppMarketV2.ApplicationsContent.Applications=new Class({Implements:[Options,Events],options:{type:"applications"},initialize:function(t,a){this.setOptions(a),this.content=t,this.app=this.content.app,this.actions=this.app.actions,this.container=this.content.container,this.page=1,this.pageSize=100,this.load()},load:function(){this.loadAppCategorys(),this.loadApplications()},loadAppCategorys:function(){this.actions.MarketAction.listCategory(function(t){t.data&&t.data.valueList&&this.showCategorys(t.data.valueList),this.fireEvent("load")}.bind(this))},loadApplications:function(){this.emptyLoadContent(),this.actions.MarketAction.listPaging(this.page,this.pageSize,this.content.querydata,function(t){t.data&&t.data.length&&(this.content.currentcategory.name=""!=this.content.querydata.category&&this.content.querydata.category?this.content.querydata.category:"全部",this.content.currentcategory.count=t.count,this.showApplications(t.data)),this.fireEvent("load")}.bind(this))},reload:function(){this.content.isLoading||(this.loadAppCategorys(),this.loadApplications())},emptyLoadContent:function(){this.content.appList.empty(),this.content.isLoading=!1},showCategorys:function(t){var a=this.content.appCategory;a.empty(),this.loadCertainCategory(a,"全部"),t.each(function(t,n){this.loadCertainCategory(a,t)}.bind(this))},loadCertainCategory:function(t,a){var n=this,i=new Element("span",{text:a,class:"o2_appmarket_appcategory"}).inject(t);i.store("data",a),n.content.querydata.category&&(""==n.content.querydata.category&&"全部"==a||n.content.querydata.category==a)&&i.removeClass("o2_appmarket_appcategory").addClass("mainColor_color").addClass("o2_appmarket_appcategory_current"),i.addEvents({mouseover:function(){this.addClass("o2_appmarket_appcategory_tab_over")},mouseout:function(){this.removeClass("o2_appmarket_appcategory_tab_over")},click:function(t){var a=this.retrieve("data");if(this.getParent().getElements(".o2_appmarket_appcategory_current").removeClass("mainColor_color").removeClass("o2_appmarket_appcategory_current").addClass("o2_appmarket_appcategory"),this.removeClass("o2_appmarket_appcategory").addClass("mainColor_color").addClass("o2_appmarket_appcategory_current"),a){n.content.querydata.category="全部"==a?"":a;var i=n.content.searchAppInputNode.get("value");null==i&&(i=""),n.content.querydata.name=i,n.loadApplications()}}})},showApplications:function(t){var a=this.content.appList,n=a.clientWidth-40;rowappnum=parseInt(n/240),rowappmargin=240*(n/240-rowappnum)/(rowappnum-1),rowappmargin<10&&(rowappnum-=1,rowappmargin=240*(n/240-rowappnum)/(rowappnum-1)),t.each(function(t,n){this.loadCertainApplication(a,t,n,rowappnum,rowappmargin)}.bind(this))},loadCertainApplication:function(t,a,n,i,e){var o=new Element("div",{class:"o2_appmarket_application"}).inject(t);(n+1)%i!=0?o.setStyle("margin-right",e+"px"):o.setStyle("margin-right","30px");var p=new Element("div",{class:"o2_appmarket_application_icon"}).inject(o);p.setStyle("background-image","url(data:image/png;base64,"+a.icon+")");for(var s=new Element("div",{class:"o2_appmarket_application_info"}).inject(o),c=(new Element("div",{text:a.name,class:"o2_appmarket_application_info_name"}).inject(s),new Element("div",{class:"o2_appmarket_application_info_recommend"}).inject(s)),r=a.grade,l=parseInt(r),h=r-l,d=0;d<l;d++)new Element("img",{src:this.app.iconPath+"blackfiveangular.png",class:"o2_appmarket_application_info_starpic"}).inject(c);h>=.5&&(new Element("img",{src:this.app.iconPath+"halffiveangular.png",class:"o2_appmarket_application_info_starpic"}).inject(c),l++);for(d=0;d<5-l;d++)new Element("img",{src:this.app.iconPath+"whitefiveangular.png",class:"o2_appmarket_application_info_starpic"}).inject(c);new Element("div",{text:a.category,class:"o2_appmarket_application_info_category"}).inject(s);var u=new Element("div",{class:"o2_appmarket_application_info_bottom"}).inject(s),m=(new Element("div",{text:0==a.price?"Free":a.price+"",class:"o2_appmarket_application_info_bottom_free"}).inject(u),new Element("div",{class:"o2_appmarket_application_info_bottom_button mainColor_bg"}).inject(u)),_=this.app.lp.setup;a.installedVersion&&""!=a.installedVersion&&(_=a.installedVersion==a.version?this.app.lp.setupDone:this.app.lp.update);new Element("div",{text:_,class:"o2_appmarket_application_info_bottom_button_text"}).inject(m);var g=this;p.store("data",a),p.addEvents({mouseover:function(){},mouseout:function(){},click:function(t){var a=this.retrieve("data");a&&g.open(t,a)}}),m.store("data",a),m.addEvents({click:function(t){var a=this.retrieve("data");a&&g.installapp(t,a)}})},installapp:function(t,a){var n=t.target.getPosition(),i={event:{x:n.x+40,y:n.y}},e=""==a.installedVersion?this.app.lp.confirmsetupTitle:this.app.lp.confirmupdateTitle,o=""==a.installedVersion?this.app.lp.confirmsetupContent:this.app.lp.confirmupdateContent,p=this;p.app.confirm("warn",i,e,o,300,120,(function(){p.app.mask(),p.actions.MarketAction.installOrUpdate(a.id,function(t){data=t.data,p.app.notice(a.name+" "+p.app.lp.setupSuccess,"success"),p.app.unmask()}.bind(p),function(t){data=t.data,p.app.unmask()}.bind(p),!0),this.close()}),(function(){this.close()}),null,null,"o2")},open:function(t,a){var n={};n.appid=a.id,n.appname=a.name,layout.openApplication(t,"AppMarketV2.Application",n)},createLoading:function(t,a){this.app.content.mask({destroyOnHide:!0,style:{opacity:.7,"background-color":"#999"},loading:!0})},clearLoading:function(){this.app.content.unmask()}});