MWF.xApplication.cms.QueryViewDesigner=MWF.xApplication.cms.QueryViewDesigner||{},MWF.CMSQVD=MWF.xApplication.cms.QueryViewDesigner,MWF.CMSQVD.options={multitask:!0,executable:!1},MWF.xDesktop.requireApp("cms.QueryViewDesigner","View",null,!1),MWF.xApplication.cms.QueryViewDesigner.Main=new Class({Extends:MWF.xApplication.Common.Main,Implements:[Options,Events],options:{style:"default",name:"cms.QueryViewDesigner",icon:"icon.png",title:MWF.CMSQVD.LP.title,appTitle:MWF.CMSQVD.LP.title,id:"",tooltip:{unCategory:MWF.CMSQVD.LP.unCategory},actions:null,category:null,processData:null},onQueryLoad:function(){this.shortcut=!0,this.status&&(this.options.application=this.status.applicationId,this.application=this.status.application,this.options.id=this.status.id),this.options.id||(this.options.desktopReload=!1,this.options.title=this.options.title+"-"+MWF.CMSQVD.LP.newView),this.actions||(this.actions=MWF.Actions.get("x_cms_assemble_control")),this.lp=MWF.xApplication.cms.QueryViewDesigner.LP,this.addEvent("queryClose",function(t){this.explorer&&this.explorer.reload()}.bind(this)),this.addEvent("postLoadWindowMax",function(t){this.loadWindowOk=!0,this.loadApplicationOk&&this.loadWindowOk&&this.view.setViewWidth()}.bind(this)),this.addEvent("postLoadApplication",function(t){this.loadApplicationOk=!0,this.loadApplicationOk&&this.loadWindowOk&&this.view.setViewWidth()}.bind(this))},loadApplication:function(t){this.createNode(),this.options.isRefresh?this.openView((function(){t&&t()})):this.maxSize(function(){this.openView((function(){t&&t()}))}.bind(this)),this.options.readMode||this.addKeyboardEvents()},addKeyboardEvents:function(){this.addEvent("copy",function(){this.copyModule()}.bind(this)),this.addEvent("paste",function(){this.pasteModule()}.bind(this)),this.addEvent("cut",function(){this.cutModule()}.bind(this)),this.addEvent("keySave",function(t){this.keySave(t)}.bind(this)),this.addEvent("keyDelete",function(t){this.keyDelete(t)}.bind(this))},keySave:function(t){this.shortcut&&(this.view.save(),t.preventDefault())},keyDelete:function(){this.shortcut&&(this.view.currentSelectedModule&&this.view.currentSelectedModule.delete())},copyModule:function(){if(this.shortcut&&this.view.currentSelectedModule){var t=this.view.currentSelectedModule;MWF.clipboard.data={type:"view",data:t.json}}},cutModule:function(){this.shortcut&&(this.view.currentSelectedModule&&(this.copyModule(),this.view.currentSelectedModule.destroy()))},pasteModule:function(){if(this.shortcut&&MWF.clipboard.data&&"view"==MWF.clipboard.data.type&&this.view.currentSelectedModule){var t=this.view.currentSelectedModule,e=MWF.clipboard.data.data;t.addColumn(null,e)}},createNode:function(){this.content.setStyle("overflow","hidden"),this.node=new Element("div",{styles:{width:"100%",height:"100%",overflow:"hidden"}}).inject(this.content)},getApplication:function(t){var e=this.options.application;this.application?t&&t():this.actions.getColumn("object"==typeOf(e)?e.id:e,function(e){this.application={name:e.data.appName,id:e.data.id},t&&t()}.bind(this))},openView:function(t){this.getApplication(function(){this.initOptions(),this.loadNodes(),this.loadViewListNodes(),this.loadContentNode(),this.loadProperty(),this.resizeNode(),this.addEvent("resize",this.resizeNode.bind(this)),this.loadView((function(){t&&t()})),this.setScrollBar(this.propertyDomArea,null,{V:{x:0,y:0},H:{x:0,y:0}})}.bind(this))},initOptions:function(){},loadNodes:function(){this.viewListNode=new Element("div.viewListNode",{styles:this.css.viewListNode}).inject(this.node),this.propertyNode=new Element("div.propertyNode",{styles:this.css.propertyNode}).inject(this.node),this.contentNode=new Element("div.contentNode",{styles:this.css.contentNode}).inject(this.node)},loadViewListNodes:function(){this.viewListTitleNode=new Element("div.viewListTitleNode",{styles:this.css.viewListTitleNode,text:MWF.CMSQVD.LP.view}).inject(this.viewListNode),this.viewListResizeNode=new Element("div.viewListResizeNode",{styles:this.css.viewListResizeNode}).inject(this.viewListNode),this.viewListAreaSccrollNode=new Element("div.viewListAreaSccrollNode",{styles:this.css.viewListAreaSccrollNode}).inject(this.viewListNode),this.viewListAreaNode=new Element("div.viewListAreaNode",{styles:this.css.viewListAreaNode}).inject(this.viewListAreaSccrollNode),this.loadViewListResize(),this.loadViewList()},loadViewListResize:function(){this.viewListResize=new Drag(this.viewListResizeNode,{snap:1,onStart:function(t,e){var i="firefox"==Browser.name?e.event.clientX:e.event.x,o="firefox"==Browser.name?e.event.clientY:e.event.y;t.store("position",{x:i,y:o});var s=this.viewListAreaSccrollNode.getSize();t.store("initialWidth",s.x)}.bind(this),onDrag:function(t,e){var i="firefox"==Browser.name?e.event.clientX:e.event.x,o=this.content.getSize(),s=t.retrieve("position"),n=t.retrieve("initialWidth").toFloat()+(i.toFloat()-s.x.toFloat());n>o.x/2&&(n=o.x/2),n<40&&(n=40),this.contentNode.setStyle("margin-left",n+1),this.viewListNode.setStyle("width",n),this.view.setViewWidth()}.bind(this)}),this.viewListResizeNode.addEvents({touchstart:function(t){el=t.target;var e="firefox"==Browser.name?t.page.clientX:t.page.x,i="firefox"==Browser.name?t.page.clientY:t.page.y;el.store("position",{x:e,y:i});var o=this.viewListAreaSccrollNode.getSize();el.store("initialWidth",o.x)}.bind(this),touchmove:function(t){el=t.target;var e="firefox"==Browser.name?t.page.clientX:t.page.x,i=this.content.getSize(),o=el.retrieve("position"),s=el.retrieve("initialWidth").toFloat()+(e.toFloat()-o.x.toFloat());s>i.x/2&&(s=i.x/2),s<40&&(s=40),this.contentNode.setStyle("margin-left",s+1),this.viewListNode.setStyle("width",s),this.view.setViewWidth()}.bind(this)})},loadViewList:function(){this.actions.listQueryView(this.application.id,function(t){t.data.each(function(t){this.createListViewItem(t)}.bind(this))}.bind(this),null,!1)},createListViewItem:function(t,e){var i=this,o=new Element("div",{styles:this.css.listViewItem}).inject(this.viewListAreaNode,e?"top":"bottom");new Element("div",{styles:this.css.listViewItemIcon}).inject(o),new Element("div",{styles:this.css.listViewItemText,text:t.name?t.name+" ("+t.alias+")":this.lp.newView}).inject(o);o.store("view",t),o.addEvents({dblclick:function(t){i.loadViewByData(this,t)},mouseover:function(){i.currentListViewItem!=this&&this.setStyles(i.css.listViewItem_over)},mouseout:function(){i.currentListViewItem!=this&&this.setStyles(i.css.listViewItem)}})},loadViewByData:function(t,e){var i=t.retrieve("view"),o=this,s={onQueryLoad:function(){this.actions=o.actions,this.category=o,this.options.id=i.id,this.application=o.application,this.explorer=o.explorer}};this.desktop.openApplication(e,"cms.QueryViewDesigner",s)},loadContentNode:function(){this.contentToolbarNode=new Element("div#contentToolbarNode",{styles:this.css.contentToolbarNode}).inject(this.contentNode),this.options.readMode||this.loadContentToolbar(),this.editContentNode=new Element("div",{styles:this.css.editContentNode}).inject(this.contentNode),this.loadEditContent(function(){this.designNode&&this.designNode.setStyles(this.css.designNode)}.bind(this))},loadContentToolbar:function(t){this.getFormToolbarHTML(function(e){e.getElements("span").each(function(t,e){var i=t.get("MWFButtonImage");i&&t.set("MWFButtonImage",this.path+""+this.options.style+"/toolbar/"+i)}.bind(this)),$(e).inject(this.contentToolbarNode),MWF.require("MWF.widget.Toolbar",function(){this.toolbar=new MWF.widget.Toolbar(e,{style:"ProcessCategory"},this),this.toolbar.load(),t&&t()}.bind(this))}.bind(this))},getFormToolbarHTML:function(t){var e=this.path+this.options.style+"/toolbars.html";new Request.HTML({url:e,method:"get",onSuccess:function(e,i,o,s){var n=e[0];t&&t(n)}.bind(this),onFailure:function(t){this.notice("request processToolbars error: "+t.responseText,"error")}.bind(this)}).send()},maxOrReturnEditor:function(){this.isMax?(this.isMax=!1,this.designNode.inject(this.editContentNode),this.designNode.setStyles(this.css.designNode),this.designNode.setStyles({position:"static"}),this.resizeNode(),this.view.setAreaNodeSize()):(this.designNode.inject(this.node),this.designNode.setStyles({position:"absolute",width:"100%",height:"100%",top:"0px",margin:"0px",left:"0px"}),this.view.setAreaNodeSize(),this.isMax=!0)},loadEditContent:function(t){this.designNode=new Element("div",{styles:this.css.designNode}).inject(this.editContentNode)},loadProperty:function(){this.propertyTitleNode=new Element("div.propertyTitleNode",{styles:this.css.propertyTitleNode,text:MWF.CMSQVD.LP.property}).inject(this.propertyNode),this.propertyResizeBar=new Element("div.propertyResizeBar",{styles:this.css.propertyResizeBar}).inject(this.propertyNode),this.loadPropertyResize(),this.propertyContentNode=new Element("div.propertyContentNode",{styles:this.css.propertyContentNode}).inject(this.propertyNode),this.propertyDomArea=new Element("div.propertyDomArea",{styles:this.css.propertyDomArea}).inject(this.propertyContentNode),this.propertyDomPercent=.3,this.propertyContentResizeNode=new Element("div.propertyContentResizeNode",{styles:this.css.propertyContentResizeNode}).inject(this.propertyContentNode),this.propertyContentArea=new Element("div.propertyContentArea",{styles:this.css.propertyContentArea}).inject(this.propertyContentNode),this.loadPropertyContentResize(),this.propertyNode.addEvent("keydown",(function(t){t.stopPropagation()}))},loadPropertyResize:function(){this.propertyResize=new Drag(this.propertyResizeBar,{snap:1,onStart:function(t,e){var i="firefox"==Browser.name?e.event.clientX:e.event.x,o="firefox"==Browser.name?e.event.clientY:e.event.y;t.store("position",{x:i,y:o});var s=this.propertyNode.getSize();t.store("initialWidth",s.x)}.bind(this),onDrag:function(t,e){var i="firefox"==Browser.name?e.event.clientX:e.event.x,o=this.content.getSize(),s=t.retrieve("position"),n=t.retrieve("initialWidth").toFloat()+(s.x.toFloat()-i.toFloat());n>o.x/2&&(n=o.x/2),n<40&&(n=40),this.contentNode.setStyle("margin-right",n+1),this.propertyNode.setStyle("width",n),this.view.setViewWidth()}.bind(this)})},loadPropertyContentResize:function(){this.propertyContentResize=new Drag(this.propertyContentResizeNode,{snap:1,onStart:function(t,e){var i="firefox"==Browser.name?e.event.clientX:e.event.x,o="firefox"==Browser.name?e.event.clientY:e.event.y;t.store("position",{x:i,y:o});var s=this.propertyDomArea.getSize();t.store("initialHeight",s.y)}.bind(this),onDrag:function(t,e){var i=this.propertyContentNode.getSize(),o="firefox"==Browser.name?e.event.clientY:e.event.y,s=t.retrieve("position"),n=o.toFloat()-s.y.toFloat(),r=t.retrieve("initialHeight").toFloat()+n;r<40&&(r=40),r>i.y-40&&(r=i.y-40),this.propertyDomPercent=r/i.y,this.setPropertyContentResize()}.bind(this)})},setPropertyContentResize:function(){var t=this.propertyContentNode.getSize(),e=this.propertyContentResizeNode.getSize(),i=t.y-e.y,o=this.propertyDomPercent*i,s=i-o;if(this.propertyDomArea.setStyle("height",o+"px"),this.propertyContentArea.setStyle("height",s+"px"),this.view&&this.view.currentSelectedModule&&this.view.currentSelectedModule.property){var n=this.view.currentSelectedModule.property.propertyTab;if(n){var r=n.tabNodeContainer.getSize();n.pages.each(function(t){var e=t.contentNodeArea.getStyle("margin-top").toFloat(),i=t.contentNodeArea.getStyle("margin-bottom").toFloat(),o=s-e-i-r.y.toFloat()-15;t.contentNodeArea.setStyle("height",o)}.bind(this))}}},resizeNode:function(){var t=this.node.getSize();this.contentNode.setStyle("height",t.y+"px"),this.propertyNode.setStyle("height",t.y+"px");var e=this.contentToolbarNode.getStyle("margin-top").toFloat(),i=this.contentToolbarNode.getStyle("margin-bottom").toFloat(),o=this.contentToolbarNode.getComputedSize(),s=t.y-o.totalHeight-e-i;if(this.editContentNode.setStyle("height",s+"px"),this.designNode){var n=this.designNode.getStyle("margin-top").toFloat(),r=this.designNode.getStyle("margin-bottom").toFloat();s=t.y-o.totalHeight-e-i-n-r,this.designNode.setStyle("height",s+"px")}titleSize=this.propertyTitleNode.getSize(),titleMarginTop=this.propertyTitleNode.getStyle("margin-top").toFloat(),titleMarginBottom=this.propertyTitleNode.getStyle("margin-bottom").toFloat(),titlePaddingTop=this.propertyTitleNode.getStyle("padding-top").toFloat(),titlePaddingBottom=this.propertyTitleNode.getStyle("padding-bottom").toFloat(),s=titleSize.y+titleMarginTop+titleMarginBottom+titlePaddingTop+titlePaddingBottom,s=t.y-s,this.propertyContentNode.setStyle("height",s+"px"),this.propertyResizeBar.setStyle("height",s+"px"),this.setPropertyContentResize(),titleSize=this.viewListTitleNode.getSize(),titleMarginTop=this.viewListTitleNode.getStyle("margin-top").toFloat(),titleMarginBottom=this.viewListTitleNode.getStyle("margin-bottom").toFloat(),titlePaddingTop=this.viewListTitleNode.getStyle("padding-top").toFloat(),titlePaddingBottom=this.viewListTitleNode.getStyle("padding-bottom").toFloat(),nodeMarginTop=this.viewListAreaSccrollNode.getStyle("margin-top").toFloat(),nodeMarginBottom=this.viewListAreaSccrollNode.getStyle("margin-bottom").toFloat(),s=titleSize.y+titleMarginTop+titleMarginBottom+titlePaddingTop+titlePaddingBottom+nodeMarginTop+nodeMarginBottom,s=t.y-s,this.viewListAreaSccrollNode.setStyle("height",s+"px"),this.viewListResizeNode.setStyle("height",s+"px")},loadView:function(t){this.getViewData(this.options.id,function(e){this.setTitle(this.options.appTitle+"-"+e.name),this.taskitem.setText(this.options.appTitle+"-"+e.name),this.options.appTitle=this.options.appTitle+"-"+e.name,this.view=new MWF.xApplication.cms.QueryViewDesigner.View(this,e),this.view.load(),t&&t()}.bind(this))},getViewData:function(t,e){this.options.id?this.loadViewData(t,e):this.loadNewViewData(e)},loadNewViewData:function(t){MWF.getJSON("../x_component_cms_QueryViewDesigner/$View/view.json",{onSuccess:function(e){this.actions.getUUID(function(i){e.id=i,e.isNewView=!0,e.application=this.application.id,this.createListViewItem(e,!0),t&&t(e)}.bind(this))}.bind(this),onerror:function(t){this.notice(t,"error")}.bind(this),onRequestFailure:function(t){this.notice(t.responseText,"error")}.bind(this)})},loadViewData:function(t,e){this.actions.getQueryView(t,function(t){if(t){var i=t.data,o=JSON.decode(i.data);if(i.data=o,this.application)e&&e(i);else{var s=i.application;this.actions.getColumn("object"==typeOf(s)?s.id:s,function(t){this.application={name:t.data.appName,id:t.data.id},e&&e(i)}.bind(this))}}}.bind(this))},saveView:function(){this.view.save(function(){var t=this.view.data.name;this.setTitle(MWF.CMSQVD.LP.title+"-"+t),this.options.desktopReload=!0,this.options.id=this.view.data.id}.bind(this))},saveViewAs:function(){this.view.saveAs()},dictionaryExplode:function(){this.view.explode()},dictionaryImplode:function(){this.view.implode()},recordStatus:function(){var t=[];t.push(this.view.data.id);var e=this.view.data.id;return{id:this.options.id,application:this.application,openViews:t,currentId:e}}});