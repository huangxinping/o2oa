MWF.xApplication=MWF.xApplication||{},MWF.xApplication.cms=MWF.xApplication.cms||{},MWF.xApplication.cms.QueryViewDesigner=MWF.xApplication.cms.QueryViewDesigner||{},MWF.CMSQVD=MWF.xApplication.cms.QueryViewDesigner,MWF.require("MWF.xScript.CMSMacro",null,!1),MWF.xDesktop.requireApp("cms.QueryViewDesigner","lp."+MWF.language,null,!1),MWF.xDesktop.requireApp("cms.QueryViewDesigner","Property",null,!1),MWF.xDesktop.requireApp("process.ViewDesigner","View",null,!1),MWF.xApplication.cms.QueryViewDesigner.View=new Class({Extends:MWF.xApplication.process.ViewDesigner.View,Implements:[Options,Events],options:{style:"default",isView:!1,showTab:!0,propertyPath:"../x_component_cms_QueryViewDesigner/$View/view.html"},initialize:function(e,t,i){this.setOptions(i),this.path="../x_component_process_ViewDesigner/$View/",this.cssPath="../x_component_process_ViewDesigner/$View/"+this.options.style+"/css.wcss",this._loadCss(),this.designer=e,this.data=t,this.data.data||(this.data.data={}),this.parseData(),this.node=this.designer.designNode,this.areaNode=new Element("div",{styles:{height:"100%",overflow:"auto"}}),this.propertyListNode=this.designer.propertyDomArea,this.designer.application&&(this.data.appId=this.designer.application.id,this.data.appName=this.designer.application.appName||this.designer.application.appName,this.data.creatorPerson||(this.data.creatorPerson=layout.desktop.session.user.distinguishedName)),this.isNewView=!this.data.id,this.items=[],this.view=this,this.autoSave(),this.designer.addEvent("queryClose",function(){this.autoSaveTimerID&&window.clearInterval(this.autoSaveTimerID)}.bind(this))},showProperty:function(){this.property?this.property.show():(this.property=new MWF.xApplication.cms.QueryViewDesigner.Property(this,this.designer.propertyContentArea,this.designer,{path:this.options.propertyPath,onPostLoad:function(){this.property.show()}.bind(this)}),this.property.load())},loadViewData:function(){this.data.id&&this.saveSilence(function(){this.viewContentBodyNode.empty(),this.viewContentTableNode=new Element("table",{styles:this.css.viewContentTableNode,border:"0px",cellPadding:"0",cellSpacing:"0"}).inject(this.viewContentBodyNode),this.designer.actions.loadQueryView(this.data.id,function(e){var t={};e.data.selectEntryList.each(function(e){t[e.column]=e}.bind(this)),this.json.data.groupEntry.column?e.data.groupGrid.length&&(e.data.groupGrid.each(function(i,s){var n=new Element("tr",{styles:this.css.viewContentTrNode}).inject(this.viewContentTableNode),o=this.items.length,a=new Element("td",{styles:this.css.viewContentGroupTdNode,colSpan:o}).inject(n),r=new Element("div",{styles:this.css.viewContentTdGroupNode}).inject(a);new Element("div",{styles:this.css.viewContentTdGroupIconNode}).inject(r);new Element("div",{styles:this.css.viewContentTdGroupTextNode}).inject(r).set("text",i.group);var d=[];i.list.each(function(i){var s=new Element("tr",{styles:this.css.viewContentTrNode}).inject(this.viewContentTableNode);s.setStyle("display","none");new Element("td",{styles:this.css.viewContentTdNode}).inject(s);Object.each(i.data,function(i,n){n!=this.json.data.groupEntry.column&&new Element("td",{styles:this.css.viewContentTdNode}).inject(s).set("text",t[n].code?MWF.CMSMacro.exec(t[n].code,{value:i,data:e.data}):i)}.bind(this)),d.push(s)}.bind(this)),r.store("subtrs",d);var h=this;r.addEvent("click",(function(){var e=this.retrieve("subtrs"),t=r.getFirst("div");e[0]&&("none"==e[0].getStyle("display")?(e.each((function(e){e.setStyle("display","table-row")})),t.setStyle("background","url(../x_component_process_ViewDesigner/$View/default/icon/down.png) center center no-repeat")):(e.each((function(e){e.setStyle("display","none")})),t.setStyle("background","url(../x_component_process_ViewDesigner/$View/default/icon/right.png) center center no-repeat"))),h.setContentHeight()}))}.bind(this)),this.setContentColumnWidth(),this.setContentHeight()):e.data.grid.length&&(e.data.grid.each(function(i,s){var n=new Element("tr",{styles:this.css.viewContentTrNode}).inject(this.viewContentTableNode);Object.each(i.data,function(i,s){new Element("td",{styles:this.css.viewContentTdNode}).inject(n).set("text",t[s].code?MWF.CMSMacro.exec(t[s].code,{value:i,data:e.data}):i)}.bind(this))}.bind(this)),this.setContentColumnWidth(),this.setContentHeight())}.bind(this))}.bind(this))},addColumn:function(){MWF.require("MWF.widget.UUID",function(){var e=(new MWF.widget.UUID).id,t={id:e,column:e,displayName:this.designer.lp.unnamed,selectType:"attribute",orderType:"original"};this.json.data.selectEntryList||(this.json.data.selectEntryList=[]),this.json.data.selectEntryList.push(t);var i=new MWF.xApplication.cms.QueryViewDesigner.View.Column(t,this);(this.items.push(i),i.selected(),this.viewContentTableNode)&&this.viewContentTableNode.getElements("tr").each(function(e){new Element("td",{styles:this.css.viewContentTdNode}).inject(e)}.bind(this));this.setViewWidth(),this.addColumnNode.scrollIntoView(!0)}.bind(this))},loadViewColumns:function(){this.json.data.selectEntryList&&this.json.data.selectEntryList.each(function(e){this.items.push(new MWF.xApplication.cms.QueryViewDesigner.View.Column(e,this))}.bind(this))},createRootItem:function(){this.items.push(new MWF.xApplication.process.DictionaryDesigner.Dictionary.item("ROOT",this.data.data,null,0,this,!0))},saveSilence:function(e){if(!this.data.name)return this.designer.notice(this.designer.lp.notice.inputName,"error"),!1;this.isNewView&&(this.data.isNewView=!0),this.designer.actions.saveQueryView(this.data,function(t){this.isNewView=!1,this.data.id=t.data.id,this.lisNode&&this.lisNode.getLast().set("text",this.data.name+"("+this.data.alias+")"),e&&e()}.bind(this))},save:function(e){if(!this.data.name)return this.designer.notice(this.designer.lp.notice.inputName,"error"),!1;this.isNewView&&(this.data.isNewView=!0),this.designer.actions.saveQueryView(this.data,function(t){this.isNewView=!1,this.designer.notice(this.designer.lp.notice.save_success,"success",this.node,{x:"left",y:"bottom"}),this.data.id=t.data.id,this.lisNode&&this.lisNode.getLast().set("text",this.data.name+"("+this.data.alias+")"),e&&e()}.bind(this))},saveAs:function(){new MWF.xApplication.cms.QueryViewDesigner.View.NewName(this,{name:this.data.name+"_副本"},{onSave:function(e,t){this._saveAs(e.name,t)}.bind(this)},{app:this.designer}).edit()},clone:function(e){if(null==e||"object"!=typeof e)return e;if("number"==typeof e.length){for(var t=[],i=0,s=e.length;i<s;++i)t[i]=this.clone(e[i]);return t}t={};for(var n in e)t[n]=this.clone(e[n]);return t},_saveAs:function(e,t){var i=this.clone(this.data);i.isNewView=!0,i.id=this.designer.actions.getUUID(),i.name=e,i.alias="",delete i[this.data.id+"viewFilterType"],i[i.id+"viewFilterType"]="custom",i.data.selectEntryList.each(function(e){e.id=(new MWF.widget.UUID).id}.bind(this)),this.designer.actions.saveQueryView(i,function(e){this.designer.notice(this.designer.lp.notice.saveAs_success,"success",this.node,{x:"left",y:"bottom"}),t&&t()}.bind(this))}}),MWF.xApplication.cms.QueryViewDesigner.View.Column=new Class({Extends:MWF.xApplication.process.ViewDesigner.View.Column,initialize:function(e,t,i){this.propertyPath="../x_component_cms_QueryViewDesigner/$View/column.html",this.view=t,this.json=e,this.next=i,this.css=this.view.css,this.content=this.view.viewTitleTrNode,this.domListNode=this.view.domListNode,this.load()},showProperty:function(){this.property?this.property.show():(this.property=new MWF.xApplication.cms.QueryViewDesigner.Property(this,this.view.designer.propertyContentArea,this.view.designer,{path:this.propertyPath,onPostLoad:function(){this.property.show()}.bind(this)}),this.property.load())}}),MWF.xApplication.cms.QueryViewDesigner.View.NewName=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"blue",width:700,height:"220",hasTop:!0,hasIcon:!1,draggable:!0,title:"新数据视图名称"},_createTableContent:function(){this.formTableArea.set("html","<table width='80%' bordr='0' cellpadding='7' cellspacing='0' styles='formTable' style='margin: 20px auto 0px auto; '><tr><td styles='formTableTitle' lable='name' width='25%'></td>    <td styles='formTableValue' item='name' colspan='3'></td></tr></table>"),MWF.xDesktop.requireApp("Template","MForm",function(){this.form=new MForm(this.formTableArea,this.data||{},{isEdited:!0,style:"cms",hasColon:!0,itemTemplate:{name:{text:"名称",notEmpty:!0}}},this.app),this.form.load()}.bind(this),null,!0)},ok:function(){var e=this.form.getResult(!0,null,!0,!1,!0);e&&this.fireEvent("save",[e,function(){this.close()}.bind(this)])}});