MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.Subpage=MWF.APPSubpage=new Class({Extends:MWF.APP$Module,_loadUserInterface:function(){this.node.empty(),this.getSubpage(function(){this.loadSubpage()}.bind(this))},reload:function(){this.node.empty(),this.getSubpage(function(){this.loadSubpage()}.bind(this))},loadCss:function(){if(this.subpageData.json.css&&this.subpageData.json.css.code){for(var e,t=this.form.parseCSS(this.subpageData.json.css.code),s=new RegExp("(.+)(?=\\{)","g"),a=this.form.json.id.replace(/\-/g,"");null!==(e=s.exec(t));){var i=".css"+a+" ",o=i+e[0];t=t.substring(0,e.index)+o+t.substring(s.lastIndex,t.length),s.lastIndex=s.lastIndex+i.length}var n;if(!(n=$("style"+this.form.json.id)))(n=document.createElement("style")).setAttribute("type","text/css"),n.id="style"+this.form.json.id,n.inject(this.form.container,"before");if(n.styleSheet){var r=function(){n.styleSheet.cssText+=t};n.styleSheet.disabled?setTimeout(r,10):r()}else{var p=document.createTextNode(t);n.appendChild(p)}}},checkSubpageNested:function(e){return this.parentpageIdList?!this.parentpageIdList.contains(e):![this.form.json.id].contains(e)},getParentpageIdList:function(){var e;return this.parentpageIdList?(e=Array.clone(this.parentpageIdList)).push(this.subpageData.json.id):e=[this.form.json.id,this.subpageData.json.id],e},loadSubpage:function(){if(this.subpageData)if(this.checkSubpageNested(this.subpageData.json.id)){this.loadCss(),this.form.subpageModules=this.form.subpageModules||{};var e=this.form.subpageModules[this.json.id]={},t=this.getPageParamenters();if("object"===typeOf(t)&&this.form.Macro&&this.form.Macro.environment){var s=this.form.Macro.environment;s.subpageParameters=s.subpageParameters||{},s.subpageParameters[this.json.id]=t}this.node.set("html",this.subpageData.html),Object.each(this.subpageData.json.moduleList,function(e,t){var s=t;if(this.form.json.moduleList[t]){s=this.json.id+"_"+t;var a=this.node.getElement("#"+t);a&&a.set("id",s),e.orgiginalId=t,e.id=s}this.form.json.moduleList[s]=e}.bind(this)),this.form._getModuleNodes(this.node).each(function(t){if("form"!==t.get("MWFtype")){var s=this,a=this.form._getDomjson(t),i=this.form._loadModule(a,t,(function(){this.subpage=s,this.parentpageIdList=s.getParentpageIdList()}));this.form.modules.push(i),e[a.orgiginalId||a.id]=i}}.bind(this))}else this.form.notice(MWF.xApplication.process.Xform.LP.subpageNestedError,"error");this.form.subpageLoadedCount?this.form.subpageLoadedCount++:this.form.subpageLoadedCount=1,this.form.checkSubformLoaded()},getSubpage:function(e){var t="Mobile"===this.form.json.mode||layout.mobile?"getPageByNameMobile":"getPageByName";if("script"===this.json.subpageType){if(this.json.subpageScript&&this.json.subpageScript.code){var s=this.form.Macro.exec(this.json.subpageScript.code,this);if(s){var a=this.form.businessData.pageInfor.portal;o2.Actions.get("x_portal_assemble_surface")[t](s,a,function(t){this.getSubpageData(t.data),e&&e()}.bind(this))}else e&&e()}}else if(this.json.subpageSelected&&"none"!==this.json.subpageSelected){a=this.form.businessData.pageInfor.portal;o2.Actions.get("x_portal_assemble_surface")[t](this.json.subpageSelected,a,function(t){this.getSubpageData(t.data),e&&e()}.bind(this))}else e&&e()},getSubpageData:function(e){var t;t=e.data,this.subpageData=null,t&&(this.subpageData=JSON.decode(MWF.decodeJsonString(t)),this.subpageData.updateTime=e.updateTime)},getPageParamenters:function(){var e=null;if("map"===this.json.parameterType)e=this.json.parametersMapList;else if("script"===this.json.parameterType){var t=this.json.parametersScript?this.json.parametersScript.code:"";t&&(e=this.form.Macro.exec(t,this))}return e}});