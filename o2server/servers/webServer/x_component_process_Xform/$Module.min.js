MWF.require("MWF.widget.Common",null,!1),MWF.xApplication.process.Xform.$Module=MWF.APP$Module=new Class({Implements:[Events],options:{moduleEvents:["load","queryLoad","postLoad"]},initialize:function(s,t,i,e){this.node=$(s),this.node.store("module",this),this.json=t,this.form=i},_getSource:function(){for(var s=this.node.getParent();s&&"source"!=s.get("MWFtype")&&"subSource"!=s.get("MWFtype")&&"subSourceItem"!=s.get("MWFtype");)s=s.getParent();return s?s.retrieve("module"):null},hide:function(){var s=this.node.getStyle("display");"none"!==s&&this.node.store("mwf_display",s),this.node.setStyle("display","none"),this.iconNode&&this.iconNode.setStyle("display","none")},show:function(){var s=this.node.retrieve("mwf_display",s);this.node.setStyle("display",s),this.iconNode&&this.iconNode.setStyle("display","block")},load:function(){this._loadModuleEvents(),this.fireEvent("queryLoad")&&(this._queryLoaded(),this._loadUserInterface(),this._loadStyles(),this._loadDomEvents(),this._afterLoaded(),this.fireEvent("postLoad"),this.fireEvent("load"))},_loadUserInterface:function(){},_loadStyles:function(){this.json.styles&&Object.each(this.json.styles,function(s,t){if(-1!=s.indexOf("x_processplatform_assemble_surface")||-1!=s.indexOf("x_portal_assemble_surface")||-1!=s.indexOf("x_cms_assemble_control")){var i=MWF.Actions.getHost("x_processplatform_assemble_surface"),e=MWF.Actions.getHost("x_portal_assemble_surface"),n=MWF.Actions.getHost("x_cms_assemble_control");-1!==s.indexOf("/x_processplatform_assemble_surface")?s=s.replace("/x_processplatform_assemble_surface",i+"/x_processplatform_assemble_surface"):-1!==s.indexOf("x_processplatform_assemble_surface")&&(s=s.replace("x_processplatform_assemble_surface",i+"/x_processplatform_assemble_surface")),-1!==s.indexOf("/x_portal_assemble_surface")?s=s.replace("/x_portal_assemble_surface",e+"/x_portal_assemble_surface"):-1!==s.indexOf("x_portal_assemble_surface")&&(s=s.replace("x_portal_assemble_surface",e+"/x_portal_assemble_surface")),-1!==s.indexOf("/x_cms_assemble_control")?s=s.replace("/x_cms_assemble_control",n+"/x_cms_assemble_control"):-1!==s.indexOf("x_cms_assemble_control")&&(s=s.replace("x_cms_assemble_control",n+"/x_cms_assemble_control")),s=o2.filterUrl(s)}this.node.setStyle(t,s)}.bind(this))},_loadModuleEvents:function(){Object.each(this.json.events,function(s,t){s.code&&-1!==this.options.moduleEvents.indexOf(t)&&this.addEvent(t,function(t){return this.form.Macro.fire(s.code,this,t)}.bind(this))}.bind(this))},_loadDomEvents:function(){Object.each(this.json.events,function(s,t){s.code&&-1===this.options.moduleEvents.indexOf(t)&&this.node.addEvent(t,function(t){return this.form.Macro.fire(s.code,this,t)}.bind(this))}.bind(this))},_loadEvents:function(){Object.each(this.json.events,function(s,t){s.code&&(-1!==this.options.moduleEvents.indexOf(t)?this.addEvent(t,function(t){return this.form.Macro.fire(s.code,this,t)}.bind(this)):this.node.addEvent(t,function(t){return this.form.Macro.fire(s.code,this,t)}.bind(this)))}.bind(this))},addModuleEvent:function(s,t){-1!==this.options.moduleEvents.indexOf(s)?this.addEvent(s,function(s){return t?t(this,s):null}.bind(this)):this.node.addEvent(s,function(s){return t?t(this,s):null}.bind(this))},_getBusinessData:function(){return"yes"==this.json.section?this._getBusinessSectionData():"Opinion"===this.json.type?this._getBusinessSectionDataByPerson():this.form.businessData.data[this.json.id]||""},_getBusinessSectionData:function(){switch(this.json.sectionBy){case"person":return this._getBusinessSectionDataByPerson();case"unit":return this._getBusinessSectionDataByUnit();case"activity":return this._getBusinessSectionDataByActivity();case"splitValue":return this._getBusinessSectionDataBySplitValue();case"script":return this._getBusinessSectionDataByScript(this.json.sectionByScript?this.json.sectionByScript.code:"");default:return this.form.businessData.data[this.json.id]||""}},_getBusinessSectionDataByPerson:function(){this.form.sectionListObj[this.json.id]=layout.desktop.session.user.id;var s=this.form.businessData.data[this.json.id];return s&&s[layout.desktop.session.user.id]||""},_getBusinessSectionDataByUnit:function(){this.form.sectionListObj[this.json.id]="";var s=this.form.businessData.data[this.json.id];if(!s)return"";var t=this.form.businessData.task?this.form.businessData.task.unit:"";return t&&(this.form.sectionListObj[this.json.id]=t),t&&s[t]||""},_getBusinessSectionDataByActivity:function(){this.form.sectionListObj[this.json.id]="";var s=this.form.businessData.data[this.json.id];if(!s)return"";var t=this.form.businessData.work?this.form.businessData.work.activity:"";return t&&(this.form.sectionListObj[this.json.id]=t),t&&s[t]||""},_getBusinessSectionDataBySplitValue:function(){this.form.sectionListObj[this.json.id]="";var s=this.form.businessData.data[this.json.id];if(!s)return"";var t=this.form.businessData.work?this.form.businessData.work.splitValue:"";return t&&(this.form.sectionListObj[this.json.id]=t),t&&s[t]||""},_getBusinessSectionDataByScript:function(s){this.form.sectionListObj[this.json.id]="";var t=this.form.businessData.data[this.json.id];if(!t)return"";var i=this.form.Macro.exec(s,this);return i&&(this.form.sectionListObj[this.json.id]=i),i&&t[i]||""},_setBusinessData:function(s){"yes"==this.json.section?this._setBusinessSectionData(s):"Opinion"===this.json.type?this._setBusinessSectionDataByPerson(s):(this.form.businessData.data[this.json.id]?this.form.businessData.data[this.json.id]=s:(this.form.businessData.data[this.json.id]=s,this.form.Macro.environment.setData(this.form.businessData.data)),this.json.isTitle&&(this.form.businessData.work.title=s))},_setBusinessSectionData:function(s){switch(this.json.sectionBy){case"person":this._setBusinessSectionDataByPerson(s);break;case"unit":this._setBusinessSectionDataByUnit(s);break;case"activity":this._setBusinessSectionDataByActivity(s);break;case"splitValue":this._setBusinessSectionDataBySplitValue(s);break;case"script":this._setBusinessSectionDataByScript(this.json.sectionByScript.code,s);break;default:this.form.businessData.data[this.json.id]?this.form.businessData.data[this.json.id]=s:(this.form.businessData.data[this.json.id]=s,this.form.Macro.environment.setData(this.form.businessData.data))}},_setBusinessSectionDataByPerson:function(s){var t=!1,i=layout.desktop.session.user.id,e=this.form.businessData.data[this.json.id];e||(e={},this.form.businessData.data[this.json.id]=e,t=!0),e[i]||(t=!0),e[i]=s,t&&this.form.Macro.environment.setData(this.form.businessData.data)},_setBusinessSectionDataByUnit:function(s){var t=!1,i=this.form.businessData.task?this.form.businessData.task.unit:"";if(i){var e=this.form.businessData.data[this.json.id];e||(e={},this.form.businessData.data[this.json.id]=e,t=!0),e[i]||(t=!0),e[i]=s}t&&this.form.Macro.environment.setData(this.form.businessData.data)},_setBusinessSectionDataByActivity:function(s){var t=!1,i=this.form.businessData.work?this.form.businessData.work.activity:"";if(i){var e=this.form.businessData.data[this.json.id];e||(e={},this.form.businessData.data[this.json.id]=e,t=!0),e[i]||(t=!0),e[i]=s}t&&this.form.Macro.environment.setData(this.form.businessData.data)},_setBusinessSectionDataBySplitValue:function(s){var t=!1,i=this.form.businessData.work?this.form.businessData.work.splitValue:"";if(i){var e=this.form.businessData.data[this.json.id];e||(e={},this.form.businessData.data[this.json.id]=e,t=!0),e[i]||(t=!0),e[i]=s}t&&this.form.Macro.environment.setData(this.form.businessData.data)},_setBusinessSectionDataByScript:function(s,t){var i=!1,e=this.form.Macro.exec(s,this);if(e){var n=this.form.businessData.data[this.json.id];n||(n={},this.form.businessData.data[this.json.id]=n,i=!0),n[e]||(i=!0),n[e]=t}i&&this.form.Macro.environment.setData(this.form.businessData.data)},_queryLoaded:function(){},_afterLoaded:function(){},setValue:function(){},focus:function(){this.node.focus()}});