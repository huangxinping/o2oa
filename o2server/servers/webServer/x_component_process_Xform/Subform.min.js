MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.Subform=MWF.APPSubform=new Class({Extends:MWF.APP$Module,_loadUserInterface:function(){this.node.empty(),this.json.isDelay?(this.form.subformLoadedCount?this.form.subformLoadedCount++:this.form.subformLoadedCount=1,this.form.checkSubformLoaded(),this.checked=!0):this.getSubform(function(){this.loadSubform()}.bind(this))},active:function(t){this.loaded?t&&t():this.reload(t)},reload:function(t){this.node.empty(),this.getSubform(function(){this.loadSubform(),t&&t()}.bind(this))},loadCss:function(){if(this.subformData.json.css&&this.subformData.json.css.code){for(var t,s=this.form.parseCSS(this.subformData.json.css.code),o=new RegExp("(.+)(?=\\{)","g"),i=this.form.json.id.replace(/\-/g,"");null!==(t=o.exec(s));){var e=".css"+i+" ",r=e+t[0];s=s.substring(0,t.index)+r+s.substring(o.lastIndex,s.length),o.lastIndex=o.lastIndex+e.length}var n;if(!(n=$("style"+this.form.json.id)))(n=document.createElement("style")).setAttribute("type","text/css"),n.id="style"+this.form.json.id,n.inject(this.form.container,"before");if(n.styleSheet){var f=function(){n.styleSheet.cssText+=s};n.styleSheet.disabled?setTimeout(f,10):f()}else{var m=document.createTextNode(s);n.appendChild(m)}}},checkSubformNested:function(t){return!t||(this.parentformIdList?!this.parentformIdList.contains(t):![this.form.json.id].contains(t))},checkSubformUnique:function(t){return!t||(!this.form.subformLoaded||!this.form.subformLoaded.contains(t))},getParentformIdList:function(){var t;return this.parentformIdList?(t=Array.clone(this.parentformIdList)).push(this.subformData.json.id):t=[this.form.json.id,this.subformData.json.id],t},loadSubform:function(){if(this.subformData)if(this.checkSubformNested(this.subformData.json.id))if(this.checkSubformUnique(this.subformData.json.id)){this.loadCss(),this.node.set("html",this.subformData.html),Object.each(this.subformData.json.moduleList,function(t,s){var o=s;if(this.form.json.moduleList[s]){o=this.json.id+"_"+s;var i=this.node.getElement("#"+s);i&&i.set("id",o),t.id=o}this.form.json.moduleList[o]=t}.bind(this)),this.form._getModuleNodes(this.node).each(function(t){if("form"!==t.get("MWFtype")){var s=this,o=this.form._getDomjson(t),i=this.form._loadModule(o,t,(function(){this.parentformIdList=s.getParentformIdList()}));this.form.modules.push(i)}}.bind(this)),this.form.subformLoaded.push(this.subformData.json.id)}else this.form.notice(MWF.xApplication.process.Xform.LP.subformUniqueError,"error");else this.form.notice(MWF.xApplication.process.Xform.LP.subformNestedError,"error");this.checked||(this.form.subformLoadedCount?this.form.subformLoadedCount++:this.form.subformLoadedCount=1,this.form.checkSubformLoaded()),this.loaded=!0,this.checked=!0},getSubform:function(t){var s="Mobile"===this.form.json.mode||layout.mobile?"getFormMobile":"getForm";if("script"===this.json.subformType){if(this.json.subformScript&&this.json.subformScript.code){var o,i=this.form.Macro.exec(this.json.subformScript.code,this);if(i)"string"===typeOf(i)?o=i:(i.application&&(e=i.application),i.subform&&(o=i.subform)),o?(e||(e=(this.form.businessData.work||this.form.businessData.workCompleted).application),MWF.Actions.get("x_processplatform_assemble_surface")[s](o,e,function(s){this.getSubformData(s.data),t&&t()}.bind(this))):t&&t();else t&&t()}}else if(this.json.subformSelected&&"none"!==this.json.subformSelected){var e,r=this.form.app.relatedFormMap?this.form.app.relatedFormMap[this.json.subformSelected]:null;if(r)this.getSubformData({data:r.data}),t&&t();else e=this.json.subformAppSelected?this.json.subformAppSelected:(this.form.businessData.work||this.form.businessData.workCompleted).application,MWF.Actions.get("x_processplatform_assemble_surface")[s](this.json.subformSelected,e,function(s){this.getSubformData(s.data),t&&t()}.bind(this))}else t&&t()},getSubformData:function(t){if(t&&"object"===typeOf(t)){var s;s=t.data,this.subformData=null,s&&(this.subformData=JSON.decode(MWF.decodeJsonString(s)),this.subformData.updateTime=t.updateTime)}}}),MWF.xApplication.process.Xform.SubmitForm=MWF.APPSubmitform=new Class({Extends:MWF.APPSubform,_loadUserInterface:function(){this.getSubform(function(){this.loadSubform()}.bind(this))},reload:function(){this.getSubform(function(){this.loadSubform()}.bind(this))},show:function(){this.json.submitScript&&this.json.submitScript.code&&this.form.Macro.exec(this.json.submitScript.code,this)},loadSubform:function(){if(this.subformData)if(this.checkSubformUnique(this.subformData.json.id))if(this.checkSubformNested(this.subformData.json.id)){this.loadCss(),this.node.set("html",this.subformData.html),Object.each(this.subformData.json.moduleList,function(t,s){var o=s;if(this.form.json.moduleList[s]){o=this.json.id+"_"+s;var i=this.node.getElement("#"+s);i&&i.set("id",o),t.id=o}this.form.json.moduleList[o]=t}.bind(this)),this.form._getModuleNodes(this.node).each(function(t){if("form"!==t.get("MWFtype")){var s=this,o=this.form._getDomjson(t),i=this.form._loadModule(o,t,(function(){this.parentformIdList=s.getParentformIdList()}));this.form.modules.push(i)}}.bind(this)),this.form.subformLoaded.push(this.subformData.json.id),this.fireEvent("afterModulesLoad")}else this.form.notice(MWF.xApplication.process.Xform.LP.subformNestedError,"error");else this.isEmbedded=!0,this.fireEvent("afterModulesLoad")},getSubform:function(t){var s="Mobile"===this.form.json.mode||layout.mobile?"getFormMobile":"getForm";if("script"===this.json.submitFormType){if(this.json.submitFormScript&&this.json.submitFormScript.code){var o,i,e=this.form.Macro.exec(this.json.submitFormScript.code,this);if(e)"string"===typeOf(e)?o=e:(e.application&&(i=e.application),e.form&&(o=e.form)),o?(i||(i=(this.form.businessData.work||this.form.businessData.workCompleted).application),MWF.Actions.get("x_processplatform_assemble_surface")[s](o,i,function(s){this.getSubformData(s.data),t&&t()}.bind(this))):t&&t();else t&&t()}}else this.json.submitFormSelected&&"none"!==this.json.submitFormSelected?(i=this.json.submitFormAppSelected?this.json.submitFormAppSelected:(this.form.businessData.work||this.form.businessData.workCompleted).application,MWF.Actions.get("x_processplatform_assemble_surface")[s](this.json.submitFormSelected,i,function(s){this.getSubformData(s.data),t&&t()}.bind(this))):t&&t()}});