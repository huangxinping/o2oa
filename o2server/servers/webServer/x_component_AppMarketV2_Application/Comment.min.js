MWF.xApplication.AppMarketV2.Application.Comment=new Class({Implements:[Options,Events],options:{view:"applicationComment.html"},initialize:function(t,e,i){this.setOptions(i),this.app=t,this.appdata=this.app.appdata,this.container=e,this.viewPath=this.app.path+this.app.options.style+"/"+this.options.view,this.iconPath=this.app.path+this.app.options.style+"/icon/",this.actions=MWF.Actions.load("x_program_center"),this.load()},load:function(){this.container.loadHtml(this.viewPath,{bind:{lp:this.app.lp},module:this},function(){this.loadApplication(function(){this.fireEvent("load")}.bind(this))}.bind(this))},loadApplication:function(t){this.isLoading||(this.applicationsContentV?this.applicationsContentV.load():this.applicationsContentV=new MWF.xApplication.AppMarketV2.Application.Comment.ViewPage(this,{onLoad:function(){t&&t()}}))}}),MWF.xApplication.AppMarketV2.Application.Comment.ViewPage=new Class({Implements:[Options,Events],options:{type:"commentViewPage"},initialize:function(t,e){this.setOptions(e),this.content=t,this.app=this.content.app,this.appdata=this.content.appdata,this.actions=this.app.actions,this.container=this.content.container,this.page=1,this.pageSize=100,this.querydata={},this.load()},load:function(){""==this.app.collectToken||""==this.app.collectUrl?this.actions.CollectAction.login(function(t){t.type&&"success"==t.type&&(data=t.data,this.app.collectUrl=data.collectUrl,this.app.collectToken=data.collectToken,this.loadCommentsGrade(this,this.commentsGrade.bind(this)),this.loadCommentPower(this,this.commentsPower.bind(this)),this.loadCommentsList(this,this.commentsView.bind(this)))}.bind(this),null,!1):(this.loadCommentsGrade(this,this.commentsGrade.bind(this)),this.loadCommentPower(this,this.commentsPower.bind(this)),this.loadCommentsList(this,this.commentsView.bind(this)))},loadCommentsGrade:function(t,e){var i=t.app.collectUrl+"/o2_collect_assemble/jaxrs/comment/stat/grade/app/"+t.appdata.id+"?time="+(new Date).getMilliseconds();new Request.JSON({url:i,headers:{"x-debugger":!0,Authorization:t.app.collectToken,"c-token":t.app.collectToken},secure:!1,method:"get",async:!0,withCredentials:!0,contentType:"application/json",crossDomain:!0,onSuccess:function(t,i){t,"function"==typeOf(e).toLowerCase()?e(t):o2.runCallback(e,"success",[t,i])}.bind(this),onFailure:function(t){o2.runCallback(e,"requestFailure",[t])}.bind(this),onError:function(t,i){o2.runCallback(e,"error",[t,i])}.bind(this)}).send()},loadCommentPower:function(t,e){var i=t.app.collectUrl+"/o2_collect_assemble/jaxrs/comment/app/"+t.appdata.id+"/available?time="+(new Date).getMilliseconds();new Request.JSON({url:i,headers:{"x-debugger":!0,Authorization:t.app.collectToken,"c-token":t.app.collectToken},secure:!1,method:"get",async:!0,withCredentials:!0,contentType:"application/json",crossDomain:!0,onSuccess:function(t,i){t,"function"==typeOf(e).toLowerCase()?e(t):o2.runCallback(e,"success",[t,i])}.bind(this),onFailure:function(t){o2.runCallback(e,"requestFailure",[t])}.bind(this),onError:function(t,i){o2.runCallback(e,"error",[t,i])}.bind(this)}).send()},loadCommentsList:function(t,e){var i=t.app.collectUrl+"/o2_collect_assemble/jaxrs/comment/list/app/"+t.appdata.id+"?time="+(new Date).getMilliseconds();new Request.JSON({url:i,headers:{"x-debugger":!0,Authorization:t.app.collectToken,"c-token":t.app.collectToken},secure:!1,method:"get",async:!0,withCredentials:!0,contentType:"application/json",crossDomain:!0,onSuccess:function(t,i){t,"function"==typeOf(e).toLowerCase()?e(t):o2.runCallback(e,"success",[t,i])}.bind(this),onFailure:function(t){o2.runCallback(e,"requestFailure",[t])}.bind(this),onError:function(t,i){o2.runCallback(e,"error",[t,i])}.bind(this)}).send()},commentsGrade:function(t){var e=0,i=0,n=0,a=t.data,o=["0","0","0","0","0"];a.each(function(t){o[parseInt(t.grade)-1]=t.count,e+=parseInt(t.count)}.bind(this)),o.each((function(t,e){n+=parseInt(t)*(e+1)})),e>0&&(i=this.numberFix(n/e,1)),this.content.applicationcommenttopgrade.set("text",i+"");for(var c=parseInt(i),r=i-c,l=0;l<c;l++)new Element("img",{src:this.content.iconPath+"blackfiveangular.png",class:"o2_appmarket_application_introduce_memo_remark_inner_pic"}).inject(this.content.applicationcommenttopangular);r>=.5&&(new Element("img",{src:this.content.iconPath+"halffiveangular.png",class:"o2_appmarket_application_introduce_memo_remark_inner_pic"}).inject(this.content.applicationcommenttopangular),c++);for(l=0;l<5-c;l++)new Element("img",{src:this.content.iconPath+"whitefiveangular.png",class:"o2_appmarket_application_introduce_memo_remark_inner_pic"}).inject(this.content.applicationcommenttopangular);new Element("span",{class:"o2_appmarket_application_introduce_memo_remark_inner_text",text:"共"+e+"个评分"}).inject(this.content.applicationcommenttopangular),new Element("div",{text:"5",class:"o2_appmarket_application_comment_top_right_graderatioItem"}).inject(this.content.applicationcommentrightfive),gradeangular=new Element("div",{class:"o2_appmarket_application_comment_top_right_graderatioItem"}).inject(this.content.applicationcommentrightfive),new Element("img",{src:this.content.iconPath+"blackfiveangular.png",class:"o2_appmarket_application_introduce_memo_remark_inner_pic"}).inject(gradeangular),graderatiodiv=new Element("div",{class:"o2_appmarket_application_comment_gradetotal"}).inject(this.content.applicationcommentrightfive),blackratiodiv=new Element("div",{class:"o2_appmarket_application_comment_graderatio"}).inject(graderatiodiv),graderratiodivwidth=graderatiodiv.clientWidth,0==e?(blackratio=0,blackratiodiv.setStyle("width","0px")):(blackratio=parseInt(o[4])/e,blackratiowidth=blackratio*graderratiodivwidth,blackratiodiv.setStyle("width",blackratiowidth+"px")),new Element("div",{text:this.numberFix(100*blackratio,1)+"%",class:"o2_appmarket_application_comment_top_right_graderatioItem"}).inject(this.content.applicationcommentrightfive),new Element("div",{text:"4",class:"o2_appmarket_application_comment_top_right_graderatioItem"}).inject(this.content.applicationcommentrightfour),gradeangular=new Element("div",{class:"o2_appmarket_application_comment_top_right_graderatioItem"}).inject(this.content.applicationcommentrightfour),new Element("img",{src:this.content.iconPath+"blackfiveangular.png",class:"o2_appmarket_application_introduce_memo_remark_inner_pic"}).inject(gradeangular),graderatiodiv=new Element("div",{class:"o2_appmarket_application_comment_gradetotal"}).inject(this.content.applicationcommentrightfour),blackratiodiv=new Element("div",{class:"o2_appmarket_application_comment_graderatio"}).inject(graderatiodiv),graderratiodivwidth=graderatiodiv.clientWidth,0==e?(blackratio=0,blackratiodiv.setStyle("width","0px")):(blackratio=parseInt(o[3])/e,blackratiowidth=blackratio*graderratiodivwidth,blackratiodiv.setStyle("width",blackratiowidth+"px")),new Element("div",{text:this.numberFix(100*blackratio,1)+"%",class:"o2_appmarket_application_comment_top_right_graderatioItem"}).inject(this.content.applicationcommentrightfour),new Element("div",{text:"3",class:"o2_appmarket_application_comment_top_right_graderatioItem"}).inject(this.content.applicationcommentrightthree),gradeangular=new Element("div",{class:"o2_appmarket_application_comment_top_right_graderatioItem"}).inject(this.content.applicationcommentrightthree),new Element("img",{src:this.content.iconPath+"blackfiveangular.png",class:"o2_appmarket_application_introduce_memo_remark_inner_pic"}).inject(gradeangular),graderatiodiv=new Element("div",{class:"o2_appmarket_application_comment_gradetotal"}).inject(this.content.applicationcommentrightthree),blackratiodiv=new Element("div",{class:"o2_appmarket_application_comment_graderatio"}).inject(graderatiodiv),graderratiodivwidth=graderatiodiv.clientWidth,0==e?(blackratio=0,blackratiodiv.setStyle("width","0px")):(blackratio=(parseInt(o[2])/e).toFixed(4),blackratiowidth=blackratio*graderratiodivwidth,blackratiodiv.setStyle("width",blackratiowidth+"px")),new Element("div",{text:this.numberFix(100*blackratio,1)+"%",class:"o2_appmarket_application_comment_top_right_graderatioItem"}).inject(this.content.applicationcommentrightthree),new Element("div",{text:"2",class:"o2_appmarket_application_comment_top_right_graderatioItem"}).inject(this.content.applicationcommentrighttwo),gradeangular=new Element("div",{class:"o2_appmarket_application_comment_top_right_graderatioItem"}).inject(this.content.applicationcommentrighttwo),new Element("img",{src:this.content.iconPath+"blackfiveangular.png",class:"o2_appmarket_application_introduce_memo_remark_inner_pic"}).inject(gradeangular),graderatiodiv=new Element("div",{class:"o2_appmarket_application_comment_gradetotal"}).inject(this.content.applicationcommentrighttwo),blackratiodiv=new Element("div",{class:"o2_appmarket_application_comment_graderatio"}).inject(graderatiodiv),graderratiodivwidth=graderatiodiv.clientWidth,0==e?(blackratio=0,blackratiodiv.setStyle("width","0px")):(blackratio=(parseInt(o[1])/e).toFixed(4),blackratiowidth=blackratio*graderratiodivwidth,blackratiodiv.setStyle("width",blackratiowidth+"px")),new Element("div",{text:this.numberFix(100*blackratio,1)+"%",class:"o2_appmarket_application_comment_top_right_graderatioItem"}).inject(this.content.applicationcommentrighttwo),new Element("div",{text:"1",class:"o2_appmarket_application_comment_top_right_graderatioItem"}).inject(this.content.applicationcommentrightone),gradeangular=new Element("div",{class:"o2_appmarket_application_comment_top_right_graderatioItem"}).inject(this.content.applicationcommentrightone),new Element("img",{src:this.content.iconPath+"blackfiveangular.png",class:"o2_appmarket_application_introduce_memo_remark_inner_pic"}).inject(gradeangular),graderatiodiv=new Element("div",{class:"o2_appmarket_application_comment_gradetotal"}).inject(this.content.applicationcommentrightone),blackratiodiv=new Element("div",{class:"o2_appmarket_application_comment_graderatio"}).inject(graderatiodiv),graderratiodivwidth=graderatiodiv.clientWidth,0==e?(blackratio=0,blackratiodiv.setStyle("width","0px")):(blackratio=(parseInt(o[0])/e).toFixed(4),blackratiowidth=blackratio*graderratiodivwidth,blackratiodiv.setStyle("width",blackratiowidth+"px")),new Element("div",{text:this.numberFix(100*blackratio,1)+"%",class:"o2_appmarket_application_comment_top_right_graderatioItem"}).inject(this.content.applicationcommentrightone)},commentsPower:function(t){var e="";if(t.type&&"success"==t.type&&t.data.value&&(e="您已评论过该应用！"),""==this.appdata.installedVersion&&(e="由于您还未安装本应用，因此无法对其进行评分及评论！"),""==e){var i=new Element("div",{class:"o2_appmarket_application_comment_middle_commentbutton"}).inject(this.content.applicationcommentmiddle);new Element("span",{class:"o2_appmarket_application_comment_middle_commentbutton_InnerSpan",text:"我要评分及评论"}).inject(i);var n=this;i.addEvents({click:function(t){n.createComment(t)}})}else new Element("div",{class:"o2_appmarket_application_comment_middle_tip",text:e}).inject(this.content.applicationcommentmiddle)},commentsView:function(t){t.data.each(function(t){var e=new Element("div",{class:"o2_appmarket_application_comment_content"}).inject(this.content.applicationcommentbottom),i=new Element("div",{class:"o2_appmarket_application_comment_content_left"}).inject(e),n=new Element("div",{class:"o2_appmarket_application_comment_content_left_icon"}).inject(i);new Element("img",{src:this.content.iconPath+"icon_men.png"}).inject(n),new Element("div",{class:"o2_appmarket_application_comment_content_left_name",text:t.person}).inject(i);for(var a=new Element("div",{class:"o2_appmarket_application_comment_content_right"}).inject(e),o=new Element("div").inject(a),c=0;c<parseInt(t.grade);c++)new Element("img",{src:this.content.iconPath+"blackfiveangular.png",class:"o2_appmarket_application_introduce_memo_remark_inner_pic"}).inject(o);for(c=0;c<5-parseInt(t.grade);c++)new Element("img",{src:this.content.iconPath+"whitefiveangular.png",class:"o2_appmarket_application_introduce_memo_remark_inner_pic"}).inject(o);new Element("div",{class:"o2_appmarket_application_comment_content_title",text:t.title}).inject(a),new Element("div",{class:"o2_appmarket_application_comment_content_text",text:t.comment,title:t.comment}).inject(a)}.bind(this))},reload:function(){this.content.isLoading||(this.loadComments(),this.loadCommentPower())},emptyLoadContent:function(){this.content.commentnode.empty(),this.content.isLoading=!1},createComment:function(t){var e,i=new Element("div",{styles:{margin:"20px"}}),n=new Element("div").inject(i);new Element("div",{class:"comment_dlg_title",text:"评分："}).inject(n),xingpngdiv=new Element("div",{class:"comment_dlg_png"}).inject(n);for(var a=this,o=0,c=0;c<5;c++)(e=new Element("img",{src:this.content.iconPath+"whitefiveangular.png",class:c+"star comment_dlg_star"}).inject(xingpngdiv)).store("id",c),e.addEvents({click:function(t){var e=this.retrieve("id");o=e+1;for(var i=this,n=this.nextElementSibling;n;)n.set("src",a.content.iconPath+"whitefiveangular.png"),n=n.nextElementSibling;for(;i;)i.set("src",a.content.iconPath+"blackfiveangular.png"),i=i.previousElementSibling}});new Element("div",{style:"clear:both"}).inject(i);var r=new Element("div").inject(i);new Element("div",{class:"comment_dlg_title",text:"评论："}).inject(r),inputdiv=new Element("div",{class:"comment_dlg_input_div"}).inject(r),commentcontentNode=new Element("textarea",{class:"comment_dlg_input"}).inject(inputdiv),o2.DL.open({title:this.app.lp.commentTitle,content:i,width:740,height:520,buttonList:[{text:this.app.lp.ok,class:"comment_dlg_button_ok",action:function(){if(0==o||""==commentcontentNode.get("value"))MWF.xDesktop.notice("error",{x:"right",y:"top"},"请评分，评论后提交");else{var t={title:""};t.application=a.appdata.id,t.grade=o+"",t.comment=commentcontentNode.get("value"),a.submitComment(t),this.close()}}},{text:this.app.lp.cancel,class:"comment_dlg_button_cancel",action:function(){this.close()}}]})},submitComment:function(t){JSON.stringify(t);var e=this.app.collectUrl+"/o2_collect_assemble/jaxrs/comment";new Request.JSON({url:e,headers:{"Content-Type":"application/json; charset=utf-8","x-debugger":!0,Authorization:this.app.collectToken,"c-token":this.app.collectToken},secure:!1,method:"POST",secure:!1,emulation:!1,noCache:!0,withCredentials:!0,crossDomain:!0,data:JSON.stringify(t),onSuccess:function(t,e){MWF.xDesktop.notice("success",{x:"right",y:"top"},this.app.lp.commentsuccess),this.app.loadIntroduceComment()}.bind(this),onFailure:function(t){MWF.xDesktop.notice("error",{x:"right",y:"top"},t)}.bind(this),onError:function(t,e){MWF.xDesktop.notice("error",{x:"right",y:"top"},t)}.bind(this)}).send()},numberFix:function(t,e){for(var i="",n=0;n<e;n++)i+="0";var a=1+i,o=Math.round(parseFloat(t)*a)/a,c=o.toString().split(".");return 1==c.length?o=o.toString():c.length>1?(c[1].length<e&&(o=o.toString()+"0"),o):void 0}});