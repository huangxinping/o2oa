MWF.xApplication.ExeManager=MWF.xApplication.ExeManager||{},MWF.xDesktop.requireApp("Template","Explorer",null,!1),MWF.xDesktop.requireApp("Template","MPopupForm",null,!1),MWF.xDesktop.requireApp("Template","MForm",null,!1),MWF.xDesktop.requireApp("ExeManager","Attachment",null,!1),MWF.require("MWF.widget.Identity",null,!1),MWF.xApplication.ExeManager.IndentityList=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default"},initialize:function(t,e,i,n){this.setOptions(n),this.app=e,this.lp=e.lp,this.path="../x_component_ExeManager/$IndentityList/",this.loadCss(),this.actions=i,this.node=$(t)},loadCss:function(){this.cssPath="../x_component_ExeManager/$IndentityList/"+this.options.style+"/css.wcss",this._loadCss()},load:function(){this.middleContent=this.app.middleContent,this.middleContent.setStyles({"margin-top":"0px",border:"0px solid #f00","background-color":"#ffffff"}),this.createToolBarContent(),this.createContentDiv(),this.resizeWindow(),this.app.addEvent("resize",function(){this.resizeWindow()}.bind(this))},reload:function(){this.createToolBarContent(),this.createContentDiv()},resizeWindow:function(){var t=this.app.middleContent.getSize();this.contentDiv.setStyles({height:t.y-110+"px"})},createToolBarContent:function(){this.toolBarDiv&&this.toolBarDiv.destroy(),this.toolBarDiv=new Element("div.toolBarDiv",{styles:this.css.toolBarDiv}).inject(this.middleContent),this.toolBarActionDiv=new Element("div.toolBarActionDiv",{styles:this.css.toolBarActionDiv}).inject(this.toolBarDiv),this.toolBarSearchDiv=new Element("div.toolBarSearchDiv",{styles:this.css.toolBarSearchDiv}).inject(this.toolBarDiv),this.toolBarSearchInput=new Element("input.toolBarSearchInput",{styles:this.css.toolBarSearchInput}).inject(this.toolBarSearchDiv),this.toolBarSearchInput.addEvents({keyup:function(t){13==t.code&&this.searchView(this.toolBarSearchInput.get("value"))}.bind(this)}),this.toolBarSearchActionBtn=new Element("div.toolBarSearchBtn",{styles:this.css.toolBarSearchBtn,text:this.lp.IndentityList.searchAction}).inject(this.toolBarSearchDiv),this.toolBarSearchActionBtn.addEvents({click:function(){this.searchView(this.toolBarSearchInput.get("value"))}.bind(this)}),this.toolBarStatusDiv=new Element("div.toolBarStatusDiv",{styles:this.css.toolBarStatusDiv}).inject(this.toolBarDiv),this.toolBarStatusDiv.setStyle("display","none"),this.toolBarStatusAllDiv=new Element("div.toolBarStatusAllDiv",{styles:this.css.toolBarStatusAllDiv}).inject(this.toolBarStatusDiv),this.toolBarStatusPercentDiv=new Element("div.toolBarStatusPercentDiv",{styles:this.css.toolBarStatusPercentDiv}).inject(this.toolBarStatusDiv)},createContentDiv:function(t){this.contentDiv&&this.contentDiv.destroy(),this.contentDiv=new Element("div.contentDiv",{styles:this.css.contentDiv}).inject(this.middleContent),this.scrollBar&&this.scrollBar.scrollVAreaNode&&this.scrollBar.scrollVAreaNode.destroy(),MWF.require("MWF.widget.ScrollBar",function(){this.scrollBar=new MWF.widget.ScrollBar(this.contentDiv,{indent:!1,style:"xApp_TaskList",where:"before",distance:30,friction:4,axis:{x:!1,y:!0},onScroll:function(t){var e=this.contentDiv.getScrollSize(),i=this.contentDiv.getSize(),n=e.y-i.y,s=this.view;t+200>n&&s&&s.loadElementList&&(s.isItemsLoaded||s.loadElementList())}.bind(this)})}.bind(this),!1);var e=this.path+"listItem.json",i={identity:t};this.view&&delete this.view,this.view=new MWF.xApplication.ExeManager.IndentityList.View(this.contentDiv,this.app,{explorer:this,lp:this.lp.IndentityList,css:this.css,actions:this.actions},{templateUrl:e,category:"",filterData:i}),this.view.load()},searchView:function(t){this.createContentDiv(t),this.resizeWindow()},showErrorMsg:function(t,e,i){var n,s=i;t&&(n=t.responseText);try{var o=JSON.parse(n);o&&o.message?this.app.notice(o.message,"error"):this.app.notice(s,"error")}catch(o){this.app.notice("failure","error")}}}),MWF.xApplication.ExeManager.IndentityList.View=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexView,_createDocument:function(t){return new MWF.xApplication.ExeManager.IndentityList.Document(this.viewNode,t,this.explorer,this)},_getCurrentPageData:function(t,e){e||(e=20);var i=this.items.length?this.items[this.items.length-1].data.id:"(0)",n=this.options.filterData||{};"(0)"==i&&this.app.createShade(),this.actions.getErrorIndentitytNext(i,e,n,function(e){t&&t(e),this.app.destroyShade()}.bind(this),function(t,e,i){this.explorer.explorer.showErrorMsg(t,e,i)}.bind(this))},_create:function(){},_openDocument:function(t){this.indentityForm=new MWF.xApplication.ExeManager.IndentityList.IndentityForm(this.explorer.explorer,this.actions,t,{isNew:!1,isEdited:!1,onReloadView:function(t){this.app.topBarContent.getElements(".topBarLi").each(function(t){"topIndentity"==t.get("id")&&t.click()}.bind(this))}.bind(this)}),this.indentityForm.load()},_queryCreateViewNode:function(){},_postCreateViewNode:function(t){},_queryCreateViewHead:function(){},_postCreateViewHead:function(t){}}),MWF.xApplication.ExeManager.IndentityList.Document=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexDocument,action_open:function(t){}}),MWF.xApplication.ExeManager.IndentityList.IndentityForm=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"default",width:"90%",height:"100%",top:0,left:0,hasTop:!0,hasIcon:!1,hasBottom:!0,title:"",draggable:!1,closeAction:!0,isNew:!1,isEdited:!1},initialize:function(t,e,i,n){this.setOptions(n),this.explorer=t,this.app=t.app,this.lp=this.app.lp.indentityForm,this.actions=this.app.restActions,this.path="../x_component_ExeManager/$IndentityList/",this.cssPath=this.path+this.options.style+"/indentityForm.wcss",this._loadCss(),this.options.title=this.lp.title,this.data=i||{},this.actions=e},load:function(){if(this.data.id){var t={identity:this.data.identity};this.actions.getErrorIdentityDetail(t,function(t){t.data&&(this.detailsData=t.data)}.bind(this),null,!1)}this.options.isNew?this.create():this.options.isEdited?this.edit():this.open()},_open:function(){if(this.formMarkNode=new Element("div.formMarkNode",{styles:this.css.formMarkNode,events:{mouseover:function(t){t.stopPropagation()},mouseout:function(t){t.stopPropagation()},click:function(t){t.stopPropagation()}}}).inject(this.app.content),this.formAreaNode=new Element("div.formAreaNode",{styles:this.css.formAreaNode}),this.createFormNode(),this.formAreaNode.inject(this.formMarkNode,"after"),this.formAreaNode.fade("in"),this.setFormNodeSize(),this.setFormNodeSizeFun=this.setFormNodeSize.bind(this),this.app.addEvent("resize",this.setFormNodeSizeFun),this.options.draggable&&this.formTopNode){var t=this.app.content.getSize(),e=this.formAreaNode.getSize();this.formAreaNode.makeDraggable({handle:this.formTopNode,limit:{x:[0,t.x-e.x],y:[0,t.y-e.y]}})}},_close:function(){this.formMarkNode&&this.formMarkNode.destroy()},createTopNode:function(){this.formTopNode||(this.formTopNode=new Element("div.formTopNode",{styles:this.css.formTopNode}).inject(this.formNode),this.formTopIconNode=new Element("div",{styles:this.css.formTopIconNode}).inject(this.formTopNode),this.formTopTextNode=new Element("div",{styles:this.css.formTopTextNode,text:this.options.title}).inject(this.formTopNode),this.options.closeAction&&(this.formTopCloseActionNode=new Element("div",{styles:this.css.formTopCloseActionNode}).inject(this.formTopNode),this.formTopCloseActionNode.addEvent("click",function(){this.close()}.bind(this))),this.formTopContentNode=new Element("div",{styles:this.css.formTopContentNode}).inject(this.formTopNode),this._createTopContent())},_createTopContent:function(){},_createTableContent:function(){if(this.formTableArea&&this.formTableArea.empty(),this.modifyDiv=new Element("div.modifyDiv",{styles:this.css.modifyDiv}).inject(this.formTableArea),this.oldIdentitySpan=new Element("span.oldIdentitySpan",{styles:this.css.oldIdentitySpan,text:this.lp.oldIdentity+": "+this.data.identity}).inject(this.modifyDiv),this.newIdentitySpan=new Element("span.newIdentitySpan",{styles:this.css.newIdentitySpan,text:this.lp.newIdentity+": "}).inject(this.modifyDiv),this.newIdentityInput=new Element("input.newIdentityInput",{styles:this.css.newIdentityInput,readonly:!0,type:"text"}).inject(this.modifyDiv),this.newIdentityInput.addEvents({click:function(){this.selectPerson(this.newIdentityInput,"identity")}.bind(this)}),this.modifyBottonDiv=new Element("div.modifyBottonDiv",{styles:this.css.modifyBottonDiv,text:this.lp.modify}).inject(this.modifyDiv),this.modifyBottonDiv.addEvents({click:function(t){""==this.newIdentityInput.get("value")?this.app.notice(this.lp.newIdentityEmpty,"error"):this.replaceIdentity(t)}.bind(this)}),this.contentDiv=new Element("div.contentDiv",{styles:this.css.contentDiv}).inject(this.formTableArea),this.naviTabDiv=new Element("div.naviTabDiv",{styles:this.css.naviTabDiv}).inject(this.contentDiv),this.detailsData){var t=this;this.detailsData.each(function(e){new Element("li.categoryLi",{styles:this.css.categoryLi,text:e.recordType}).inject(this.naviTabDiv).addEvents({click:function(){t.loadList(this)}})}.bind(t)),t.naviTabDiv.getElements("li")[0].click()}},_createBottomContent:function(){this.cancelActionNode=new Element("div.formCancelActionNode",{styles:this.css.formCancelActionNode,text:this.lp.close}).inject(this.formBottomNode),this.cancelActionNode.addEvent("click",function(t){this.cancel(t)}.bind(this))},loadList:function(t){this.naviTabDiv.getElements("li").setStyles({"border-bottom":""}),t.setStyles({"border-bottom":"2px solid #124c93"}),this.contentList&&this.contentList.destroy(),this.contentList=new Element("div.contentList",{styles:this.css.contentList}).inject(this.formTableArea),this.table&&this.table.destroy(),this.table=new Element("table.table",{styles:{width:"100%"}}).inject(this.contentList);var e=new Element("tr.tr").inject(this.table);new Element("td.td",{text:this.lp.tableTitle,align:"left",styles:{"padding-left":"200px","font-weight":"bold"}}).inject(e);this.detailsData.each(function(e){e.recordType==t.get("text")&&(this.listData=e.errorRecords)}.bind(this)),this.listData.each(function(t,i){var n=i%2==0?"#f1f1f1":"#fff";(e=new Element("tr.tr").inject(this.table)).setStyles({"background-color":n}),new Element("td.td",{styles:this.css.tableTd,text:t.title}).inject(e)}.bind(this))},replaceIdentity:function(t){var e=this;this.app.confirm("warn",t,this.lp.warn.warnTitle,this.lp.warn.warnContent,300,120,(function(){var t={oldIdentity:e.data.identity,newIdentity:e.newIdentityInput.get("value"),recordType:"all",recordId:"all",tableName:"all"};e.app.createShade(),e.actions.replaceErrorIdentity(t,function(t){e.app.notice(e.lp.modifySuccess,"success"),e.app.destroyShade(),e.close(),e.fireEvent("reloadView")}.bind(e),function(t,i,n){e.app.showErrorMessage(t,i,n),e.app.destroyShade()}.bind(e)),this.close()}),(function(){this.close()}))},selectPerson:function(t,e){MWF.xDesktop.requireApp("Organization","Selector.package",null,!1),this.fireEvent("querySelect",this);var i={type:e,title:"select",count:1,names:t.get("value").split(this.valSeparator)||[],onComplete:function(e){var i=[];e.each(function(t){i.push(t.data.name)}.bind(this)),t.set("value",i.join(","))}.bind(this)};new MWF.OrgSelector(this.app.content,i)}});