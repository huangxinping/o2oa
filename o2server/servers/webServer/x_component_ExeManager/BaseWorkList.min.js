function removeDoc(t){alert("before="+t.length),alert("after="+t.length),window.setInterval((function(){alert("in="+t.length)}),2e3)}MWF.xApplication.ExeManager=MWF.xApplication.ExeManager||{},MWF.xDesktop.requireApp("Template","Explorer",null,!1),MWF.xDesktop.requireApp("Template","MPopupForm",null,!1),MWF.xDesktop.requireApp("Template","MForm",null,!1),MWF.xDesktop.requireApp("ExeManager","Attachment",null,!1),MWF.require("MWF.widget.Identity",null,!1),MWF.xApplication.ExeManager.BaseWorkList=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default"},initialize:function(t,e,i,s){this.setOptions(s),this.app=e,this.lp=e.lp,this.path="../x_component_ExeManager/$BaseWorkList/",this.loadCss(),this.actions=i,this.node=$(t)},loadCss:function(){this.cssPath="../x_component_ExeManager/$BaseWorkList/"+this.options.style+"/css.wcss",this._loadCss()},load:function(){this.middleContent=this.app.middleContent,this.middleContent.setStyles({"margin-top":"0px",border:"0px solid #f00","background-color":"#ffffff"}),this.createToolBarContent(),this.createContentDiv(),this.resizeWindow(),this.app.addEvent("resize",function(){this.resizeWindow()}.bind(this))},reload:function(){this.createToolBarContent(),this.createContentDiv()},resizeWindow:function(){var t=this.app.middleContent.getSize();this.contentDiv.setStyles({height:t.y-110+"px"})},createToolBarContent:function(){this.toolBarDiv&&this.toolBarDiv.destroy(),this.toolBarDiv=new Element("div.toolBarDiv",{styles:this.css.toolBarDiv}).inject(this.middleContent),this.toolBarActionDiv=new Element("div.toolBarActionDiv",{styles:this.css.toolBarActionDiv}).inject(this.toolBarDiv),this.toolBarActionBRemoveBtn=new Element("div.toolBarActionBRemoveBtn",{styles:this.css.toolBarActionBtn,text:this.lp.baseWorkList.remove}).inject(this.toolBarActionDiv),this.toolBarActionBRemoveBtn.addEvents({click:function(t){this.checkedDoc=this.view.getCheckedItems(),this.removeDocument(t)}.bind(this)}),this.toolBarSearchDiv=new Element("div.toolBarSearchDiv",{styles:this.css.toolBarSearchDiv}).inject(this.toolBarDiv),this.toolBarSearchInput=new Element("input.toolBarSearchInput",{styles:this.css.toolBarSearchInput}).inject(this.toolBarSearchDiv),this.toolBarSearchInput.addEvents({keyup:function(t){13==t.code&&this.searchView(this.toolBarSearchInput.get("value"))}.bind(this)}),this.toolBarSearchActionBtn=new Element("div.toolBarSearchBtn",{styles:this.css.toolBarSearchBtn,text:this.lp.baseWorkList.searchAction}).inject(this.toolBarSearchDiv),this.toolBarSearchActionBtn.addEvents({click:function(t){this.searchView(this.toolBarSearchInput.get("value"))}.bind(this)}),this.toolBarStatusDiv=new Element("div.toolBarStatusDiv",{styles:this.css.toolBarStatusDiv}).inject(this.toolBarDiv),this.toolBarStatusDiv.setStyle("display","none"),this.toolBarStatusAllDiv=new Element("div.toolBarStatusAllDiv",{styles:this.css.toolBarStatusAllDiv}).inject(this.toolBarStatusDiv),this.toolBarStatusPercentDiv=new Element("div.toolBarStatusPercentDiv",{styles:this.css.toolBarStatusPercentDiv}).inject(this.toolBarStatusDiv)},removeDocument:function(t){var e=this,i=!0;this.app.confirm("warn",t,this.lp.baseWorkList.warnTitle,this.lp.baseWorkList.warnContent,300,120,(function(){e.toolBarStatusDiv.setStyle("display",""),__self=this;var t=e.checkedDoc,s=t.length,o=0,a=window.setInterval(function(){if(0!=t.length&&i){var n=++o/s;n*=e.toolBarStatusAllDiv.getSize().x,e.toolBarStatusPercentDiv.set("text",o+"/"+s),e.toolBarStatusPercentDiv.setStyles({width:n+"px"}),i&&t[0].data&&t[0].data.id&&e.actions.deleteBaseWork(t[0].data.id,function(t){}.bind(e),function(s,o,a){e.app.notice(e.lp.baseWorkList.removeResult.failure+":"+t[0].data.title,"error"),i=!1}.bind(e),!1),t=t.slice(1,t.length)}else clearInterval(a),__self.close(),e.reload(),e.resizeWindow()}.bind(e),10)}),(function(){this.close()}))},createContentDiv:function(t){this.contentDiv&&this.contentDiv.destroy(),this.contentDiv=new Element("div.contentDiv",{styles:this.css.contentDiv}).inject(this.middleContent),this.scrollBar&&this.scrollBar.scrollVAreaNode&&this.scrollBar.scrollVAreaNode.destroy(),MWF.require("MWF.widget.ScrollBar",function(){this.scrollBar=new MWF.widget.ScrollBar(this.contentDiv,{indent:!1,style:"xApp_TaskList",where:"before",distance:30,friction:4,axis:{x:!1,y:!0},onScroll:function(t){var e=this.contentDiv.getScrollSize(),i=this.contentDiv.getSize(),s=e.y-i.y,o=this.view;t+200>s&&o&&o.loadElementList&&(o.isItemsLoaded||o.loadElementList())}.bind(this)})}.bind(this),!1),templateUrl=this.path+"listItem.json";var e={filterLikeContent:t};this.view&&delete this.view,this.view=new MWF.xApplication.ExeManager.BaseWorkList.View(this.contentDiv,this.app,{explorer:this,lp:this.lp.baseWorkList,css:this.css,actions:this.actions},{templateUrl:templateUrl,category:"",filterData:e}),this.view.load()},searchView:function(t){this.createContentDiv(t),this.resizeWindow()},showErrorMsg:function(t,e,i){var s=i;t&&(errorMessage=t.responseText);try{var o=JSON.parse(errorMessage);o&&o.message?this.app.notice(o.message,"error"):this.app.notice(s,"error")}catch(o){this.app.notice("failure","error")}}}),MWF.xApplication.ExeManager.BaseWorkList.View=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexView,_createDocument:function(t){return new MWF.xApplication.ExeManager.BaseWorkList.Document(this.viewNode,t,this.explorer,this)},_getCurrentPageData:function(t,e){e||(e=20);var i=this.items.length?this.items[this.items.length-1].data.id:"(0)",s=this.options.filterData||{};"(0)"==i&&this.app.createShade(),this.actions.getBaseWorkListNext(i,e,s,function(e){t&&t(e),this.app.destroyShade()}.bind(this),function(t,e,i){this.explorer.explorer.showErrorMsg(t,e,i)}.bind(this))},_create:function(){},_openDocument:function(t){this.workForm=new MWF.xApplication.ExeManager.BaseWorkList.WorkForm(this.explorer.explorer,this.actions,t,{isNew:!1,isEdited:!1,onPostSave:function(){this.view.explorer.contentChanged=!0}.bind(this)}),this.workForm.load()},_queryCreateViewNode:function(){},_postCreateViewNode:function(t){},_queryCreateViewHead:function(){},_postCreateViewHead:function(t){}}),MWF.xApplication.ExeManager.BaseWorkList.Document=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexDocument,action_remove:function(t){var e=this;this.app.confirm("warn",t,this.lp.warnTitle,this.lp.warnContent,300,120,(function(){e.actions.deleteBaseWork(e.data.id,function(t){e.app.notice(e.lp.removeResult.success,"success"),e.view.explorer.explorer.reload(),e.view.explorer.explorer.resizeWindow()}.bind(e),function(t,i,s){e.view.explorer.explorer.showErrorMsg(t,i,s)}.bind(e),!1),this.close()}),(function(){this.close()}))}}),MWF.xApplication.ExeManager.BaseWorkList.WorkForm=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"default",width:"800",height:"100%",top:0,left:0,hasTop:!0,hasIcon:!1,hasBottom:!0,title:"",draggable:!1,closeAction:!0,isNew:!1,isEdited:!1},initialize:function(t,e,i,s){this.setOptions(s),this.explorer=t,this.app=t.app,this.lp=this.app.lp.baseWorkForm,this.actions=this.app.restActions,this.path="../x_component_ExeManager/$BaseWorkList/",this.cssPath=this.path+this.options.style+"/baseWorkForm.wcss",this._loadCss(),this.options.title=this.lp.title,this.data=i||{},this.actions=e},load:function(){this.data.id&&this.actions.getBaseWorkDetails(this.data.id,function(t){this.data.workSplitAndDescription=t.data.workDetail,this.data.specificActionInitiatives=t.data.progressAction,this.data.cityCompanyDuty=t.data.dutyDescription,this.data.milestoneMark=t.data.landmarkDescription,this.data.importantMatters=t.data.majorIssuesDescription}.bind(this),null,!1),this.options.isNew?this.create():this.options.isEdited?this.edit():this.open()},_open:function(){if(this.formMarkNode=new Element("div.formMarkNode",{styles:this.css.formMarkNode,events:{mouseover:function(t){t.stopPropagation()},mouseout:function(t){t.stopPropagation()},click:function(t){t.stopPropagation()}}}).inject(this.app.content),this.formAreaNode=new Element("div.formAreaNode",{styles:this.css.formAreaNode}),this.createFormNode(),this.formAreaNode.inject(this.formMarkNode,"after"),this.formAreaNode.fade("in"),this.setFormNodeSize(),this.setFormNodeSizeFun=this.setFormNodeSize.bind(this),this.app.addEvent("resize",this.setFormNodeSizeFun),this.options.draggable&&this.formTopNode){var t=this.app.content.getSize(),e=this.formAreaNode.getSize();this.formAreaNode.makeDraggable({handle:this.formTopNode,limit:{x:[0,t.x-e.x],y:[0,t.y-e.y]}})}},createTopNode:function(){this.formTopNode||(this.formTopNode=new Element("div.formTopNode",{styles:this.css.formTopNode}).inject(this.formNode),this.formTopIconNode=new Element("div",{styles:this.css.formTopIconNode}).inject(this.formTopNode),this.formTopTextNode=new Element("div",{styles:this.css.formTopTextNode,text:this.options.title+(this.data.title?"-"+this.data.title:"")}).inject(this.formTopNode),this.options.closeAction&&(this.formTopCloseActionNode=new Element("div",{styles:this.css.formTopCloseActionNode}).inject(this.formTopNode),this.formTopCloseActionNode.addEvent("click",function(){this.close()}.bind(this))),this.formTopContentNode=new Element("div",{styles:this.css.formTopContentNode}).inject(this.formTopNode),this._createTopContent())},_createTopContent:function(){},_close:function(){this.formMarkNode&&this.formMarkNode.destroy()},_createTableContent:function(){this.formTableArea.set("html","<table width='100%' bordr='0' cellpadding='5' cellspacing='0' styles='formTable'><tr>   <td styles='formTableTitle' lable='timeLimit'></td>   <td styles='formTableValue' item='timeLimit'></td>   <td styles='formTableTitle' lable='reportCycle'></td>   <td styles='formTableValue'><span item='reportCycle'></span><span item='reportDay' style='margin-left:5px'></span></td></tr><tr>   <td styles='formTableTitle' lable='dutyDepartment'></td>   <td styles='formTableValue' item='dutyDepartment'></td>   <td styles='formTableTitle' lable='dutyPerson'></td>   <td styles='formTableValue' item='dutyPerson'></td></tr><tr>   <td styles='formTableTitle' lable='secondDepartment'></td>   <td styles='formTableValue' item='secondDepartment'></td>   <td styles='formTableTitle' lable='secondPerson'></td>   <td styles='formTableValue' item='secondPerson'></td></tr><tr>   <td styles='formTableTitle' lable='readReader'></td>   <td styles='formTableValue' item='readReader' colspan='3'></td></tr><tr>   <td styles='formTableValue' colspan='4'>       <div styles='formTableTitleDiv' lable='workSplitAndDescription'></div>       <div styles='formTableValueDiv' item='workSplitAndDescription'></div>   </td></tr><tr>   <td styles='formTableValue' colspan='4'>       <div styles='formTableTitleDiv' lable='specificActionInitiatives'></div>       <div styles='formTableValueDiv' item='specificActionInitiatives'></div>   </td></tr><tr></tr><tr>   <td styles='formTableValue' colspan='4'>       <div styles='formTableTitleDiv' lable='milestoneMark'></div>       <div styles='formTableValueDiv' item='milestoneMark'></div>   </td></tr><tr>   <td styles='formTableValue' colspan='4'>       <div styles='formTableValueDiv' item='attachments'></div>   </td></tr></table>"),this.loadForm()},loadForm:function(){this.form=new MForm(this.formTableArea,this.data,{style:"execution",isEdited:this.isEdited||this.isNew,itemTemplate:this.getItemTemplate(this.lp)},this.app),this.form.load(),this.attachmentArea=this.formTableArea.getElement("[item='attachments']"),this.loadAttachment(this.attachmentArea)},getItemTemplate:function(t){return _self=this,{timeLimit:{text:t.timeLimit+":",name:"completeDateLimitStr"},reportCycle:{text:t.reportCycle+":"},reportDay:{name:"reportDayInCycle"},dutyDepartment:{text:t.dutyDepartment+":",tType:"department",name:"responsibilityOrganizationName"},dutyPerson:{text:t.dutyPerson+":",name:"responsibilityIdentity"},secondDepartment:{text:t.secondDepartment+":",tType:"department",name:"cooperateOrganizationName"},secondPerson:{text:t.secondPerson+":",tType:"identity",name:"cooperateIdentity",count:0},readReader:{text:t.readReader+":",tType:"identity",name:"readLeaderIdentity",count:0},subject:{text:t.subject+":",name:"title",notEmpty:!0},workSplitAndDescription:{text:t.workSplitAndDescription+":",type:"textarea",name:"workDetail",notEmpty:!0,style:{height:"70px"}},specificActionInitiatives:{text:t.specificActionInitiatives+":",type:"textarea",name:"progressAction",style:{height:"70px"}},cityCompanyDuty:{text:t.cityCompanyDuty+":",type:"textarea",name:"dutyDescription"},milestoneMark:{text:t.milestoneMark+":",type:"textarea",name:"landmarkDescription",style:{height:"70px"}},importantMatters:{text:t.importantMatters+":",type:"textarea",name:"majorIssuesDescription"}}},loadAttachment:function(t){this.attachment=new MWF.xApplication.ExeManager.Attachment(t,this.app,this.actions,this.app.lp,{documentId:this.data.id,isNew:this.options.isNew,isEdited:this.options.isEdited,onQueryUploadAttachment:function(){if(this.attachment.isQueryUploadSuccess=!0,!this.data.id||""==this.data.id){var t=this.form.getResult(!0,",",!0,!1,!0);if(!t)return void(this.attachment.isQueryUploadSuccess=!1);this.options.isNew&&(t.title=t.workDetail,t.deployerName=this.app.user,t.creatorName=this.app.user,t.centerId=this.data.centerWorkId||this.data.centerId),this.app.restActions.saveTask(t,function(t){t.type&&"success"==t.type&&t.data&&t.data.id&&(this.attachment.options.documentId=t.data.id,this.data.id=t.data.id)}.bind(this),null,!1)}}.bind(this)}),this.attachment.load()},_createBottomContent:function(){this.cancelActionNode=new Element("div.formCancelActionNode",{styles:this.css.formCancelActionNode,text:this.lp.close}).inject(this.formBottomNode),this.cancelActionNode.addEvent("click",function(t){this.cancel(t)}.bind(this))}});