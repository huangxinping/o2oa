MWF.xApplication.Strategy=MWF.xApplication.Strategy||{},MWF.xDesktop.requireApp("Strategy","Template",null,!1),MWF.xDesktop.requireApp("Template","MPopupForm",null,!1),MWF.xDesktop.requireApp("Template","MForm",null,!1),MWF.xDesktop.requireApp("Template","MDomItem",null,!1),MWF.xDesktop.requireApp("Strategy","Attachment",null,!1),MWF.xApplication.Strategy.ImportForm=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"default",width:"500",height:"200",hasTop:!0,hasIcon:!1,hasBottom:!1,title:"",draggable:!0,maxAction:!0,closeAction:!0},initialize:function(t,e,i,s){this.setOptions(i),this.explorer=t,this.app=t.app,this.lp=this.app.lp.importForm,this.actions=this.app.restActions,this.path="../x_component_Strategy/$ImportForm/",this.cssPath=this.path+this.options.style+"/css.wcss",this.options.from&&(this.cssPath=this.path+this.options.style+"/css_portal.wcss"),this._loadCss(),this.options.title=this.lp.title,this.data=e||{},s&&(this.para=s)},load:function(){var t=new Date;this.thisYear=t.getFullYear(),this.options.isNew?this.create():this.options.isEdited?this.edit():this.open()},createTopNode:function(){this.formTopNode||(this.formTopNode=new Element("div.formTopNode",{styles:this.css.formTopNode}).inject(this.formNode),this.formTopIconNode=new Element("div.formTopIconNode",{styles:this.css.formTopIconNode}).inject(this.formTopNode),this.formTopTextNode=new Element("div",{styles:this.css.formTopTextNode,text:this.data.title?this.data.title:this.lp.title}).inject(this.formTopNode),this.options.closeAction&&(this.formTopCloseActionNode=new Element("div",{styles:this.css.formTopCloseActionNode}).inject(this.formTopNode),this.formTopCloseActionNode.addEvent("click",function(){this.close()}.bind(this))),this._createTopContent())},_createTopContent:function(){},_createTableContent:function(){this.createTableInfo()},getData:function(t){this.options.isNew?t&&t():(this.data.id?this.id=this.data.id:this.options.id&&(this.id=this.options.id),this.actions.getMeasureById(this.id,function(e){"success"==e.type&&(this.data=e.data,this.formTopTextNode.set("text",this.data.measuresinfotitle),e.data.measuresinfoyear&&(this.currentYear=e.data.measuresinfoyear),t&&t())}.bind(this)))},createTableInfo:function(){this.templateDiv=new Element("div.templateDiv",{styles:this.css.templateDiv}).inject(this.formTableArea),this.templateText=new Element("span.templateText",{styles:this.css.templateText,text:this.lp.template}).inject(this.templateDiv),this.templateText.addEvents({click:function(){}.bind(this)}),this.inputDiv=new Element("div.inputDiv",{styles:this.css.inputDiv}).inject(this.formTableArea),this.input=new Element("input.input",{styles:this.css.input,type:"file",name:"file"}).inject(this.inputDiv),this.sheetDiv=new Element("div.sheetDiv",{styles:this.css.sheetDiv}).inject(this.formTableArea),this.sheetSel=new MDomItem(this.sheetDiv,{text:"sheet页",name:"sheet",type:"MSelector",selectValue:"1,2,3,4,5,6,7,8,9,10",selectText:"1,2,3,4,5,6,7,8,9,10",mSelectorOptions:{width:"150px",defaultOptionLp:"请选择Sheet",tooltipsOptions:{axis:"y",position:{x:"auto",y:"auto"},event:"click",hiddenDelay:200,displayDelay:0}}},null,this.app,this.css),this.sheetSel.load(),this.importAction=new Element("div.importAction",{styles:this.css.importAction,text:this.lp.importAction}).inject(this.formTableArea),this.importAction.addEvents({click:function(){var t=this.inputDiv.getFirst().files;if(t.length)for(var e=0;e<t.length;e++){var i=t.item(e),s=new FormData;s.append("file",i),s.append("year",this.data.year||""),s.append("parentid",this.data.parentid||""),s.append("sheetsequence",this.sheetSel.get("value")||""),this.actions.importMeasure(function(t){if(t.data.isPersist)this.app.notice(t.data.describe,"success"),this.fireEvent("importSave",t),this.close();else{this.app.notice(t.data.describe,"error");var e=this.actions.action.address+"/jaxrs/measuresimport/result/flag/"+t.data.flag;window.open(o2.filterUrl(e))}}.bind(this),function(t,e,i){this.app.notice("导入失败","error"),this.close()}.bind(this),s,i)}else this.app.notice(this.lp.notice.fileEmpty,"error");""==this.sheetSel.get("value")&&this.app.notice(this.lp.notice.sheetEmpty,"error")}.bind(this)}),this.closeAction=new Element("div.closeAction",{styles:this.css.closeAction,text:this.lp.importClose}).inject(this.formTableArea),this.closeAction.addEvents({click:function(){this.close()}.bind(this)})},createShade:function(t,e){var i=this.content,s=t||i,o=e||"loading...";this.shadeDiv&&this.shadeDiv.destroy(),this.shadeTxtDiv&&this.shadeTxtDiv.destroy(),this.shadeDiv=new Element("div.shadeDiv").inject(s),this.inforDiv=new Element("div.inforDiv",{styles:{height:"16px",display:"inline-block",position:"absolute","background-color":"#000000","border-radius":"3px",padding:"5px 10px"}}).inject(this.shadeDiv),this.loadImg=new Element("img.loadImg",{styles:{width:"16px",height:"16px",float:"left"},src:this.path+"default/icon/loading.gif"}).inject(this.inforDiv),this.shadeTxtSpan=new Element("span.shadeTxtSpan").inject(this.inforDiv),this.shadeTxtSpan.set("text",o),this.shadeDiv.setStyles({width:"100%",height:"100%",position:"absolute",opacity:"0.6","background-color":"#cccccc","z-index":"999"}),this.shadeTxtSpan.setStyles({color:"#ffffff","font-size":"12px",display:"inline-block","line-height":"16px","padding-left":"5px"});var n=s.getSize().x,a=s.getSize().y;this.shadeDiv.setStyles({left:s.getLeft()-i.getLeft()+"px",top:s.getTop()-i.getTop()+"px",width:n+"px",height:a+"px"}),"absolute"==s.getStyle("position")&&this.shadeDiv.setStyles({left:"0px",top:"0px"}),this.inforDiv.setStyles({left:n/2+"px",top:a/2+"px"})},destroyShade:function(){this.shadeDiv&&this.shadeDiv.destroy()},showErrorMessage:function(t,e,i){var s,o=i;if(t&&(s=t.responseText),""!=s){var n=JSON.parse(s);n.message?this.notice(n.message,"error"):this.notice(o,"error")}else this.notice(o,"error")},aa:function(){var t="";if(d.configValue&&""!=d.configValue)for(var e=d.configValue.split(","),i=0;i<e.length;i++)t=""==t?e[i].split("@")[0]:t+","+e[i].split("@")[0];return t}});