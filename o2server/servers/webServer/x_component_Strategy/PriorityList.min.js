MWF.xApplication.Strategy=MWF.xApplication.Strategy||{},MWF.xDesktop.requireApp("Template","MDomItem",null,!1),MWF.xDesktop.requireApp("Strategy","Template",null,!1),MWF.require("MWF.widget.Identity",null,!1),MWF.xApplication.Strategy.PriorityList=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default"},initialize:function(t,e,i,n){this.setOptions(n),this.app=e,this.lp=e.lp.priority,this.path="../x_component_Strategy/$PriorityList/",this.loadCss(),this.actions=i,this.node=$(t)},loadCss:function(){this.cssPath=this.path+this.options.style+"/css.wcss",this._loadCss()},load:function(){"portal"==this.options.style&&this.node.setStyles({"background-color":"#ffffff"}),this.allArrowArr=[],this.node.addEvents({click:function(){this.listContentDiv&&$(this.listContentDiv).destroy(),this.allArrowArr.length>0&&this.allArrowArr.each(function(t){$(t).setStyles({background:"url(../x_component_Strategy/$Template/default/icons/arrow.png) no-repeat center"})}.bind(this))}.bind(this)}),this.node.empty(),this.createDepartmentNavi(),this.app.addEvent("resize",function(){this.resizeContent()}.bind(this))},reload:function(t){},createDepartmentNavi:function(){this.departmentNavi=new Element("div.departmentNavi",{styles:this.css.departmentNavi}).inject(this.node),this.actions.getPriorityDepartments(function(t){if("success"==t.type){var e=this;t.data.each(function(t){new Element("div.departmentItem",{styles:e.css.departmentItem,distinguishedName:t.distinguishedName,text:t.name}).inject(e.departmentNavi).addEvents({click:function(){e.openDepartment(this.get("distinguishedName"))},mouseover:function(){e.currentDistinguishedName!=this.get("distinguishedName")&&this.setStyles({"background-color":"#D9EBFF",color:"#4990E2"})},mouseout:function(){e.currentDistinguishedName!=this.get("distinguishedName")&&this.setStyles({"background-color":"",color:""})}})}.bind(e)),this.departmentNavi.getElements(".departmentItem")[0].click()}}.bind(this))},openDepartment:function(t){t&&(this.changeDepartmentSelect(t),this.createYearContent(function(){this.resizeContent()}.bind(this)))},changeDepartmentSelect:function(t){t&&(this.currentDistinguishedName=t,this.departmentNavi.getElements(".departmentItem").each(function(e){e.setStyles({"background-color":"",color:""}),t==e.get("distinguishedName")&&e.setStyles({"background-color":"#D9EBFF",color:"#4990E2"})}.bind(this)))},createYearContent:function(t){this.rightContent&&this.rightContent.destroy(),this.rightContent=new Element("div.rightContent",{styles:this.css.rightContent}).inject(this.node),this.rightContent.setStyles({width:this.node.getWidth()-this.departmentNavi.getWidth()+"px"}),this.yearContent=new Element("div.yearContent",{styles:this.css.yearContent}).inject(this.rightContent),this.yearContentList=new Element("div.yearContentList",{styles:this.css.yearContentList}).inject(this.yearContent);var e={keyworkunit:this.currentDistinguishedName};this.actions.getYearsByDepartment(e,function(e){"success"==e.type&&e.data&&e.data.valueList&&(this.yearList=e.data.valueList,this.yearList.each(function(t,e){e<3&&new Element("div.year",{styles:this.css.year,value:t,name:t,text:t}).inject(this.yearContentList).addEvents({click:function(){this.changeYearSelected(t),this.openList(t)}.bind(this)})}.bind(this)),this.yearList.length>3&&new Element("div.yearMore",{styles:this.css.year,id:"yearMore"}).inject(this.yearContentList).setStyles({width:"30px"}).set({text:"..."}).addEvents({click:function(){this.expandYears()}.bind(this)}),this.currentYear?this.yearContentList.getElements("div[name='"+this.currentYear+"']").length>0&&this.yearContentList.getElements("div[name='"+this.currentYear+"']")[0].click():this.yearContentList.getElements("div").length>0&&this.yearContentList.getElements("div")[0].click(),t&&t())}.bind(this)),this.actions.getPriorityAddAuthorize(function(t){"success"==t.type&&t.data&&t.data.value&&(this.addContent=new Element("div.addContent",{styles:this.css.addContent}).inject(this.yearContent).addEvents({click:function(){MWF.xDesktop.requireApp("Strategy","PriorityForm",function(){this.Priorityform=new MWF.xApplication.Strategy.PriorityForm(this,{},{isNew:!0,onPostSave:function(){this.openDepartment(this.currentDistinguishedName)}.bind(this),width:"90%",height:"100%",maxAction:!0,year:this.currentYear||"",department:this.currentDistinguishedName,container:this.app.portalContainer||this.app.content},{container:this.app.portalContainer||this.app.content}),this.Priorityform.load()}.bind(this))}.bind(this)}),this.addContentImg=new Element("div.addContentImg",{styles:this.css.addContentImg}).inject(this.addContent),this.addContentLabel=new Element("div.addContentLabel",{styles:this.css.addContentLabel,text:this.lp.add}).inject(this.addContent))}.bind(this))},expandYears:function(){this.yearContentList.getElementById("yearMore").destroy(),this.yearList.each(function(t,e){e>2&&new Element("div.year",{styles:this.css.year,value:t,name:t,text:t}).inject(this.yearContentList).addEvents({click:function(){this.changeYearSelected(t),this.openList(t)}.bind(this)})}.bind(this))},openList:function(t){this.currentYear=t,this.createSearch(),this.createViewContent()},changeYearSelected:function(t){this.yearContentList.getElements("div").each(function(e){e.get("text")==t?e.setStyles({"background-color":"#4990E2",color:"#FFFFFF"}):e.setStyles({"background-color":"",color:"#666666"})}.bind(this))},createSearch:function(){this.searchContent&&this.searchContent.destroy(),this.searchContent=new Element("div.searchContent",{styles:this.css.searchContent}).inject(this.rightContent),this.searchBar=new Element("div.searchBar",{styles:this.css.searchBar}).inject(this.searchContent),this.searchIn=new Element("input.searchIn",{styles:this.css.searchIn,placeholder:this.lp.defaultSearchIn}).inject(this.searchBar).addEvents({keydown:function(t){""!=this.searchIn.get("value")&&"13"==t.event.keyCode&&(this.searchReset.setStyles({display:""}),this.createViewContent({keyworktitle:this.searchIn.get("value")}))}.bind(this)}),this.searchImg=new Element("div.searchImg",{styles:this.css.searchImg}).inject(this.searchBar),this.searchImg.addEvents({click:function(){""!=this.searchIn.get("value")&&(this.searchReset.setStyles({display:""}),this.createViewContent({keyworktitle:this.searchIn.get("value")}))}.bind(this)}),this.searchReset=new Element("div.searchReset",{styles:this.css.searchReset}).inject(this.searchBar).addEvents({click:function(){this.searchIn.set("value",""),this.searchReset.setStyles({display:"none"}),this.createViewContent()}.bind(this)})},createViewContent:function(t){for(var e in this.viewContent&&this.viewContent.destroy(),this.viewContent=new Element("div.viewContent",{styles:this.css.viewContent}).inject(this.rightContent),this.viewContentList=new Element("div.viewContentList",{styles:this.css.viewContentList}).inject(this.viewContent),this.filter={keyworkyear:this.currentYear,keyworkunit:this.currentDistinguishedName,ordersymbol:"ASC"},t)t[e]!=this.app.lp.template.defaultSelect&&(this.filter[e]=t[e]);var i=this.path+"Priority.json";this.view=new MWF.xApplication.Strategy.PriorityList.View(this.viewContentList,this.app,{explorer:this,lp:this.lp.view,css:this.css,actions:this.actions},{templateUrl:i,filterData:this.filter}),this.view.load(),this.resizeContent()},createPageContent:function(){this.pageContent&&this.pageContent.destroy(),this.pageContent=new Element("div.pageContent",{styles:this.css.pageContent}).inject(this.viewContent)},dragItemData:function(){var t=new Sortables("tabBody",{clone:!0,opacity:.3,onStart:function(t,e){e.setStyles({position:"absolute","margin-top":160-this.viewContentList.getScrollTop()+"px",border:"1px dotted #000",width:this.viewContentList.getWidth()-10+"px",height:t.getHeight()+"px",overflow:"hidden","max-height":t.getHeight()+"px"})}.bind(this),onSort:function(t,e){}.bind(this),onComplete:function(e){e.get("id"),t.serialize()}.bind(this)})},resizeContent:function(){var t=this.node.getSize(),e=this.departmentNavi;this.rightContent.setStyles({width:t.x-e.getWidth()+"px",height:t.y+"px"});var i=$(this.yearContent),n=$(this.searchContent),s=$(this.viewContent),o=$(this.viewContentList);n&&s&&$(s).setStyles({height:t.y-i.getHeight()-n.getHeight()+"px"}),o&&$(o).setStyles({height:s.getHeight()-10+"px"})},createShade:function(t,e){var i=this.node,n=t||i,s=e||"loading...";this.shadeDiv&&$(this.shadeDiv).destroy(),this.shadeTxtDiv&&this.shadeTxtDiv.destroy(),this.shadeDiv=new Element("div.shadeDiv").inject(n),this.inforDiv=new Element("div.inforDiv",{styles:{height:"16px",width:"200px",display:"line-block",position:"relative","background-color":"#000000","border-radius":"3px",padding:"5px 10px"}}).inject(this.shadeDiv),this.loadImg=new Element("img.loadImg",{styles:{width:"16px",height:"16px",float:"left"},src:"../x_component_Strategy/$Main/default/icon/loading.gif"}).inject(this.inforDiv),this.shadeTxtSpan=new Element("span.shadeTxtSpan").inject(this.inforDiv),this.shadeTxtSpan.set("text",s),this.shadeDiv.setStyles({width:"100%",height:"100%",opacity:"0.6","background-color":"#cccccc","z-index":"999"}),this.shadeTxtSpan.setStyles({color:"#ffffff","font-size":"12px",display:"inline-block","line-height":"16px","padding-left":"5px"});var o=n.getSize().x,r=n.getSize().y;this.shadeDiv.setStyles({left:n.getLeft()-i.getLeft()+"px",top:n.getTop()-i.getTop()+"px",width:o+"px",height:r+"px"}),"position"==n.getStyle("position")&&this.shadeDiv.setStyles({left:"0px",top:"0px"}),this.inforDiv.setStyles({left:o/2+"px",top:r/2+"px"}),this.inforDiv.setStyles({display:"none"})},destroyShade:function(){this.shadeDiv&&$(this.shadeDiv).destroy()},showErrorMessage:function(t,e,i){var n,s=i;if(t&&(n=t.responseText),""!=n){var o=JSON.parse(n);o.message?this.notice(o.message,"error"):this.notice(s,"error")}else this.notice(s,"error")}}),MWF.xApplication.Strategy.PriorityList.View=new Class({Extends:MWF.xApplication.Strategy.Template.view,_createDocument:function(t){return new MWF.xApplication.Strategy.PriorityList.Document(this.viewBodyNode,t,this.explorer,this)},loadScrollElementList:function(t){this.isItemsLoaded||(this.isItemLoadding?this.loadItemQueue++:(this.isItemLoadding=!0,this._getCurrentPageData(function(t){(this.dataCount=t.count)<=this.items.length&&(this.isItemsLoaded=!0),t.data&&"array"==typeOf(t.data)&&t.data.each(function(t){var e=t[this.options.documentKeyWord||"id"];if(!this.documents[e]){var i=this._createDocument(t,this.items.length);this.items.push(i),this.documents[e]=i}}.bind(this)),this.isItemLoadding=!1,"portal"!=this.explorer.explorer.options.style&&(this.explorer.explorer.filter.keyworktitle||this.explorer.explorer.dragItemData()),this.loadItemQueue>0&&(this.loadItemQueue--,this.loadElementList())}.bind(this),t)))},_getCurrentPageData:function(t,e){e||(e=100);var i=this.items.length?this.items[this.items.length-1].data.id:"(0)";"(0)"==i&&this.explorer.explorer.createShade();var n=this.options.filterData||{};this.actions.getPriorityListNext(i,e,n,function(e){t&&t(e),this.explorer.explorer.destroyShade()}.bind(this))},_removeDocument:function(t){},_create:function(){},_openDocument:function(t){MWF.xDesktop.requireApp("Strategy","PriorityForm",function(){this.priorityForm=new MWF.xApplication.Strategy.PriorityForm(this,this.actions,{id:t.id},{isEdited:!1,container:this.app.portalContainer||this.app.content}),this.priorityForm.load()}.bind(this))},_queryCreateViewNode:function(){},_postCreateViewNode:function(){},_queryCreateViewHead:function(){},_postCreateViewHead:function(t){}}),MWF.xApplication.Strategy.PriorityList.Document=new Class({Extends:MWF.xApplication.Strategy.Template.Document,openActionReturn:function(t){var e=!1;return t.actions&&1==t.actions.length&&(e=!0),e},editActionReturn:function(t){var e=!1;return t.actions&&t.actions.indexOf("EDIT")>-1&&(e=!0),e},deleteActionReturn:function(t){var e=!1;return t.actions&&t.actions.indexOf("DELETE")>-1&&(e=!0),e},action_open:function(){MWF.xDesktop.requireApp("Strategy","PriorityForm",function(){this.PriorityForm=new MWF.xApplication.Strategy.PriorityForm(this,this.actions,{id:this.data.id},{isEdited:!1}),this.PriorityForm.load()}.bind(this))},action_edit:function(){MWF.xDesktop.requireApp("Strategy","PriorityForm",function(){this.Priorityform=new MWF.xApplication.Strategy.PriorityForm(this,this.app.actions,{id:this.data.id,isNew:!1,isEdited:!0,width:1e3,height:500,year:this.data.keyworkyear,onPostSave:function(){this.explorer.explorer.openDepartment(this.explorer.explorer.currentDistinguishedName)}.bind(this)},{container:this.app.portalContainer||this.app.content}),this.Priorityform.load()}.bind(this))},action_delete:function(t){var e=this;e.view.app.confirm("warn",t,e.explorer.explorer.app.lp.priority.submitWarn.title,e.explorer.explorer.app.lp.priority.submitWarn.content.deleted,300,120,(function(){e.actions.deletePriority(e.data.id,function(t){t.type&&"success"==t.type&&(this.app.notice(e.explorer.explorer.app.lp.prompt.priority.deleteOK,"success"),e.explorer.explorer.openDepartment(e.explorer.explorer.currentDistinguishedName))}.bind(e)),this.close()}),(function(){this.close()}))},_postCreateDocumentNode:function(t,e){t.set("id",e.id),this.openActionReturn(e)||t.getElements("[item='action_open']").destroy(),this.editActionReturn(e)||t.getElements("[item='action_edit']").destroy(),this.deleteActionReturn(e)||t.getElements("[item='action_delete']").destroy()}});