MWF.require("MWF.widget.Calendar",null,!1),MWF.xApplication.Report.DayView=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",date:null},initialize:function(t,e,s){this.setOptions(s),this.path="../x_component_Report/$DayView/",this.cssPath="../x_component_Report/$DayView/"+this.options.style+"/css.wcss",this._loadCss(),this.app=e,this.container=$(t);var i=this.options.date;this.date=i?"string"==typeOf(i)?new Date(i):i:new Date,this.load()},recordStatus:function(){return{date:this.days.length>0?this.days[0].date.clone():this.date}},load:function(){this.days=[],this.scrollNode=new Element("div.scrollNode",{styles:this.app.inContainer?this.css.scrollNode_inContainer:this.css.scrollNode}).inject(this.container),this.contentWarpNode=new Element("div",{styles:this.css.contentWarpNode}).inject(this.scrollNode),this.contentContainerNode=new Element("div",{styles:this.css.contentContainerNode}).inject(this.contentWarpNode),this.node=new Element("div",{styles:this.css.contentNode}).inject(this.contentContainerNode),this.leftNode=new Element("div",{styles:this.css.leftNode_disable}).inject(this.node),this.leftNode.addEvents({click:function(){1!=this.pageNum&&this.decrementDay()}.bind(this),mouseover:function(){1!=this.pageNum&&this.leftNode.setStyles(this.css.leftNode_over)}.bind(this),mouseout:function(){1!=this.pageNum&&this.leftNode.setStyles(this.css.leftNode)}.bind(this)}),this.dayContainerNode=new Element("div",{styles:this.css.dayContainerNode}).inject(this.node),this.rightNode=new Element("div",{styles:this.css.rightNode_disable}).inject(this.node),this.rightNode.addEvents({click:function(){this.pageNum<this.totalPage&&this.incrementDay()}.bind(this),mouseover:function(){this.pageNum<this.totalPage&&this.rightNode.setStyles(this.css.rightNode_over)}.bind(this),mouseout:function(){this.pageNum<this.totalPage&&this.rightNode.setStyles(this.css.rightNode)}.bind(this)}),this.resetNodeSize(),this.resetNodeSizeFun=this.resetNodeSize.bind(this),this.app.addEvent("resize",this.resetNodeSizeFun)},resetNodeSize:function(){var t=this.container.getSize(),e=this.app.inContainer?800:t.y,s=this.leftNode?this.leftNode.getSize():{x:0,y:0},i=this.rightNode?this.rightNode.getSize():{x:0,y:0},o=this.app.sideBar?this.app.sideBar.getSize():{x:0,y:0},a=t.x-s.x-i.x-o.x;this.dayNodeHeight=e-110;var n=(this.dayNodeHeight-s.y)/2,h=(this.dayNodeHeight-i.y)/2;this.leftNode.setStyle("margin-top",n+"px"),this.rightNode.setStyle("margin-top",h+"px");var d=(a/330).toInt();if(this.app.inContainer?this.scrollNode.setStyle("min-height",e-60+"px"):this.scrollNode.setStyle("height",e-60+"px"),this.scrollNode.setStyle("margin-top","60px"),this.scrollNode.setStyle("margin-right",o.x),this.contentWarpNode){var r=330*d+s.x+i.x+o.x,l=(t.x-r)/2-10;this.contentWarpNode.setStyles({width:r+"px","margin-left":l+"px"})}if(this.dayCount!=d)this.dayCount=d,this.getPageNumberForDay(function(){this.totalPage?this.adjustDay():this.showNoReportNode()}.bind(this));else for(var y=0;y<this.days.length;y++)this.days[y].resetHeight()},getPageNumberForDay:function(t){var e=this.date.format("%Y-%m-%d");this.app.restActions.getPageNumberForDay(e,this.dayCount,function(e){this.pageNum=e.data.currentPage,this.totalPage=e.data.totalPage,t&&t()}.bind(this))},listDayForPage:function(t){this.app.restActions.listDayForPage(this.pageNum,this.dayCount,function(e){this.data={},e.data.each(function(t,e){0==e&&(this.date=Date.parse(t.date)),this.data[t.date]=t.reports}.bind(this)),t&&t()}.bind(this))},toDay:function(t){this.date=t,this.dayContainerNode.empty(),this.leftNode.setStyles(this.css.leftNode_disable),this.rightNode.setStyles(this.css.rightNode_disable),this.days=[],this.getPageNumberForDay(function(){this.adjustDay()}.bind(this))},showNoReportNode:function(){this.noReportNode&&this.noReportNode.destroy(),this.noReportNode=new Element("div",{styles:this.css.noReportNode,text:this.app.lp.noReportDayView}).inject(this.contentContainerNode,"top"),this.setLeftRightNode()},adjustDay:function(){if(this.dayCount<=this.days.length){for(var t=0;t<this.days.length;t++)t<this.dayCount?this.days[t].resetHeight():this.days[t]&&this.days[t].destroy();this.days.splice(this.dayCount,this.days.length-this.dayCount),this.setLeftRightNode()}else{for(t=0;t<this.days.length;t++)this.days[t].resetHeight();this.listDayForPage(function(){for(var t in this.data){var e=this.data[t],s=!0;this.days.each(function(e){e.date.format("%Y-%m-%d")==t&&(s=!1)}.bind(this)),s&&this.loadDay(Date.parse(t),e,0==this.days.length)}this.setLeftRightNode()}.bind(this))}},setLeftRightNode:function(){1==this.pageNum||0==this.totalPage?this.leftNode.setStyles(this.css.leftNode_disable):this.leftNode.setStyles(this.css.leftNode),this.pageNum>=this.totalPage||0==this.totalPage?this.rightNode.setStyles(this.css.rightNode_disable):this.rightNode.setStyles(this.css.rightNode)},incrementDay:function(){this.pageNum>=this.totalPage||(this.pageNum++,this.days.each(function(t){t.destroy()}.bind(this)),this.days=[],this.dayContainerNode.empty(),this.leftNode.setStyles(this.css.leftNode_disable),this.rightNode.setStyles(this.css.rightNode_disable),this.adjustDay())},decrementDay:function(t){1!=this.pageNum&&(this.pageNum--,this.days.each(function(t){t.destroy()}.bind(this)),this.days=[],this.dayContainerNode.empty(),this.leftNode.setStyles(this.css.leftNode_disable),this.rightNode.setStyles(this.css.rightNode_disable),this.adjustDay())},loadDay:function(t,e,s){var i=new MWF.xApplication.Report.DayView.Day(this,this.dayContainerNode,null,t,s,e);this.days.push(i)},hide:function(){new Fx.Morph(this.scrollNode,{duration:"300",transition:Fx.Transitions.Expo.easeOut}).start({opacity:0}).chain(function(){this.scrollNode.setStyle("display","none")}.bind(this))},show:function(){this.scrollNode.setStyles(this.app.inContainer?this.css.scrollNode_inContainer:this.css.scrollNode),this.scrollNode.setStyles({display:""});var t=new Fx.Morph(this.scrollNode,{duration:"800",transition:Fx.Transitions.Expo.easeOut});this.app.fireAppEvent("resize"),t.start({opacity:1,left:"0px"}).chain(function(){this.scrollNode.setStyles({position:"static",width:"auto",display:""})}.bind(this))},reload:function(){this.date=this.days.length>0?this.days[0].date.clone():this.date,this.days.each((function(t){t.destroy()})),this.dayContainerNode.empty(),this.days=[],this.getPageNumberForDay(function(){this.totalPage?this.adjustDay():this.showNoReportNode()}.bind(this))},destroy:function(){this.days.each((function(t){t.destroy()})),this.app.removeEvent("resize",this.resetNodeSizeFun),this.scrollNode.destroy()}}),MWF.xApplication.Report.DayView.Day=new Class({Implements:[Events],initialize:function(t,e,s,i,o,a){this.view=t,this.css=this.view.css,this.container=e,this.position=s||"bottom",this.app=this.view.app,this.date=i?i.clone().clearTime():(new Date).clearTime(),this.data=a,this.today=(new Date).clearTime(),this.isToday=0==this.date.diff(this.today),this.times=[],this.reports=[],this.isFirst=o,this.load()},load:function(){this.node=new Element("div.dayNode",{styles:this.css.dayNode}).inject(this.container,this.position),this.node.setStyle("min-height",this.view.dayNodeHeight+"px"),this.node.addEvents({mouseover:function(){this.node.setStyles(this.css.dayNode_over)}.bind(this),mouseout:function(){this.node.setStyles(this.css.dayNode)}.bind(this)}),this.titleNode=new Element("div.titleNode",{styles:this.css[this.isToday?"dayTitleNode_today":"dayTitleNode"]}).inject(this.node),this.isFirst?className=this.isToday?"dayTitleTextNode_today_first":"dayTitleTextNode_first":className=this.isToday?"dayTitleTextNode_today":"dayTitleTextNode",this.titleTextNode=new Element("div.dayTitleTextNode",{styles:this.css[className],text:this.date.format("%Y年%m月%d日")}).inject(this.titleNode),this.isFirst&&(this.calendar=new MWF.xApplication.Report.Calendar(this.titleTextNode,{style:"meeting_blue",target:this.node,baseDate:this.date,onQueryComplate:function(t,e,s){var i=new Date.parse(e);this.view.toDay(i)}.bind(this)}),this.calendar.app=this.app),this.dayWeekNode=new Element("div.dayWeekNode",{styles:this.css[this.isToday?"dayWeekNode_today":"dayWeekNode"],text:this.getWeek()}).inject(this.titleNode),this.dayContentNode=new Element("div.dayContentNode",{styles:this.css.dayContentNode}).inject(this.node),this.loadReports()},resetHeight:function(){this.node.setStyle("min-height",this.view.dayNodeHeight+"px"),this.noReportNode&&(this.noReportNode.setStyle("min-height",this.view.dayNodeHeight-220+"px"),this.noReportNode.setStyle("line-height",this.view.dayNodeHeight-220+"px"))},getWeek:function(){var t=this.app.lp.weeks.arr[this.date.getDay()];return 0==this.today.diff(this.date)?this.app.lp.today:t},setFrist:function(){this.isFirst||(this.isFirst=!0,className=this.isToday?"dayTitleTextNode_today_first":"dayTitleTextNode_first",this.titleTextNode.setStyles(this.css[className]),this.calendar=new MWF.xApplication.Report.Calendar(this.titleTextNode,{style:"meeting_blue",target:this.node,baseDate:this.date,onQueryComplate:function(t,e,s){var i=new Date.parse(e);this.view.toDay(i)}.bind(this)}),this.calendar.app=this.app)},destroy:function(){this.calendar&&this.calendar.container.destroy(),this.reports.each((function(t){t.destroy()})),this.reports=[],this.node.destroy()},loadReports:function(){this.data.each(function(t){this.reports.push(new MWF.xApplication.Report.ReportArea(this.dayContentNode,this,t))}.bind(this))},reload:function(){this.view.reload()}}),MWF.xApplication.Report.Calendar=new Class({Extends:MWF.widget.Calendar,_setDayDate:function(t,e,s){var i=this.options.baseDate;null!=e&&null!=s&&((i=new Date).setDate(1),i.setFullYear(e),i.setMonth(s)),this.loadDayData(i,function(){this._setDayD(t,e,s)}.bind(this))},loadDayData:function(t,e){var s=t.clone();s.decrement("month",1),this.data={};for(var i=0,o=0;o<3;o++){var a=this.app.common.addZero((s.get("month")+1).toString(),2),n=s.get("year");this.app.restActions.listDayByYearMonth(n,a,function(t){i++,t.data.each(function(t){this.data[t.date]=t.reports}.bind(this)),e&&3==i&&e()}.bind(this),null,!1),s.increment("month",1)}},_setDayD:function(t,e,s){var i=t||this.contentTable,o=this.options.baseDate;null!=e&&null!=s&&((o=new Date).setDate(1),o.setFullYear(e),o.setMonth(s));var a=i.getElement("tbody").getElements("td"),n=o.clone();n.setDate(1);for(var h=n.getDay(),d=n.clone(),r=h-1;r>=0;r--){var l=a[r];d.increment("day",-1),l.set("text",d.getDate()),l.addClass("gray_"+this.options.style),l.setStyles(this.css["gray_"+this.options.style]),l.store("dateValue",d.toString()),this.data[d.format("%Y-%m-%d")]?(l.setStyles({position:"relative",cursor:"pointer"}),new Element("div",{position:"absolute",top:"2px",right:"2px",width:"2px",height:"2px","background-color":"#4990e2","border-radius":"5px"}).inject(l)):a[r].setStyles({cursor:"default"})}for(r=h;r<a.length;r++){if(a[r].set("text",n.getDate()),n.toString()==this.options.baseDate.toString()?(a[r].addClass("current_"+this.options.style),a[r].setStyles(this.css["current_"+this.options.style]),a[r].removeClass("gray_"+this.options.style),a[r].setStyle("border","1px solid #FFF")):n.getMonth()!=o.getMonth()?(a[r].addClass("gray_"+this.options.style),a[r].setStyles(this.css["gray_"+this.options.style]),a[r].removeClass("current_"+this.options.style),a[r].setStyle("border","1px solid #FFF")):(a[r].setStyles(this.css["normal_"+this.options.style]),a[r].removeClass("current_"+this.options.style),a[r].removeClass("gray_"+this.options.style),a[r].setStyle("border","1px solid #FFF")),n.clone().clearTime().toString()==this.today.clearTime().toString()&&(a[r].setStyles(this.css["today_"+this.options.style]),a[r].setStyle("border","0px solid #AAA")),a[r].store("dateValue",n.toString()),this.data[n.format("%Y-%m-%d")])(l=a[r]).setStyles({position:"relative",cursor:"pointer"}),new Element("div",{styles:{position:"absolute",top:"5px",right:"5px",width:"5px",height:"5px","background-color":"#4990e2","border-radius":"5px"}}).inject(l);else a[r].setStyles({cursor:"default"});n.increment("day",1)}},_selectDate:function(t){var e=new Date(t);if(this.data[e.format("%Y-%m-%d")]){var s=e.format(this.options.format);if(this.options.isTime)this.changeViewToTime(e);else{if(!this.options.beforeCurrent){var i=new Date;if(e.setHours(23,59,59),e.getTime()-i.getTime()<0)return alert("选择的日期必须大于当前日期!"),this.node.focus(),!1}this.fireEvent("queryComplate",[s,e])&&(this.node.set("value",s),this.hide(),this.fireEvent("complate",[s,e]))}}}});