MWF.xDesktop.requireApp("Report","Attachment",null,!1),MWF.xDesktop.requireApp("Template","MSelector",null,!1),MWF.xDesktop.requireApp("Template","Explorer",null,!1),MWF.xDesktop.requireApp("Template","MPopupForm",null,!1),MWF.xApplication.Report.StrategyExplorer=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",id:"",type:"app"},initialize:function(t,e,i){this.setOptions(i),this.app=t,this.path="../x_component_Report/$StrategyExplorer/",this.cssPath="../x_component_Report/$StrategyExplorer/"+this.options.style+"/css.wcss",this._loadCss(),this.lp=this.app.lp,this.actions=e},reload:function(){this.node.empty(),this.loadLayout()},destroy:function(){"app"==this.options.type&&this.app.removeEvent("resize",this.resetNodeSizeFun),this.node.empty()},load:function(t){this.reportContainer&&(this.node=$(this.reportContainer)),this.loadLayout(t),"app"==this.options.type&&(this.resetNodeSizeFun=this.resetNodeSize.bind(this),this.app.addEvent("resize",this.resetNodeSizeFun))},loadLayout:function(t){this.createNode(),this.actions.getReport(this.options.id,function(e){this.data=e.data,t&&t(this.data),this.userName=(layout.desktop.session.user||layout.user).distinguishedName,this.isEdited=!1,this.getStatus(function(){this.app.setTitle(this.getTitle()),this.loadContentNode(),"app"==this.options.type&&this.resetNodeSize()}.bind(this))}.bind(this))},getTitle:function(){var t=this.data.year+"年"+parseInt(this.data.month)+"月工作总结",e=new Date(this.data.year,parseInt(this.data.month)-1,1).increment("month",1),i=e.getFullYear()+"年"+(e.getMonth()+1)+"月工作计划";return this.data.targetUnit.split("@")[0]+t+"和"+i},isToReadLeader:function(t){MWF.Actions.get("x_organization_assemble_express").getUnitWithIdentityAndLevelValue({identity:this.data.targetIdentity,level:"1"},function(e){var i=e.data.unit;i?MWF.Actions.get("x_organization_assemble_express").getDutyValue({name:"董事长",unit:i},function(e){var i=!1,s=e.data.identityList||[];(layout.desktop.session.user||layout.user).identityList.each((function(t){s.contains(t.distinguishedName)&&(i=!0)})),t&&t(i)}.bind(this)):t&&t(!1)}.bind(this))},isToRead:function(){var t=!1;return(this.workApp.readList||[]).each(function(e){this.userName==e.person&&(t=!0,this.readData=e)}.bind(this)),t},getStatus:function(t){this.isEdited=this.workApp.control.allowProcessing||this.workApp.control.allowSave,this.activityName=this.workApp.activity?this.workApp.activity.name:"",this.activityAlias=this.workApp.activity?this.workApp.activity.alias:"","月度汇报员分派填写人"==this.data.reportStatus||"拟稿"==this.data.activityName||"月度汇报员分派填写人"==this.activityName||"deployment"==this.activityAlias?(this.status="deployment",t&&t()):"汇报人"==this.activityName||"write"==this.activityAlias?(this.status="write",t&&t()):"月度汇报员汇总"==this.activityName||"confirm"==this.activityAlias?(this.status="confirm",t&&t()):"战略负责人审核"==this.activityName||"audit"==this.activityAlias?(this.status="audit",t&&t()):(this.activityName,this.status="summary",t&&t())},createNode:function(){this.container=new Element("div.container",{styles:this.css.container}).inject(this.node),this.contentContainer=new Element("div.contentContainerNode",{styles:this.css["app"==this.options.type?"contentContainer":"contentContainer_flow"]}).inject(this.container)},createTopNode:function(){var t=this.topNode=new Element("div.topNode",{styles:this.css.topNode}).inject(this.contentContainer);this.isPrinted&&t.setStyle("width","auto");var e=new Element("div.topTitleMiddleNode",{styles:this.css.topTitleMiddleNode}).inject(t);new Element("div.topItemTitleNode",{styles:this.css.topItemTitleNode,text:this.lp.title}).inject(e).addEvent("click",function(){this.app.desktop.apps.Report?this.app.desktop.apps.Report.setCurrent():this.app.desktop.openApplication(null,"Report",{})}.bind(this));new Element("div.topItemSepNode",{styles:this.css.topItemSepNode,text:">"}).inject(e),new Element("div.topItemTitleNode",{styles:this.css.topItemTitleLastNode,text:this.data.title}).inject(e)},loadContentNode:function(){if(this.middleNode=new Element("div.middleNode",{styles:this.css.middleNode}).inject(this.contentContainer),this.isPrinted&&this.middleNode.setStyle("width","auto"),this.inforNode=new Element("div",{styles:this.css.inforNode}).inject(this.middleNode),this.mainContentNode=new Element("div.mainContentNode",{styles:this.css.mainContentNode}).inject(this.middleNode),this.loadInforContent(),"print"==this.options.type)MWF.xDesktop.requireApp("Report","StrategyExplorerPrint",null,!1),this.print=new MWF.xApplication.Report.StrategyExplorer.Print(this.mainContentNode,this,this.data,{isEdited:!1,isKeyworkEdited:!1,status:this.status}),this.print.load();else if("deployment"==this.status)MWF.xDesktop.requireApp("Report","StrategyExplorerDeploy",null,!1),this.deployment=new MWF.xApplication.Report.StrategyExplorer.Deployment(this.mainContentNode,this,this.data,{isEdited:this.isEdited,isKeyworkEdited:!1}),this.deployment.load();else if("summary"==this.status){var t=function(t,e){MWF.xDesktop.requireApp("Report","StrategyExplorerSummary",null,!1),this.summary=new MWF.xApplication.Report.StrategyExplorer.Summary(this.mainContentNode,this,this.data,{isToRead:t,isToReadLeader:e,isEdited:this.isEdited,status:this.status}),this.summary.load()}.bind(this);this.isToRead()?this.isToReadLeader((function(e){t(!0,e)})):t(!1,!1)}else MWF.xDesktop.requireApp("Report","StrategyExplorerWrite",null,!1),this.write=new MWF.xApplication.Report.StrategyExplorer.Write(this.mainContentNode,this,this.data,{isEdited:this.isEdited,status:this.status}),this.write.load()},verifyProcess:function(t){return"confirm"!=t&&"audit"!=t||this.write.verifyProcess(t)},loadInforContent:function(){if("summary"==this.status||"print"==this.options.type){var t="<table width='96%' bordr='0' cellpadding='7' cellspacing='0' styles='formTable' >   <td styles='formTableTitleP10' lable='unitManager' style='width:90px;'></td>    <td styles='formTableValueP10' item='unitManager' style='width:100px;'></td>   <td styles='formTableTitleP10' lable='activityName2' style='width:50px;'></td>    <td styles='formTableValueP10' item='activityName2' style='width:100px;'></td></tr>";t+="</table>",this.inforNode.set("html",t),MWF.xDesktop.requireApp("Template","MForm",function(){new MForm(this.inforNode,this.data,{usesNewVersion:!0,isEdited:!1,style:"report",hasColon:!0,itemTemplate:{createDateString:{text:this.lp.reportDate,type:"innertext"},unitManager:{text:"部主管",type:"org",orgType:"person",defaultValue:this.data.unitManager},activityName2:{text:this.lp.activityName,type:"innertext",defaultValue:this.data.reportStatus||this.data.activityName}}},this).load()}.bind(this),!0)}else{t="<table width='96%' bordr='0' cellpadding='7' cellspacing='0' styles='formTable' >   <td styles='formTableTitleP10' lable='targetPerson' style='width:90px;'></td>    <td styles='formTableValueP10' item='targetPerson' style='width:100px;'></td>   <td styles='formTableTitleP10' lable='activityName2' style='width:50px;'></td>    <td styles='formTableValueP10' item='activityName2' style='width:100px;'></td></tr>";"deployment"==this.status&&"print"!=this.options.type||(t+="<tr>   <td styles='formTableTitleP10' lable='currentPersonName' style='width:70px;'></td>    <td styles='formTableValueP10' item='currentPersonName' colspan='3'></td></tr>"),t+="</table>",this.inforNode.set("html",t),MWF.xDesktop.requireApp("Template","MForm",function(){new MForm(this.inforNode,this.data,{usesNewVersion:!0,isEdited:!1,style:"report",hasColon:!0,itemTemplate:{createDateString:{text:this.lp.reportDate,type:"innertext"},targetPerson:{text:"月度汇报员",type:"org",orgType:"person"},currentPersonName:{text:"汇报人",type:"org",orgType:"person",defaultValue:this.data.workreportPersonList},reportObjType:{text:this.lp.reportObjType,type:"select",selectValue:["","PERSON","UNIT"],selectText:["","个人汇报","组织汇报"]},activityName2:{text:this.lp.activityName,type:"innertext",defaultValue:this.data.reportStatus||this.data.activityName}}},this).load()}.bind(this),!0)}},resetNodeSize:function(){this.topNode&&this.topNode.getSize();var t=this.node.getSize(),e=this.contentContainer.getStyle("padding-top").toFloat(),i=this.contentContainer.getStyle("padding-bottom").toFloat(),s=t.y-e-i;this.contentContainer.setStyle("height",s+"px")},perview:function(){var t=this.getPerviewUrl();new MWF.xApplication.Report.StrategyExplorer.Previewer(this,{url:t},{},{app:this.app}).open()},getPerviewUrl:function(){var t=this.workApp.appForm.businessData,e=t.work?t.work.application:t.workCompleted.application,i=this.workApp.appForm,s=i.json.id;if(i.json.printForm&&(s=i.json.printForm),t.workCompleted){e=t.workCompleted.application;return window.location.protocol+"//"+window.location.host+"../x_component_Report/$Common/printWork.html?workCompletedId="+t.workCompleted.id+"&app="+e+"&form="+s+"&debugger"}e=t.work.application;return window.location.protocol+"//"+window.location.host+"../x_component_Report/$Common/printWork.html?workid="+t.work.id+"&app="+e+"&form="+s+"&debugger"}}),MWF.xApplication.Report.StrategyExplorer.Previewer=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"report",width:"95%",height:"95%",minWidth:300,minHeight:220,hasTop:!0,hasTopIcon:!1,hasTopContent:!1,hasIcon:!1,hasScroll:!1,hasBottom:!0,hasMask:!0,closeByClickMask:!0,title:"预览",draggable:!1,resizeable:!1,maxAction:!0,closeAction:!0,relativeToApp:!0,sizeRelateTo:"app"},_createTableContent:function(){this.formTableContainer.setStyles({width:"99%",height:"99%"}),this.formTableArea.setStyle("text-align","center"),this.iframe=new Element("iframe",{src:this.data.url,frameborder:0,height:"100%",width:"100%",scrolling:"auto",seamless:"seamless"}).inject(this.formTableArea)},_setNodesSize:function(t,e,i,s){this.iframe.set("width",t-100),this.iframe.set("height",s-5)},_createBottomContent:function(){(this.isNew||this.isEdited)&&(this.okActionNode=new Element("button.inputOkButton",{styles:this.css.inputOkButton,text:this.lp.save}).inject(this.formBottomNode),this.okActionNode.addEvent("click",function(t){this.save(t)}.bind(this))),this.cancelActionNode=new Element("button.inputCancelButton",{styles:this.isEdited||this.isNew?this.css.inputCancelButton:this.css.inputCancelButton_long,text:this.lp.close}).inject(this.formBottomNode),this.cancelActionNode.addEvent("click",function(t){this.close(t)}.bind(this))}});