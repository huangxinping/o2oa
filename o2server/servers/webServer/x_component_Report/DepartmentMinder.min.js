MWF.xApplication.Execution=MWF.xApplication.Execution||{},MWF.xDesktop.requireApp("Template","MForm",null,!1),MWF.xDesktop.requireApp("Template","Minder",null,!1),MWF.xDesktop.requireApp("Report","Common",null,!1),MWF.xApplication.Report.DepartmentMinder=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{id:"",year:"",style:"default",template:"default",theme:"fresh-blue-compat"},initialize:function(t,i,e,n){this.setOptions(n),this.app=i,this.path="../x_component_Report/$DepartmentMinder/",this.cssPath="../x_component_Report/$DepartmentMinder/"+this.options.style+"/css.wcss",this._loadCss(),this.lp=this.app.lp,this.actions=e,this.node=$(t)},load:function(){this.departmentCN=this.options.department.split("@")[0],this.app.setTitle(this.options.year+"年"+this.departmentCN+"工作汇报"),this.data={root:{data:{text:this.departmentCN,isRoot:!0,watch:!0},children:[]}},this.app.strategyActions.listMeasureByYearDepartment(this.options.year,this.options.department,function(t){var i=this.data.root.children,e=t.data||[],n=0;e.each(function(t){t.text=t.measuresinfotitle,t.note=" ",t.isMeasure=!0,t.watch=!0;var o={data:t,children:[]};this.app.strategyActions.listPriorityByUnitMeasure(this.options.year,t.id,this.options.department,function(t){t.data||(t.data=[]),t.data.each((function(t){t.keyworktitle&&(t.text=t.keyworktitle,t.note=" ",t.isPriority=!0,t.watch=!0,o.children.push({data:t,children:[{data:{text:"加载中..."}}]}))})),++n==e.length&&this.createMinder(this.data)}.bind(this)),i.push(o)}.bind(this))}.bind(this)),this.refreshFun=this.refresh.bind(this),this.app.addEvent("resize",this.refreshFun)},destroy:function(){for(var t in this.minder&&this.minder.destroy(),this.tooltips)this.tooltips[t].destroy();this.refreshFun&&this.app.removeEvent("resize",this.refreshFun)},refresh:function(){this.minder&&this.minder.refresh()},reload:function(){this.minder&&this.minder.destroy(),this.node.empty(),this.load()},createMinder:function(t){this.minder=new MWF.xApplication.Template.Minder(this.node,this.app,t,{hasNavi:!1,onPostLoad:function(){this.minder.km.execCommand("ExpandToLevel",2),this.minder.loadNavi(this.node)}.bind(this),onPostLoadNode:function(t){this.setMinderNode(t)}.bind(this)}),this.minder.load()},setMinderNode:function(t){var i=this;if(t.getData().watch){var e=t.getData(),n=t.getRenderer("NoteIconRenderer");if(n&&n.getRenderShape()){var o=n.getRenderShape();o.addEventListener("mouseover",function(t){i.tooltipTimer=setTimeout(function(){var t=this.getRenderBox("screen");i.loadTooltip(this.getData(),t)}.bind(this),300)}.bind(t)),o.addEventListener("mouseout",function(t){clearTimeout(i.tooltipTimer),i.hideTooltip()}.bind(t))}if(e.isPriority){var s=t.getRenderer("ExpanderRenderer").getRenderShape();s&&s.addEventListener("mousedown",function(t){var e=this.getData();e.loaded||setTimeout(function(){i.expendPriority(this,e,function(){}.bind(this))}.bind(this),100)}.bind(t))}t.getRenderContainer().node.addEventListener("click",function(t){var e=this.getData();e.isPriority&&(e.loaded?this.getRenderer("ExpanderRenderer").expander.fire("mousedown"):setTimeout(function(){i.expendPriority(this,e,function(){}.bind(this))}.bind(this),100))}.bind(t))}else;},expendPriority:function(t,i,e){this.isLoaddingChildren||(this.isLoaddingChildren=!0,this.actions.listWithPriority(this.options.year,{workIds:[i.id],unitList:[this.options.department]},function(e){i.loaded=!0;var n={},o=e.data;o.sort((function(t,i){return t.month.localeCompare(i.month)})),o.each((function(t){n[t.month]||(n[t.month]=[]),n[t.month].push(t)}));var s={data:i,children:[]};for(var r in n){var a=[];n[r].each(function(t){var i=[];t.progList.each(function(t){i.push(this.app.common.splitWithLength(t.targetPerson.split("@")[0]+"："+t.progressContent,35))}.bind(this)),a.push(i.join("\n"))}.bind(this)),s.children.push({data:{text:parseInt(r)+"月"},children:[{data:{text:a.join("\n")}}]})}for(;t.getChildren().length;){var d=t.getChildren()[0];this.minder.km.removeNode(d)}this.minder.km.importNode(t,s),t.expand(),this.minder.km.refresh(),this.isLoaddingChildren=!1}.bind(this)))},loadTooltip:function(t,i){if(this.tooltips||(this.tooltips={}),this.tooltips[t.id]){(e=this.currentTooltip=this.tooltips[t.id]).targetCoordinates=i,e.load()}else{if(t.isRoot)var e=this.currentTooltip=new MWF.xApplication.Report.KeyWorkTooltip(this.node,null,this.app,t,{},i);else if(t.isMeasure)e=this.currentTooltip=new MWF.xApplication.Report.MeasureTooltip(this.node,null,this.app,t,{},i);else if(t.isPriority)e=this.currentTooltip=new MWF.xApplication.Report.PriorityTooltip(this.node,null,this.app,t,{},i);e&&(e.load(),this.tooltips[t.id]=e)}},hideTooltip:function(){this.currentTooltip&&this.currentTooltip.hide()}});