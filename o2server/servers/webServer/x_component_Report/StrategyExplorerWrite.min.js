MWF.xApplication.Report.StrategyExplorer.Write=new Class({Implements:[Options,Events],options:{style:"default",isEdited:!1,status:"write"},initialize:function(t,e,i,s){this.setOptions(s),this.container=t,this.explorer=e,this.app=this.explorer.app,this.lp=this.app.lp,this.css=this.explorer.css,this.actions=this.app.restActions,this.data=i,this.path="../x_component_Report/$StrategyExplorer/"},load:function(){if(this.month=parseInt(this.data.month),this.thisMonth_inputContent_all=[],this.nextMonth_inputTitle_all=[],this.nextMonth_inputContent_all=[],this.nextMonth_inputTitle=[],this.thisMonthKeyworkList=[],this.thisMonthKeyworkNode=new Element("div",{}).inject(this.explorer.summaryContainer),this.data.thisMonth_workList.each(function(t,e){var i=new MWF.xApplication.Report.StrategyExplorer.Write.ThisKeyWorkItem(this.thisMonthKeyworkNode,this,t,{reportId:this.data.id,isEdited:this.options.isEdited,status:this.options.status,orderNumber:e+1});i.load(),this.thisMonthKeyworkList.push(i)}.bind(this)),this.nexMonthKeyworkList=[],this.nextMonthKeyWorkNode=new Element("div",{}).inject(this.explorer.planContainer),this.data.nextMonth_workList.each(function(t,e){if(""==t.workTitle){var i=this.data.thisMonth_workList&&this.data.thisMonth_workList.length>e?this.data.thisMonth_workList[e].workTitle:"";i&&(t.workTitle=i,this.app.restActions.saveWorkInfor(t,function(){}.bind(this)))}var s=new MWF.xApplication.Report.StrategyExplorer.Write.NextKeyWorkItem(this.nextMonthKeyWorkNode,this,t,{reportId:this.data.id,isEdited:this.options.isEdited,status:this.options.status,orderNumber:e+1,defaultTitle:this.data.thisMonth_workList&&this.data.thisMonth_workList.length>e?this.data.thisMonth_workList[e].workTitle:""});s.load(),this.nexMonthKeyworkList.push(s)}.bind(this)),this.options.isEdited&&"write"==this.options.status){var t=this;this.nextMonth_inputTitle.each(function(e,i){var s=new Element("button",{value:"沿用标题",text:"沿用标题",title:"标题沿用上月重点工作",styles:this.css.normalButton,events:{click:function(){var e=this.index,i=this.input;t.data.thisMonth_workList&&t.data.thisMonth_workList.length>e&&(i.get("value")?i.set("value",i.get("value")+" "+t.data.thisMonth_workList[e].workTitle):i.set("value",t.data.thisMonth_workList[e].workTitle))}.bind({input:e,index:i})}}).inject(e,"before");t.data.thisMonth_workList&&t.data.thisMonth_workList.length>i&&new Element("div",{styles:{"margin-bottom":"5px"},html:this.app.common.replaceWithBr(t.data.thisMonth_workList[i].workTitle)}).inject(s,"before")}.bind(this))}this.extWorkNode=new Element("div",{styles:{width:"96%",margin:"0px auto"}}).inject(this.explorer.threeworkContainer),(this.extWork=new MWF.xApplication.Report.StrategyExplorer.Write.ExtWork(this.extWorkNode,this,this.data,{reportId:this.data.id,isEdited:this.options.isEdited,status:this.options.status})).load()},getExtKeywork:function(t,e){for(var i=this["ext"+t+"KeyworkList"],s=0;s<i.length;s++)if(i[s].data.id==e)return i[s];return null},getThisMonthKeywork:function(t){for(var e=0;e<this.thisMonthKeyworkList.length;e++)if(this.thisMonthKeyworkList[e].data.id==t)return this.thisMonthKeyworkList[e];return null},getNextMonthKeywork:function(t){for(var e=0;e<this.nexMonthKeyworkList.length;e++)if(this.nexMonthKeyworkList[e].data.id==t)return this.nexMonthKeyworkList[e];return null},listPlan:function(t,e,i){!e&&this.planDataObject?i&&i(this.planDataObject[t]||[]):this.actions.listPlan(this.data.id||this.options.id,function(e){this.planDataObject={},e.data.each(function(t){this.planDataObject[t.workInfoId]||(this.planDataObject[t.workInfoId]=[]),this.planDataObject[t.workInfoId].push(t)}.bind(this)),i&&i(this.planDataObject[t]||[])}.bind(this))},listWork:function(t,e,i){!e&&this.workDataObject?i&&i(this.workDataObject[t]||[]):this.actions.listWork(this.data.id||this.options.id,function(e){this.workDataObject={},e.data.each(function(t){this.workDataObject[t.workInfoId]||(this.workDataObject[t.workInfoId]=[]),this.workDataObject[t.workInfoId].push(t)}.bind(this)),i&&i(this.workDataObject[t]||[])}.bind(this))},listPlanNext:function(t,e,i){!e&&this.planNextDataObject?i&&i(this.planNextDataObject[t]||[]):this.actions.listPlanNext(this.data.id||this.options.id,function(e){this.planNextDataObject={},e.data.each(function(t){this.planNextDataObject[t.workInfoId]||(this.planNextDataObject[t.workInfoId]=[]),this.planNextDataObject[t.workInfoId].push(t)}.bind(this)),i&&i(this.planNextDataObject[t]||[])}.bind(this))},submit:function(){var t=!1,e=this.getResult(!0);if(e&&this.actions.saveWorkPerson(e,function(){t=!0}.bind(this),null,!1),!t&&this.errorNodeList&&this.errorNodeList.length>0){var i=this.errorNodeList[0];this.app.scrollNode&&this.app.scrollNode.scrollTo(0,i.getCoordinates().top-this.app.scrollNode.getCoordinates().top+this.app.scrollNode.scrollTop.toFloat()-120)}return t},save:function(){var t=!1,e=this.getResult(!1);return e&&this.actions.saveWorkPerson(e,function(){t=!0}.bind(this),null,!1),t},verifyProcess:function(t){if(this.errorNodeList&&this.errorNodeList.length)for(;this.errorNodeList.length>0;)this.errorNodeList.pop().destroy();if("confirm"==t||"audit"==t){var e=!0;this.thisMonth_inputContent_all.each(function(t){""==t.get("value")&&(e=!1,this.createErrorNode(t,"请填写工作总结"))}.bind(this));var i=!0;this.nextMonth_inputTitle_all.each(function(t){""==t.get("value")&&(i=!1,this.createErrorNode(t,"请填写标题"))}.bind(this));var s=!0;this.nextMonth_inputContent_all.each(function(t){""==t.get("value")&&(s=!1,this.createErrorNode(t,"请填写工作计划"))}.bind(this));var n,a,o;this.extWork.gridContainer.getElements("textarea").each(function(t){var e=t.get("name").split("_")[0];""!=t.get("value").trim()&&("fuwu"==e&&(n=!0),"guanai"==e&&(a=!0),"yijian"==e&&(o=!0))}.bind(this));var r=[];return n||r.push("至少需要填写一项服务客户内容"),a||r.push("至少需要填写一项关爱员工内容"),o||r.push("至少需要填写一项意见建议内容"),r.length>0&&this.createErrorNode(this.extWork.gridContainer,r.join(",")+"。"),r=[],e||r.push("本月工作总结不能为空"),i||r.push("下月部门重点工作不能为空"),s||r.push("下月工作计划工作不能为空"),n||r.push("至少需要填写一项服务客户内容"),a||r.push("至少需要填写一项关爱员工内容"),o||r.push("至少需要填写一项意见建议内容"),r.length>0&&this.app.notice(r.join(",<br/>")+"。","error"),e&&i&&s&&n&&a&&o}return!0},getResult:function(t){this.errorNodeList&&(this.errorNodeList.each(function(t){t.destroy()}.bind(this)),this.errorNodeList=[]);var e=!0;if(this.options.isEdited&&"confirm"==this.options.status){var i=[];return this.nexMonthKeyworkList.each(function(s){var n=s.getWorkTitle();n&&0!=n.length||t&&(this.createErrorNode(s.workTitleInput,"请填写工作标题",{float:"left"}),e=!1);var a=s.getMeasuresList();a&&0!=a.length||t&&(this.createErrorNode(s.measureContentNode,"请选择举措"),e=!1),i.push({id:s.data.id,orderNumber:s.getOrderNumber(),workTitle:n,measuresList:a})}.bind(this)),!!e&&{id:this.data.id,workList:i}}},createErrorNode:function(t,e,i){this.errorNodeList||(this.errorNodeList=[]);var s=new Element("div",{text:e,styles:this.css.warningMessageNode}).inject(t,"after");i&&s.setStyles(i),this.errorNodeList.push(s)}}),MWF.xApplication.Report.StrategyExplorer.Write.ThisKeyWorkItem=new Class({Implements:[Options,Events],options:{style:"default",reportId:"",isEdited:!0,orderNumber:1,status:""},initialize:function(t,e,i,s){this.setOptions(s),this.container=t,this.explorer=e,this.app=this.explorer.app,this.lp=this.app.lp,this.css=this.explorer.css,this.actions=this.app.restActions,this.data=i},load:function(){var t=this.options.status,e=new Element("table",{width:"96%",border:"0",cellpadding:"5",cellspacing:"0",styles:this.css.formTable}).inject(this.container),i=new Element("tr").inject(e);new Element("td",{rowspan:3,text:this.data.orderNumber||this.options.orderNumber,width:"30",styles:this.css.formTableTitle}).inject(i),new Element("td",{text:"部门重点工作",width:"140",styles:this.css.formTableTitle}).inject(i);var s=new Element("td",{styles:this.css.formTableValue}).inject(i);new Element("div",{html:this.app.common.replaceWithBr(this.data.workTitle),styles:{width:"870px",float:"left"}}).inject(s);var n=new Element("input",{type:"button",styles:this.css.showMeasureNode,value:"查看举措"}).inject(s);if(new MWF.xApplication.Report.ShowMeasureTooltip(this.app.content,n,this.app,this.explorer.data,{style:"report",position:{x:"auto",y:"auto"},event:"click"}).measuresList=this.data.measuresList,i=new Element("tr").inject(e),new Element("td",{text:"工作计划",styles:this.css.formTableTitle}).inject(i),s=new Element("td",{styles:this.css.formTableValue,html:this.app.common.replaceWithBr(this.data.workPlanSummary)}).inject(i),i=new Element("tr").inject(e),new Element("td",{text:"工作总结",styles:this.css.formTableTitle}).inject(i),s=new Element("td",{styles:this.css.formTableValue}).inject(i),"confirm"!=t&&"write"!=t||this.loadWorkView(s),"confirm"==t||"audit"==t)if(this.options.isEdited)this.contentInput_all=new Element("textarea",{placeholder:"confirm"==t?"请汇总工作总结":"",styles:this.css.textarea,value:this.data.workProgSummary}).inject(s),this.explorer.thisMonth_inputContent_all.push(this.contentInput_all),this.contentInput_all.addEvent("blur",function(){this.data.workProgSummary!=this.contentInput_all.get("value")&&(this.data.workProgSummary=this.contentInput_all.get("value"),this.app.onChangeValue&&this.app.onChangeValue()),this.app.restActions.saveWorkProgSummary({id:this.data.id,workProgSummary:this.contentInput_all.get("value")},function(){this.app.notice("工作总结保存并上传成功","success",this.contentInput_all.getParent())}.bind(this))}.bind(this));else if("confirm"==t){var a=new Element("div").inject(s),o="<table width='100%' bordr='0' cellpadding='3' cellspacing='0' style='margin-top: 5px; '><tr><td width='70' align='center'>汇总:</td>    <td>"+this.app.common.replaceWithBr(this.data.workProgSummary)+"</td></table>";a.set("html",o)}else{(a=new Element("div").inject(s)).set("html",this.app.common.replaceWithBr(this.data.workProgSummary))}},addContentToAll:function(t){var e=this.contentInput_all.get("value");e?this.contentInput_all.set("value",e+" "+t.progressContent):this.contentInput_all.set("value",t.progressContent),this.app.onChangeValue&&this.app.onChangeValue(),this.data.workProgSummary=this.contentInput_all.get("value"),this.app.restActions.saveWorkProgSummary({id:this.data.id,workProgSummary:this.contentInput_all.get("value")},function(){this.app.notice("工作总结保存并上传成功","success",this.contentInput_all.getParent())}.bind(this))},loadPlanView:function(t){this.planViewNode=new Element("div").inject(t),this.planView=new MWF.xApplication.Report.StrategyExplorer.PlanView(this.planViewNode,this.app,this,{style:"default",documentSortable:!1,reportId:this.options.reportId,isEdited:this.options.isEdited,templateUrl:this.explorer.path+"listItemPlan.json",onDocumentSortComplete:function(t,e){var i=[];this.planView.node.getElements("[item='id']").each(function(t,e){var s=t.get("text");this.planView.documents[s].data.orderNumber=e+1,i.push({id:s,orderNumber:e+1})}.bind(this)),this.actions.updatePlanOrder({orderList:i})}.bind(this)}),this.planView.report=this.explorer.explorer,this.planView.data=this.data.planList,this.planView.load()},loadWorkView:function(t){this.workView=new MWF.xApplication.Report.StrategyExplorer.WorkView(t||this.workViewNode,this.app,this,{style:"default",documentSortable:!1,reportId:this.options.reportId,isEdited:this.options.isEdited,templateUrl:this.explorer.path+"listItemWork.json",onDocumentSortComplete:function(t,e){var i=[];this.workView.node.getElements("[item='id']").each(function(t,e){var s=t.get("text");this.workView.documents[s].data.orderNumber=e+1,i.push({id:s,orderNumber:e+1})}.bind(this)),this.actions.updateWorkOrder({orderList:i})}.bind(this)}),this.workView.report=this.explorer.explorer,this.workView.data=this.data.progList,this.workView.load()}}),MWF.xApplication.Report.StrategyExplorer.Write.NextKeyWorkItem=new Class({Implements:[Options,Events],options:{style:"default",reportId:"",isEdited:!1,orderNumber:1,status:"",defaultTitle:""},initialize:function(t,e,i,s){this.setOptions(s),this.container=t,this.explorer=e,this.app=this.explorer.app,this.lp=this.app.lp,this.css=this.explorer.css,this.actions=this.app.restActions,this.data=i},load:function(){var t=this.options.status,e=new Element("table",{width:"96%",border:"0",cellpadding:"5",cellspacing:"0",styles:this.css.formTable}).inject(this.container),i=new Element("tr").inject(e);new Element("td",{rowspan:"write"==t?3:4,text:this.data.orderNumber||this.options.orderNumber,width:"30",styles:this.css.formTableTitle}).inject(i),new Element("td",{text:"write"==t?"标题":"部门重点工作",width:"140",styles:this.css.formTableTitle}).inject(i);var s=new Element("td",{styles:this.css.formTableValue}).inject(i);if("confirm"!=t&&"write"!=t||this.loadPlanTitleViewNext(s),"confirm"==t||"audit"==t)if(this.options.isEdited)this.titleInput_all=new Element("textarea",{placeholder:"confirm"==t?"请汇总部门重点工作":"",styles:this.css.textarea,value:this.data.workTitle||this.options.defaultTitle}).inject(s),this.explorer.nextMonth_inputTitle_all.push(this.titleInput_all),this.titleInput_all.addEvent("blur",function(){var t=Object.clone(this.data);delete t.planNextList,delete t.planList,this.data.workTitle!=this.titleInput_all.get("value")&&(this.data.workTitle=this.titleInput_all.get("value"),this.app.onChangeValue&&this.app.onChangeValue()),t.workPlanSummary=this.contentInput_all.get("value"),t.workTitle=this.titleInput_all.get("value"),this.app.restActions.saveWorkInfor(t,function(){this.app.notice("部门重点工作保存并上传成功","success",this.titleInput_all.getParent())}.bind(this))}.bind(this));else if("confirm"==t){var n=new Element("div").inject(s),a="<table width='100%' bordr='0' cellpadding='3' cellspacing='0' style='margin-top: 5px; '><tr><td width='70' align='center'>汇总:</td>    <td>"+this.app.common.replaceWithBr(this.data.workTitle)+"</td></table>";n.set("html",a)}else{(n=new Element("div").inject(s)).set("html",this.app.common.replaceWithBr(this.data.workTitle))}if("confirm"==t||"audit"==t){i=new Element("tr").inject(e);new Element("td",{text:"举措",width:"140",styles:this.css.formTableTitle}).inject(i);s=new Element("td",{styles:this.css.formTableValue}).inject(i);var o=new Element("table",{width:"100%",border:0,cellspacing:0,cellpadding:0,styles:this.css.listViewTable}).inject(s),r=new Element("tr",{styles:this.css.listViewTableTr}).inject(o),l=new Element("td",{styles:this.css.listViewTableTd}).inject(r);if(this.measureContentNode=new Element("div").inject(l),this.loadMeasureList(this.data.measuresList||[]),l=new Element("td",{styles:this.css.listViewTableTd,width:"80"}).inject(r),this.options.isEdited){var h=new Element("button",{text:"选择举措",styles:this.css.selectMeasureAction}).inject(l);new MWF.xApplication.Report.SelectMeasureTooltips(this.app.content,h,this.app,this.explorer.data,{style:"report",hasArrow:!1,position:{x:"auto",y:"auto"},event:"click",onSelect:function(t,e){this.measureContentNode.empty();var i=[];t.each((function(t){i.push(t.id)})),this.loadMeasureList(i),this.app.onChangeValue&&this.app.onChangeValue(),this.measuresList=this.data.measuresList=i;var s=Object.clone(this.data);delete s.planNextList,delete s.planList,s.workPlanSummary=this.contentInput_all.get("value"),s.workTitle=this.titleInput_all.get("value"),this.app.restActions.saveWorkInfor(s,function(){this.app.notice("举措保存并上传成功","success")}.bind(this))}.bind(this)}).measuresList=this.data.measuresList}}if(i=new Element("tr").inject(e),new Element("td",{text:"工作计划",styles:this.css.formTableTitle}).inject(i),s=new Element("td",{styles:this.css.formTableValue}).inject(i),"confirm"!=t&&"write"!=t||this.loadPlanViewNext(s),"confirm"==t||"audit"==t)if(this.options.isEdited)this.contentInput_all=new Element("textarea",{placeholder:"confirm"==t?"请汇总计划":"",styles:this.css.textarea,value:this.data.workPlanSummary}).inject(s),this.explorer.nextMonth_inputContent_all.push(this.contentInput_all),this.contentInput_all.addEvent("blur",function(){this.data.workPlanSummary!=this.contentInput_all.get("value")&&(this.data.workPlanSummary=this.contentInput_all.get("value"),this.app.onChangeValue&&this.app.onChangeValue()),this.app.restActions.saveWorkPlanSummary({id:this.data.id,workPlanSummary:this.contentInput_all.get("value")},function(){this.app.notice("工作计划保存并上传成功","success",this.contentInput_all.getParent())}.bind(this))}.bind(this));else if("confirm"==t){n=new Element("div").inject(s),a="<table width='100%' bordr='0' cellpadding='3' cellspacing='0' style='margin-top: 5px; '><tr><td width='70' align='center'>汇总:</td>    <td>"+this.app.common.replaceWithBr(this.data.workPlanSummary)+"</td></table>";n.set("html",a)}else{(n=new Element("div").inject(s)).set("html",this.app.common.replaceWithBr(this.data.workPlanSummary))}},addTitleToAll:function(t){var e=this.titleInput_all.get("value");e?this.titleInput_all.set("value",e+" "+t.title):this.titleInput_all.set("value",t.title),delete(t=Object.clone(this.data)).planNextList,delete t.planList,this.data.workTitle=this.titleInput_all.get("value"),this.app.onChangeValue&&this.app.onChangeValue(),t.workPlanSummary=this.contentInput_all.get("value"),t.workTitle=this.titleInput_all.get("value"),this.app.restActions.saveWorkInfor(t,function(){this.app.notice("部门重点工作保存并上传成功","success",this.titleInput_all.getParent())}.bind(this))},addContentToAll:function(t){var e=this.contentInput_all.get("value");e?this.contentInput_all.set("value",e+" "+t.planContent):this.contentInput_all.set("value",t.planContent),this.data.workPlanSummary=this.contentInput_all.get("value"),this.app.onChangeValue&&this.app.onChangeValue(),this.app.restActions.saveWorkPlanSummary({id:this.data.id,workPlanSummary:this.contentInput_all.get("value")},function(){this.app.notice("工作计划保存并上传成功","success",this.contentInput_all.getParent())}.bind(this))},getOrderNumber:function(){return this.data.orderNumber||this.options.orderNumber},getWorkTitle:function(){return this.workTitleInput.get("value")},getMeasuresList:function(){return this.measuresList||this.data.measuresList},loadMeasureList:function(t){this.selectableMeasureObject={},(this.explorer.data.nextMonth_selectableMeasures||[]).each(function(t){this.selectableMeasureObject[t.id]=t}.bind(this));var e=new Element("table",{width:"100%",border:0,cellspacing:0,cellpadding:3,styles:this.css.listViewTable}).inject(this.measureContentNode);t.each(function(t,i){if(t){var s=this.selectableMeasureObject[t],n=new Element("tr",{styles:this.css.listViewTableTr}).inject(e),a=new Element("td",{styles:this.css.listViewTableTd,width:"40"}).inject(n),o=new Element("div",{styles:this.css.descriptionNode,text:"详情"}).inject(a);this.loadMeasureTooltip(o,t);a=new Element("td",{styles:this.css.listViewTableTd,text:s.measuresinfotitle}).inject(n)}}.bind(this))},loadMeasureTooltip:function(t,e){new MWF.xApplication.Report.MeasureTooltip(this.app.content,t,this.app,this.selectableMeasureObject[e],{style:"report",position:{x:"auto",y:"auto"},measureId:e,displayDelay:300})},loadPlanTitleViewNext:function(t){this.planViewTitleNextNode=new Element("div",{"data-id":this.data.id}).inject(t),this.planTitleViewNext=new MWF.xApplication.Report.StrategyExplorer.PlanTitleViewNext(this.planViewTitleNextNode,this.app,this,{style:"default",reportId:this.options.reportId,isEdited:this.options.isEdited,templateUrl:this.explorer.path+"listItemPlanTitleNext.json"}),this.planTitleViewNext.report=this.explorer.explorer,this.planTitleViewNext.load()},loadPlanViewNext:function(t){this.planViewNextNode=new Element("div",{"data-id":this.data.id}).inject(t),this.planViewNext=new MWF.xApplication.Report.StrategyExplorer.PlanViewNext(this.planViewNextNode,this.app,this,{style:"default",reportId:this.options.reportId,isEdited:this.options.isEdited,templateUrl:this.explorer.path+"listItemPlanNext.json"}),this.planViewNext.report=this.explorer.explorer,this.planViewNext.load()},savePersonPlan:function(t,e){var i=this.currentPersonData,s=this.titleInput.get("value").trim(),n=this.contentInput.get("value").trim();if(s||n){if(!i){i={};var a=this.explorer.explorer.data,o=this.data;i.reportId=a.id,i.workInfoId=o.id,i.keyWorkId=o.keyWorkId,i.workTitle=o.workTitle,i.flag=a.flag,i.year=a.year,i.month=a.month,i.week=a.week,i.date=a.date,i.targetPerson=(layout.desktop.session.user||layout.user).distinguishedName,i.orderNumber=this.options.orderNumber||1}i.title=s,i.workDescribe=n,i.planContent=n,this.app.restActions.savePlanNext(i,function(i){var s=i.data.id;this.app.restActions.getPlanNext(s,function(t){this.currentPersonData=t.data}.bind(this)),this.app.notice(e,"success",t.target.getParent())}.bind(this))}else s||n||!i||this.app.restActions.deletePlanNext(i.id,function(){this.currentPersonData=null,this.app.notice(e,"success",t.target.getParent())}.bind(this))}}),MWF.xApplication.Report.StrategyExplorer.Write.ExtWork=new Class({Implements:[Options,Events],options:{style:"default",reportId:"",isEdited:!0,status:""},initialize:function(t,e,i,s){this.setOptions(s),this.container=t,this.explorer=e,this.app=this.explorer.app,this.lp=this.app.lp,this.css=this.explorer.css,this.actions=this.app.restActions,this.data=i},load:function(){this.userName=(layout.desktop.session.user||layout.user).distinguishedName,this.summaryContainer_last=new Element("div").inject(this.container),this.personContainer=new Element("div").inject(this.container),this.summaryContainer=new Element("div").inject(this.container),this.listSummary_last(),"confirm"!=this.options.status&&"write"!=this.options.status||this.listPersonData(),"confirm"!=this.options.status&&"audit"!=this.options.status||this.listSummaryData()},listSummary_last:function(){if(this.data.WoReport_I_Ext_Contents_sumamry_lastMonth){var t=this.table=new Element("table",{width:"100%",border:"0",cellpadding:"5",cellspacing:"0",styles:this.css.formTable}).inject(this.summaryContainer_last),e=new Element("tr").inject(t);new Element("td",{colspan:4,styles:this.css.formTableTitle,text:"上月汇总"}).inject(e),e=new Element("tr").inject(t),new Element("td",{width:"30",styles:this.css.formTableTitle,text:"序号"}).inject(e),new Element("td",{width:"140",styles:this.css.formTableTitle,text:"服务客户"}).inject(e),new Element("td",{width:"140",styles:this.css.formTableTitle,text:"关爱员工"}).inject(e),new Element("td",{width:"140",styles:this.css.formTableTitle,text:"意见建议"}).inject(e),this.data.WoReport_I_Ext_Contents_sumamry_lastMonth.each(function(i,s){e=new Element("tr").inject(t),new Element("td",{width:"30",align:"center",styles:this.css.formTableValue,text:s+1}).inject(e).setStyle("text-align","center"),new Element("td",{text:i.fuwu,width:"140",styles:this.css.formTableValue}).inject(e),new Element("td",{text:i.guanai,width:"140",styles:this.css.formTableValue}).inject(e),new Element("td",{text:i.yijian,width:"140",styles:this.css.formTableValue}).inject(e)}.bind(this))}},listSummaryData:function(){var t=this.data.WoReport_I_Ext_Contents_sumamry;if(t&&t.length)this.loadSummaryGrid(this.data.WoReport_I_Ext_Contents_sumamry);else{for(var e=1;e<=5;e++){var i={infoLevel:"汇总",orderNumber:e};this.app.restActions.saveExtWork(this.data.id,i,function(t){}.bind(this),null,!1)}this.actions.listExtWorkWithReportId(this.data.id,{infoLevel:"汇总"},function(t){this.loadSummaryGrid(t.data)}.bind(this))}},listPersonData:function(){var t=[],e=[],i=this.data.WoReport_I_Ext_Contents||[];i.sort((function(t,e){var i=t.targetPerson.localeCompare(e.targetPerson);return 0==i?t.orderNumber-e.orderNumber:i})),i.each(function(i){i.targetPerson==this.userName&&"write"==this.options.status?t.push(i):(i.fuwu||i.guanai||i.yijian)&&e.push(i)}.bind(this)),this.loadPersonTable(e),"write"==this.options.status&&this.loadPersonGrid(t)},loadSummaryGrid:function(t){this.gridContainer=new Element("div").inject(this.summaryContainer),MWF.xDesktop.requireApp("Template","MGrid",function(){var e=new MGrid(this.gridContainer,t,{style:"report",isEdited:this.options.isEdited,hasOperation:!1,hasSequence:!0,tableAttributes:{width:"100%",border:"0",cellpadding:"5",cellspacing:"0"},itemTemplate:{fuwu:{attr:{placeholder:"请汇总服务客户"},text:"服务客户",type:"textarea",event:{blur:function(t,e){this.saveExtWork_summary(t,e,"服务客户")}.bind(this)}},guanai:{attr:{placeholder:"请汇总关爱员工"},text:"关爱员工",type:"textarea",event:{blur:function(t,e){this.saveExtWork_summary(t,e,"关爱员工")}.bind(this)}},yijian:{attr:{placeholder:"请汇总意见建议"},text:"意见建议",type:"textarea",event:{blur:function(t,e){this.saveExtWork_summary(t,e,"意见建议")}.bind(this)}}},onPostCreateTable:function(t){var e=t.table,i=new Element("tr").inject(e);new Element("td",{colspan:4,styles:this.css.formTableTitle,text:"本月汇总"}).inject(i)},onQueryCreateTr:function(){},onQueryRemoveTr:function(t,e,i){}.bind(this)},this.app);e.load();var i=t.length?5-t.length:5;e.addTrs(i-1)}.bind(this),!0)},loadPersonTable:function(t){var e=this.table=new Element("table",{width:"100%",border:"0",cellpadding:"5",cellspacing:"0",styles:this.css.formTable}).inject(this.personContainer),i="write"==this.options.status?"本月同事填写":"本月员工填写",s=new Element("tr").inject(e);new Element("td",{colspan:this.options.isEdited?5:4,styles:this.css.formTableTitle,text:i}).inject(s);s=new Element("tr").inject(e);new Element("td",{width:"20",styles:this.css.formTableTitle,text:"姓名"}).inject(s),new Element("td",{width:"100",styles:this.css.formTableTitle,text:"服务客户"}).inject(s),new Element("td",{width:"100",styles:this.css.formTableTitle,text:"关爱员工"}).inject(s),new Element("td",{width:"100",styles:this.css.formTableTitle,text:"意见建议"}).inject(s),t.each(function(t){var i=new Element("tr").inject(e);new Element("td",{styles:this.css.formTableValue,text:t.targetPerson.split("@")[0]}).inject(i),new Element("td",{styles:this.css.formTableValue,text:t.fuwu}).inject(i),new Element("td",{styles:this.css.formTableValue,text:t.guanai}).inject(i),new Element("td",{styles:this.css.formTableValue,text:t.yijian}).inject(i)}.bind(this))},loadPersonGrid:function(t){this.gridContainer=new Element("div").inject(this.personContainer),MWF.xDesktop.requireApp("Template","MGrid",function(){new MGrid(this.gridContainer,t,{style:"report",isEdited:this.options.isEdited,hasOperation:!0,hasSequence:!0,minTrCount:1,maxTrCount:5,tableAttributes:{width:"100%",border:"0",cellpadding:"5",cellspacing:"0"},lp:{add:"添加",remove:"删除"},itemTemplate:{fuwu:{text:"服务客户",type:"textarea",event:{blur:function(t,e){this.saveExtWork_person(t,e,"服务客户")}.bind(this)}},guanai:{text:"关爱员工",type:"textarea",event:{blur:function(t,e){this.saveExtWork_person(t,e,"关爱员工")}.bind(this)}},yijian:{text:"意见建议",type:"textarea",event:{blur:function(t,e){this.saveExtWork_person(t,e,"意见建议")}.bind(this)}}},onNewData:function(t,e){var i=t.trList;if(i.length>0)var s=i[i.length-1].sourceData.orderNumber+1;else s=1;e&&e(this.addEmptyExtWork_person(s))}.bind(this),onPostCreateTable:function(t){var e=t.table,i=new Element("tr").inject(e);new Element("td",{colspan:this.options.isEdited?5:4,styles:this.css.formTableTitle,text:"本月本人填写"}).inject(i)},onQueryRemoveTr:function(t,e,i){i.sourceData&&i.sourceData.id&&this.app.restActions.deleteExtWork(this.options.reportId,i.sourceData.id,function(){}.bind(this),null,!1)}.bind(this)},this.app).load()}.bind(this),!0)},saveExtWork_summary:function(t,e,i){var s=t.parent.getResult(!0,"<br>",!1,!1,!0);s.infoLevel="汇总",s.orderNumber||(s.orderNumber=t.options.index),this.app.onChangeValue&&this.app.onChangeValue(),this.app.restActions.saveExtWork(this.data.id,s,function(n){s.id||this.app.restActions.getExtWork(n.data.id,function(e){t.parent.sourceData=e.data}.bind(this),null,!1),this.app.notice(i+"保存并上传成功","success",e.target.getParent("tr"))}.bind(this),null,!1)},saveExtWork_person:function(t,e,i){var s=t.parent.getResult(!0,"<br>",!1,!1,!0);s.infoLevel="员工",s.orderNumber||(s.orderNumber=1),this.app.restActions.saveExtWork(this.data.id,s,function(n){s.id||this.app.restActions.getExtWork(n.data.id,function(e){t.parent.sourceData=e.data}.bind(this),null,!1),this.app.notice(i+"保存并上传成功","success",e.target.getParent("tr"))}.bind(this),null,!1)},addEmptyExtWork_person:function(t){var e,i={};return i.infoLevel="员工",i.orderNumber=t,this.app.restActions.saveExtWork(this.data.id,i,function(t){this.app.restActions.getExtWork(t.data.id,function(t){e=t.data}.bind(this),null,!1)}.bind(this),null,!1),e}}),MWF.xApplication.Report.StrategyExplorer.WorkView=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexView,_createDocument:function(t,e){return new MWF.xApplication.Report.StrategyExplorer.WorkDocument(this.viewBodyNode||this.viewNode,t,this.departmentexplorer,this,null,e)},_getCurrentPageData:function(t,e,i){if(this.userName=(layout.desktop.session.user||layout.user).distinguishedName,this.loaded)this.explorer.explorer.listWork(this.explorer.data.id,this.loaded,function(e){this.loaded=!0,e.sort((function(t,e){return t.orderNumber-e.orderNumber})),t&&t({data:e})}.bind(this));else{this.loaded=!0;var s=this.explorer.data.progList||[];t&&t({data:s})}},_removeDocument:function(t,i){this.app.common.deleteWork(t,e,function(){this.reload()}.bind(this))},_openDocument:function(t){this.app.common.openWork(t,this.report.data,this.explorer.data,this,this.report.isEdited)},_postCreateViewBody:function(t){"write"==this.getStatus()&&this.options.isEdited&&(this.contentInput=new Element("textarea",{placeholder:"请填写您的工作总结",styles:this.css.textarea}).inject(this.container),this.currentPersonData&&(this.contentInput.set("text",this.currentPersonData.progressContent),this.contentInput.set("value",this.currentPersonData.progressContent)),this.contentInput.addEvent("blur",function(t){this.saveWork(t,"工作总结保存并上传成功")}.bind(this)))},saveWork:function(t,e){var i=this.currentPersonData,s=this.contentInput.get("value").trim();if(s){if(!i){i={};var n=this.report.data,a=this.explorer.data;i.reportId=n.id,i.workInfoId=a.id,i.keyWorkId=a.keyWorkId,i.title=a.workTitle,i.workTitle=a.workTitle,i.flag=n.flag,i.year=n.year,i.month=n.month,i.week=n.week,i.date=n.date,i.targetPerson=(layout.desktop.session.user||layout.user).distinguishedName,i.orderNumber=this.options.orderNumber||1}i.workDescribe=s,i.progressContent=s,this.app.restActions.saveWork(i,function(i){var s=i.data.id;this.app.restActions.getWork(s,function(t){this.currentPersonData=t.data}.bind(this)),this.app.notice(e,"success",t.target.getParent())}.bind(this))}else!s&&i&&this.app.restActions.deleteWork(i.id,function(){this.currentPersonData=null,this.app.notice(e,"success",t.target.getParent())}.bind(this))},getStatus:function(){return this.status||(this.status=this.explorer.options.status),this.status}}),MWF.xApplication.Report.StrategyExplorer.WorkDocument=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexDocument,open:function(){},edit:function(t,e){},delete:function(t,e){this.app.common.deleteWork(this.data,e,function(){this.view.reload()}.bind(this)),e.stopPropagation()},_postCreateDocumentNode:function(t,e){"write"==this.view.getStatus()&&this.view.options.isEdited&&e.targetPerson==this.view.userName&&(t.setStyle("display","none"),this.view.currentPersonData=e)}}),MWF.xApplication.Report.StrategyExplorer.PlanView=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexView,_createDocument:function(t,e){return new MWF.xApplication.Report.StrategyExplorer.PlanDocument(this.viewBodyNode||this.viewNode,t,this.explorer,this,null,e)},_getCurrentPageData:function(t,e,i){this.userName=(layout.desktop.session.user||layout.user).distinguishedName,this.loaded?this.explorer.explorer.listPlan(this.explorer.data.id,this.loaded,function(e){this.loaded=!0,e.sort((function(t,e){return t.orderNumber-e.orderNumber})),t&&t({data:e})}.bind(this)):(this.loaded=!0,t&&t({data:this.explorer.data.planList}))},_openDocument:function(t){this.app.common.openPlan(t,this.report.data,this.explorer.data,this,!1,this.report.isEdited)}}),MWF.xApplication.Report.StrategyExplorer.PlanDocument=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexDocument,open:function(){this.view._openDocument(this.data)},edit:function(t,e){this.app.common.editPlan(this.data,this.view.report.data,this.explorer.data,this.view,!1),e.stopPropagation()},delete:function(t,e){this.app.common.deletePlan(this.data,e,function(){this.view.reload()}.bind(this)),e.stopPropagation()}}),MWF.xApplication.Report.StrategyExplorer.PlanViewNext=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexView,_createDocument:function(t,e){return new MWF.xApplication.Report.StrategyExplorer.PlanDocumentNext(this.viewBodyNode||this.viewNode,t,this.explorer,this,null,e)},_getCurrentPageData:function(t,e,i){this.userName=(layout.desktop.session.user||layout.user).distinguishedName;if(this.loaded)this.explorer.explorer.listPlanNext(this.explorer.data.id,this.loaded,function(e){this.loaded=!0,e.sort((function(t,e){return t.orderNumber-e.orderNumber})),t&&t({data:e})}.bind(this));else{this.loaded=!0;var s=this.explorer.data.planNextList||[];t&&t({data:s})}},_openDocument:function(t){this.app.common.openPlan(t,this.report.data,this.explorer.data,this,!0,this.report.isEdited)},_postCreateViewBody:function(t){"write"==this.getStatus()&&this.options.isEdited&&(this.explorer.contentInput=new Element("textarea",{placeholder:"请填写计划",styles:this.css.textarea}).inject(this.container),this.explorer.currentPersonData&&(this.explorer.contentInput.set("text",this.explorer.currentPersonData.planContent),this.explorer.contentInput.set("value",this.explorer.currentPersonData.planContent)),this.explorer.contentInput.addEvent("blur",function(t){this.explorer.savePersonPlan(t,"计划保存并上传成功")}.bind(this)))},getStatus:function(){return this.status||(this.status=this.explorer.options.status),this.status}}),MWF.xApplication.Report.StrategyExplorer.PlanDocumentNext=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexDocument,open:function(){this.view._openDocument(this.data)},edit:function(t,e){this.app.common.editPlan(this.data,this.view.report.data,this.explorer.data,this.view,!0),e.stopPropagation()},delete:function(t,e){this.app.common.deletePlanNext(this.data,e,function(){this.view.reload()}.bind(this)),e.stopPropagation()},_postCreateDocumentNode:function(t,e){"write"==this.view.getStatus()&&this.view.options.isEdited&&e.targetPerson==this.view.userName&&(t.setStyle("display","none"),this.explorer.currentPersonData=e)}}),MWF.xApplication.Report.StrategyExplorer.PlanTitleViewNext=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexView,_createDocument:function(t,e){return new MWF.xApplication.Report.StrategyExplorer.PlanTitleDocumentNext(this.viewBodyNode||this.viewNode,t,this.explorer,this,null,e)},_getCurrentPageData:function(t,e,i){this.userName=(layout.desktop.session.user||layout.user).distinguishedName;if(this.loaded)this.explorer.explorer.listPlanNext(this.explorer.data.id,this.loaded,function(e){this.loaded=!0,e.sort((function(t,e){return t.orderNumber-e.orderNumber})),t&&t({data:e})}.bind(this));else{this.loaded=!0;var s=this.explorer.data.planNextList||[];t&&t({data:s})}},_postCreateViewBody:function(t){"write"==this.getStatus()&&this.options.isEdited&&(this.explorer.titleInput=new Element("textarea",{placeholder:"请填写标题",styles:this.css.textarea}).inject(this.container),this.explorer.explorer.nextMonth_inputTitle.push(this.explorer.titleInput),this.explorer.currentPersonData&&(this.explorer.titleInput.set("text",this.explorer.currentPersonData.title),this.explorer.titleInput.set("value",this.explorer.currentPersonData.title)),this.explorer.titleInput.addEvent("blur",function(t){this.explorer.savePersonPlan(t,"标题保存并上传成功")}.bind(this)))},getStatus:function(){return this.status||(this.status=this.explorer.options.status),this.status}}),MWF.xApplication.Report.StrategyExplorer.PlanTitleDocumentNext=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexDocument,open:function(){this.view._openDocument(this.data)},edit:function(t,e){this.app.common.editPlan(this.data,this.view.report.data,this.explorer.data,this.view,!0),e.stopPropagation()},delete:function(t,e){this.app.common.deletePlanNext(this.data,e,function(){this.view.reload()}.bind(this)),e.stopPropagation()},_postCreateDocumentNode:function(t,e){"write"==this.view.getStatus()&&this.view.options.isEdited&&e.targetPerson==this.view.userName&&(t.setStyle("display","none"),this.explorer.currentPersonData=e)}});