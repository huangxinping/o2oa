MWF.xDesktop.requireApp("Template","MPopupForm",null,!1),MWF.xApplication.Report.SettingForm=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"report",width:"1000",height:"600",minWidth:700,minHeight:320,hasTop:!0,hasIcon:!1,hasTopIcon:!1,hasTopContent:!1,maxAction:!0,hasBottom:!0,draggable:!0,resizeable:!0,closeAction:!0},createTab:function(){var t,e=this;this.tabContainer=new Element("div.formTabContainer",{styles:this.css.formTabContainer}).inject(this.formNode),(t=new Element("div.formTabNode",{styles:this.css.formTabNode,text:this.lp.systemSetting}).inject(this.tabContainer)).addEvents({mouseover:function(){e.currentTabNode!=this.node&&this.node.setStyles(e.css.formTabNode_over)}.bind({node:t}),mouseout:function(){e.currentTabNode!=this.node&&this.node.setStyles(e.css.formTabNode)}.bind({node:t}),click:function(){e.currentTabNode&&e.currentTabNode.setStyles(e.css.formTabNode),e.currentTabNode=this.node,this.node.setStyles(e.css.formTabNode_current),e.sysContainer.setStyle("display",""),e.personContainer.setStyle("display","none")}.bind({node:t})}),t.setStyles(this.css.formTabNode_current),e.currentTabNode=t,(t=new Element("div.tabNode",{styles:this.css.formTabNode,text:this.lp.personSetting}).inject(this.tabContainer)).addEvents({mouseover:function(){e.currentTabNode!=this.node&&this.node.setStyles(e.css.formTabNode_over)}.bind({node:t}),mouseout:function(){e.currentTabNode!=this.node&&this.node.setStyles(e.css.formTabNode)}.bind({node:t}),click:function(){e.currentTabNode&&e.currentTabNode.setStyles(e.css.formTabNode),e.currentTabNode=this.node,this.node.setStyles(e.css.formTabNode_current),e.sysContainer.setStyle("display","none"),e.personContainer.setStyle("display","")}.bind({node:t})})},createContent:function(){this.formTopTextNode.set("text","工作汇报配置"),this.isAdmin=this.app.common.isAdmin(),this.formContentNode=new Element("div.formContentNode",{styles:this.css.formContentNode}).inject(this.formNode),this.formTableContainer=new Element("div.formTableContainer",{styles:this.css.formTableContainer}).inject(this.formContentNode),this.formTableArea=new Element("div.formTableArea",{styles:this.css.formTableArea}).inject(this.formTableContainer),this._createTableContent()},_createTableContent:function(){this.isAdmin&&(this.sysContainer=new Element("div.sysContainer").inject(this.formTableArea),this.loadSysSetting(this.sysContainer))},loadPersonSetting:function(t){var e="<table width='100%' bordr='0' cellpadding='7' cellspacing='0' styles='formTable' style='margin-top:40px;'><tr><td styles='formTableTitle' lable='defaultView' width='20%'></td>    <td styles='formTableValue' colspan='3' width='80%'>       <div item='defaultView' style='"+(this.isEdited||this.isNew?"border:1px solid #ccc; border-radius: 4px;overflow: hidden;padding:8px;":"")+"'></div>   </td></tr></table>";t.set("html",e),MWF.UD.getDataJson("reportConfig",function(e){MWF.xDesktop.requireApp("Template","MForm",function(){this.personform=new MForm(t,e,{usesNewVersion:!0,isEdited:this.isEdited||this.isNew,style:"meeting",hasColon:!0,itemTemplate:{defaultView:{text:"默认视图",type:"radio",selectValue:["toList","toDay"],selectText:["列表","日"]}}},this.app),this.personform.load()}.bind(this),!0)}.bind(this))},loadSysSetting:function(t){this.getSysData();var e=this.isEdited||this.isNew?"border:1px solid #ccc; border-radius: 4px;overflow: hidden;padding:8px;":"",s="<table width='100%' bordr='0' cellpadding='7' cellspacing='0' styles='formTable' style='margin:20px 0px;'><tr><td>是否启用：</td>    <td styles='formTableValue14' colspan='3' item='MONTHREPORT_ENABLE'></td></tr><tr><td>自动启动时间类型：</td>    <td styles='formTableValue14' colspan='3' item='AUTOCREATE_TYPE'></td></tr><tr item='CRON_EXPRESSION_TR' style='display: "+("CUSTOMDATELIST"==this.data.AUTOCREATE_TYPE?"none":"")+"'>   <td>自动启动时间表达式：<a styles='helpNode' href='../x_component_Report/$Setting/cron_express_description.html' target='_blank'></a></td>    <td styles='formTableValue14' colspan='3' item='CRON_EXPRESSION'></td></tr><tr item='CUSTOM_DATELIST_TR' style='display: "+("CUSTOMDATELIST"!=this.data.AUTOCREATE_TYPE?"none":"")+"'><td>自动启动时间列表：</td>    <td styles='formTableValue14' colspan='3'>       <div item='CUSTOM_DATELIST' style='"+e+"'></div></td></tr><tr><td lable='WEEKEND_IGNORE'></td>    <td styles='formTableValue14' item='WEEKEND_IGNORE' colspan='3'></td></tr><tr><td lable='HOLIDAY_IGNORE'></td>    <td styles='formTableValue14' item='HOLIDAY_IGNORE' colspan='3' ></td></tr><tr><td lable='UNITREPORT_DUTY'></td>    <td styles='formTableValue14' item='UNITREPORT_DUTY' colspan='3' ></td></tr><tr><td>参与应用：</td>    <td styles='formTableValue14' colspan='3'>       <div item='REPORT_MONTH_MODULE' style='"+e+"'></div></td></tr><tr><td>关联流程：</td>    <td styles='formTableValue14' colspan='3' item='UNITMONTH_REPORT_WORKFLOW'></td></tr><tr><td lable='createDate'></td>    <td styles='formTableValue14' colspan='3' >       <span item='createDate' ></span>       <span item='createReport' ></span></td></tr></table>";t.set("html",s),this.itemTemplate={MONTHREPORT_ENABLE:{text:"开启月汇报",type:"select",selectValue:["true","false"],selectText:["是","否"],defaultValue:"false",style:{width:"100px"}},WEEKREPORT_ENABLE:{text:"开启周汇报",type:"select",selectValue:["true","false"],selectText:["是","否"],defaultValue:"false",style:{width:"100px"}},DAYREPORT_ENABLE:{text:"开启日汇报",type:"select",selectValue:["true","false"],selectText:["是","否"],defaultValue:"false",style:{width:"100px"}},createDate:{text:"发起汇报",tType:"date",style:{width:"200px"}},createReport:{text:"手工发起汇报",value:"手工发起汇报",type:"button",event:{click:function(t,e){var s=this.sysform.getItem("createDate").getValue();""==s?this.app.notice("请先选择时间","error"):this.actions.createImmediately({date:s},function(){this.app.notice("发起汇报成功！"),this.sysform.getItem("createDate").setValue("")}.bind(this))}.bind(this)}},REPORT_MONTH_DAYTYPE:{text:"月报发起时间",type:"select",selectValue:["THIS_MONTH","NEXT_MONTH"],selectText:["当月","下月"],style:{width:"100px"}},REPORT_MONTH_DAY:{text:"每月汇报发起日期",type:"select",selectValue:function(){for(var t=[],e=1;e<=31;e++)t.push(e.toString());return t},selectText:function(){for(var t=[],e=1;e<=31;e++)t.push(e.toString()+"号");return t},style:{width:"100px"}},REPORT_MONTH_TIME:{text:"每月汇报发起时间",tType:"time",style:{width:"200px"}},REPORT_WEEK_DAYTYPE:{text:"周报",type:"select",selectValue:["THIS_WEEK","NEXT_WEEK"],selectText:["本周","下周"],style:{width:"100px"}},REPORT_WEEK_DAY:{text:"每周汇报发起日期",type:"select",selectValue:["0","1","2","3","4","5","6"],selectValue:["周日","周一","周二","周三","周四","周五","周六"],style:{width:"100px"}},REPORT_WEEK_TIME:{text:"每周汇报发起时间",tType:"time",style:{width:"200px"}},REPORT_DAY_DAYTYPE:{text:"日报",type:"select",selectValue:["NONE","TODAY","TOMORROW"],selectText:["无","当天","下一天"],style:{width:"100px"}},REPORT_DAY_TIME:{text:"每日汇报发起时间",tType:"time",style:{width:"200px"}},WEEKEND_IGNORE:{text:"忽略周末",type:"select",selectValue:["true","false"],selectText:["是","否"],notEmpty:!0,style:{width:"100px"}},HOLIDAY_IGNORE:{text:"忽略假日",type:"select",selectValue:["true","false"],selectText:["是","否"],notEmpty:!0,style:{width:"100px"}},REPORT_MONTH_MODULE:{text:"参与月报的应用",type:"checkbox",selectValue:["CMS","BBS","OKR","WORKFLOW","MEETTING","ATTENDANCE","STRATEGY"],selectText:["内容管理","论坛","OKR","流程应用","会议管理","考勤","战略"]},REPORT_WEEK_MODULE:{text:"参与周报的应用",type:"checkbox",selectValue:["CMS","BBS","OKR","WORKFLOW","MEETTING","ATTENDANCE","STRATEGY"],selectText:["内容管理","论坛","OKR","流程应用","会议管理","考勤","战略"]},REPORT_DAY_MODULE:{text:"参与周报的应用",type:"checkbox",selectValue:["CMS","BBS","OKR","WORKFLOW","MEETTING","ATTENDANCE","STRATEGY"],selectText:["内容管理","论坛","OKR","流程应用","会议管理","考勤","战略"]},PERSONMONTH_REPORT_WORKFLOW:{text:"个人月报流程",type:"org",orgType:"Process",className:"inputPlus"},UNITMONTH_REPORT_WORKFLOW:{text:"个人月报流程",type:"org",orgType:"Process",className:"inputPlus"},PERSONWEEK_REPORT_WORKFLOW:{text:"个人周报流程",type:"org",orgType:"Process",className:"inputPlus"},UNITWEEK_REPORT_WORKFLOW:{text:"个人周报流程",type:"org",orgType:"Process",className:"inputPlus"},PERSONDAY_REPORT_WORKFLOW:{text:"个人日报流程",type:"org",orgType:"Process",className:"inputPlus"},UNITDAY_REPORT_WORKFLOW:{text:"组织日报流程",type:"org",orgType:"Process",className:"inputPlus"},PERSONREPORT_REMOVE_DUTY:{text:"个人汇报排除职务",type:"org",orgType:"Duty",count:0,className:"inputPlus"},UNITREPORT_DUTY:{text:"组织汇报指定职务",type:"org",orgType:"Duty",count:0,className:"inputPlus"},AUTOCREATE_TYPE:{text:"汇报自动生成时间类型",type:"select",selectValue:["EXPRESSION","CUSTOMDATELIST"],selectText:["时间表达式","时间列表"],notEmpty:!0,style:{width:"100px"},event:{change:function(e,s){"EXPRESSION"==e.getValue()?(t.getElement("[item='CRON_EXPRESSION_TR']").setStyle("display",""),t.getElement("[item='CUSTOM_DATELIST_TR']").setStyle("display","none")):(t.getElement("[item='CRON_EXPRESSION_TR']").setStyle("display","none"),t.getElement("[item='CUSTOM_DATELIST_TR']").setStyle("display",""))}.bind(this)}},CRON_EXPRESSION:{text:"时间表达式",validRule:{isNotEmpty:function(t,e){return!("EXPRESSION"==e.form.getItem("AUTOCREATE_TYPE").getValue()&&!t)}.bind(this)},validMessage:{isNotEmpty:"时间表达式不能为空"},onPostLoad:function(t){MWF.xDesktop.requireApp("Template","widget.CronPicker",null,!1),new MWF.xApplication.Template.widget.CronPicker(this.app.content,t.container,this.app,{},{position:{x:"right",y:"auto"},onSelect:function(e){t.setValue(e)}})}}},MWF.xDesktop.requireApp("Template","MForm",function(){this.sysform=new MForm(t,this.data,{isEdited:this.isEdited||this.isNew,style:"report",hasColon:!0,itemTemplate:this.itemTemplate},this.app),this.sysform.load()}.bind(this),!0);var i=[];this.data&&this.data.CUSTOM_DATELIST.split(",").each((function(t){i.push({CUSTOM_DATELIST:t})})),MWF.xDesktop.requireApp("Template","MGrid",function(){this.dateGrid=new MGrid(t.getElement("[item='CUSTOM_DATELIST']"),i||null,{style:"report",isEdited:this.isEdited||this.isNew,hasOperation:!0,minTrCount:1,tableAttributes:{width:"550px",border:"0",cellpadding:"5",cellspacing:"0"},itemTemplate:{CUSTOM_DATELIST:{tType:"datetime",defaultValue:"请选择时间",defaultValueAsEmpty:!0,event:{focus:function(t,e){"请选择时间"==t.getValue()&&t.setValue("")}.bind(this),blur:function(t,e){""==t.getValue()&&t.setValue("请选择时间")}.bind(this)}}}},this.app),this.dateGrid.setThTemplate("<tr><th style='text-align: center;font-size:14px;font-weight: normal;'>序号</th><th style='width:360px;text-align: center;font-size:14px;font-weight: normal;'>选择时间</th><th button_add></th></tr>"),this.dateGrid.setTrTemplate("<tr><td sequence style='text-align: center;vertical-align: top;padding-top:10px;'></td><td><div item='CUSTOM_DATELIST' style='padding-top:5px'></div></td><td button_remove style='vertical-align: top;padding-top:10px;'></td></tr>"),this.dateGrid.load()}.bind(this),!0)},_createBottomContent:function(){(this.isNew||this.isEdited)&&(this.okActionNode=new Element("button.inputOkButton",{styles:this.css.inputOkButton,text:this.lp.save}).inject(this.formBottomNode),this.okActionNode.addEvent("click",function(t){this.save(t)}.bind(this))),this.cancelActionNode=new Element("button.inputCancelButton",{styles:this.isEdited||this.isNew?this.css.inputCancelButton:this.css.inputCancelButton_long,text:this.lp.close}).inject(this.formBottomNode),this.cancelActionNode.addEvent("click",function(t){this.close(t)}.bind(this))},getSysData:function(){this.actions.listSetting(function(t){this.decodeSysData(t.data)}.bind(this),null,!1)},decodeSysData:function(t){this.data={},this.dataJson={},t.each(function(t){var e=t.configValue;if("string"==typeOf(e))"NONE"==e&&(e="");else if("array"==typeOf(e))for(var s=0;s<e.length-1;s++)"NONE"==e[s]&&(e[s]="");this.data[t.configCode]=e,this.dataJson[t.configCode]=t}.bind(this))},encodeSysData:function(t){var e=[];for(var s in t)if(this.dataJson[s]){var i=Object.clone(this.dataJson[s]),o=t[s];""!=o||"REPORT_WEEK_MODULE"!=s&&"REPORT_MONTH_MODULE"!=s&&"REPORT_DAY_MODULE"!=s||(o="NONE");["PERSONMONTH_REPORT_WORKFLOW","UNITMONTH_REPORT_WORKFLOW","MONTH_REPORT_WORKFLOW","PERSONWEEK_REPORT_WORKFLOW","UNITWEEK_REPORT_WORKFLOW","WEEK_REPORT_WORKFLOW","PERSONDAY_REPORT_WORKFLOW","UNITDAY_REPORT_WORKFLOW","DAY_REPORT_WORKFLOW"].contains(s)&&(""==o?o="NONE":this.sysform.getItem(s)&&this.sysform.getItem(s).orgObject&&(o=this.sysform.getItem(s).orgObject[0].data.id)),""!=o||"REPORT_WEEK_TIME"!=s&&"REPORT_MONTH_TIME"!=s&&"REPORT_DAY_TIME"!=s||(o="--无--"),i.configValue=o,e.push(i)}return e},save:function(t){if(this.personform){var e=this.personform.getResult(!0,null,!0,!1,!1);e&&MWF.UD.putData("reportConfig",e,function(){this.sysform?this.saveSysData():this.app.notice(this.lp.save_success,"success")}.bind(this),!1)}else this.sysform&&this.saveSysData()},saveSysData:function(){var t=this.sysform.getResult(!0,"|",!0,!1,!1);if(t){var e=this.dateGrid.getResult(!0,",",!0,!1,!1),s=[],i=!0;if(e.each((function(e){e.CUSTOM_DATELIST&&"请选择时间"!=e.CUSTOM_DATELIST||"CUSTOMDATELIST"!=t.AUTOCREATE_TYPE||(i=n),s.push(e.CUSTOM_DATELIST)})),!i||0==s.length)return void this.app.notice("请选择启动时间","error");t.CUSTOM_DATELIST=s.join(",");var o=this.encodeSysData(t),n=!0;o.each(function(t){this.app.restActions.saveSetting(t,function(t){}.bind(this),function(t){var e=JSON.decode(t.responseText);this.app.notice(this.lp.save_fail+":"+e.message,"error"),n=!1}.bind(this),!1)}.bind(this)),n&&this.app.notice(this.lp.save_success,"success")}},setFormNodeSize:function(t,e,s,i){t||(t=this.options.width?this.options.width:"50%"),e||(e=this.options.height?this.options.height:"50%"),s||(s=this.options.top?this.options.top:0),i||(i=this.options.left?this.options.left:0);var o=this.container.getSize();o.x<t&&(t=o.x),o.y<e&&(e=o.y);var n=this.app.content.getSize(),a=n.x,l=n.y;"string"==typeof t&&1<t.length&&"%"==t.substr(t.length-1,1)&&(t=parseInt(a*parseInt(t,10)/100,10)),"string"==typeof e&&1<e.length&&"%"==e.substr(e.length-1,1)&&(e=parseInt(l*parseInt(e,10)/100,10)),300>t&&(t=300),220>e&&(e=220),s=s||parseInt((l-e)/2,10),i=i||parseInt((a-t)/2,10),this.formAreaNode.setStyles({width:t+"px",height:e+"px",top:s+"px",left:i+"px"}),this.formNode.setStyles({width:t+"px",height:e+"px"});var r=this.formIconNode?this.formIconNode.getSize():{x:0,y:0},d=this.formTopNode?this.formTopNode.getSize():{x:0,y:0},T=this.formBottomNode?this.formBottomNode.getSize():{x:0,y:0},c=this.tabContainer?this.tabContainer.getSize():{x:0,y:0},p=e-r.y-d.y-T.y-c.y;this.formContentNode.setStyles({height:p+"px"}),this.formTableContainer.setStyles({height:p+"px"})}});