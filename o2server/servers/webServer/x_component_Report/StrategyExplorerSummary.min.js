MWF.xApplication.Report.StrategyExplorer.Summary=new Class({Implements:[Options,Events],options:{style:"default",isEdited:!1,status:"summary",isToRead:!1,isToReadLeader:!1},initialize:function(t,e,i,s){this.setOptions(s),this.container=t,this.explorer=e,this.app=this.explorer.app,this.lp=this.app.lp,this.css=this.explorer.css,this.actions=this.app.restActions,this.data=i,this.path="../x_component_Report/$StrategyExplorer/"},load:function(){if(this.options.isToReadLeader)this.loadLeaderRead();else if(this.options.isToRead)this.loadOpinion(!0);else if(this.data.detail.opinions){var t=JSON.parse(this.data.detail.opinions);"array"==typeOf(t)&&this.loadOpinion(!1)}this._load()},loadOpinion:function(t){var e=new Element("table",{width:"96%",border:"0",cellpadding:"5",cellspacing:"0",styles:this.css.formTable}).inject(this.explorer.ideaContainer),i=new Element("tr").inject(e);(s=new Element("td",{styles:this.css.formTableTitle,text:"领导意见"}).inject(i)).setStyle("width","14%");var s=new Element("td",{styles:this.css.formTableValue}).inject(i),n=this.data.detail.opinions;if(n){var a=JSON.parse(n);if("array"==typeOf(a)){var l=new Element("div").inject(s);a.each(function(t){var e=new Element("table",{width:"100%",border:"0",cellpadding:"0",cellspacing:"0"}).inject(l),i=new Element("tr").inject(e),s=new Element("td",{text:t.identity.split("@")[0]+":"}).inject(i);s.setStyle("width","50px"),s=new Element("td",{text:(t.content?this.app.common.replaceWithBr(t.content):"已阅")+"      ("+t.datetime+")"}).inject(i)}.bind(this))}}t&&(l=new Element("div",{styles:{"margin-top":"10px"}}).inject(s),new Element("button",{value:"已阅",text:"已阅",styles:this.css.setRead}).inject(l).addEvent("click",function(t){this.setReaded(t)}.bind(this)))},loadLeaderRead:function(){var t="";if(this.data.detail.opinions){var e=JSON.parse(this.data.detail.opinions);"array"==typeOf(e)&&e.each(function(e){e.name==this.explorer.userName&&(t=e.content)}.bind(this))}var i=new Element("table",{width:"96%",border:"0",cellpadding:"5",cellspacing:"0",styles:this.css.formTable}).inject(this.explorer.ideaContainer),s=new Element("tr").inject(i);(n=new Element("td",{styles:this.css.formTableTitle,text:"填写意见"}).inject(s)).setStyle("width","14%");var n=new Element("td",{styles:this.css.formTableValue}).inject(s),a=new Element("div").inject(n);this.textarea_idea=new Element("textarea",{styles:this.css.textarea,value:t}).inject(a),this.textarea_idea.addEvent("blur",function(){var t=[{identity:null,name:(layout.desktop.session.user||layout.user).distinguishedName,activity:"领导阅知",content:this.textarea_idea.get("value")}];this.app.restActions.saveOpinion(this.data.id,{opinions:t})}.bind(this)),a=new Element("div").inject(n),new Element("button",{value:"已阅",text:"已阅",styles:this.css.setRead}).inject(a).addEvent("click",function(t){this.setReaded(t)}.bind(this))},getWorkId:function(){var t=this.explorer.workApp;if(t.work&&t.work.id)return t.work.id;if(t.workCompleted&&t.workCompleted.id)return t.workCompleted.id;if(t.data&&t.data.$work){var e=t.data.$work;return e.completed?e.workCompletedId:e.workId}},sendRead:function(t){MWF.Actions.get("x_organization_assemble_express").getDutyValue({name:"部主管",unit:this.data.targetUnit},function(e){var i=e.data.identityList;if(i&&"array"==typeOf(i)&&i.length>0){var s=this.getWorkId();MWF.Actions.get("x_processplatform_assemble_surface").sendReaderByWorkCompleted(function(){t&&t()}.bind(this),null,s,{identityList:i},!1)}else t&&t()}.bind(this))},setReaded:function(t){var e=this,i=function(){var t=e.explorer.readData;e.textarea_idea&&(t.opinion=e.textarea_idea.get("value").trim()),MWF.Actions.get("x_processplatform_assemble_surface").setReaded(function(){e.app.notice("标记已阅成功!"),e.app.close()}.bind(e),null,t.id,t)}.bind(this);this.app.confirm("infor",t,"标记已阅确认","您确定要标记为已阅吗？",350,130,(function(){if(e.options.isToReadLeader){var t=e.textarea_idea.get("value").trim();t&&""!=t||e.textarea_idea.set("value","已阅");var s=[{identity:null,name:(layout.desktop.session.user||layout.user).distinguishedName,activity:"领导阅知",content:e.textarea_idea.get("value")}];e.app.restActions.saveOpinion(e.data.id,{opinions:s},function(){e.app.restActions.modifyReportStatus(e.data.id,{reportStatus:"结束"},function(){e.sendRead(function(){i(),this.close()}.bind(this))}.bind(this))}.bind(this))}else i(),this.close()}),(function(){this.close()}),null,this.app.content)},_load:function(){this.month=parseInt(this.data.month);var t=this.table=new Element("table",{width:"96%",border:"0",cellpadding:"5",cellspacing:"0",styles:this.css.formTable}).inject(this.explorer.totalContainer),e=new Element("tr").inject(t);new Element("td",{rowspan:2,width:"30",styles:this.css.formTableTitle,text:"序号"}).inject(e),new Element("td",{colspan:3,text:this.data.year+"年"+parseInt(this.data.month)+"月工作总结",width:"140",styles:this.css.formTableTitle}).inject(e);var i=new Date(this.data.year,parseInt(this.data.month)-1,1).increment("month",1),s=i.getFullYear()+"年"+(i.getMonth()+1)+"月工作计划";new Element("td",{colspan:2,text:s,width:"140",styles:this.css.formTableTitle}).inject(e),new Element("td",{rowspan:2,text:"服务客户",width:"140",styles:this.css.formTableTitle}).inject(e),new Element("td",{rowspan:2,text:"关爱员工",width:"140",styles:this.css.formTableTitle}).inject(e),new Element("td",{rowspan:2,text:"意见建议",width:"140",styles:this.css.formTableTitle}).inject(e);e=new Element("tr").inject(t);new Element("td",{text:"部门重点工作",width:"140",styles:this.css.formTableTitle}).inject(e),new Element("td",{text:"计划",width:"140",styles:this.css.formTableTitle}).inject(e),new Element("td",{text:"总结",width:"140",styles:this.css.formTableTitle}).inject(e),new Element("td",{text:"部门重点工作",width:"140",styles:this.css.formTableTitle}).inject(e),new Element("td",{text:"计划",width:"140",styles:this.css.formTableTitle}).inject(e),this.listExtSummaryData(function(){this.loadContent()}.bind(this))},listExtSummaryData:function(t){this.extSummaryData=this.data.WoReport_I_Ext_Contents_sumamry||[],t&&t()},loadContent:function(){this.getTableData().each(function(t){var e=new Element("tr").inject(this.table);new Element("td",{text:t.sequence,align:"center",styles:this.css.formTableValue}).inject(e);var i=new Element("td",{html:this.app.common.replaceWithBr(t.thisMonth.title),width:"140",styles:this.css.formTableValue}).inject(e);if(t.thisMonth.measuresList.length){var s=new Element("input",{type:"button",styles:this.css.showMeasureNode2,value:"查看举措"}).inject(i);new MWF.xApplication.Report.ShowMeasureTooltip(this.app.content,s,this.app,this.data,{style:"report",position:{x:"auto",y:"auto"},event:"click"}).measuresList=t.thisMonth.measuresList}if(new Element("td",{html:this.app.common.replaceWithBr(t.thisMonth.plan),width:"140",styles:this.css.formTableValue}).inject(e),new Element("td",{html:this.app.common.replaceWithBr(t.thisMonth.prog),width:"140",styles:this.css.formTableValue}).inject(e),i=new Element("td",{html:this.app.common.replaceWithBr(t.nextMonth.title),width:"140",styles:this.css.formTableValue}).inject(e),t.nextMonth.measuresList.length){s=new Element("input",{type:"button",styles:this.css.showMeasureNode2,value:"查看举措"}).inject(i);new MWF.xApplication.Report.ShowMeasureTooltip(this.app.content,s,this.app,this.data,{style:"report",nextMonth:!0,position:{x:"auto",y:"auto"},event:"click"}).measuresList=t.nextMonth.measuresList}new Element("td",{html:this.app.common.replaceWithBr(t.nextMonth.plan),width:"140",styles:this.css.formTableValue}).inject(e),new Element("td",{html:this.app.common.replaceWithBr(t.extWork.fuwu),width:"140",styles:this.css.formTableValue}).inject(e),new Element("td",{html:this.app.common.replaceWithBr(t.extWork.guanai),width:"140",styles:this.css.formTableValue}).inject(e),new Element("td",{html:this.app.common.replaceWithBr(t.extWork.yijian),width:"140",styles:this.css.formTableValue}).inject(e)}.bind(this))},getTableData:function(){this.tableData=[];for(var t=0;t<5;t++){var e=this.extSummaryData[t],i=this.data.thisMonth_workList[t],s=this.data.nextMonth_workList[t],n={sequence:t+1,thisMonth:{title:i?i.workTitle:"",plan:i?i.workPlanSummary:"",prog:i?i.workProgSummary:"",measuresList:i?i.measuresList:[]},nextMonth:{title:s?s.workTitle:"",plan:s?s.workPlanSummary:"",measuresList:s?s.measuresList:[]},extWork:{fuwu:e?e.fuwu:"",guanai:e?e.guanai:"",yijian:e?e.yijian:""}};this.tableData.push(n)}return this.tableData}});