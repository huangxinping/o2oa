MWF.xApplication.Execution=MWF.xApplication.Execution||{},MWF.xDesktop.requireApp("Template","MForm",null,!1),MWF.xDesktop.requireApp("Template","Minder",null,!1),MWF.xDesktop.requireApp("Report","Common",null,!1),MWF.xApplication.Report.KeyWorkMinder=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{id:"",year:"",style:"default",template:"default",theme:"fresh-blue-compat"},initialize:function(t,e,i,n){this.setOptions(n),this.app=e,this.path="../x_component_Report/$KeyWorkMinder/",this.cssPath="../x_component_Report/$KeyWorkMinder/"+this.options.style+"/css.wcss",this._loadCss(),this.lp=this.app.lp,this.actions=i,this.node=$(t)},load:function(){this.data={root:{data:{},children:[]}},this.app.strategyActions.getKeyWorkById(this.options.id,function(t){this.app.setTitle(t.data.strategydeploytitle),t.data.text=t.data.strategydeploytitle,t.data.note=" ",t.data.isRoot=!0,t.data.watch=!0,this.data.root.data=t.data,this.app.strategyActions.listMeasuresWidthKeyWork(this.options.id,function(t){var e=this.data.root.children;t.data.each((function(t){t.text=t.measuresinfotitle,t.note=" ",t.isMeasure=!0,t.watch=!0;var i={data:t,children:[]};t.deptlist.each((function(e){i.children.push({data:{text:e.split("@")[0],department:e,measureId:t.id,isDepartment:!0,watch:!0},children:[{data:{text:"加载中..."}}]})})),e.push(i)})),this.createMinder(this.data)}.bind(this))}.bind(this)),this.refreshFun=this.refresh.bind(this),this.app.addEvent("resize",this.refreshFun)},destroy:function(){for(var t in this.minder&&this.minder.destroy(),this.tooltips)this.tooltips[t].destroy();this.refreshFun&&this.app.removeEvent("resize",this.refreshFun)},refresh:function(){this.minder&&this.minder.refresh()},reload:function(){this.minder&&this.minder.destroy(),this.node.empty(),this.load()},createMinder:function(t){this.minder=new MWF.xApplication.Template.Minder(this.node,this.app,t,{hasNavi:!1,onPostLoad:function(){this.minder.km.execCommand("ExpandToLevel",2),this.minder.loadNavi(this.node)}.bind(this),onPostLoadNode:function(t){this.setMinderNode(t)}.bind(this)}),this.minder.load()},setMinderNode:function(t){var e=this;if(t.getData().watch){var i=t.getData(),n=t.getRenderer("NoteIconRenderer");if(n&&n.getRenderShape()){var o=n.getRenderShape();o.addEventListener("mouseover",function(t){e.tooltipTimer=setTimeout(function(){var t=this.getRenderBox("screen");e.loadTooltip(this.getData(),t)}.bind(this),300)}.bind(t)),o.addEventListener("mouseout",function(t){clearTimeout(e.tooltipTimer),e.hideTooltip()}.bind(t))}if(i.isDepartment){var s=t.getRenderer("ExpanderRenderer").getRenderShape();s&&s.addEventListener("mousedown",function(t){var i=this.getData();i.loaded||setTimeout(function(){e.expendDepartment(this,i,function(){}.bind(this))}.bind(this),100)}.bind(t))}t.getRenderContainer().node.addEventListener("click",function(t){var i=this.getData();i.isDepartment&&(i.loaded?this.getRenderer("ExpanderRenderer").expander.fire("mousedown"):setTimeout(function(){e.expendDepartment(this,i,function(){}.bind(this))}.bind(this),100))}.bind(t))}else;},expendDepartment:function(t,e,i){this.isLoaddingChildren||(this.isLoaddingChildren=!0,this.actions.listPriorityByUnitMeasure(this.options.year,e.measureId,e.department,function(i){e.loaded=!0,i.data||(i.data=[]),this.proiorityLength=i.data.length,this.proiorityLoadedLength=0;var n={data:e,children:[]};for(i.data.each((function(t){t.keyworktitle&&(t.text=t.keyworktitle,t.note=" ",t.department=e.department,t.isPriority=!0,t.watch=!0,n.children.push({data:t}))}));t.getChildren().length;){var o=t.getChildren()[0];this.minder.km.removeNode(o)}this.minder.km.importNode(t,n);var s=t.getChildren();s.length?s.forEach(function(e){this.expendPriority(t,e,e.getData(),null)}.bind(this)):this.minder.km.refresh(),this.isLoaddingChildren=!1}.bind(this)))},expendPriority:function(t,e,i,n){this.actions.listWithPriority(this.options.year,{workIds:[i.id],unitList:[i.department]},function(n){var o={},s=n.data;s.sort((function(t,e){return t.month.localeCompare(e.month)})),s.each((function(t){o[t.month]||(o[t.month]=[]),o[t.month].push(t)}));var r={data:i,children:[]};for(var a in o){var d=[];o[a].each(function(t){var e=[];t.progList.each(function(t){e.push(this.app.common.splitWithLength(t.targetPerson.split("@")[0]+"："+t.progressContent,35))}.bind(this)),d.push(e.join("\n"))}.bind(this)),r.children.push({data:{text:parseInt(a)+"月"},children:[{data:{text:d.join("\n")}}]})}(this.minder.km.importNode(e,r),this.proiorityLoadedLength++,this.proiorityLoadedLength==this.proiorityLength)&&(t.expand(),this.minder.km.refresh(),t.getChildren().forEach(function(t){this.setMinderNode(t)}.bind(this)))}.bind(this))},loadTooltip:function(t,e){if(this.tooltips||(this.tooltips={}),this.tooltips[t.id]){(i=this.currentTooltip=this.tooltips[t.id]).targetCoordinates=e,i.load()}else{if(t.isRoot)var i=this.currentTooltip=new MWF.xApplication.Report.KeyWorkTooltip(this.node,null,this.app,t,{},e);else if(t.isMeasure)i=this.currentTooltip=new MWF.xApplication.Report.MeasureTooltip(this.node,null,this.app,t,{},e);else if(t.isPriority)i=this.currentTooltip=new MWF.xApplication.Report.PriorityTooltip(this.node,null,this.app,t,{},e);i&&(i.load(),this.tooltips[t.id]=i)}},hideTooltip:function(){this.currentTooltip&&this.currentTooltip.hide()}});