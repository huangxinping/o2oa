MWF.xApplication.Report.StrategyExplorer.Deployment=new Class({Implements:[Options,Events],options:{style:"default",isEdited:!0,isKeyworkEdited:!0},initialize:function(t,e,s,i){this.setOptions(i),this.container=t,this.explorer=e,this.app=this.explorer.app,this.lp=this.app.lp,this.css=this.explorer.css,this.actions=this.app.restActions,this.data=s,this.path="../x_component_Report/$StrategyExplorer/"},load:function(){this.month=parseInt(this.data.month),this.node=new Element("div",{styles:this.css.deplymentNode}).inject(this.container),this.loadPerson(),this.keyWorkContainer=new Element("div").inject(this.node),this.keyworkList=[],this.data.thisMonth_workList.each(function(t,e){this.loadKeyWork(t,e+1)}.bind(this))},loadPerson:function(){this.personNode=new Element("div.personDeployNode",{styles:this.css.personDeployNode}).inject(this.node);this.personNode.set("html","<table width='96%' bordr='0' cellpadding='7' cellspacing='0' styles='formTable' ><tr>   <td style='width: 15%;font-size: 14px;' styles='formTableTitleP10'>汇报填写人员</td>    <td style='width: 85%' item='workreportPersonList' styles='formTableValueP10'></td></tr></table>"),MWF.xDesktop.requireApp("Template","MForm",function(){this.peronform=new MForm(this.personNode,this.data,{verifyType:"single",isEdited:this.options.isEdited,style:"report",itemTemplate:{workreportPersonList:{text:this.lp.targetPerson,type:"org",orgType:"identity",isEdited:this.options.isEdited,count:0,notEmpty:!0,units:[this.data.targetUnit.split("@")[0]],event:{change:function(t){this.save(t.getElements()[0])}.bind(this)}}}},this.app),this.peronform.load()}.bind(this),!0)},loadKeyWork:function(t,e){var s=new MWF.xApplication.Report.StrategyExplorer.Deployment.KeyWorkItem(this.keyWorkContainer,this,t,{reportId:this.data.id,isEdited:this.options.isKeyworkEdited&&this.options.isEdited,orderNumber:this.data.orderNumber||e});s.load(),this.keyworkList.push(s)},getPersonString:function(){},arrayIsContains:function(t,e){for(var s=0;s<t.length;s++)if(t[s].woPerson.distinguishedName==e.woPerson.distinguishedName)return!0;return!1},getPerson:function(){var t=this.peronform.getItem("workreportPersonList").dom.getData(!0),e=Object.clone((layout.desktop.session.user||layout.user).identityList[0]),s=layout.desktop.session.user||layout.user;e.woPerson=s;var i=MWF.org.parseOrgData(e);return this.arrayIsContains(t,i)||t.push(i),t},submit:function(){this.errorNodeList&&this.errorNodeList.each((function(t){t.destroy()}));var t=!1,e=this.getResult(!0);if(e){var s=this.getPerson(),i=[],o=[];s.each((function(t){var e=t.woPerson?t.woPerson.distinguishedName:t.distinguishedName;i.contains(e)||i.push(e),o.contains(t.distinguishedName)||o.push(t.distinguishedName)})),e.workreportPersonList=o;var n=[];i.each((function(t){n.push({permission:"阅读",permissionObjectType:"人员",permissionObjectName:t})})),e.readerList=n;var r=[];i.each((function(t){r.push({permission:"作者",permissionObjectType:"人员",permissionObjectName:t})})),e.authorList=r,this.actions.submitWorkPerson(e,function(){t=!0}.bind(this),null,!1)}return t},save:function(t){var e=!1,s=this.getResult(!1);return s&&this.actions.saveWorkPerson(s,function(){this.app.notice("保存并上传成功","success"),e=!0}.bind(this),null,!1),e},getResult:function(t){var e=!0,s=this.peronform.getResult(t,null,!0,!1,!0);if(t&&!s&&(e=!1),this.options.isKeyworkEdited){var i=[];return this.keyworkList.each(function(s){var o=s.getWorkTitle();o&&0!=o.length||t&&(this.createErrorNode(s.workTitleInput,"请填写工作标题",{float:"left"}),e=!1);var n=s.getMeasuresList();if(n&&0!=n.length||t&&(this.createErrorNode(s.measureContentNode,"请选择举措"),e=!1),i.push({id:s.data.id,orderNumber:s.options.orderNumber,workTitle:o,measuresList:n}),t){var r=s.getPlanData();r&&0!=r.length||(this.createErrorNode(s.planListNode,"请填写计划"),e=!1)}}.bind(this)),!!e&&{id:this.data.id,workreportPersonList:s.workreportPersonList,workList:i}}return!!e&&{id:this.data.id,workreportPersonList:s.workreportPersonList}},listPlan:function(t,e,s){!e&&this.planDataObject?s&&s(this.planDataObject[t]||[]):this.actions.listPlan(this.data.id||this.options.id,function(e){this.planDataObject={},e.data.each(function(t){this.planDataObject[t.workInfoId]||(this.planDataObject[t.workInfoId]=[]),this.planDataObject[t.workInfoId].push(t)}.bind(this)),s&&s(this.planDataObject[t]||[])}.bind(this))},createErrorNode:function(t,e,s){this.errorNodeList||(this.errorNodeList=[]);var i=new Element("div",{text:e,styles:this.css.warningMessageNode}).inject(t,"after");s&&i.setStyles(s),this.errorNodeList.push(i)}}),MWF.xApplication.Report.StrategyExplorer.Deployment.KeyWorkItem=new Class({Implements:[Options,Events],options:{style:"default",reportId:"",isEdited:!0,orderNumber:1},initialize:function(t,e,s,i){this.setOptions(i),this.container=t,this.explorer=e,this.app=this.explorer.app,this.lp=this.app.lp,this.css=this.explorer.css,this.actions=this.app.restActions,this.data=s},load:function(){var t=new Element("table",{width:"96%",border:"0",cellpadding:"5",cellspacing:"0",styles:this.css.formTable}).inject(this.container),e=new Element("tr").inject(t);new Element("td",{rowspan:2,text:this.data.orderNumber||this.options.orderNumber,styles:this.css.formTableTitle}).inject(e),new Element("td",{text:"部门重点工作",width:"140",styles:this.css.formTableTitle}).inject(e);var s=new Element("td",{styles:this.css.formTableValue}).inject(e);this.options.isEdited?this.workTitleInput=new Element("input",{value:this.data.workTitle,styles:this.css.keyWorkTitleInput}).inject(s):new Element("div",{html:this.app.common.replaceWithBr(this.data.workTitle),styles:{width:"870px",float:"left"}}).inject(s);var i=new Element("input",{type:"button",styles:this.css.showMeasureNode,value:"查看举措"}).inject(s);new MWF.xApplication.Report.ShowMeasureTooltip(this.app.content,i,this.app,this.explorer.data,{style:"report",position:{x:"auto",y:"auto"},event:"click"}).measuresList=this.data.measuresList,e=new Element("tr").inject(t),new Element("td",{text:"工作计划",styles:this.css.formTableTitle}).inject(e),s=new Element("td",{styles:this.css.formTableValue,html:this.app.common.replaceWithBr(this.data.workPlanSummary)}).inject(e)},getWorkTitle:function(){return this.workTitleInput.get("value")},getMeasuresList:function(){return this.measuresList||this.data.measuresList},getPlanData:function(){return this.planDataList},loadMeasureTooltip:function(t,e){new MWF.xApplication.Report.MeasureTooltip(this.app.content,t,this.app,null,{position:{x:"right",y:"auto"},measureId:e,displayDelay:300})}});