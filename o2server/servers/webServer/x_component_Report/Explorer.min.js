MWF.xDesktop.requireApp("Report","Attachment",null,!1),MWF.xApplication.Report.Explorer=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",id:"",type:"app"},initialize:function(t,e,i,o){this.setOptions(o),this.app=e,this.path="../x_component_Report/$Explorer/",this.cssPath="../x_component_Report/$Explorer/"+this.options.style+"/css.wcss",this._loadCss(),this.lp=this.app.lp,this.actions=i,this.node=$(t)},reload:function(){this.node.empty(),this.loadLayout()},destroy:function(){"flow"!=this.options.type&&this.app.removeEvent("resize",this.resetNodeSizeFun),this.node.empty()},load:function(){this.loadLayout(),"flow"!=this.options.type&&(this.resetNodeSizeFun=this.resetNodeSize.bind(this),this.app.addEvent("resize",this.resetNodeSizeFun))},loadLayout:function(){this.createNode(),this.actions.getReport(this.options.id,function(t){this.data=t.data,this.userName=(layout.desktop.session.user||layout.user).distinguishedName,this.isEdited=!1,"汇报者填写"!=this.data.reportStatus||!this.app.common.isAdmin()&&this.userName!=this.data.targetPerson||(this.isEdited=!0),this.app.setTitle(this.data.title),this.createTopNode(),this.loadContentNode(),"flow"!=this.options.type&&this.resetNodeSize()}.bind(this))},createNode:function(){this.container=new Element("div.container",{styles:this.css.container}).inject(this.node),this.contentContainer=new Element("div.contentContainerNode",{styles:this.css["flow"==this.options.type?"contentContainer_flow":"contentContainer"]}).inject(this.container)},createTopNode:function(){var t=this.topNode=new Element("div.topNode",{styles:this.css.topNode}).inject(this.contentContainer),e=new Element("div.topTitleMiddleNode",{styles:this.css.topTitleMiddleNode}).inject(t);new Element("div.topItemTitleNode",{styles:this.css.topItemTitleNode,text:this.lp.title}).inject(e).addEvent("click",function(){this.app.desktop.apps.Report?this.app.desktop.apps.Report.setCurrent():this.app.desktop.openApplication(null,"Report",{})}.bind(this));new Element("div.topItemSepNode",{styles:this.css.topItemSepNode,text:">"}).inject(e),new Element("div.topItemTitleNode",{styles:this.css.topItemTitleLastNode,text:this.data.title}).inject(e)},loadContentNode:function(){this.middleNode=new Element("div.middleNode",{styles:this.css.middleNode}).inject(this.contentContainer),this.inforNode=new Element("div",{styles:this.css.inforNode}).inject(this.middleNode),this.planNode=new Element("div.listContainer",{styles:this.css.listContainer}).inject(this.middleNode),this.workNode=new Element("div.listContainer",{styles:this.css.listContainer}).inject(this.middleNode),this.planNodeNext=new Element("div.listContainer",{styles:this.css.listContainer}).inject(this.middleNode),this.loadInforContent(),this.loadPlanTop(this.planNode,!0,!1),this.loadPlanView(this.planNode),this.loadWorkTop(),this.loadWorkView(),this.loadWorkAction(),this.loadPlanTop(this.planNodeNext,!0,!0),this.loadPlanViewNext(this.planNodeNext),this.loadPlanAction(this.planNodeNext)},loadInforContent:function(){this.inforNode.set("html","<table width='100%' bordr='0' cellpadding='7' cellspacing='0' styles='formTable' ><tr><td styles='formTableTitleP10' lable='createDateString'></td>    <td styles='formTableValueP10' item='createDateString'></td>   <td styles='formTableTitleP10' lable='targetPerson'></td>    <td styles='formTableValueP10' item='targetPerson'></td>   <td styles='formTableTitleP10' lable='activityName'></td>    <td styles='formTableValueP10' item='activityName'></td>   <td styles='formTableTitleP10' lable='currentPersonName'></td>    <td styles='formTableValueP10' item='currentPersonName'></td>   <td styles='formTableTitleP10' lable='reportObjType'></td>    <td styles='formTableValueP10' item='reportObjType'></td></tr></table>"),MWF.xDesktop.requireApp("Template","MForm",function(){new MForm(this.inforNode,this.data,{usesNewVersion:!0,isEdited:!1,style:"report",hasColon:!0,itemTemplate:{createDateString:{text:this.lp.reportDate,type:"innertext"},targetPerson:{text:this.lp.targetPerson,type:"org",orgType:"person"},reportObjType:{text:this.lp.reportObjType,type:"select",selectValue:["","PERSON","UNIT"],selectText:["","个人汇报","组织汇报"]},activityName:{text:this.lp.activityName,type:"innertext"},currentPersonName:{text:this.lp.currentPersonName,type:"org",orgType:"person"}}},this).load()}.bind(this),!0)},loadPlanTop:function(t,e,i){var o=new Element("div.listTop",{styles:this.css.listTop,text:i?"下月工作计划":"本月工作计划"}).inject(t);if(e&&this.isEdited){var s=new Element("div.listTopAction",{styles:this.css.listTopAction,text:"增加"}).inject(o);s.addEvents({mouseover:function(){this.node.setStyles(this._self.css.listTopAction_over)}.bind({_self:this,node:s}),mouseout:function(){this.node.setStyles(this._self.css.listTopAction)}.bind({_self:this,node:s}),click:function(){this._self.app.common.addPlan(this._self.data,i?this._self.planViewNext:this._self.planView,i)}.bind({_self:this})})}},loadPlanView:function(t){this.planViewNode=new Element("div").inject(t),this.planView=new MWF.xApplication.Report.Explorer.PlanView(this.planViewNode,this.app,this,{style:"default",templateUrl:"listItemPlan.json"}),this.planView.load()},loadPlanViewNext:function(t){this.planViewNextNode=new Element("div").inject(t),this.planViewNext=new MWF.xApplication.Report.Explorer.PlanViewNext(this.planViewNextNode,this.app,this,{style:"default",templateUrl:"listItemPlan.json"}),this.planViewNext.load()},loadPlanAction:function(t){this.isEdited&&(this.addPlanNode=new Element("div.listAddAction",{styles:this.css.listAddActionContainer,events:{mouseover:function(){this.addPlanNode.setStyles(this.css.listAddActionContainer_over),this.addPlanAction.setStyles(this.css.listAddAction_over)}.bind(this),mouseout:function(){this.addPlanNode.setStyles(this.css.listAddActionContainer),this.addPlanAction.setStyles(this.css.listAddAction)}.bind(this),click:function(){this._self.app.common.addPlan(this._self.data,this._self.planViewNext,!0)}.bind({_self:this})}}).inject(t),this.addPlanAction=new Element("div.listAddAction",{styles:this.css.listAddAction,text:"增加计划"}).inject(this.addPlanNode))},loadWorkTop:function(t){var e=new Element("div.listTop",{styles:this.css.listTop,text:"本月完成情况"}).inject(this.workNode);if(this.isEdited){var i=new Element("div.listTopAction",{styles:this.css.listTopAction,text:"增加"}).inject(e);i.addEvents({mouseover:function(){this.node.setStyles(this._self.css.listTopAction_over)}.bind({_self:this,node:i}),mouseout:function(){this.node.setStyles(this._self.css.listTopAction)}.bind({_self:this,node:i}),click:function(){this._self.app.common.addWork(this._self.data,this._self.workView)}.bind({_self:this})})}},loadWorkView:function(){this.workViewNode=new Element("div").inject(this.workNode),this.workView=new MWF.xApplication.Report.Explorer.WorkView(this.workViewNode,this.app,this,{style:"default",templateUrl:"listItemWork.json"}),this.workView.load()},loadWorkAction:function(){this.isEdited&&(this.addWorkNode=new Element("div.listAddAction",{styles:this.css.listAddActionContainer,events:{mouseover:function(){this.addWorkNode.setStyles(this.css.listAddActionContainer_over),this.addWorkAction.setStyles(this.css.listAddAction_over)}.bind(this),mouseout:function(){this.addWorkNode.setStyles(this.css.listAddActionContainer),this.addWorkAction.setStyles(this.css.listAddAction)}.bind(this),click:function(){this._self.app.common.addWork(this._self.data,this._self.workView)}.bind({_self:this})}}).inject(this.workNode),this.addWorkAction=new Element("div.listAddAction",{styles:this.css.listAddAction,text:"增加工作"}).inject(this.addWorkNode))},resetNodeSize:function(){this.topNode&&this.topNode.getSize();var t=this.node.getSize(),e=this.contentContainer.getStyle("padding-top").toFloat(),i=this.contentContainer.getStyle("padding-bottom").toFloat(),o=t.y-e-i;this.contentContainer.setStyle("height",o+"px")}}),MWF.xApplication.Report.Explorer.WorkView=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexView,_createDocument:function(t,e){return new MWF.xApplication.Report.Explorer.WorkDocument(this.viewNode,t,this.explorer,this,null,e)},_getCurrentPageData:function(t,e,i){this.actions.listWork(this.explorer.data.id,(function(e){t&&t(e)}))},_removeDocument:function(t,i){this.app.common.deleteWork(t,e,function(){this.reload()}.bind(this))},_create:function(){},_openDocument:function(t){this.app.common.openWork(t,this.explorer.data,this,this.explorer.isEdited)},_queryCreateViewNode:function(){},_postCreateViewNode:function(t){},_queryCreateViewHead:function(){},_postCreateViewHead:function(t){}}),MWF.xApplication.Report.Explorer.WorkDocument=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexDocument,_queryCreateDocumentNode:function(t){},_postCreateDocumentNode:function(t,e){},open:function(){this.view._openDocument(this.data)},edit:function(t,e){this.app.common.editWork(this.data,this.explorer.data,this.view),e.stopPropagation()},delete:function(t,e){this.app.common.deleteWork(this.data,e,function(){this.view.reload()}.bind(this)),e.stopPropagation()}}),MWF.xApplication.Report.Explorer.PlanView=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexView,_createDocument:function(t,e){return new MWF.xApplication.Report.Explorer.PlanDocument(this.viewNode,t,this.explorer,this,null,e)},_getCurrentPageData:function(t,e,i){this.actions.listPlan(this.explorer.data.id,(function(e){t&&t(e)}))},_create:function(){},_openDocument:function(t){this.app.common.openPlan(t,this.explorer.data,this,!1,this.explorer.isEdited)},_queryCreateViewNode:function(){},_postCreateViewNode:function(t){},_queryCreateViewHead:function(){},_postCreateViewHead:function(t){}}),MWF.xApplication.Report.Explorer.PlanDocument=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexDocument,_queryCreateDocumentNode:function(t){},_postCreateDocumentNode:function(t,e){},open:function(){this.view._openDocument(this.data)},edit:function(t,e){this.app.common.editPlan(this.data,this.explorer.data,this.view,!1),e.stopPropagation()},delete:function(t,e){this.app.common.deletePlan(this.data,e,function(){this.view.reload()}.bind(this)),e.stopPropagation()}}),MWF.xApplication.Report.Explorer.PlanViewNext=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexView,_createDocument:function(t,e){return new MWF.xApplication.Report.Explorer.PlanDocumentNext(this.viewNode,t,this.explorer,this,null,e)},_getCurrentPageData:function(t,e,i){this.actions.listPlanNext(this.explorer.data.id,(function(e){t&&t(e)}))},_create:function(){},_openDocument:function(t){this.app.common.openPlan(t,this.explorer.data,this.view,!0)},_queryCreateViewNode:function(){},_postCreateViewNode:function(t){},_queryCreateViewHead:function(){},_postCreateViewHead:function(t){}}),MWF.xApplication.Report.Explorer.PlanDocumentNext=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexDocument,_queryCreateDocumentNode:function(t){},_postCreateDocumentNode:function(t,e){},open:function(){this.view._openDocument(this.data)},edit:function(t,e){this.app.common.editPlan(this.data,this.explorer.data,this.view,!0),e.stopPropagation()},delete:function(t,e){this.app.common.deletePlanNext(this.data,e,function(){this.view.reload()}.bind(this)),e.stopPropagation()}});