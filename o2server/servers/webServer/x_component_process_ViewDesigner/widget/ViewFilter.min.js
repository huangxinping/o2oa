MWF.xApplication.process.ViewDesigner=MWF.xApplication.process.ViewDesigner||{},MWF.xApplication.process.ViewDesigner.widget=MWF.xApplication.process.ViewDesigner.widget||{},MWF.xApplication.process.ViewDesigner.widget.ViewFilter=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{style:"default",type:"identity",names:[]},initialize:function(t,e,i,s){this.setOptions(s),this.node=$(t),this.app=e,this.filtrData=i,this.path="../x_component_process_ViewDesigner/widget/$ViewFilter/",this.cssPath="../x_component_process_ViewDesigner/widget/$ViewFilter/"+this.options.style+"/css.wcss",this._loadCss(),this.items=[],this.load()},load:function(t){this.getInputNodes(),this.createActionNode(),this.loadData()},loadData:function(){this.filtrData.filtrData&&this.filtrData.filtrData.length&&this.filtrData.filtrData.each(function(t){this.items.push(new MWF.xApplication.process.ViewDesigner.widget.ViewFilter.Item(this,t))}.bind(this)),this.filtrData.customData&&this.filtrData.customData.length&&this.filtrData.customData.each(function(t){t.type="custom",this.items.push(new MWF.xApplication.process.ViewDesigner.widget.ViewFilter.ItemCustom(this,t))}.bind(this))},createScriptArea:function(t){this.scriptValueArea=t;var e=t.get("title");MWF.require("MWF.widget.ScriptArea",function(){this.scriptArea=new MWF.widget.ScriptArea(t,{title:e,maxObj:this.app.formContentNode||this.app.pageContentNode,onChange:function(){this.scriptData=this.scriptArea.toJson()}.bind(this),onSave:function(){}.bind(this),style:"formula"});var i=this.scriptData?this.scriptData.code:"";this.scriptArea.load(i)}.bind(this))},getInputNodes:function(){this.inputAreaNode=this.node.getElement(".inputAreaNode_vf"),this.actionAreaNode=this.node.getElement(".actionAreaNode_vf"),this.actionAreaNode.setStyles(this.css.actionAreaNode),this.listAreaNode=this.node.getElement(".listAreaNode_vf"),this.fieldListAreaNode=this.node.getElement(".fieldListAreaNode_vf"),this.restrictViewFilterTable=this.node.getElement(".restrictViewFilterTable_vf");var t=this.node.getElement(".MWFFilterFormulaArea");t&&this.createScriptArea(t),this.titleInput=this.inputAreaNode.getElement(".titleInput_vf"),this.pathInput=this.inputAreaNode.getElement(".pathInput_vf"),this.datatypeInput=this.inputAreaNode.getElement(".datatypeInput_vf"),this.restrictFilterInput=this.inputAreaNode.getElement(".restrictFilterInput_vf"),this.customFilterInput=this.inputAreaNode.getElement(".customFilterInput_vf"),this.logicInput=this.inputAreaNode.getElement(".logicInput_vf"),this.comparisonInput=this.inputAreaNode.getElement(".comparisonInput_vf"),this.valueTextInput=this.inputAreaNode.getElement(".valueTextInput_vf"),this.valueNumberInput=this.inputAreaNode.getElement(".valueNumberInput_vf"),this.valueDatetimeInput=this.inputAreaNode.getElement(".valueDatetimeInput_vf"),this.valueBooleanInput=this.inputAreaNode.getElement(".valueBooleanInput_vf"),MWF.require("MWF.widget.Calendar",function(){this.calendar=new MWF.widget.Calendar(this.valueDatetimeInput,{style:"xform",isTime:!0,secondEnable:!0,target:this.app.content,format:"db"})}.bind(this)),this.datatypeInput.addEvent("change",function(){this.changeValueInput()}.bind(this)),this.valueTextInput.addEvent("keydown",function(t){13==t.code&&this.modifyOrAddFilterItem()}.bind(this)),this.valueNumberInput.addEvent("keydown",function(t){13==t.code&&this.modifyOrAddFilterItem()}.bind(this))},changeValueInput:function(){switch(this.datatypeInput.options[this.datatypeInput.selectedIndex].value){case"textValue":this.valueTextInput.setStyle("display","block"),this.valueNumberInput.setStyle("display","none"),this.valueDatetimeInput.setStyle("display","none"),this.valueBooleanInput.setStyle("display","none");break;case"numberValue":this.valueTextInput.setStyle("display","none"),this.valueNumberInput.setStyle("display","block"),this.valueDatetimeInput.setStyle("display","none"),this.valueBooleanInput.setStyle("display","none");break;case"datetimeValue":case"dateTimeValue":this.valueTextInput.setStyle("display","none"),this.valueNumberInput.setStyle("display","none"),this.valueDatetimeInput.setStyle("display","block"),this.valueBooleanInput.setStyle("display","none");break;case"booleanValue":this.valueTextInput.setStyle("display","none"),this.valueNumberInput.setStyle("display","none"),this.valueDatetimeInput.setStyle("display","none"),this.valueBooleanInput.setStyle("display","block")}},createActionNode:function(){this.actionNode=new Element("div",{styles:this.css.actionNode}).inject(this.actionAreaNode),this.actionNode.addEvent("click",function(){this.modifyOrAddFilterItem()}.bind(this))},modifyOrAddFilterItem:function(){this.currentFilterItem?this.modifyFilterItem():this.restrictFilterInput.checked?this.addFilterItem():this.addCustomFilterItem()},modifyFilterItem:function(){var t=this.getInputData();this.verificationData(t)&&(this.currentFilterItem.reload(t),this.currentFilterItem.unSelected(),this.fireEvent("change"))},addFilterItem:function(){var t=this.getInputData();this.verificationData(t)&&(this.items.push(new MWF.xApplication.process.ViewDesigner.widget.ViewFilter.Item(this,t)),this.fireEvent("change"))},addCustomFilterItem:function(){var t=this.getInputData();this.verificationDataCustom(t)&&(this.items.push(new MWF.xApplication.process.ViewDesigner.widget.ViewFilter.ItemCustom(this,t)),this.fireEvent("change"))},verificationData:function(t){return!!t.path||(this.verificationNode=new Element("div",{styles:this.css.verificationNode}).inject(this.inputAreaNode),new Element("div",{styles:this.css.verificationTextNode,text:this.app.lp.mastInputPath}).inject(this.verificationNode),this.pathInput.focus(),this.pathInput.setStyle("background-color","#fbe8e8"),this.pathInput.addEvents({keydown:function(){this.verificationNode&&(this.verificationNode.destroy(),this.verificationNode=null,this.pathInput.setStyle("background-color","#FFF"))}.bind(this),click:function(){this.verificationNode&&(this.verificationNode.destroy(),this.verificationNode=null)}.bind(this)}),!1)},verificationDataCustom:function(t){return t.title?!!t.path||(this.verificationNode=new Element("div",{styles:this.css.verificationNode}).inject(this.inputAreaNode),new Element("div",{styles:this.css.verificationTextNode,text:this.app.lp.mastInputPath}).inject(this.verificationNode),this.pathInput.focus(),this.pathInput.setStyle("background-color","#fbe8e8"),this.pathInput.addEvents({keydown:function(){this.verificationNode&&(this.verificationNode.destroy(),this.verificationNode=null,this.pathInput.setStyle("background-color","#FFF"))}.bind(this),click:function(){this.verificationNode&&(this.verificationNode.destroy(),this.verificationNode=null)}.bind(this)}),!1):(this.verificationNode=new Element("div",{styles:this.css.verificationNode}).inject(this.inputAreaNode),new Element("div",{styles:this.css.verificationTextNode,text:this.app.lp.mastInputTitle}).inject(this.verificationNode),this.titleInput.focus(),this.titleInput.setStyle("background-color","#fbe8e8"),this.titleInput.addEvents({keydown:function(){this.verificationNode&&(this.verificationNode.destroy(),this.verificationNode=null,this.titleInput.setStyle("background-color","#FFF"))}.bind(this),click:function(){this.verificationNode&&(this.verificationNode.destroy(),this.verificationNode=null)}.bind(this)}),!1)},getInputData:function(){var t=this.logicInput.options[this.logicInput.selectedIndex].value,e=this.pathInput.get("value"),i=this.titleInput.get("value");if(this.restrictFilterInput.checked)var s="restrict";if(this.customFilterInput.checked)s="custom";var n=this.comparisonInput.options[this.comparisonInput.selectedIndex].value,a=this.datatypeInput.options[this.datatypeInput.selectedIndex].value,o="";switch(a){case"textValue":o=this.valueTextInput.get("value");break;case"numberValue":o=this.valueNumberInput.get("value").toFloat();break;case"datetimeValue":case"dateTimeValue":o=this.valueDatetimeInput.get("value");break;case"booleanValue":o="true"==(o=this.valueBooleanInput.options[this.valueBooleanInput.selectedIndex].value)}return{logic:t,path:e,title:i,type:s,comparison:n,formatType:a,value:o,code:this.scriptData}},setData:function(t){for(var e=0;e<this.logicInput.options.length;e++)if(this.logicInput.options[e].value===t.logic){this.logicInput.options[e].set("selected",!0);break}this.titleInput.set("value",t.title),this.pathInput.set("value",t.path);for(e=0;e<this.comparisonInput.options.length;e++)if(this.comparisonInput.options[e].value===t.comparison){this.comparisonInput.options[e].set("selected",!0);break}for(e=0;e<this.datatypeInput.options.length;e++)if(this.datatypeInput.options[e].value===t.formatType){this.datatypeInput.options[e].set("selected",!0);break}switch(t.formatType){case"textValue":this.valueTextInput.set("value",t.value);break;case"numberValue":this.valueNumberInput.set("value",t.value);break;case"datetimeValue":case"dateTimeValue":this.valueDatetimeInput.set("value",t.value);break;case"booleanValue":for(e=0;e<this.valueBooleanInput.options.length;e++){var i=this.valueBooleanInput.options[e].value;if((i="true"==i)===t.value){this.valueBooleanInput.options[e].set("selected",!0);break}}}this.scriptData=t.code,this.scriptArea.editor&&this.scriptArea.editor.setValue(this.scriptData.code)},deleteItem:function(t){this.currentFilterItem==t&&t.unSelected(),this.items.erase(t),t.node.destroy(),MWF.release(t),this.fireEvent("change")},getData:function(){var t=[],e=[];return this.items.each(function(i){"custom"===i.data.type?e.push(i.data):t.push(i.data)}.bind(this)),{data:t,customData:e}}}),MWF.xApplication.process.ViewDesigner.widget.ViewFilter.Item=new Class({Implements:[Events],initialize:function(t,e){this.filter=t,this.data=e,this.container=this.filter.listAreaNode,this.css=this.filter.css,this.app=this.filter.app,this.load()},load:function(){this.node=new Element("div",{styles:this.css.itemNode}).inject(this.container),this.deleteNode=new Element("div",{styles:this.css.itemDeleteNode}).inject(this.node),this.contentNode=new Element("div",{styles:this.css.itemContentNode}).inject(this.node),this.contentNode.set("text",this.getText()),this.contentNode.addEvent("click",function(){this.selected()}.bind(this)),this.deleteNode.addEvent("click",function(t){this.deleteItem(t)}.bind(this))},getText:function(){var t=this.app.lp.filter;return t[this.data.logic]+" "+this.data.path+" "+t[this.data.comparison]+' "(S)"'},reload:function(t){this.data=t,this.contentNode.set("text",this.getText())},selected:function(){this.filter.currentFilterItem&&this.filter.currentFilterItem.unSelected(),this.node.setStyles(this.css.itemNode_current),this.filter.currentFilterItem=this,this.filter.setData(this.data)},unSelected:function(){this.node.setStyles(this.css.itemNode),this.filter.currentFilterItem=null,this.filter.currentItem=this},deleteItem:function(t){var e=this;this.filter.app.confirm("warn",t,this.app.lp.delete_filterItem_title,this.app.lp.delete_filterItem,300,120,(function(){e.destroy(),this.close()}),(function(){this.close()}))},destroy:function(){this.filter.deleteItem(this)}}),MWF.xApplication.process.ViewDesigner.widget.ViewFilter.ItemCustom=new Class({Extends:MWF.xApplication.process.ViewDesigner.widget.ViewFilter.Item,initialize:function(t,e){this.filter=t,this.data=e,this.container=this.filter.fieldListAreaNode,this.css=this.filter.css,this.app=this.filter.app,this.load()},getText:function(){this.app.lp.filter;return this.data.title+"("+this.data.path+")"}});