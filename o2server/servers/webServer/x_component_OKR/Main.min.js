MWF.xApplication.OKR=MWF.xApplication.OKR||{},MWF.require("MWF.widget.Identity",null,!1),MWF.xDesktop.requireApp("OKR","Actions.RestActions",null,!1),MWF.xApplication.OKR.options={multitask:!0,executable:!0},MWF.xApplication.OKR.Main=new Class({Extends:MWF.xApplication.Common.Main,Implements:[Options,Events],options:{style:"default",name:"OKR",icon:"icon.png",width:"1200",height:"700",isResize:!1,isMax:!0,title:MWF.xApplication.OKR.LP.title},onQueryLoad:function(){this.lp=MWF.xApplication.OKR.LP,this.user=layout.desktop.session.user.name,this.userGender=layout.desktop.session.user.genderType},loadApplication:function(t){this.manageDepartments=[],this.manageCompanys=[],this.restActions=new MWF.xApplication.OKR.Actions.RestActions,this.createNode(),this.loadApplicationContent()},isAdmin:function(){return this.isCompanyManager()||MWF.AC.isAdministrator()},isDepartmentManager:function(){return this.manageDepartments.length>0},isCompanyManager:function(){return this.manageCompanys.length>0},loadController:function(t){t&&t()},createNode:function(){this.content.setStyle("overflow","hidden"),this.node=new Element("div",{styles:{width:"100%",height:"100%",overflow:"hidden"}}).inject(this.content)},loadApplicationContent:function(){this.loadController(function(){this.loaNavi()}.bind(this))},loaNavi:function(t){this.naviNode=new Element("div.naviNode",{styles:this.css.naviNode}).inject(this.node);var e={id:""};this.status&&(e.id=this.status.id),this.navi=new MWF.xApplication.OKR.Navi(this,this.naviNode,e)},clearContent:function(){this.explorerContent&&(this.explorer&&delete this.explorer,this.explorerContent.destroy(),this.explorerContent=null)},openMinder:function(){MWF.xDesktop.requireApp("OKR","MinderExplorer",function(){this.clearContent(),this.explorerContent=new Element("div",{styles:this.css.rightContentNode}).inject(this.node),this.explorer=new MWF.xApplication.OKR.MinderExplorer(this.explorerContent,this,this.restActions,{isAdmin:this.isAdmin()}),this.explorer.load()}.bind(this))},opeCoreWork:function(){MWF.xDesktop.requireApp("Execution","CenterWorkDeployer",function(){this.explorer=new MWF.xApplication.Execution.CenterWorkDeployer({app:this},this.restActions,{},{isAdmin:this.isAdmin()}),this.explorer.load()}.bind(this))},opeWorkForm:function(){MWF.xDesktop.requireApp("Execution","WorkForm",function(){this.form=new MWF.xApplication.Execution.WorkForm({app:this},this.restActions,{},{isNew:!0,isEdited:!1}),this.form.load()}.bind(this))},opeWorkDetail:function(){MWF.xDesktop.requireApp("Execution","WorkDetail",function(){this.form=new MWF.xApplication.Execution.WorkDetail({app:this},this.restActions,{},{isNew:!1,isEdited:!1}),this.form.load()}.bind(this))},openImageCliper:function(){this.clearContent(),this.explorerContent=new Element("div",{styles:this.css.rightContentNode}).inject(this.node),MWF.require("MWF.widget.ImageClipper",function(){this.editor=new MWF.widget.ImageClipper(this.explorerContent,{}),this.editor.load()}.bind(this))},recordStatus:function(){return this.navi&&this.navi.currentItem?this.navi.currentItem.retrieve("data"):{}}}),MWF.xApplication.OKR.Navi=new Class({Implements:[Options,Events],options:{id:""},initialize:function(t,e,i){this.setOptions(i),this.app=t,this.node=$(e),this.css=this.app.css,this.currentMenu=null,this.currentItem=null,this.menus={},this.items={},this.elements=[],this.load()},load:function(){var t=this.app.path+"navi.json";MWF.getJSON(t,function(t){t.each(function(t){t.access&&"admin"==t.access?this.app.isAdmin()&&this.createNaviNode(t):t.access&&"admin_dept"==t.access?(this.app.isDepartmentManager()||this.app.isAdmin())&&this.createNaviNode(t):this.createNaviNode(t)}.bind(this)),""==this.options.id&&this.elements[0].click()}.bind(this))},createNaviNode:function(t){if("sep"==t.type){var e=!0;"admin"==t.access?this.app.isAdmin()||(e=!1):t.access&&"admin_dept"==t.access&&(this.app.isDepartmentManager()||this.app.isAdmin()||(e=!1)),e&&new Element("div",{styles:this.css.viewNaviSepartorNode}).inject(this.node)}else t.sub&&t.sub.length>0?this.createNaviMenuNode(t):(this.menus[t.id]={},this.createNaviItemNode(t,t.id))},createNaviMenuNode:function(t){if("admin"==t.access){if(!this.app.isAdmin())return}else if("admin_dept"==t.access&&!this.app.isDepartmentManager()&&!this.app.isAdmin())return;var e=this,i=new Element("div",{styles:this.css.naviMenuNode});i.store("data",t),i.store("type","menu"),new Element("div",{styles:this.css.naviMenuTextNode,text:t.title}).inject(i),i.inject(this.node),this.menus[t.id]={},this.menus[t.id].node=i,this.elements.push(i),i.addEvents({mouseover:function(){e.currentMenu!=this&&this.setStyles(e.app.css.naviMenuNode_over)},mouseout:function(){e.currentMenu!=this&&this.setStyles(e.app.css.naviMenuNode)},mousedown:function(){e.currentMenu!=this&&this.setStyles(e.app.css.naviMenuNode_down)},mouseup:function(){e.currentMenu!=this&&this.setStyles(e.app.css.naviMenuNode_over)},click:function(){e.clickMenu.apply(e,[this])}}),t.sub.each(function(e){this.createNaviItemNode(e,t.id,i)}.bind(this))},clickMenu:function(t){var e=t.retrieve("data");e.action;this.closeCurrentMenu(),this.menus[e.id].itemNodes&&this.menus[e.id].itemNodes.each((function(t){t.setStyle("display","block")}));t.retrieve("type");e.target&&"_blank"==e.target||(t.setStyles(this.css.naviMenuNode_current),this.currentMenu=t)},closeCurrentMenu:function(){if(this.currentMenu){var t=this.currentMenu.retrieve("data");this.menus[t.id].itemNodes&&this.menus[t.id].itemNodes.each((function(t){t.setStyle("display","none")})),this.currentMenu.setStyles(this.css.naviMenuNode)}},createNaviItemNode:function(t,e){if("admin"==t.access){if(!this.app.isAdmin())return}else if(t.access&&"admin_dept"==t.access&&!this.app.isDepartmentManager()&&!this.app.isAdmin())return;var i=this,s=this.menus[e].itemNodes=this.menus[e].itemNodes||[],n=new Element("div",{styles:this.css.naviItemNode});n.setStyle("display","block"),s.push(n),n.store("data",t),n.store("type","item"),new Element("div",{styles:this.css.naviItemTextNode,text:t.title}).inject(n),n.inject(this.node),this.elements.push(n),this.items[t.id]=n,n.addEvents({mouseover:function(){i.currentItem!=this&&this.setStyles(i.app.css.naviItemNode_over)},mouseout:function(){i.currentItem!=this&&this.setStyles(i.app.css.naviItemNode)},mousedown:function(){i.currentItem!=this&&this.setStyles(i.app.css.naviItemNode_down)},mouseup:function(){i.currentItem!=this&&this.setStyles(i.app.css.naviItemNode_over)},click:function(){i.clickItem.apply(i,[this])}}),t.id==this.options.id&&n.click()},clickItem:function(t){var e=t.retrieve("data");e.action,t.retrieve("type");e.target&&"_blank"==e.target||(this.currentItem&&this.currentItem.setStyles(this.css.naviItemNode),t.setStyles(this.css.naviItemNode_current),this.currentItem=t),e.action&&this.app[e.action]&&this.app[e.action].call(this.app,e)}});