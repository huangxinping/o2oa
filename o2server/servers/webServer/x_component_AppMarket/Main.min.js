MWF.require("MWF.widget.MaskNode",null,!1),MWF.xApplication.AppMarket.Main=new Class({Extends:MWF.xApplication.Common.Main,Implements:[Options,Events],options:{style:"default",name:"AppMarket",icon:"icon.png",width:"1000",height:"700",title:MWF.xApplication.AppMarket.LP.title},onQueryLoad:function(){this.lp=MWF.xApplication.AppMarket.LP,this.actions=MWF.Actions.get("x_program_center")},mask:function(){this.maskNode||(this.maskNode=new MWF.widget.MaskNode(this.contentNode,{style:"bam"}),this.maskNode.load())},unmask:function(){this.maskNode&&this.maskNode.hide(function(){MWF.release(this.maskNode),this.maskNode=null}.bind(this))},loadApplication:function(t){this.components=[],this.loadTitle(),this.contentNode=new Element("div",{styles:this.css.contentNode}).inject(this.content),this.contentModuleArea=new Element("div",{styles:this.css.contentModuleArea}).inject(this.contentNode),this.setContentSize(),this.addEvent("resize",this.setContentSize),this.loadCloudAppsContent()},loadTitle:function(){this.titleBar=new Element("div",{styles:this.css.titleBar}).inject(this.content),this.titleActionNode=new Element("div",{styles:this.css.titleActionNode,text:this.lp.implodeLocal}).inject(this.titleBar),this.taskTitleTextNode=new Element("div",{styles:this.css.titleTextNode,text:this.lp.title}).inject(this.titleBar),this.titleActionNode.addEvent("click",function(){this.implodeLocal()}.bind(this))},implodeLocal:function(t){MWF.xDesktop.requireApp("AppCenter","",function(){if(this.uploadFileAreaNode){this.fileUploadNode&&this.fileUploadNode.destroy(),this.uploadFileAreaNode.empty();t='<input name="file" type="file" accept=".xapp"/>';this.uploadFileAreaNode.set("html",t),this.fileUploadNode=this.uploadFileAreaNode.getFirst(),this.fileUploadNode.addEvent("change",this.importLocalFile.bind(this))}else{this.uploadFileAreaNode=new Element("div");var t='<input name="file" type="file" accept=".xapp"/>';this.uploadFileAreaNode.set("html",t),this.fileUploadNode=this.uploadFileAreaNode.getFirst(),this.fileUploadNode.addEvent("change",this.importLocalFile.bind(this))}this.fileUploadNode.click()}.bind(this))},importLocalFile:function(){var t=this.fileUploadNode.files;if(t.length){var e=t[0],i=this.titleActionNode.getPosition(this.content),s=this.contentNode.getSize(),o=.9*s.x;o>600&&(o=600);var n=.9*s.y,a=(s.x-o)/2,l=(s.y-n)/2,d=null,c=new MWF.xApplication.AppCenter.Main;c.inBrowser=!0,c.load(!0),MWF.require("MWF.xDesktop.Dialog",function(){var t=new MWF.xDesktop.Dialog({title:this.lp.setupTitle,style:"appMarket",top:l+20,left:a,fromTop:i.y,fromLeft:i.x,width:o,height:n,html:"",maskNode:this.content,container:this.content,buttonList:[{text:c.lp.ok,action:function(){d&&d.setup(),this.close()}},{text:c.lp.cancel,action:function(){this.close()}}]});t.show(),d=new MWF.xApplication.AppCenter.Module.SetupLocal(e,t,c)}.bind(this))}},setContentSize:function(){var t=this.content.getSize(),e=this.titleBar.getSize(),i=t.y-e.y;this.contentNode.setStyles({height:i+"px",overflow:"auto"});for(var s=.98*t.x,o=(t.x/170).toInt(),n=170*o;n>s;)n=170*--o;this.contentModuleArea.setStyle("width",n+"px")},loadCloudAppsContent:function(){this.loadCloudApps(function(){MWF.AC.isAdministrator()&&this.loadNewApp()}.bind(this))},loadCloudApps:function(t){this.categoryList=[],this.itemList=[],this.actions.listModule({categoryList:[]},function(t){t.data.each(function(t){this.categoryList.push(t.category),t.moduleList.each(function(t){this.itemList.push(new MWF.xApplication.AppMarket.Module(this,t))}.bind(this))}.bind(this)),this.unmask()}.bind(this),function(t,e,i){if(this.unmask(),0!=t.status){var s=i;if(t){var o=JSON.decode(t.responseText);s=o?o.message.trim()||"request json error":"request json error: "+t.responseText}MWF.xDesktop.notice("error",{x:"right",y:"top"},s)}}.bind(this))}}),MWF.xApplication.AppMarket.Module=new Class({initialize:function(t,e){this.app=t,this.data=e,this.lp=this.app.lp,this.css=this.app.css,this.content=this.app.contentModuleArea,this.load()},load:function(){this.node=new Element("div",{styles:this.css.moduleNode}).inject(this.content),this.iconAreaNode=new Element("div",{styles:this.css.moduleIconAreaNode}).inject(this.node),this.iconNode=new Element("div",{styles:this.css.moduleIconNode}).inject(this.iconAreaNode),this.data.icon&&(this.iconNode.setStyle("background-image","url(data:image/png;base64,"+this.data.icon+")"),this.iconNode.setStyle("background-size","cover")),this.contentNode=new Element("div",{styles:this.css.moduleContentNode}).inject(this.node),this.nameNode=new Element("div",{styles:this.css.moduleNameNode}).inject(this.contentNode),this.categoryNode=new Element("div",{styles:this.css.moduleCategoryNode}).inject(this.contentNode),this.descriptionNode=new Element("div",{styles:this.css.moduleDescriptionNode}).inject(this.contentNode),this.actionNode=new Element("div",{styles:this.css.moduleActionNode}).inject(this.contentNode),this.nameNode.set("text",this.data.name),this.categoryNode.set("text",this.data.category),this.descriptionNode.set("text",this.data.description),this.actionNode.set("text",this.lp.download),this.loadEvent()},loadEvent:function(){this.node.addEvents({mouseover:function(){this.setStyle("background-color","#ffffff")},mouseout:function(){this.setStyle("background-color","#f5f5f5")}}),this.actionNode.addEvent("click",function(t){this.downloadApp(),t.stopPropagation()}.bind(this)),this.node.addEvent("click",function(){this.openApp()}.bind(this))},downloadApp:function(){var t=this.actionNode.getPosition(this.app.content),e=this.app.contentNode.getSize(),i=.9*e.x;i>600&&(i=600);var s=.9*e.y,o=(e.x-i)/2,n=(e.y-s)/2,a=null;MWF.require("MWF.xDesktop.Dialog",function(){var e=new MWF.xDesktop.Dialog({title:this.lp.setupTitle+" "+this.data.name,style:"appMarket",top:n+20,left:o,fromTop:t.y,fromLeft:t.x,width:i,height:s,html:"",maskNode:this.app.content,container:this.app.content,buttonList:[{text:this.lp.ok,action:function(){a&&a.setup(),this.close()}},{text:this.lp.cancel,action:function(){this.close()}}]});e.show(),a=new MWF.xApplication.AppMarket.Module.Setup(this,e)}.bind(this))},openApp:function(){}}),MWF.xApplication.AppMarket.Module.Setup=new Class({initialize:function(t,e){this.module=t,this.app=this.module.app,this.data=this.module.data,this.lp=this.module.lp,this.css=this.app.css,this.dlg=e,this.content=this.dlg.content,this.setupData={},this.compareData=null,this.load()},load:function(){this.node=new Element("div",{styles:this.css.moduleSetupContentNode}).inject(this.content),this.loadTitle(),this.loadContent()},loadTitle:function(){this.titleNode=new Element("div",{styles:this.css.moduleSetupTitleNode}).inject(this.node),this.iconAreaNode=new Element("div",{styles:this.css.moduleSetupIconAreaNode}).inject(this.titleNode);var t=new Element("div",{styles:this.css.moduleSetupIconNode}).inject(this.iconAreaNode);this.data.icon&&(t.setStyle("background-image","url(data:image/png;base64,"+this.data.icon+")"),t.setStyle("background-size","cover"));var e=new Element("div",{styles:this.css.moduleSetupTitleContentNode}).inject(this.titleNode),i=new Element("div",{styles:this.css.moduleSetupNameNode}).inject(e),s=new Element("div",{styles:this.css.moduleSetupCategoryNode}).inject(e),o=new Element("div",{styles:this.css.moduleSetupDescriptionNode}).inject(e);i.set("text",this.data.name),s.set("text",this.data.category),o.set("text",this.data.description)},loadContent:function(){this.contentNode=new Element("div",{styles:this.css.moduleSetupCompareContentNode}).inject(this.node),this.createLoading(this.contentNode),this.loadCompare()},createLoading:function(t){this.dlg.button.setStyle("display","none"),this.loadingAreaNode=new Element("div",{styles:this.css.moduleLoadingAreaNode}).inject(t);new Element("img",{styles:this.css.moduleLoadingImgNode,src:this.app.path+this.app.options.style+"/icon/loading.gif"}).inject(this.loadingAreaNode)},clearLoading:function(){this.loadingAreaNode&&(this.loadingAreaNode.destroy(),this.loadingAreaNode=null),this.dlg.button.setStyle("display","block")},loadCompare:function(){this.app.actions.compareModule(this.data.id,function(t){this.clearLoading(),this.setupData.flag=t.data.flag,this.createListArea(),this.compareData=t.data,this.loadProcessList(),this.loadPortalList(),this.loadCMSList(),this.loadQueryList()}.bind(this))},createListArea:function(){this.contentAreaNode=new Element("div").inject(this.contentNode),this.contentInforNode=new Element("div",{styles:this.css.moduleSetupContentInforNode,text:this.lp.downloadInfor}).inject(this.contentAreaNode),this.processAreaTitle=new Element("div",{styles:this.css.moduleSetupListAreaTitleNode,text:this.lp.process}).inject(this.contentAreaNode),this.processAreaContent=new Element("div",{styles:this.css.moduleSetupListAreaContentNode}).inject(this.contentAreaNode),this.portalAreaTitle=new Element("div",{styles:this.css.moduleSetupListAreaTitleNode,text:this.lp.portal}).inject(this.contentAreaNode),this.portalAreaContent=new Element("div",{styles:this.css.moduleSetupListAreaContentNode}).inject(this.contentAreaNode),this.cmsAreaTitle=new Element("div",{styles:this.css.moduleSetupListAreaTitleNode,text:this.lp.cms}).inject(this.contentAreaNode),this.cmsAreaContent=new Element("div",{styles:this.css.moduleSetupListAreaContentNode}).inject(this.contentAreaNode),this.queryAreaTitle=new Element("div",{styles:this.css.moduleSetupListAreaTitleNode,text:this.lp.query}).inject(this.contentAreaNode),this.queryAreaContent=new Element("div",{styles:this.css.moduleSetupListAreaContentNode}).inject(this.contentAreaNode)},loadProcessList:function(){this.processListNodes=[],this.compareData.processPlatformList.each(function(t){this.processListNodes.push(new MWF.xApplication.AppMarket.Module.Setup.ProcessElement(this,this.processAreaContent,t))}.bind(this))},loadPortalList:function(){this.portalListNodes=[],this.compareData.portalList.each(function(t){this.portalListNodes.push(new MWF.xApplication.AppMarket.Module.Setup.PortalElement(this,this.portalAreaContent,t))}.bind(this))},loadCMSList:function(){this.cmsListNodes=[],this.compareData.cmsList.each(function(t){this.cmsListNodes.push(new MWF.xApplication.AppMarket.Module.Setup.CmsElement(this,this.cmsAreaContent,t))}.bind(this))},loadQueryList:function(){this.queryListNodes=[],this.compareData.queryList.each(function(t){this.queryListNodes.push(new MWF.xApplication.AppMarket.Module.Setup.QueryElement(this,this.queryAreaContent,t))}.bind(this))},setup:function(){this.setupData.flag=this.compareData.flag,this.setupData.processPlatformList=[],this.setupData.portalList=[],this.setupData.queryList=[],this.setupData.cmsList=[],this.getWriteData(this.processListNodes,this.setupData.processPlatformList),this.getWriteData(this.portalListNodes,this.setupData.portalList),this.getWriteData(this.cmsListNodes,this.setupData.cmsList),this.getWriteData(this.queryListNodes,this.setupData.queryList),this.contentAreaNode.setStyle("display","none"),this.createLoading(this.contentNode),this.app.actions.importModule(this.compareData.flag,this.setupData,function(){this.app.notice(this.module.data.name+" "+this.lp.setupSuccess,"success"),this.clearLoading()}.bind(this))},getWriteData:function(t,e){t.each(function(t){if(t.action){var i=t.action.options[t.action.selectedIndex].get("value");"ignore"!=i&&e.push({id:t.data.id,method:i})}else e.push({id:t.data.id})}.bind(this))}}),MWF.xApplication.AppMarket.Module.SetupLocal=new Class({Extends:MWF.xApplication.AppMarket.Module.Setup,initialize:function(t,e,i){this.app=i,this.file=t,this.lp=this.app.lp,this.module={data:{name:this.lp.localApp,category:"",description:""}},this.data=this.module.data,this.css=this.app.css,this.dlg=e,this.content=this.dlg.content,this.setupData={},this.compareData=null,this.load()},loadCompare:function(){var t=new FormData;t.append("file",this.file),this.app.actions.compareUpload(t,this.file,function(t){this.clearLoading(),this.setupData.flag=t.data.flag,this.createListArea(),this.compareData=t.data,this.loadProcessList(),this.loadPortalList(),this.loadCMSList(),this.loadQueryList()}.bind(this))}}),MWF.xApplication.AppMarket.Module.Setup.Element=new Class({initialize:function(t,e,i){this.setup=t,this.app=this.setup.app,this.data=i,this.lp=this.app.lp,this.css=this.app.css,this.content=e,this.load()},load:function(){if(this.contentNode=new Element("div",{styles:this.css.moduleSetupListContentNode}).inject(this.content),this.iconNode=new Element("div",{styles:this.css.moduleSetupListIconNode}).inject(this.contentNode),this.actionNode=new Element("div",{styles:this.css.moduleSetupListActionNode}).inject(this.contentNode),this.inforNode=new Element("div",{styles:this.css.moduleSetupListInforNode}).inject(this.contentNode),this.nameNode=new Element("div",{styles:this.css.moduleSetupListNameNode}).inject(this.contentNode),this.nameNode.set(this.getNameContent()),this.data.exist){this.iconNode.setStyle("background","url("+this.app.path+this.app.options.style+"/icon/conflict.png) center center no-repeat"),this.contentNode.setStyle("color","#e86a58"),this.inforNode.set("text",this.lp.conflict),this.action=new Element("select",{styles:this.css.moduleSetupListActionSelectNode}).inject(this.actionNode);var t="<option value='ignore' selected>"+this.lp.ignore+"</option>";t+="<option value='create'>"+this.lp.create+"</option>",t+="<option value='cover'>"+this.lp.cover+"</option>",this.action.set("html",t)}else{this.action=new Element("select",{styles:this.css.moduleSetupListActionSelectNode}).inject(this.actionNode);t="<option value='ignore'>"+this.lp.ignore+"</option>";t+="<option value='create' selected>"+this.lp.create+"</option>",this.action.set("html",t)}},getNameContent:function(){return{title:this.lp.name+": "+this.data.name+" "+this.lp.id+": "+this.data.id,text:this.data.name}}}),MWF.xApplication.AppMarket.Module.Setup.ProcessElement=new Class({Extends:MWF.xApplication.AppMarket.Module.Setup.Element}),MWF.xApplication.AppMarket.Module.Setup.PortalElement=new Class({Extends:MWF.xApplication.AppMarket.Module.Setup.Element}),MWF.xApplication.AppMarket.Module.Setup.CmsElement=new Class({Extends:MWF.xApplication.AppMarket.Module.Setup.Element}),MWF.xApplication.AppMarket.Module.Setup.QueryElement=new Class({Extends:MWF.xApplication.AppMarket.Module.Setup.Element});